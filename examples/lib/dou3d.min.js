var dou3d,__extends=this&&this.__extends||function(){var i=function(t,e){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};return function(t,e){function r(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}();!function(t){var e=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._count=0,t}return __extends(t,e),Object.defineProperty(t.prototype,"canDispose",{get:function(){return this._count<=0},enumerable:!0,configurable:!0}),t.prototype.incRef=function(){this._count++},t.prototype.decRef=function(){0<=this._count-1&&this._count--},t}(dou.HashObject);t.Reference=e}(dou3d||(dou3d={})),function(u){var t=function(){function h(){}return h.prototype.register=function(){h.gl.getExtension("WEBGL_depth_texture")||h.gl.getExtension("MOZ_WEBGL_depth_texture")||h.gl.getExtension("WEBKIT_WEBGL_depth_texture"),h.gl.getExtension("EXT_texture_filter_anisotropic")||h.gl.getExtension("MOZ_EXT_texture_filter_anisotropic")||h.gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),h.gl.getExtension("WEBGL_compressed_texture_pvrtc")||h.gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),h.gl.getExtension("WEBGL_compressed_texture_etc1"),h.gl.getExtension("OES_element_index_uint"),h.gl.getExtension("OES_texture_float_linear"),h.gl.getExtension("OES_texture_float"),h.gl.getExtension("OES_texture_half_float"),h.gl.getExtension("OES_texture_half_float_linear"),h.gl.getExtension("OES_standard_derivatives"),h.gl.getExtension("GL_OES_standard_derivatives"),h.gl.getExtension("WEBGL_draw_buffers"),h.gl.getExtension("WEBGL_depth_texture"),h.gl.getExtension("WEBGL_lose_context")},h.prototype.viewPort=function(t,e,r,i){h.gl.viewport(t,e,r,i)},h.prototype.setScissorRectangle=function(t,e,r,i){h.gl.scissor(t,h.canvasRectangle.h-i-e,r,i)},h.prototype.createVertexShader=function(t){var e=h.gl.createShader(h.gl.VERTEX_SHADER);return h.gl.shaderSource(e,t),h.gl.compileShader(e),new u.Shader(e)},h.prototype.createFragmentShader=function(t){var e=h.gl.createShader(h.gl.FRAGMENT_SHADER);return h.gl.shaderSource(e,t),h.gl.compileShader(e),new u.Shader(e)},h.prototype.createProgram=function(t,e){var r=h.gl.createProgram();h.gl.attachShader(r,t.shader),h.gl.attachShader(r,e.shader),h.gl.linkProgram(r);var i=h.gl.getProgramParameter(r,h.gl.LINK_STATUS);return DEBUG&&!i&&(console.error("vsShader error"+h.gl.getShaderInfoLog(t.shader)),console.error("fsShader error"+h.gl.getShaderInfoLog(e.shader))),new u.Program3D(r)},h.prototype.setProgram=function(t){this._program!=t&&(this._program=t,h.gl.useProgram(t.program))},h.prototype.createVertexBuffer=function(t,e){void 0===e&&(e=h.gl.STATIC_DRAW);var r=h.gl.createBuffer();return h.gl.bindBuffer(h.gl.ARRAY_BUFFER,r),h.gl.bufferData(h.gl.ARRAY_BUFFER,t,e),new u.VertexBuffer3D(r,t)},h.prototype.uploadVertexBuffer=function(t){h.gl.bindBuffer(h.gl.ARRAY_BUFFER,t.buffer),h.gl.bufferData(h.gl.ARRAY_BUFFER,t.arrayBuffer,h.gl.DYNAMIC_DRAW)},h.prototype.createIndexBuffer=function(t){var e=h.gl.createBuffer();return h.gl.bindBuffer(h.gl.ELEMENT_ARRAY_BUFFER,e),h.gl.bufferData(h.gl.ELEMENT_ARRAY_BUFFER,t,h.gl.STATIC_DRAW),new u.IndexBuffer3D(e,t)},h.prototype.uploadIndexBuffer=function(t){h.gl.bindBuffer(h.gl.ELEMENT_ARRAY_BUFFER,t.buffer),h.gl.bufferData(h.gl.ELEMENT_ARRAY_BUFFER,t.arrayBuffer,h.gl.DYNAMIC_DRAW)},h.prototype.getUniformLocation=function(t,e){return h.gl.getUniformLocation(t.program,e)},h.prototype.uniform1f=function(t,e){h.gl.uniform1f(t,e)},h.prototype.uniform1fv=function(t,e){h.gl.uniform1fv(t,e)},h.prototype.uniform1i=function(t,e){h.gl.uniform1i(t,e)},h.prototype.uniform1iv=function(t,e){h.gl.uniform1iv(t,e)},h.prototype.uniform2f=function(t,e,r){h.gl.uniform2f(t,e,r)},h.prototype.uniform2fv=function(t,e){h.gl.uniform2fv(t,e)},h.prototype.uniform2i=function(t,e,r){h.gl.uniform2i(t,e,r)},h.prototype.uniform2iv=function(t,e){h.gl.uniform2iv(t,e)},h.prototype.uniform3f=function(t,e,r,i){h.gl.uniform3f(t,e,r,i)},h.prototype.uniform3fv=function(t,e){h.gl.uniform3fv(t,e)},h.prototype.uniform3i=function(t,e,r,i){h.gl.uniform3i(t,e,r,i)},h.prototype.uniform3iv=function(t,e){h.gl.uniform3iv(t,e)},h.prototype.uniform4f=function(t,e,r,i,a){h.gl.uniform4f(t,e,r,i,a)},h.prototype.uniform4fv=function(t,e){h.gl.uniform4fv(t,e)},h.prototype.uniform4i=function(t,e,r,i,a){h.gl.uniform4i(t,e,r,i,a)},h.prototype.uniform4iv=function(t,e){h.gl.uniform4iv(t,e)},h.prototype.uniformMatrix2fv=function(t,e,r){h.gl.uniformMatrix2fv(t,e,r)},h.prototype.uniformMatrix3fv=function(t,e,r){h.gl.uniformMatrix3fv(t,e,r)},h.prototype.uniformMatrix4fv=function(t,e,r){h.gl.uniformMatrix4fv(t,e,r)},h.prototype.getShaderAttribLocation=function(t,e){return h.gl.getAttribLocation(t.program,e)},h.prototype.disableAllVertexAttribArray=function(){for(var t=0;t<8;t++)h.gl.disableVertexAttribArray(t)},h.prototype.vertexAttribPointer=function(t,e,r,i,a,n){h.gl.vertexAttribPointer(t,e,r,i,a,n),h.gl.enableVertexAttribArray(t)},h.prototype.setVertexShaderConstData=function(t,e,r){h.gl.vertexAttrib4fv(e,t.subarray(e,r))},h.prototype.bindVertexBuffer=function(t){h.gl.bindBuffer(h.gl.ARRAY_BUFFER,t.buffer)},h.prototype.bindIndexBuffer=function(t){h.gl.bindBuffer(h.gl.ELEMENT_ARRAY_BUFFER,t.buffer)},h.prototype.createTexture=function(){return h.gl.createTexture()},h.prototype.texParameteri=function(t,e,r){h.gl.texParameteri(t,e,r)},h.prototype.upLoadTextureData=function(t,e){h.gl.bindTexture(h.gl.TEXTURE_2D,e.texture2D.texture),0==e.texture2D.internalFormat?h.gl.texImage2D(h.gl.TEXTURE_2D,0,h.gl.RGBA,h.gl.RGBA,e.texture2D.dataFormat,e.texture2D.imageData):1==e.texture2D.internalFormat?this.upLoadCompressedTexture2D(t,e.texture2D):2==e.texture2D.internalFormat&&h.gl.texImage2D(h.gl.TEXTURE_2D,t,e.texture2D.colorFormat,e.texture2D.mimapData[t].width,e.texture2D.mimapData[t].height,e.texture2D.border,e.texture2D.colorFormat,e.texture2D.dataFormat,e.texture2D.mimapData[t].data),e.useMipmap&&h.gl.generateMipmap(h.gl.TEXTURE_2D)},h.prototype.upLoadCompressedTexture2D=function(t,e){h.gl.compressedTexImage2D(h.gl.TEXTURE_2D,t,e.colorFormat,e.mimapData[t].width,e.mimapData[t].height,e.border,e.mimapData[t].data)},h.prototype.uploadCubetexture=function(t){h.gl.bindTexture(h.gl.TEXTURE_CUBE_MAP,t.texture),t.image_right.mimapData&&0<t.image_right.mimapData.length?h.gl.texImage2D(h.gl.TEXTURE_CUBE_MAP_POSITIVE_X,0,h.gl.RGB,t.image_right.mimapData[0].width,t.image_right.mimapData[0].height,0,h.gl.RGB,h.gl.UNSIGNED_BYTE,t.image_right.mimapData[0].data):h.gl.texImage2D(h.gl.TEXTURE_CUBE_MAP_POSITIVE_X,0,h.gl.RGB,h.gl.RGB,h.gl.UNSIGNED_BYTE,t.image_right.imageData),t.image_left.mimapData&&0<t.image_left.mimapData.length?h.gl.texImage2D(h.gl.TEXTURE_CUBE_MAP_NEGATIVE_X,0,h.gl.RGB,t.image_left.mimapData[0].width,t.image_left.mimapData[0].height,0,h.gl.RGB,h.gl.UNSIGNED_BYTE,t.image_left.mimapData[0].data):h.gl.texImage2D(h.gl.TEXTURE_CUBE_MAP_NEGATIVE_X,0,h.gl.RGB,h.gl.RGB,h.gl.UNSIGNED_BYTE,t.image_left.imageData),t.image_up.mimapData&&0<t.image_up.mimapData.length?h.gl.texImage2D(h.gl.TEXTURE_CUBE_MAP_POSITIVE_Y,0,h.gl.RGB,t.image_up.mimapData[0].width,t.image_up.mimapData[0].height,0,h.gl.RGB,h.gl.UNSIGNED_BYTE,t.image_up.mimapData[0].data):h.gl.texImage2D(h.gl.TEXTURE_CUBE_MAP_POSITIVE_Y,0,h.gl.RGB,h.gl.RGB,h.gl.UNSIGNED_BYTE,t.image_up.imageData),t.image_down.mimapData&&0<t.image_down.mimapData.length?h.gl.texImage2D(h.gl.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,h.gl.RGB,t.image_down.mimapData[0].width,t.image_down.mimapData[0].height,0,h.gl.RGB,h.gl.UNSIGNED_BYTE,t.image_down.mimapData[0].data):h.gl.texImage2D(h.gl.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,h.gl.RGB,h.gl.RGB,h.gl.UNSIGNED_BYTE,t.image_down.imageData),t.image_front.mimapData&&0<t.image_front.mimapData.length?h.gl.texImage2D(h.gl.TEXTURE_CUBE_MAP_POSITIVE_Z,0,h.gl.RGB,t.image_front.mimapData[0].width,t.image_front.mimapData[0].height,0,h.gl.RGB,h.gl.UNSIGNED_BYTE,t.image_front.mimapData[0].data):h.gl.texImage2D(h.gl.TEXTURE_CUBE_MAP_POSITIVE_Z,0,h.gl.RGB,h.gl.RGB,h.gl.UNSIGNED_BYTE,t.image_front.imageData),t.image_back.mimapData&&0<t.image_back.mimapData.length?h.gl.texImage2D(h.gl.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,h.gl.RGB,t.image_back.mimapData[0].width,t.image_back.mimapData[0].height,0,h.gl.RGB,h.gl.UNSIGNED_BYTE,t.image_back.mimapData[0].data):h.gl.texImage2D(h.gl.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,h.gl.RGB,h.gl.RGB,h.gl.UNSIGNED_BYTE,t.image_back.imageData),h.gl.texParameteri(h.gl.TEXTURE_CUBE_MAP,h.gl.TEXTURE_MAG_FILTER,h.gl.LINEAR),h.gl.texParameteri(h.gl.TEXTURE_CUBE_MAP,h.gl.TEXTURE_MIN_FILTER,h.gl.LINEAR),h.gl.texParameteri(h.gl.TEXTURE_CUBE_MAP,h.gl.TEXTURE_WRAP_S,h.gl.CLAMP_TO_EDGE),h.gl.texParameteri(h.gl.TEXTURE_CUBE_MAP,h.gl.TEXTURE_WRAP_T,h.gl.CLAMP_TO_EDGE)},h.prototype.createFramebuffer=function(t,e,r){var i=h.gl.createFramebuffer(),a=new u.ContextTexture2D,n=h.gl.createRenderbuffer();switch(a.texture=a.texture||h.gl.createTexture(),h.gl.bindTexture(h.gl.TEXTURE_2D,a.texture),r){case 2:h.gl.texImage2D(h.gl.TEXTURE_2D,0,h.gl.RGB,t,e,0,h.gl.RGB,h.gl.UNSIGNED_BYTE,null);break;case 3:h.gl.texImage2D(h.gl.TEXTURE_2D,0,h.gl.RGBA,t,e,0,h.gl.RGBA,h.gl.UNSIGNED_BYTE,null);break;case 0:for(var o=new Float32Array(t*e*4),s=0;s<t*e;s++)o[s]=Math.random(),o[s+1]=Math.random(),o[s+2]=Math.random();h.gl.texImage2D(h.gl.TEXTURE_2D,0,h.gl.RGB,t,e,0,h.gl.RGB,h.gl.FLOAT,o);break;case 1:for(o=new Float32Array(t*e*4),s=0;s<t*e;s++)o[s]=Math.random(),o[s+1]=Math.random(),o[s+2]=Math.random(),o[s+3]=Math.random();h.gl.texImage2D(h.gl.TEXTURE_2D,0,h.gl.RGBA,t,e,0,h.gl.RGBA,h.gl.FLOAT,o)}return h.gl.texParameteri(h.gl.TEXTURE_2D,h.gl.TEXTURE_MAG_FILTER,h.gl.NEAREST),h.gl.texParameteri(h.gl.TEXTURE_2D,h.gl.TEXTURE_MIN_FILTER,h.gl.NEAREST),h.gl.texParameteri(h.gl.TEXTURE_2D,h.gl.TEXTURE_WRAP_S,h.gl.CLAMP_TO_EDGE),h.gl.texParameteri(h.gl.TEXTURE_2D,h.gl.TEXTURE_WRAP_T,h.gl.CLAMP_TO_EDGE),h.gl.bindFramebuffer(h.gl.FRAMEBUFFER,i),h.gl.framebufferTexture2D(h.gl.FRAMEBUFFER,h.gl.COLOR_ATTACHMENT0,h.gl.TEXTURE_2D,a.texture,0),h.gl.bindRenderbuffer(h.gl.RENDERBUFFER,n),h.gl.renderbufferStorage(h.gl.RENDERBUFFER,h.gl.DEPTH_COMPONENT16,t,e),a.width=t,a.height=e,a.frameBuffer=i,a.renderbuffer=n,h.gl.bindFramebuffer(h.gl.FRAMEBUFFER,null),h.gl.bindTexture(h.gl.TEXTURE_2D,null),h.gl.bindRenderbuffer(h.gl.RENDERBUFFER,null),a},h.prototype.setRenderToTexture=function(t){h.gl.viewport(0,0,t.width,t.height),h.gl.scissor(0,0,t.width,t.height),h.gl.bindFramebuffer(h.gl.FRAMEBUFFER,t.frameBuffer),h.gl.clearColor(0,0,0,0),h.gl.clear(h.gl.COLOR_BUFFER_BIT|h.gl.DEPTH_BUFFER_BIT),h.gl.framebufferTexture2D(h.gl.FRAMEBUFFER,h.gl.COLOR_ATTACHMENT0,h.gl.TEXTURE_2D,t.texture,0),h.gl.framebufferRenderbuffer(h.gl.FRAMEBUFFER,h.gl.DEPTH_ATTACHMENT,h.gl.RENDERBUFFER,t.renderbuffer)},h.prototype.setRenderToBackBuffer=function(){h.gl.bindTexture(h.gl.TEXTURE_2D,null),h.gl.bindFramebuffer(h.gl.FRAMEBUFFER,null),h.gl.bindRenderbuffer(h.gl.RENDERBUFFER,null)},h.prototype.setTexture2DAt=function(t,e,r,i){h.gl.activeTexture(t),h.gl.bindTexture(h.gl.TEXTURE_2D,i.texture),h.gl.uniform1i(e,r)},h.prototype.setCubeTextureAt=function(t,e,r,i){h.gl.activeTexture(t),h.gl.bindTexture(h.gl.TEXTURE_CUBE_MAP,i.texture),h.gl.uniform1i(e,r)},h.prototype.setBlendFactors=function(t,e){this._sfactor==t&&this._dfactor==e||(this._sfactor=t,this._dfactor=e,h.gl.blendFunc(t,e))},h.prototype.setCulling=function(t){this._cullingMode!=t&&(this._cullingMode=t,h.gl.cullFace(t))},h.prototype.enableDepth=function(){this._depthTest||(this._depthTest=!0,h.gl.enable(h.gl.DEPTH_TEST))},h.prototype.disableDepth=function(){this._depthTest&&(this._depthTest=!1,h.gl.disable(h.gl.DEPTH_TEST))},h.prototype.enableCullFace=function(){this._cullFace||(this._cullFace=!0,h.gl.enable(h.gl.CULL_FACE))},h.prototype.disableCullFace=function(){this._cullFace&&(this._cullFace=!1,h.gl.disable(h.gl.CULL_FACE))},h.prototype.enableBlend=function(){h.gl.enable(h.gl.BLEND)},h.prototype.disableBlend=function(){h.gl.disable(h.gl.BLEND)},h.prototype.depthFunc=function(t){void 0===t&&(t=0),this._depthCompareMode!=t&&(this._depthCompareMode=t,h.gl.depthFunc(t))},h.prototype.drawArrays=function(t,e,r){h.gl.drawArrays(t,e,r)},h.prototype.drawElement=function(t,e,r){h.gl.drawElements(t,r,h.gl.UNSIGNED_SHORT,e)},h.prototype.flush=function(){h.gl.flush()},h.prototype.clear=function(t){h.gl.clear(t)},h.prototype.clearColor=function(t,e,r,i){h.gl.clearColor(t,e,r,i)},h.prototype.clearStencil=function(t){h.gl.clearStencil(t)},h}();u.Context3DProxy=t}(dou3d||(dou3d={})),function(e){var t=function(){function t(){this.border=0}return t.prototype.dispose=function(){this.texture&&(e.Context3DProxy.gl.deleteTexture(this.texture),this.texture=null),this.frameBuffer&&(e.Context3DProxy.gl.deleteFramebuffer(this.frameBuffer),this.frameBuffer=null),this.renderbuffer&&(e.Context3DProxy.gl.deleteRenderbuffer(this.renderbuffer),this.renderbuffer=null)},t}();e.ContextTexture2D=t}(dou3d||(dou3d={})),function(e){var t=function(){function t(){this.border=0}return t.prototype.dispose=function(){this.texture&&(e.Context3DProxy.gl.deleteTexture(this.texture),this.texture=null),this.image_front&&(this.image_front.dispose(),this.image_front=null),this.image_back&&(this.image_back.dispose(),this.image_back=null),this.image_left&&(this.image_left.dispose(),this.image_left=null),this.image_right&&(this.image_right.dispose(),this.image_right=null),this.image_up&&(this.image_up.dispose(),this.image_up=null),this.image_down&&(this.image_down.dispose(),this.image_down=null)},t}();e.ContextTexture3D=t}(dou3d||(dou3d={})),function(t){var e=function(){};(dou3d||(dou3d={})).FrameBuffer=e}(),function(e){var t=function(){function t(t,e){this._buffer=t,this._arrayBuffer=e}return Object.defineProperty(t.prototype,"buffer",{get:function(){return this._buffer},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"arrayBuffer",{get:function(){return this._arrayBuffer},enumerable:!0,configurable:!0}),t.prototype.dispose=function(){this._buffer&&(e.Context3DProxy.gl.deleteBuffer(this._buffer),this._buffer=null),this._arrayBuffer&&(this._arrayBuffer=null)},t}();e.IndexBuffer3D=t}(dou3d||(dou3d={})),function(t){var e=function(t,e,r){this.data=t,this.width=e,this.height=r};(dou3d||(dou3d={})).MipmapData=e}(),function(t){var e=function(){function e(t){this._id=e.ID++,this._program=t}return Object.defineProperty(e.prototype,"id",{get:function(){return this._id},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"program",{get:function(){return this._program},enumerable:!0,configurable:!0}),e.prototype.dispose=function(){this._program&&(t.Context3DProxy.gl.deleteProgram(this._program),this._program=null)},e.ID=0,e}();t.Program3D=e}(dou3d||(dou3d={})),function(t){var e=function(){function e(t){this._id=""+e.ID++,this._shader=t}return Object.defineProperty(e.prototype,"id",{get:function(){return this._id},set:function(t){this._id=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"shader",{get:function(){return this._shader},enumerable:!0,configurable:!0}),e.prototype.dispose=function(){this._shader&&(t.Context3DProxy.gl.deleteShader(this._shader),this._shader=null)},e.ID=0,e}();t.Shader=e}(dou3d||(dou3d={})),function(e){var t=function(){function t(t,e){this._buffer=t,this._arrayBuffer=e}return Object.defineProperty(t.prototype,"buffer",{get:function(){return this._buffer},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"arrayBuffer",{get:function(){return this._arrayBuffer},enumerable:!0,configurable:!0}),t.prototype.dispose=function(){this._buffer&&(e.Context3DProxy.gl.deleteBuffer(this._buffer),this._buffer=null),this._arrayBuffer&&(this._arrayBuffer=null)},t}();e.VertexBuffer3D=t}(dou3d||(dou3d={})),function(n){var t=function(e){function t(){var t=e.call(this)||this;return t._visible=!0,t._layer=0,t._globalMatrix=new n.Matrix4,t._position=new n.Vector3,t._rotation=new n.Vector3,t._scale=new n.Vector3(1,1,1),t._orientation=new n.Quaternion,t._globalPosition=new n.Vector3,t._globalRotation=new n.Vector3,t._globalScale=new n.Vector3(1,1,1),t._globalOrientation=new n.Quaternion,t}return __extends(t,e),Object.defineProperty(t.prototype,"position",{get:function(){return this._position},set:function(t){this._position.equal(t)||(this._position.copy(t),this.invalidTransform())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"x",{get:function(){return this._position.x},set:function(t){this._position.x!=t&&(this._position.x=t,this.invalidTransform())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return this._position.y},set:function(t){this._position.y!=t&&(this._position.y=t,this.invalidTransform())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"z",{get:function(){return this._position.z},set:function(t){this._position.z!=t&&(this._position.z=t,this.invalidTransform())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rotation",{get:function(){return this._rotation},set:function(t){this._rotation.equal(t)||(this._rotation.copy(t),this._orientation.fromEuler(this._rotation.x,this._rotation.y,this._rotation.z),this.invalidTransform())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rotationX",{get:function(){return this._rotation.x},set:function(t){this._rotation.x!=t&&(this._rotation.x=t,this._orientation.fromEuler(this._rotation.x,this._rotation.y,this._rotation.z),this.invalidTransform())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rotationY",{get:function(){return this._rotation.y},set:function(t){this._rotation.y!=t&&(this._rotation.y=t,this._orientation.fromEuler(this._rotation.x,this._rotation.y,this._rotation.z),this.invalidTransform())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rotationZ",{get:function(){return this._rotation.z},set:function(t){this._rotation.z!=t&&(this._rotation.z=t,this._orientation.fromEuler(this._rotation.x,this._rotation.y,this._rotation.z),this.invalidTransform())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"scale",{get:function(){return this._scale},set:function(t){this._scale.equal(t)||(this._scale.copy(t),this.invalidTransform())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"scaleX",{get:function(){return this._scale.x},set:function(t){this._scale.x!=t&&(this._scale.x=t,this.invalidTransform())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"scaleY",{get:function(){return this._scale.y},set:function(t){this._scale.y!=t&&(this._scale.y=t,this.invalidTransform())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"scaleZ",{get:function(){return this._scale.z},set:function(t){this._scale.z!=t&&(this._scale.z=t,this.invalidTransform())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"orientation",{get:function(){return this._orientation},set:function(t){this._orientation.equal(t)||(this._orientation.copy(t),this.invalidTransform())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"orientationX",{get:function(){return this._orientation.x},set:function(t){this._orientation.x!=t&&(this._orientation.x=t,this.invalidTransform())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"orientationY",{get:function(){return this._orientation.y},set:function(t){this._orientation.y!=t&&(this._orientation.y=t,this.invalidTransform())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"orientationZ",{get:function(){return this._orientation.z},set:function(t){this._orientation.z!=t&&(this._orientation.z=t,this.invalidTransform())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"orientationW",{get:function(){return this._orientation.w},set:function(t){this._orientation.w!=t&&(this._orientation.w=t,this.invalidTransform())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"globalPosition",{get:function(){return this.validateTransformNow(),this._globalPosition},set:function(t){if(this._parent){var e=dou.recyclable(n.Quaternion);e.inverse(this._parent.globalOrientation);var r=dou.recyclable(n.Vector3);r.subtract(this._parent._globalPosition,t),e.transformVector(r,r),r.divide(this._parent._globalScale),this._position.copy(r),e.recycle(),r.recycle(),this.invalidTransform()}else this._position.copy(t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"globalRotation",{get:function(){return this.validateTransformNow(),this._globalRotation},set:function(t){var e=dou.recyclable(n.Quaternion);e.fromEuler(t.x,t.y,t.z),this._globalOrientation.copy(e),e.recycle(),this.invalidTransform()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"globalScale",{get:function(){return this.validateTransformNow(),this._globalScale},set:function(t){if(this._parent){var e=dou.recyclable(n.Vector3);e.divide(t,this._parent._globalScale),this._scale.copy(e),e.recycle(),this.invalidTransform()}else this._scale.copy(t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"globalOrientation",{get:function(){return this.validateTransformNow(),this._globalOrientation},set:function(t){if(this._parent){var e=dou.recyclable(n.Quaternion);e.inverse(this._parent.globalOrientation),e.multiply(e,t),this._orientation.copy(e),e.recycle(),this.invalidTransform()}else this._orientation.copy(t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"globalMatrix",{get:function(){return this.validateTransformNow(),this._globalMatrix},set:function(t){t.decompose(this._globalPosition,this._globalOrientation,this._globalScale),this.invalidTransform()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"visible",{get:function(){return this._visible},set:function(t){this._visible=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"parent",{get:function(){return this._parent},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"name",{get:function(){return this._name},set:function(t){this._name=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"layer",{get:function(){return this._layer},set:function(t){this._layer=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"controller",{get:function(){return this._controller},set:function(t){this._controller=t},enumerable:!0,configurable:!0}),t.prototype.setParent=function(t){this._parent=t},t.prototype.invalidTransform=function(){this.invalidGlobalTransform()},t.prototype.invalidGlobalTransform=function(){this._globalTransformChanged=!0},t.prototype.validateTransformNow=function(){this.updateGlobalTransform()},t.prototype.updateGlobalTransform=function(){this._globalTransformChanged&&(this._parent?(this._globalOrientation.multiply(this._parent.globalOrientation,this._orientation),this._globalOrientation.toEuler(this._globalRotation),this._globalScale.multiply(this._parent.globalScale,this._scale),this._globalPosition.multiply(this._parent.globalScale,this._position),this._parent.globalOrientation.transformVector(this._globalPosition,this._globalPosition),this._globalPosition.add(this._parent.globalPosition,this._globalPosition)):(this._globalOrientation.copy(this._orientation),this._globalPosition.copy(this._position),this._globalScale.copy(this._scale),this._globalRotation.copy(this._rotation)),this._globalTransformChanged=!1,this.markTransform(),this.onTransformUpdate())},t.prototype.markTransform=function(){this._globalMatrix.compose(this._globalPosition,this._globalOrientation,this._globalScale)},t.prototype.onTransformUpdate=function(){},t.prototype.lookAt=function(t,e,r){void 0===r&&(r=n.Vector3.UP),this.globalPosition=t;var i=dou.recyclable(n.Matrix4);i.lookAt(t,e,r),i.inverse();var a=dou.recyclable(n.Quaternion);i.decompose(null,a),this.globalOrientation=a,i.recycle(),a.recycle()},t.prototype.lookAtTarget=function(t){var e=dou.recyclable(n.Vector4);t.globalMatrix.transformVector(n.Vector3.UP,e);var r=dou.recyclable(n.Matrix4);r.lookAt(this._globalPosition,this._globalPosition,e),r.inverse();var i=dou.recyclable(n.Quaternion);r.decompose(null,i),this.globalOrientation=i,e.recycle(),r.recycle(),i.recycle()},t.prototype.localToGlobal=function(t,e){return e=e||dou.recyclable(n.Vector4),this._parent?this.globalMatrix.transformVector(t,e):(e.x=t.x,e.y=t.y,e.z=t.z),e},t.prototype.globalToLocal=function(t,e){if(e=e||dou.recyclable(n.Vector4),this._parent){var r=dou.recyclable(n.Matrix4);r.copy(this.globalMatrix),r.inverse(),r.transformVector(t,e),r.recycle()}else e.x=t.x,e.y=t.y,e.z=t.z;return e},t.prototype.update=function(t,e,r){this._controller&&this._controller.autoUpdate&&this._controller.update(t,e)},t.prototype.dispose=function(){this._controller=null},t}(dou.EventDispatcher);n.Object3D=t}(dou3d||(dou3d={})),function(t){var e=function(i){function t(){var t=null!==i&&i.apply(this,arguments)||this;return t._materialCount=0,t._order=0,t.multiMaterial={},t.type="",t}return __extends(t,i),Object.defineProperty(t.prototype,"order",{get:function(){return this._order},set:function(t){this._order=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"geometry",{get:function(){return this._geometry},set:function(t){this._geometry!=t&&(t&&t.incRef(),this._geometry&&this._geometry.dispose(),this._geometry=t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"lightGroup",{get:function(){return this._lightGroup},set:function(t){for(var e in this._lightGroup=t,this.multiMaterial)this.multiMaterial[e].lightGroup=this._lightGroup},enumerable:!0,configurable:!0}),t.prototype.addSubMaterial=function(t,e){this.multiMaterial[t]||this._materialCount++,(this.multiMaterial[t]=e).lightGroup=this._lightGroup},t.prototype.removeSubMaterial=function(t){this.multiMaterial[t]&&(delete this.multiMaterial[t],this._materialCount--)},t.prototype.getMaterial=function(t){return this.multiMaterial[t]},t.prototype.materialCount=function(){return this._materialCount},t.prototype.update=function(t,e,r){i.prototype.update.call(this,t,e,r),this.animation&&this.animation.update(t,e,this._geometry),this.geometry.subGeometrys.length<=0&&this.geometry.buildDefaultSubGeometry()},t.prototype.dispose=function(){this.geometry=null,this.multiMaterial={}},t}(t.Object3D);t.RenderBase=e}(dou3d||(dou3d={})),function(t){var e=function(r){function t(){var t=r.call(this)||this;return t._children=[],t}return __extends(t,r),Object.defineProperty(t.prototype,"children",{get:function(){return this._children},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"numChildren",{get:function(){return this._children.length},enumerable:!0,configurable:!0}),t.prototype.invalidGlobalTransform=function(){r.prototype.invalidGlobalTransform.call(this);for(var t=0,e=this._children;t<e.length;t++){e[t].invalidTransform()}},t.prototype.addChild=function(t){return-1!=this._children.indexOf(t)||(t.parent&&t.parent.removeChild(t),t.setParent(this),t.invalidTransform(),this._children.push(t)),t},t.prototype.getChildAt=function(t){return this._children[t]},t.prototype.getChildIndex=function(t){return this._children.indexOf(t)},t.prototype.removeChild=function(t){var e=this._children.indexOf(t);return-1==e||(this._children.splice(e,1),t.setParent(null),t.invalidTransform()),t},t.prototype.removeChildAt=function(t){if(t<0||t>=this._children.length)return null;var e=this._children[t];return this._children.splice(t,1),e.setParent(null),e.invalidTransform(),e},t.prototype.removeAllChildren=function(){for(;0<this._children.length;)this.removeChildAt(0)},t.prototype.dispose=function(){r.prototype.dispose.call(this);for(var t=0,e=this._children;t<e.length;t++){e[t].dispose()}this.removeAllChildren()},t}(t.Object3D);t.ObjectContainer3D=e}(dou3d||(dou3d={})),function(n){var t=function(a){function e(t,e,r){var i=a.call(this)||this;return i.type="mesh",i.geometry=t,i.material=e||new n.TextureMaterial,i.addSubMaterial(0,i.material),r?i.animation=r:t&&64&i.geometry.vertexFormat&&(i.animation=new n.SkeletonAnimation),i}return __extends(e,a),e.prototype.clone=function(){var t=new e(this.geometry,this.material,this.animation?this.animation.clone():null);return t.multiMaterial=this.multiMaterial,t},e}(n.RenderBase);n.Mesh=t}(dou3d||(dou3d={})),function(o){var t=function(n){function e(t,e,r,i){void 0===r&&(r=100),void 0===i&&(i=100);var a=this;return e||(e=new o.PlaneGeometry(r,i,1,1,1,1)),(a=n.call(this,e,t)||this)._plane=a.geometry,a}return __extends(e,n),e.prototype.update=function(t,e,r){n.prototype.update.call(this,t,e,r);var i=dou.recyclable(o.Vector3);r.globalOrientation.toEuler(i);var a=dou.recyclable(o.Quaternion);a.fromEuler(i.x+o.MathUtil.toRadians(270),i.y,i.z),this.globalOrientation=a,i.recycle(),a.recycle()},e.prototype.clone=function(){var t=new e(this.material,this.geometry,this._plane.width,this._plane.height);return t.multiMaterial=this.multiMaterial,t},e}(o.Mesh);o.Billboard=t}(dou3d||(dou3d={})),function(i){var t=function(r){function t(t){void 0===t&&(t=8289918);var e=r.call(this)||this;return e.type="wireframe",e.geometry=new i.Geometry,e.material=new i.ColorMaterial(t),e.addSubMaterial(0,e.material),e.material.drawMode=i.Context3DProxy.gl.LINES,e.geometry.vertexFormat=27,e}return __extends(t,r),t.prototype.fromVertexs=function(t,e){if(void 0===e&&(e=1),t){this.geometry.setVerticesForIndex(0,e,t,t.length/i.GeometryUtil.fromVertexFormatToLength(e)),this.geometry.indexCount=2*(this.geometry.vertexCount-1);for(var r=0;r<this.geometry.vertexCount-1;++r)this.geometry.indexArray[2*r+0]=r,this.geometry.indexArray[2*r+1]=r+1}},t.prototype.fromVertexsEx=function(t,e){if(void 0===e&&(e=1),t){this.geometry.setVerticesForIndex(0,e,t,t.length/i.GeometryUtil.fromVertexFormatToLength(e)),this.geometry.indexCount=this.geometry.vertexCount;for(var r=0;r<this.geometry.vertexCount;++r)this.geometry.indexArray[r]=r}},t.prototype.fromGeometry=function(t){var e=[];t.getVertexForIndex(0,9,e,t.vertexCount),this.geometry.setVerticesForIndex(0,9,e,t.vertexCount),this.geometry.indexCount=6*t.faceCount;for(var r=0;r<t.faceCount;++r){var i=t.indexArray[3*r+0],a=t.indexArray[3*r+1],n=t.indexArray[3*r+2];this.geometry.indexArray[6*r+0]=i,this.geometry.indexArray[6*r+1]=a,this.geometry.indexArray[6*r+2]=a,this.geometry.indexArray[6*r+3]=n,this.geometry.indexArray[6*r+4]=n,this.geometry.indexArray[6*r+5]=i}},t}(i.RenderBase);i.Wireframe=t}(dou3d||(dou3d={})),function(n){var t=function(a){function t(t,e,r){var i=a.call(this,t,e)||this;return i.camera=r,e.cullMode=n.Context3DProxy.gl.FRONT,i}return __extends(t,a),t.prototype.update=function(t,e,r){a.prototype.update.call(this,t,e,r),this.camera&&(this.position=this.camera.globalPosition)},t}(n.Mesh);n.SkyBox=t}(dou3d||(dou3d={})),function(t){var e=function(){function t(){this._renderList=[]}return Object.defineProperty(t.prototype,"renderList",{get:function(){return this._renderList},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"scene",{get:function(){return this._scene},set:function(t){this._scene=t},enumerable:!0,configurable:!0}),t.prototype.findRenderObject=function(t){for(var e=0;e<this._renderList.length;++e)if(this._renderList[e]===t)return e;return-1},t.prototype.update=function(t){t.validateTransformNow(),this._renderList.length=0},t}();t.CollectBase=e}(dou3d||(dou3d={})),function(n){var t=function(a){function t(){var t=null!==a&&a.apply(this,arguments)||this;return t.layerMap={},t}return __extends(t,a),t.prototype.update=function(t){a.prototype.update.call(this,t),this.clearLayerList(),this.applyRender(this._scene.root,t);for(var e=0;e<2;e++){this.layerMap[e].sort(this.sortByOrder);for(var r=this.layerMap[e].length,i=0;i<r;i++)this._renderList.push(this.layerMap[e][i])}},t.prototype.clearLayerList=function(){for(var t=0;t<2;t++)this.layerMap[t]?this.layerMap[t].length=0:this.layerMap[t]=[]},t.prototype.applyRender=function(t,e){if(t.visible)if(t instanceof n.ObjectContainer3D)for(var r=0;r<t.children.length;r++)this.applyRender(t.children[r],e);else t instanceof n.RenderBase&&t.material&&this.addRenderList(t,e)},t.prototype.addRenderList=function(t,e,r){if(void 0===r&&(r=!0),t.material)if(0==t.layer&&t.material.materialData.alphaBlending)this.layerMap[1].push(t);else for(var i=0;i<2;i++)t.layer==i&&this.layerMap[i].push(t)},t.prototype.sort=function(t,e,r){var i=n.Vector3.getDistance(t.globalPosition,r.position),a=n.Vector3.getDistance(e.globalPosition,r.position);return a<i?-1:i<a?1:0},t.prototype.sortByOrder=function(t,e){return e.order-t.order},t}(n.CollectBase);n.EntityCollect=t}(dou3d||(dou3d={})),function(a){var t=function(r){function t(t){var e=r.call(this)||this;return e._deltaTime=0,e._engine=t,a.Engine.context3DProxy.enableBlend(),a.Engine.context3DProxy.enableCullFace(),a.Context3DProxy.gl.enable(a.Context3DProxy.gl.SCISSOR_TEST),a.Context3DProxy.gl.enableVertexAttribArray(0),a.Context3DProxy.gl.enableVertexAttribArray(1),a.Context3DProxy.gl.enableVertexAttribArray(2),a.Context3DProxy.gl.enableVertexAttribArray(3),a.Context3DProxy.gl.enableVertexAttribArray(4),a.Context3DProxy.gl.enableVertexAttribArray(5),a.Context3DProxy.gl.enableVertexAttribArray(6),a.ShaderUtil.load(),a.ShaderPool.register(a.Engine.context3DProxy),e}return __extends(t,r),Object.defineProperty(t.prototype,"deltaTime",{get:function(){return this._deltaTime},enumerable:!0,configurable:!0}),t.prototype.updateLogic=function(t){this._deltaTime=t,dou.Tween.tick(t,!1);var e=this._engine.viewRect,r=this._engine.view3Ds;a.Context3DProxy.canvasRectangle=e,a.Engine.context3DProxy.viewPort(0,0,e.w,e.h),a.Engine.context3DProxy.setScissorRectangle(0,0,e.w,e.h);for(var i=0;i<r.length;i++)r[i].update(dou.getTimer(),t);a.Context3DProxy.gl.flush()},t}(dou.TickerBase);a.Ticker=t}(dou3d||(dou3d={})),function(s){var t=function(o){function t(t,e,r,i,a){var n=o.call(this)||this;return n._cleanParmerts=s.Context3DProxy.gl.COLOR_BUFFER_BIT|s.Context3DProxy.gl.DEPTH_BUFFER_BIT,n._viewPort=new s.Rectangle,n._camera=a||new s.Camera3D(0),n._camera.name="MainCamera",n._scene=new s.Scene3D,n._scene.root.addChild(n._camera),n._render=new s.MultiRenderer(0),n._entityCollect=new s.EntityCollect,n._entityCollect.scene=n._scene,n._backColor=new s.Vector4(.3,.3,.6,1),n.x=t,n.y=e,n.width=r,n.height=i,n._camera.aspectRatio=n._viewPort.w/n._viewPort.h,n._camera.updateViewport(n._viewPort.x,n._viewPort.y,n._viewPort.w,n._viewPort.h),n}return __extends(t,o),Object.defineProperty(t.prototype,"x",{get:function(){return this._viewPort.x},set:function(t){this._viewPort.x=t,this._camera.updateViewport(this._viewPort.x,this._viewPort.y,this._viewPort.w,this._viewPort.h)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return this._viewPort.y},set:function(t){this._viewPort.y=t,this._camera.updateViewport(this._viewPort.x,this._viewPort.y,this._viewPort.w,this._viewPort.h)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"width",{get:function(){return this._viewPort.w},set:function(t){this._viewPort.w=t,this._camera.aspectRatio=this._viewPort.w/this._viewPort.h,this._camera.updateViewport(this._viewPort.x,this._viewPort.y,this._viewPort.w,this._viewPort.h)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return this._viewPort.h},set:function(t){this._viewPort.h=t,this._camera.aspectRatio=this._viewPort.w/this._viewPort.h,this._camera.updateViewport(this._viewPort.x,this._viewPort.y,this._viewPort.w,this._viewPort.h)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"viewPort",{get:function(){return this._viewPort},enumerable:!0,configurable:!0}),t.prototype.inView3D=function(t,e){var r=dou.recyclable(s.Vector2);r.set(t,e);var i=this._viewPort.contains(r);return r.recycle(),i},t.prototype.blender=function(t,e){this._cleanParmerts=(t?s.Context3DProxy.gl.COLOR_BUFFER_BIT:0)|(e?s.Context3DProxy.gl.DEPTH_BUFFER_BIT:0)},Object.defineProperty(t.prototype,"backColor",{get:function(){return 255*this._backColor.w<<24|255*this._backColor.x<<16|255*this._backColor.y<<8|255*this._backColor.z},set:function(t){this._backColor.w=(t>>24&255)/255,this._backColor.x=(t>>16&255)/255,this._backColor.y=(t>>8&255)/255,this._backColor.z=(255&t)/255},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"scene",{get:function(){return this._scene},set:function(t){this._scene=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"camera3D",{get:function(){return this._camera},set:function(t){this._camera=t,this._camera.aspectRatio=this._viewPort.w/this._viewPort.h,this._camera.updateViewport(this._viewPort.x,this._viewPort.y,this._viewPort.w,this._viewPort.h)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"entityCollect",{get:function(){return this._entityCollect},enumerable:!0,configurable:!0}),t.prototype.update=function(t,e){this._camera.viewPort=this._viewPort,this.updateObject3D(this._scene.root,t,e),s.Engine.context3DProxy.viewPort(this._viewPort.x,this._viewPort.y,this._viewPort.w,this._viewPort.h),s.Engine.context3DProxy.setScissorRectangle(this._viewPort.x,this._viewPort.y,this._viewPort.w,this._viewPort.h),this._entityCollect.update(this._camera),s.ShadowCast.instance.enableShadow&&s.ShadowCast.instance.update(this._entityCollect,this._camera,t,e,this._viewPort),this._cleanParmerts&s.Context3DProxy.gl.COLOR_BUFFER_BIT&&s.Engine.context3DProxy.clearColor(this._backColor.x,this._backColor.y,this._backColor.z,this._backColor.w),s.Engine.context3DProxy.clear(this._cleanParmerts),this._render.draw(t,e,s.Engine.context3DProxy,this._entityCollect,this._camera,this._viewPort)},t.prototype.updateObject3D=function(t,e,r){if(t){if(t.dispatch(s.Event3D.ENTER_FRAME),t.update(e,r,this.camera3D),t instanceof s.ObjectContainer3D)for(var i=0;i<t.children.length;++i)this.updateObject3D(t.children[i],e,r);t.dispatch(s.Event3D.EXIT_FRAME)}},t}(dou.EventDispatcher);s.View3D=t}(dou3d||(dou3d={})),function(a){var t=function(){function e(t){this.name=t,this.parentIndex=-1,this.scale=new a.Vector3(1,1,1),this.orientation=new a.Quaternion,this.translation=new a.Vector3,this.localMatrix=new a.Matrix4,this.worldMatrix=new a.Matrix4,this.worldMatrixValid=!1}return e.prototype.buildLocalMatrix=function(t,e,r){this.scale.copy(t),this.translation.copy(r),e instanceof a.Vector3?this.orientation.fromEuler(e.x*a.MathUtil.DEG_RAD,e.y*a.MathUtil.DEG_RAD,e.z*a.MathUtil.DEG_RAD,6):this.orientation.copy(e),this.localMatrix.compose(this.translation,this.orientation,this.scale),this.worldMatrixValid=!1},e.prototype.buildInverseMatrix=function(t,e,r){if(this.inverseMatrix=this.inverseMatrix||new a.Matrix4,e instanceof a.Vector3){var i=dou.recyclable(a.Quaternion);i.fromEuler(e.x*a.MathUtil.DEG_RAD,e.y*a.MathUtil.DEG_RAD,e.z*a.MathUtil.DEG_RAD,6),this.inverseMatrix.compose(r,i,t),i.recycle()}else this.inverseMatrix.compose(r,e,t)},e.prototype.clone=function(){var t=new e(this.name);return t.parent=this.parent,t.parentIndex=this.parentIndex,t.scale.copy(this.scale),t.orientation.copy(this.orientation),t.translation.copy(this.translation),t.localMatrix.copy(this.localMatrix),t.worldMatrix.copy(this.worldMatrix),t.worldMatrixValid=this.worldMatrixValid,t},e}();a.Joint=t}(dou3d||(dou3d={})),function(t){var e=function(){function r(){this.joints=[]}return Object.defineProperty(r.prototype,"jointNum",{get:function(){return this.joints.length},enumerable:!0,configurable:!0}),r.prototype.findJoint=function(t){for(var e=0;e<this.joints.length;e++)if(this.joints[e].name==t)return this.joints[e];return null},r.prototype.findJointIndex=function(t){for(var e=0;e<this.joints.length;e++)if(this.joints[e].name==t)return e;return-1},r.prototype.clone=function(){for(var t=new r,e=0;e<this.joints.length;e++)t.joints.push(this.joints[e].clone());return t},r}();t.Skeleton=e}(dou3d||(dou3d={})),function(l){var t=function(e){function u(){var t=e.call(this)||this;return t.speed=1,t.isLoop=!0,t._isPlay=!1,t._animTime=0,t._animStateNames=[],t._animStates=[],t._blendSpeed=0,t._blendSkeleton=null,t._blendList=[],t._bindList={},t._changeFrameTime=0,t._oldFrameIndex=0,t._movePosIndex=-1,t._movePosObject3D=null,t._movePosition=new l.Vector3,t._resetMovePos=!0,t._currentSkeletonPose=null,t._oldTime=0,t._isPlay=!1,t}return __extends(u,e),Object.defineProperty(u.prototype,"jointNum",{get:function(){return 48},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"animStateNames",{get:function(){return this._animStateNames},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"animStates",{get:function(){return this._animStates},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"animTime",{get:function(){return this._animTime},set:function(t){if(!(this._blendList.length<=0)&&this._blendList[this._blendList.length-1].timePosition!=t){var e=t-this._animTime;if(this._blendSpeed<=0)1<this._blendList.length&&this._blendList.splice(0,this._blendList.length-1),this._blendList[0].weight=1,this._blendList[0].timePosition+=e;else{for(var r=Math.abs(e/this._blendSpeed),i=0;i<this._blendList.length;++i){var a=this._blendList[i];if(i!=this._blendList.length-1){if(a.weight=Math.max(0,a.weight-r),a.weight<=0){this._blendList.splice(i,1),--i;continue}}else a.weight=Math.min(1,a.weight+r)}this._blendList[this._blendList.length-1].timePosition+=e}this._animTime=this._blendList[this._blendList.length-1].timePosition;var n=this._blendList[0].currentSkeletonPose;if(this._blendList.length<=1)this._blendSkeleton||(this._blendSkeleton=n.clone()),this.updateBindList(n),this.updateMovePos(n),this._currentSkeletonPose=n;else{var o=this._blendList[1],s=o.currentSkeletonPose;this._blendSkeleton||(this._blendSkeleton=n.clone()),this._blendSkeleton.lerp(n,s,o.weight),this._blendSkeleton.resetWorldMatrix(),this._blendSkeleton.calculateJointWorldMatrix(),this.updateBindList(this._blendSkeleton),this.updateMovePos(this._blendSkeleton),this._currentSkeletonPose=this._blendSkeleton}}},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"timeLength",{get:function(){return this._blendList.length<=0?0:this._blendList[this._blendList.length-1].timeLength},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"frameIndex",{get:function(){return this.animTime/u.fps},set:function(t){this.animTime=t*u.fps},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"blendSpeed",{get:function(){return this._blendSpeed},set:function(t){this._blendSpeed=Math.max(t,0)},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"currentAnimName",{get:function(){return this._currentAnimName},enumerable:!0,configurable:!0}),u.prototype.isPlay=function(){return this._isPlay},u.prototype.addSkeletonAnimationClip=function(t){var e=new l.SkeletonAnimationState(t.animationName);e.skeletonAnimation=this,e.addAnimationClip(t),this.addAnimState(e)},u.prototype.addAnimState=function(t){for(var e=0;e<this._animStates.length;e++)if(this._animStates[e].name==t.name)return;this._animStates.push(t),this._animStateNames.push(t.name)},u.prototype.removeAnimState=function(t){for(var e=0;e<this._animStates.length;e++)if(this._animStates[e].name==t.name)return this._animStates.slice(e,1),void this._animStateNames.slice(e,1)},u.prototype.play=function(t,e,r,i){if(void 0===e&&(e=1),void 0===r&&(r=!0),void 0===i&&(i=!0),!(this._animStates.length<=0)){var a;t||(t=this._animStates[0].name);for(var n=0;n<this._animStates.length;n++)if(this._animStates[n].name==t){a=this._animStates[n];break}if(a&&(this._currentAnimName=t,this._blendList.push(a),this._blendSpeed<=0&&1<this._blendList.length&&this._blendList.splice(0,this._blendList.length-1),a.weight=1<this._blendList.length?0:1,r&&(this._animTime=a.timePosition=0),this._changeFrameTime=a.timePosition,this._oldFrameIndex=Math.floor(this._changeFrameTime/u.fps),this.speed=e,this._isPlay=!0,this._resetMovePos=!0,-1!=this._movePosIndex)){var o=dou.recyclable(l.Vector3);a.getSkeletonPose(0).joints[this._movePosIndex].worldMatrix.decompose(o),this._movePosition.copy(o),o.recycle()}}},u.prototype.pause=function(){this._isPlay=!1},u.prototype.stop=function(){this._isPlay=!1},u.prototype.update=function(t,e,r){if(this._oldTime!=t&&(this._oldTime=t,this._isPlay&&!(this._blendList.length<=0))){var i=this._blendList[this._blendList.length-1],a=e*this.speed;this._changeFrameTime+=a;for(var n=Math.floor(Math.abs(this._changeFrameTime/u.fps)),o=this.currentAnimName,s=0,h=0;h<n;++h){if(a<0?(s=(this._oldFrameIndex-1-h)%i.frameNum)<0&&(s+=i.frameNum):s=(this._oldFrameIndex+1+h)%i.frameNum,this.dispatch(l.Event3D.ENTER_FRAME,s),this.currentAnimName!=o){s=Math.floor(this._changeFrameTime/u.fps);break}this._changeFrameTime+=0<a?-u.fps:u.fps}this._oldFrameIndex=s,this.animTime+=e*this.speed}},u.prototype.activeState=function(t,e,r,i,a,n,o){this._currentSkeletonPose&&this._currentSkeletonPose.updateGPUCacheData(i.geometry.skeleton,i.geometry.skeletonGPUData,this._movePosition),r.uniform_time&&a.uniform1f(r.uniform_time.uniformIndex,this.animTime),a.uniform4fv(r.uniform_PoseMatrix.uniformIndex,i.geometry.skeletonGPUData)},u.prototype.bindToJointPose=function(t,e){var r,i=this._animStates[0].skeletonAnimationClip.findJointIndex(t);return!(i<0)&&(this._bindList[i]?r=this._bindList[i]:(r=[],this._bindList[i]=r),r.push(e),!0)},u.prototype.setMovePosJointName=function(t,e){var r=this._animStates[0].skeletonAnimationClip.findJointIndex(t);return!(r<0)&&(this._movePosIndex=r,this._movePosObject3D=e,this._resetMovePos=!0)},u.prototype.updateBindList=function(t){var e,r,i;for(var a in this._bindList)if(!((e=this._bindList[a]).length<=0)&&(r=t.joints[a]))for(var n=0;n<e.length;n++){i=e[n];var o=dou.recyclable(l.Vector3),s=dou.recyclable(l.Quaternion);r.worldMatrix.decompose(o,s),i.orientation=s,i.x=o.x-this._movePosition.x,i.y=o.y-this._movePosition.y,i.z=o.z-this._movePosition.z,o.recycle(),s.recycle()}},u.prototype.updateMovePos=function(t){var e;if(-1!=this._movePosIndex){e=t.joints[this._movePosIndex];var r=dou.recyclable(l.Vector3);e.worldMatrix.decompose(r),this._movePosObject3D&&(this._movePosition.x=r.x-this._movePosition.x,this._movePosition.y=r.y-this._movePosition.y,this._movePosition.z=r.z-this._movePosition.z,this._movePosObject3D.orientation.transformVector(this._movePosition,this._movePosition),this._movePosObject3D.x+=this._movePosition.x,this._movePosObject3D.y+=this._movePosition.y,this._movePosObject3D.z+=this._movePosition.z,this._resetMovePos&&(this._resetMovePos=!1,this._movePosObject3D.x-=this._movePosition.x,this._movePosObject3D.y+=this._movePosition.y,this._movePosObject3D.z-=this._movePosition.z)),this._movePosition.copy(r),r.recycle()}},u.prototype.clone=function(){var t=new u;t._blendSpeed=this._blendSpeed,t.isLoop=this.isLoop,t._animStateNames=this._animStateNames.concat([]);for(var e=0;e<this._animStates.length;e++)t._animStates.push(this._animStates[e].clone());return t},u.fps=1e3/60,u}(dou.EventDispatcher);l.SkeletonAnimation=t}(dou3d||(dou3d={})),function(o){var t=function(){function e(){this.animationName="",this.sampling=0,this.boneCount=0,this.frameDataOffset=0,this._frameCount=0,this._timeLength=0,this.poseArray=[]}return Object.defineProperty(e.prototype,"currentSkeletonPose",{get:function(){return this._skeletonPose},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"frameCount",{get:function(){return 0<this.poseArray.length?this.poseArray.length:this._frameCount},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"timeLength",{get:function(){return 0<this.poseArray.length?this.poseArray[this.poseArray.length-1].frameTime:this._timeLength},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"jointNum",{get:function(){return 0<this.poseArray.length?this.poseArray[0].joints.length:this.boneCount},enumerable:!0,configurable:!0}),e.prototype.findJointIndex=function(t){return this._skeletonPose?this._skeletonPose.findJointIndex(t):this.poseArray.length<=0?-1:this.poseArray[0].findJointIndex(t)},e.prototype.addSkeletonPose=function(t){this.poseArray.push(t)},e.prototype.buildInitialSkeleton=function(t,e,r){if(!this._skeletonPose){this._frameCount=r,this._skeletonPose=new o.SkeletonPose;for(var i=0;i<this.boneCount;i++){var a=new o.Joint(t[i]);a.parent=e[i],a.parentIndex=this._skeletonPose.findJointIndex(a.parent),this._skeletonPose.joints.push(a)}this.sourceData.position=this.frameDataOffset+(40*this.boneCount+4)*(this.frameCount-1),this._timeLength=this.sourceData.readInt()/60/80*1e3}},e.prototype.getSkeletonPose=function(t){return 0<this.poseArray.length?this.poseArray[t]:t<0||t>=2*this.frameCount?null:(t=Math.floor(t/2),this.readSkeletonPose(t,this._skeletonPose))},e.prototype.readSkeletonPose=function(t,e){this.sourceData.position=this.frameDataOffset+(40*this.boneCount+4)*t,e.frameTime=this.sourceData.readInt()/60/80*1e3;for(var r=0;r<this.boneCount;r++){var i=dou.recyclable(o.Quaternion);i.x=this.sourceData.readFloat(),i.y=this.sourceData.readFloat(),i.z=this.sourceData.readFloat(),i.w=this.sourceData.readFloat();var a=dou.recyclable(o.Vector3);a.x=this.sourceData.readFloat(),a.y=this.sourceData.readFloat(),a.z=this.sourceData.readFloat();var n=dou.recyclable(o.Vector3);n.x=this.sourceData.readFloat(),n.y=this.sourceData.readFloat(),n.z=this.sourceData.readFloat(),e.joints[r].worldMatrixValid=!1,e.joints[r].buildLocalMatrix(a,i,n),i.recycle(),a.recycle(),n.recycle()}return e.calculateJointWorldMatrix(),e},e.prototype.clone=function(){var t=new e;return t.animationName=this.animationName,t.poseArray=this.poseArray,t.sampling=this.sampling,t.boneCount=this.boneCount,t._frameCount=this._frameCount,t.frameDataOffset=this.frameDataOffset,t.sourceData=this.sourceData,t._timeLength=this._timeLength,t._skeletonPose=this._skeletonPose,this._skeletonPose&&(t._skeletonPose=this._skeletonPose.clone()),t},e}();o.SkeletonAnimationClip=t}(dou3d||(dou3d={})),function(s){var t=function(){function e(t){this.name="",this.weight=1,this._timeLength=0,this._timePosition=0,this._skeletonAnimation=null,this._skeletonAnimationClip=null,this.name=t}return Object.defineProperty(e.prototype,"skeletonAnimation",{get:function(){return this._skeletonAnimation},set:function(t){this._skeletonAnimation=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"skeletonAnimationClip",{get:function(){return this._skeletonAnimationClip},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"timeLength",{get:function(){return this._timeLength},enumerable:!0,configurable:!0}),e.prototype.addAnimationClip=function(t){if(t.sourceData)this._skeletonAnimationClip=t,this._timeLength=this._skeletonAnimationClip.timeLength;else{if(this._skeletonAnimationClip?this._skeletonAnimationClip.poseArray=[]:this._skeletonAnimationClip=new s.SkeletonAnimationClip,t.poseArray.length<2)this._skeletonAnimationClip.poseArray=t.poseArray;else{var e=t.poseArray[0],r=t.poseArray[1],i=Math.round((r.frameTime-e.frameTime)/s.SkeletonAnimation.fps);if(i<=1)this._skeletonAnimationClip.poseArray=t.poseArray;else{for(var a=1;a<t.poseArray.length;++a){e=t.poseArray[a-1],r=t.poseArray[a];for(var n=0;n<i;n++){var o=new s.SkeletonPose;o.lerp(e,r,n/i),this._skeletonAnimationClip.poseArray.push(o)}}this._skeletonAnimationClip.poseArray.push(t.poseArray[t.poseArray.length-1].clone())}}this._timeLength=this._skeletonAnimationClip.poseArray[this._skeletonAnimationClip.poseArray.length-1].frameTime}},Object.defineProperty(e.prototype,"timePosition",{get:function(){return this._timePosition},set:function(t){t!=this._timePosition&&(this._timePosition=t,this._skeletonAnimation.isLoop?(this._timePosition=t%this._timeLength,this._timePosition<0&&(this._timePosition+=this._timeLength)):this._timePosition<0?(this._timePosition=0,this.name==this._skeletonAnimation.currentAnimName&&(this._skeletonAnimation.stop(),this._skeletonAnimation.dispatch(dou.Event.COMPLETE))):this._timePosition>this._timeLength&&(this._timePosition=this._timeLength,this.name==this._skeletonAnimation.currentAnimName&&(this._skeletonAnimation.stop(),this._skeletonAnimation.dispatch(dou.Event.COMPLETE))))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"currentSkeletonPose",{get:function(){return this._skeletonAnimationClip.getSkeletonPose(this.currentFrameIndex)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"previousSkeletonPose",{get:function(){var t=this.currentFrameIndex;return 0<this._skeletonAnimation.speed?--t<0&&(t=this.frameNum-t):t=(t+1)%this.frameNum,this._skeletonAnimationClip.getSkeletonPose(t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"currentFrameIndex",{get:function(){return Math.floor(this._timePosition/s.SkeletonAnimation.fps)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"frameNum",{get:function(){return this._skeletonAnimationClip?this._skeletonAnimationClip.frameCount:0},enumerable:!0,configurable:!0}),e.prototype.getSkeletonPose=function(t){return this._skeletonAnimationClip.getSkeletonPose(t)},e.prototype.clone=function(){var t=new e(this.name);return t._timeLength=this._timeLength,t._skeletonAnimation=this._skeletonAnimation,t._skeletonAnimationClip=this._skeletonAnimationClip,t},e}();s.SkeletonAnimationState=t}(dou3d||(dou3d={})),function(_){var t=function(){function r(){this.joints=[]}return r.prototype.lerp=function(t,e,r){if(t.joints.length!=e.joints.length)throw Error("Bone number does not match!");if(this.joints.length<t.joints.length)for(var i=this.joints.length;i<=t.joints.length;++i)this.joints.push(new _.Joint(""));this.frameTime=(e.frameTime-t.frameTime)*r+t.frameTime;for(i=0;i<t.joints.length;++i){var a=t.joints[i],n=e.joints[i],o=this.joints[i];if(o.name=a.name,o.parent=a.parent,o.parentIndex=a.parentIndex,_.Vector3.lerp(a.scale,n.scale,r,o.scale),_.Quaternion.slerp(a.orientation,n.orientation,r,o.orientation),_.Vector3.slerp(a.translation,n.translation,r,o.translation),o.buildLocalMatrix(o.scale,o.orientation,o.translation),o.worldMatrixValid=a.worldMatrixValid,o.worldMatrixValid){var s=dou.recyclable(_.Vector3),h=dou.recyclable(_.Quaternion),u=dou.recyclable(_.Vector3);a.worldMatrix.decompose(s,h,u);var l=dou.recyclable(_.Vector3),c=dou.recyclable(_.Quaternion),d=dou.recyclable(_.Vector3);n.worldMatrix.decompose(l,c,d);var p=dou.recyclable(_.Vector3);_.Vector3.slerp(s,l,r,p);var f=dou.recyclable(_.Quaternion);_.Quaternion.slerp(h,c,r,f);var m=dou.recyclable(_.Vector3);_.Vector3.lerp(u,d,r,m),o.worldMatrix.compose(p,f,m),s.recycle(),h.recycle(),u.recycle(),l.recycle(),c.recycle(),d.recycle(),p.recycle(),f.recycle(),m.recycle()}}return this},r.prototype.calculateJointWorldMatrix=function(){for(var t=0;t<this.joints.length;++t)this.calculateAbsoluteMatrix(t)},r.prototype.calculateAbsoluteMatrix=function(t){var e=this.joints[t];0<=e.parentIndex&&this.calculateAbsoluteMatrix(e.parentIndex),e.worldMatrixValid||(e.worldMatrix.copy(e.localMatrix),0<=e.parentIndex&&e.worldMatrix.append(this.joints[e.parentIndex].worldMatrix),e.worldMatrixValid=!0)},r.prototype.updateGPUCacheData=function(t,e,r){for(var i=0;i<t.joints.length;++i)for(var a=0;a<this.joints.length;++a)if(t.joints[i].name==this.joints[a].name){var n=dou.recyclable(_.Matrix4);n.copy(t.joints[i].inverseMatrix),n.append(this.joints[a].worldMatrix);var o=dou.recyclable(_.Vector3),s=dou.recyclable(_.Quaternion),h=dou.recyclable(_.Vector3);n.decompose(o,s,h),e[8*i+0]=s.x,e[8*i+1]=s.y,e[8*i+2]=s.z,e[8*i+3]=s.w,e[8*i+4]=o.x-r.x,e[8*i+5]=o.y-r.y,e[8*i+6]=o.z-r.z,e[8*i+7]=1,n.recycle(),o.recycle(),s.recycle(),h.recycle();break}return e},r.prototype.findJoint=function(t){for(var e=0;e<this.joints.length;e++)if(this.joints[e].name==t)return this.joints[e];return null},r.prototype.findJointIndex=function(t){for(var e=0;e<this.joints.length;e++)if(this.joints[e].name==t)return e;return-1},r.prototype.resetWorldMatrix=function(){for(var t=0;t<this.joints.length;t++)this.joints[t].worldMatrixValid=!1},r.prototype.clone=function(){var t=new r;t.frameTime=this.frameTime;for(var e=0;e<this.joints.length;e++)t.joints.push(this.joints[e].clone());return t},r}();_.SkeletonPose=t}(dou3d||(dou3d={})),function(o){var t=function(r){function t(t){void 0===t&&(t=0);var e=r.call(this)||this;return e._aspectRatio=1,e._fov=.78,e._near=1,e._far=1e4,e._orthProjectChange=!0,e._projectMatrix=new o.Matrix4,e._orthProjectMatrix=new o.Matrix4,e._viewPort=new o.Rectangle,e._lookAtPosition=new o.Vector3,e._viewMatrix=new o.Matrix4,e._viewMatrix.identity(),e._viewProjectionMatrix=new o.Matrix4,e._viewProjectionMatrix.identity(),e._orthProjectMatrix.orthographicProjectMatrix(0,0,e._viewPort.w,e._viewPort.h,e._near,e._far),e.cameraType=t,e}return __extends(t,r),Object.defineProperty(t.prototype,"projectMatrix",{get:function(){return this._projectMatrix},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"cameraType",{get:function(){return this._cameraType},set:function(t){switch(this._cameraType=t){case 1:this._projectMatrix.orthographicProjectMatrix(0,0,this._viewPort.w,this._viewPort.h,this._near,this._far);break;case 0:this._projectMatrix.fromProjection(this._near,this._far,this._fov,1,1,this._aspectRatio,1)}this._orthProjectMatrix.orthographicProjectMatrix(0,0,this._viewPort.w,this._viewPort.h,this._near,this._far)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"aspectRatio",{get:function(){return this._aspectRatio},set:function(t){this._aspectRatio!=t&&(this._aspectRatio=t,this.cameraType=this._cameraType)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"fieldOfView",{get:function(){return this._fov},set:function(t){this._fov!=t&&(this._fov=t,this.cameraType=this._cameraType)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"near",{get:function(){return this._near},set:function(t){this._near!=t&&(this._near=t,this.cameraType=this._cameraType)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"far",{get:function(){return this._far},set:function(t){this._far!=t&&(this._far=t,this.cameraType=this._cameraType)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"viewPort",{get:function(){return this._viewPort},set:function(t){this._viewPort.copy(t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"viewProjectionMatrix",{get:function(){return this._viewProjectionMatrix.copy(this._viewMatrix),this._viewProjectionMatrix.multiply(this._projectMatrix),this._viewProjectionMatrix},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"orthProjectionMatrix",{get:function(){return this._orthProjectChange&&(this._orthProjectChange=!1,this._orthProjectMatrix.orthographicProjectMatrix(0,0,this._viewPort.w,this._viewPort.h,this._near,this._far)),this._orthProjectMatrix},enumerable:!0,configurable:!0}),t.prototype.updateViewport=function(t,e,r,i){t==this._viewPort.x&&e==this._viewPort.y&&r==this._viewPort.w&&i==this._viewPort.h||(this._orthProjectChange=!0,this._viewPort.x=t,this._viewPort.y=e,this._viewPort.w=r,this._viewPort.h=i)},t.prototype.lookAt=function(t,e,r){void 0===r&&(r=o.Vector3.UP),this.position=t,this._lookAtPosition.copy(e),this._viewMatrix.lookAt(t,e,r);var i=dou.recyclable(o.Quaternion);i.fromMatrix(this._viewMatrix),(this.globalOrientation=i).recycle()},t.prototype.onTransformUpdate=function(){r.prototype.onTransformUpdate.call(this),this._viewMatrix.copy(this._globalMatrix),this._viewMatrix.inverse()},Object.defineProperty(t.prototype,"viewMatrix",{get:function(){return this.validateTransformNow(),this._viewMatrix},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"lookAtPosition",{get:function(){return this._lookAtPosition},enumerable:!0,configurable:!0}),t.prototype.spaceToScreen=function(t,e){e=e||new o.Vector2;var r=.5*this._viewPort.w,i=.5*this._viewPort.h,a=dou.recyclable(o.Vector4);return this.viewMatrix.transformVector(t,a),this.project(a,a),e.x=r+a.x*r,e.y=this._viewPort.h-(i-a.y*i),a.recycle(),e},t.prototype.project=function(t,e){this._projectMatrix.transformVector(t,e),e.x=e.x/e.w,e.y=-e.y/e.w,e.z=t.z},t.prototype.screenToSpace=function(t,e,r){void 0===e&&(e=0),r=r||new o.Vector3;var i=.5*this._viewPort.w,a=.5*this._viewPort.h,n=dou.recyclable(o.Vector4);return n.x=(t.x-i)/i,n.y=(a-(this._viewPort.h-t.y))/a,this.unproject(n.x,n.y,e,n),this._globalMatrix.transformVector(n,n),r.x=n.x,r.y=n.y,r.z=n.z,n.recycle(),r},t.prototype.unproject=function(t,e,r,i){i.x=t,i.y=-e,i.z=r,i.w=1,i.x*=r,i.y*=r;var a=dou.recyclable(o.Matrix4);a.copy(this._projectMatrix),a.inverse(),a.transformVector(i,i),a.recycle(),i.z=r},t.prototype.markTransform=function(){var t=dou.recyclable(o.Vector3);t.set(1,1,1),this._globalMatrix.compose(this._globalPosition,this._globalOrientation,t),t.recycle()},t}(o.Object3D);o.Camera3D=t}(dou3d||(dou3d={})),function(t){var e=function(){function t(t){this._autoUpdate=!0,this.target=t}return Object.defineProperty(t.prototype,"autoUpdate",{get:function(){return this._autoUpdate},set:function(t){this._autoUpdate!=t&&(this._autoUpdate=t,this._target&&(this._target.controller=this._autoUpdate?this:null))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"target",{get:function(){return this._target},set:function(t){this._target!=t&&(this._target&&this._autoUpdate&&(this._target.controller=null),this._target=t,this._target&&this._autoUpdate&&(this._target.controller=this))},enumerable:!0,configurable:!0}),t}();t.ControllerBase=e}(dou3d||(dou3d={})),function(a){var t=function(i){function t(t,e){var r=i.call(this,t)||this;return r._upAxis=a.Vector3.UP,e&&(e instanceof a.Object3D?r.lookAtObject=e:r.lookAtPosition=e),r}return __extends(t,i),Object.defineProperty(t.prototype,"lookAtPosition",{get:function(){return this._lookAtPosition},set:function(t){this._lookAtPosition=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"lookAtObject",{get:function(){return this._lookAtObject},set:function(t){this._lookAtObject=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"upAxis",{get:function(){return this._upAxis},set:function(t){this._upAxis=t},enumerable:!0,configurable:!0}),t.prototype.update=function(t,e){if(this._target)if(this._lookAtPosition)this._target.lookAt(this._target.globalPosition,this._lookAtPosition,this._upAxis);else if(this._lookAtObject)if(this._target.parent===this._lookAtObject.parent)this._target.lookAt(this._target.position,this._lookAtObject.position,this._upAxis);else{var r=dou.recyclable(a.Vector4);this._target.parent.globalToLocal(this._lookAtObject.globalPosition,r);var i=dou.recyclable(a.Vector3);i.set(r.x,r.y,r.z),this._target.lookAt(this._target.position,i,this._upAxis),r.recycle(),i.recycle()}else this._target.lookAt(this._target.globalPosition,a.Vector3.ZERO,this._upAxis)},t}(a.ControllerBase);a.LookAtController=t}(dou3d||(dou3d={})),function(a){var t=function(p){function t(t,e,r,i,a,n,o,s,h,u,l,c){void 0===r&&(r=0),void 0===i&&(i=90),void 0===a&&(a=1e3),void 0===n&&(n=NaN),void 0===o&&(o=NaN),void 0===s&&(s=-90),void 0===h&&(h=90),void 0===u&&(u=8),void 0===l&&(l=2),void 0===c&&(c=!1);var d=p.call(this,t,e)||this;return d._panAngle=0,d._tiltAngle=90,d._distance=1e3,d._minPanAngle=-1/0,d._maxPanAngle=1/0,d._minTiltAngle=-90,d._maxTiltAngle=90,d._steps=8,d._yFactor=2,d._wrapPanAngle=!1,d.distance=a,d.panAngle=r,d.tiltAngle=i,d.minPanAngle=n||-1/0,d.maxPanAngle=o||1/0,d.minTiltAngle=s,d.maxTiltAngle=h,d.steps=u,d.yFactor=l,d.wrapPanAngle=c,d._currentPanAngle=d._panAngle,d._currentTiltAngle=d._tiltAngle,d}return __extends(t,p),Object.defineProperty(t.prototype,"panAngle",{get:function(){return this._panAngle},set:function(t){t=a.MathUtil.clamp(t,this._minPanAngle,this._maxPanAngle),this._panAngle!=t&&(this._panAngle=t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"tiltAngle",{get:function(){return this._tiltAngle},set:function(t){t=a.MathUtil.clamp(t,this._minTiltAngle,this._maxTiltAngle),this._tiltAngle!=t&&(this._tiltAngle=t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"distance",{get:function(){return this._distance},set:function(t){this._distance!=t&&(this._distance=t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"minPanAngle",{get:function(){return this._minPanAngle},set:function(t){this._minPanAngle!=t&&(this._minPanAngle=t,this.panAngle=a.MathUtil.clamp(t,this._minPanAngle,this._maxPanAngle))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"maxPanAngle",{get:function(){return this._maxPanAngle},set:function(t){this._maxPanAngle!=t&&(this._maxPanAngle=t,this.panAngle=a.MathUtil.clamp(t,this._minPanAngle,this._maxPanAngle))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"minTiltAngle",{get:function(){return this._minTiltAngle},set:function(t){this._minTiltAngle!=t&&(this._minTiltAngle=t,this.tiltAngle=a.MathUtil.clamp(t,this._minTiltAngle,this._maxTiltAngle))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"maxTiltAngle",{get:function(){return this._maxTiltAngle},set:function(t){this._maxTiltAngle!=t&&(this._maxTiltAngle=t,this.tiltAngle=a.MathUtil.clamp(t,this._minTiltAngle,this._maxTiltAngle))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"steps",{get:function(){return this._steps},set:function(t){this._steps!=t&&(this._steps=t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"yFactor",{get:function(){return this._yFactor},set:function(t){this._yFactor!=t&&(this._yFactor=t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"wrapPanAngle",{get:function(){return this._wrapPanAngle},set:function(t){this._wrapPanAngle!=t&&(this._wrapPanAngle=t)},enumerable:!0,configurable:!0}),t.prototype.update=function(t,e){if(this._tiltAngle!=this._currentTiltAngle||this._panAngle!=this._currentPanAngle){if(this._wrapPanAngle){for(this._panAngle<0?(this._currentPanAngle+=this._panAngle%360+360-this._panAngle,this._panAngle=this._panAngle%360+360):(this._currentPanAngle+=this._panAngle%360-this._panAngle,this._panAngle=this._panAngle%360);this._panAngle-this._currentPanAngle<-180;)this._currentPanAngle-=360;for(;180<this._panAngle-this._currentPanAngle;)this._currentPanAngle+=360}0<this._steps?(this._currentTiltAngle+=(this._tiltAngle-this._currentTiltAngle)/(this._steps+1),this._currentPanAngle+=(this._panAngle-this._currentPanAngle)/(this._steps+1)):(this._currentPanAngle=this._panAngle,this._currentTiltAngle=this._tiltAngle),Math.abs(this._tiltAngle-this._currentTiltAngle)<.01&&Math.abs(this._panAngle-this._currentPanAngle)<.01&&(this._currentTiltAngle=this._tiltAngle,this._currentPanAngle=this._panAngle)}if(this._target){var r=dou.recyclable(a.Vector3);if(this._lookAtPosition)r.x=this._lookAtPosition.x,r.y=this._lookAtPosition.y,r.z=this._lookAtPosition.z;else if(this._lookAtObject)if(this._target.parent===this._lookAtObject.parent)r.x=this._lookAtObject.x,r.y=this._lookAtObject.y,r.z=this._lookAtObject.z;else{var i=dou.recyclable(a.Vector4);this._target.parent.globalToLocal(this._lookAtObject.globalPosition,i),r.set(i.x,i.y,i.z),i.recycle()}else r.x=0,r.y=0,r.z=0;this._target.x=r.x+this._distance*Math.sin(this._currentPanAngle*a.MathUtil.DEG_RAD)*Math.cos(this._currentTiltAngle*a.MathUtil.DEG_RAD),this._target.z=r.z+this._distance*Math.cos(this._currentPanAngle*a.MathUtil.DEG_RAD)*Math.cos(this._currentTiltAngle*a.MathUtil.DEG_RAD),this._target.y=r.y+this._distance*Math.sin(this._currentTiltAngle*a.MathUtil.DEG_RAD)*this._yFactor,r.recycle(),p.prototype.update.call(this,t,e)}},t}(a.LookAtController);a.HoverController=t}(dou3d||(dou3d={})),function(t){t.ContextSamplerType||(t.ContextSamplerType={})}(dou3d||(dou3d={})),function(t){var e;(e=t.ShaderPhaseType||(t.ShaderPhaseType={}))[e.custom_vertex=0]="custom_vertex",e[e.start_vertex=1]="start_vertex",e[e.vertex_1=2]="vertex_1",e[e.vertex_2=3]="vertex_2",e[e.end_vertex=4]="end_vertex",e[e.custom_fragment=5]="custom_fragment",e[e.start_fragment=6]="start_fragment",e[e.materialsource_fragment=7]="materialsource_fragment",e[e.diffuse_fragment=8]="diffuse_fragment",e[e.normal_fragment=9]="normal_fragment",e[e.shadow_fragment=10]="shadow_fragment",e[e.lighting_fragment=11]="lighting_fragment",e[e.specular_fragment=12]="specular_fragment",e[e.end_fragment=13]="end_fragment"}(dou3d||(dou3d={})),function(t){var e=function(t){function o(){return null!==t&&t.apply(this,arguments)||this}return __extends(o,t),o.dispatch=function(t,e,r,i){var a=dou.recyclable(o);a.initEvent(e,r,i);var n=t.dispatchEvent(a);return a.recycle(),n},o.prototype.initEvent=function(t,e,r){this.init(t,e,r)},o.prototype.onRecycle=function(){t.prototype.onRecycle.call(this)},o.ENTER_FRAME="enterFrame",o.EXIT_FRAME="exitFrame",o.RESIZE="resize",o.TOUCH_BEGIN="touchBegin",o.TOUCH_MOVE="touchMove",o.TOUCH_END="touchEnd",o}(dou.Event);t.Event3D=e}(dou3d||(dou3d={})),function(n){var t=function(){function a(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e}return a.distance=function(t,e){var r=t.x-e.x,i=t.y-e.y;return Math.sqrt(r*r+i*i)},a.polar=function(t,e,r){return(r=r||new a).x=t*Math.sin(e),r.y=t*Math.cos(e),r},a.intersection=function(t,e,r,i,a){var n=(i.y-r.y)*(e.x-t.x)-(i.x-r.x)*(e.y-t.y);if(0==n)return!1;if(a){var o=((i.x-r.x)*(t.y-r.y)-(i.y-r.y)*(t.x-r.x))/n;a.x=t.x+o*(e.x-t.x),a.y=t.y+o*(e.y-t.y)}return!0},a.lerp=function(t,e,r,i){return(i=i||new a).x=t.x*(1-r)+e.x*r,i.y=t.y*(1-r)+e.y*r,i},Object.defineProperty(a.prototype,"sqrtLength",{get:function(){var t=this.x,e=this.y;return t*t+e*e},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"length",{get:function(){var t=this.x,e=this.y;return Math.sqrt(t*t+e*e)},enumerable:!0,configurable:!0}),a.prototype.set=function(t,e){return this.x=t,this.y=e,this},a.prototype.add=function(t,e){return e||(e=t,t=this),this.x=t.x+e.x,this.y=t.y+e.y,this},a.prototype.subtract=function(t,e){return e||(e=t,t=this),this.x=t.x-e.x,this.y=t.y-e.y,this},a.prototype.multiply=function(t,e){return e||(e=t,t=this),this.x=t.x*e.x,this.y=t.y*e.y,this},a.prototype.addScalar=function(t,e){return e=e||this,this.x=e.x+t,this.y=e.y+t,this},a.prototype.multiplyScalar=function(t,e){return e=e||this,this.x=t*e.x,this.y=t*e.y,this},a.prototype.dot=function(t){return this.x*t.x+this.y*t.y},a.prototype.getAngle=function(t){var e=dou.recyclable(a);e.normalize(this);var r=dou.recyclable(a);r.normalize(t);var i=Math.acos(e.dot(r));return e.recycle(),r.recycle(),i},a.prototype.cross=function(t){return this.x*t.y-this.y*t.x},a.prototype.normalize=function(t){var e=(t=t||this).x,r=t.y,i=Math.sqrt(e*e+r*r);return i>n.MathUtil.EPSILON?(i=1/i,this.x=e*i,this.y=r*i):(this.x=1,this.y=0),this},a.prototype.equal=function(t,e){return void 0===e&&(e=n.MathUtil.EPSILON),Math.abs(this.x-t.x)<=e&&Math.abs(this.y-t.y)<=e},a.prototype.copy=function(t){return this.set(t.x,t.y)},a.prototype.clone=function(){return new a(this.x,this.y)},a.prototype.clear=function(){return this.x=0,this.y=0,this},a.prototype.onRecycle=function(){this.clear()},a.ZERO=new a(0,0),a.ONE=new a(1,1),a.MINUS_ONE=new a(-1,-1),a}();n.Vector2=t}(dou3d||(dou3d={})),function(d){var t=function(){function c(t,e,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===r&&(r=0),this.x=t,this.y=e,this.z=r}return c.getDistance=function(t,e){var r=t.x-e.x,i=t.y-e.y,a=t.z-e.z;return Math.sqrt(r*r+i*i+a*a)},c.intersection=function(t,e,r,i,a){if(1==e.dot(i))return!1;var n=dou.recyclable(c);n.subtract(r,t);var o=dou.recyclable(c);o.cross(e,i);var s=dou.recyclable(c);s.cross(n,i);var h=n.dot(o);if(1e-5<=h||h<=1e-5)return n.recycle(),o.recycle(),s.recycle(),!1;var u=s.dot(o)/o.squaredLength;return a&&(a.copy(e),a.multiplyScalar(u),a.add(t)),n.recycle(),o.recycle(),s.recycle(),!0},c.lerp=function(t,e,r,i){return(i=i||new c).x=t.x+(e.x-t.x)*r,i.y=t.y+(e.y-t.y)*r,i.z=t.z+(e.z-t.z)*r,i},c.slerp=function(t,e,r,i){i=i||new c;var a=t.length,n=e.length;if(a<d.MathUtil.EPSILON||n<d.MathUtil.EPSILON)return this.lerp(t,e,r,i);var o=t.dot(e)/(a*n);if(o>1-d.MathUtil.EPSILON)return this.lerp(t,e,r,i);var s=d.MathUtil.lerp(a,n,r),h=dou.recyclable(d.Matrix3),u=dou.recyclable(d.Matrix4);if(o<-1+d.MathUtil.EPSILON){var l=i.orthoNormal(t);h.fromMatrix4(u.fromAxis(l,Math.PI*r)),i.multiplyScalar(1/a,t).applyMatrix3(h).multiplyScalar(s)}else{l=i.cross(t,e).normalize();h.fromMatrix4(u.fromAxis(l,Math.acos(o)*r)),i.multiplyScalar(1/a,t).applyMatrix3(h).multiplyScalar(s)}return h.recycle(),u.recycle(),i},Object.defineProperty(c.prototype,"squaredLength",{get:function(){var t=this.x,e=this.y,r=this.z;return t*t+e*e+r*r},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"length",{get:function(){var t=this.x,e=this.y,r=this.z;return Math.sqrt(t*t+e*e+r*r)},enumerable:!0,configurable:!0}),c.prototype.set=function(t,e,r){return this.x=t,this.y=e,this.z=r,this},c.prototype.addScalar=function(t,e){return e=e||this,this.x=e.x+t,this.y=e.y+t,this.z=e.z+t,this},c.prototype.multiplyScalar=function(t,e){return e=e||this,this.x=t*e.x,this.y=t*e.y,this.z=t*e.z,this},c.prototype.add=function(t,e){return e||(e=t,t=this),this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this},c.prototype.subtract=function(t,e){return e||(e=t,t=this),this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this},c.prototype.multiply=function(t,e){return e||(e=t,t=this),this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this},c.prototype.divide=function(t,e){return e||(e=t,t=this),!DEBUG||0!==e.x&&0!==e.y&&0!==e.z||console.warn("除数为 0"),this.x=t.x/e.x,this.y=t.y/e.y,this.z=t.z/e.z,this},c.prototype.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},c.prototype.getAngle=function(t){var e=this.squaredLength*t.squaredLength;if(e<d.MathUtil.EPSILON)return DEBUG&&console.warn("除数为 0"),0;var r=this.dot(t)/Math.sqrt(e);return Math.acos(Math.max(-1,Math.min(1,r)))},c.prototype.cross=function(t,e){e||(e=t,t=this);var r=t.x,i=t.y,a=t.z,n=e.x,o=e.y,s=e.z;return this.x=i*s-a*o,this.y=a*n-r*s,this.z=r*o-i*n,this},c.prototype.reflect=function(t,e){e=e||this;var r=dou.recyclable(c);return this.subtract(e,r.multiplyScalar(2*e.dot(t),t)),r.recycle(),this},c.prototype.getSquaredDistance=function(t){var e=dou.recyclable(c),r=e.subtract(t,this).squaredLength;return e.recycle(),r},c.prototype.getPointDistance=function(t){var e=dou.recyclable(c),r=e.subtract(t,this).length;return e.recycle(),r},c.prototype.fromSphericalCoords=function(t,e,r){void 0===e&&(e=0),void 0===r&&(r=0);var i=Math.sin(e)*t;return this.x=i*Math.sin(r),this.y=Math.cos(e)*t,this.z=i*Math.cos(r),this},c.prototype.applyMatrix3=function(t,e){var r=(e=e||this).x,i=e.y,a=e.z,n=t.rawData;return t instanceof d.Matrix3?(this.x=n[0]*r+n[3]*i+n[6]*a,this.y=n[1]*r+n[4]*i+n[7]*a,this.z=n[2]*r+n[5]*i+n[8]*a):(this.x=n[0]*r+n[4]*i+n[8]*a,this.y=n[1]*r+n[5]*i+n[9]*a,this.z=n[2]*r+n[6]*i+n[10]*a),this},c.prototype.applyMatrix=function(t,e){var r=(e=e||this).x,i=e.y,a=e.z,n=t.rawData,o=n[3]*r+n[7]*i+n[11]*a+n[15];return o<-d.MathUtil.EPSILON||d.MathUtil.EPSILON<o?(o=1/o,this.x=(n[0]*r+n[4]*i+n[8]*a+n[12])*o,this.y=(n[1]*r+n[5]*i+n[9]*a+n[13])*o,this.z=(n[2]*r+n[6]*i+n[10]*a+n[14])*o):(DEBUG&&console.warn("除数为 0"),this.x=0,this.y=0,this.z=0),this},c.prototype.applyDirection=function(t,e){var r=(e=e||this).x,i=e.y,a=e.z,n=t.rawData;return this.x=n[0]*r+n[4]*i+n[8]*a,this.y=n[1]*r+n[5]*i+n[9]*a,this.z=n[2]*r+n[6]*i+n[10]*a,this.normalize()},c.prototype.applyQuaternion=function(t,e){var r=(e=e||this).x,i=e.y,a=e.z,n=t.x,o=t.y,s=t.z,h=t.w,u=h*r+o*a-s*i,l=h*i+s*r-n*a,c=h*a+n*i-o*r,d=-n*r-o*i-s*a;return this.x=u*h+d*-n+l*-s-c*-o,this.y=l*h+d*-o+c*-n-u*-s,this.z=c*h+d*-s+u*-o-l*-n,this},c.prototype.normalize=function(t){var e=(t=t||this).x,r=t.y,i=t.z,a=Math.sqrt(e*e+r*r+i*i);return a>d.MathUtil.EPSILON?(a=1/a,this.x=e*a,this.y=r*a,this.z=i*a):(this.x=1,this.y=0,this.z=0),this},c.prototype.orthoNormal=function(t){var e=(t=t||this).x,r=t.y,i=t.z;if(0<i?i>d.MathUtil.SQRT1_2:i<d.MathUtil.SQRT1_2){var a=1/Math.sqrt(r*r+i*i);this.x=0,this.y=-i*a,this.z=r*a}else{a=1/Math.sqrt(e*e+r*r);this.x=-r*a,this.y=e*a,this.z=0}return this},c.prototype.negate=function(t){return t=t||this,this.x=-t.x,this.y=-t.y,this.z=-t.z,this},c.prototype.equal=function(t,e){return void 0===e&&(e=d.MathUtil.EPSILON),Math.abs(this.x-t.x)<=e&&Math.abs(this.y-t.y)<=e&&Math.abs(this.z-t.z)<=e},c.prototype.fromArray=function(t,e){return void 0===e&&(e=0),this.x=t[e],this.y=t[e+1],this.z=t[e+2],this},c.prototype.fromMatrixPosition=function(t){return this.fromArray(t.rawData,12)},c.prototype.fromMatrixColumn=function(t,e){return this.fromArray(t.rawData,4*e)},c.prototype.toArray=function(t,e){return void 0===e&&(e=0),(t=t||[])[0+e]=this.x,t[1+e]=this.y,t[2+e]=this.z,t},c.prototype.copy=function(t){return this.set(t.x,t.y,t.z)},c.prototype.clone=function(){return new c(this.x,this.y,this.z)},c.prototype.clear=function(){return this.x=0,this.y=0,this.z=0,this},c.prototype.onRecycle=function(){this.clear()},c.ZERO=new c(0,0,0),c.ONE=new c(1,1,1),c.MINUS_ONE=new c(-1,-1,-1),c.UP=new c(0,1,0),c.DOWN=new c(0,-1,0),c.LEFT=new c(-1,0,0),c.RIGHT=new c(1,0,0),c.FORWARD=new c(0,0,1),c.BACK=new c(0,0,-1),c}();d.Vector3=t}(dou3d||(dou3d={})),function(o){var t=function(){function a(t,e,r,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===r&&(r=0),void 0===i&&(i=1),this.x=t,this.y=e,this.z=r,this.w=i}return a.lerp=function(t,e,r,i){return(i=i||new a).x=t.x+(e.x-t.x)*r,i.y=t.y+(e.y-t.y)*r,i.z=t.z+(e.z-t.z)*r,i.w=t.w+(e.w-t.w)*r,i},Object.defineProperty(a.prototype,"squaredLength",{get:function(){var t=this.x,e=this.y,r=this.z,i=this.w;return t*t+e*e+r*r+i*i},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"length",{get:function(){var t=this.x,e=this.y,r=this.z,i=this.w;return Math.sqrt(t*t+e*e+r*r+i*i)},enumerable:!0,configurable:!0}),a.prototype.set=function(t,e,r,i){return this.x=t,this.y=e,this.z=r,this.w=i,this},a.prototype.multiplyScalar=function(t,e){return e=e||this,this.x=t*e.x,this.y=t*e.y,this.z=t*e.z,this.w=t*e.w,this},a.prototype.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w},a.prototype.inverse=function(t){return t=t||this,this.x=-1*t.x,this.y=-1*t.y,this.z=-1*t.z,this.w=t.w,this},a.prototype.normalize=function(t){var e=(t=t||this).x,r=t.y,i=t.z,a=t.w,n=Math.sqrt(e*e+r*r+i*i+a*a);return n>o.MathUtil.EPSILON?(n=1/n,this.x=e*n,this.y=r*n,this.z=i*n,this.w=a*n):this.clear(),this},a.prototype.equal=function(t,e){return void 0===e&&(e=o.MathUtil.EPSILON),Math.abs(this.x-t.x)<=e&&Math.abs(this.y-t.y)<=e&&Math.abs(this.z-t.z)<=e&&Math.abs(this.w-t.w)<=e},a.prototype.fromArray=function(t,e){return void 0===e&&(e=0),this.x=t[e],this.y=t[e+1],this.z=t[e+2],this.w=t[e+3],this},a.prototype.toArray=function(t,e){return void 0===e&&(e=0),(t=t||[])[0+e]=this.x,t[1+e]=this.y,t[2+e]=this.z,t[3+e]=this.w,t},a.prototype.copy=function(t){return this.set(t.x,t.y,t.z,t.w)},a.prototype.clone=function(){return new a(this.x,this.y,this.z,this.w)},a.prototype.clear=function(){return this.x=0,this.y=0,this.z=0,this.w=1,this},a.prototype.onRecycle=function(){this.clear()},a}();o.Vector4=t}(dou3d||(dou3d={})),function(x){var t=function(t){function y(){return null!==t&&t.apply(this,arguments)||this}return __extends(y,t),y.lerp=function(t,e,r,i){i=i||new y;var a=t.x,n=t.y,o=t.z,s=t.w,h=e.x,u=e.y,l=e.z,c=e.w;return a*h+n*u+o*l+s*c<0?(i.x=a+(-h-a)*r,i.y=n+(-u-n)*r,i.z=o+(-l-o)*r,i.w=s+(-c-s)*r):(i.x=a+(h-a)*r,i.y=n+(u-n)*r,i.z=o+(l-o)*r,i.w=s+(c-s)*r),i.normalize()},y.slerp=function(t,e,r,i){i=i||new y;var a=t.x,n=t.y,o=t.z,s=t.w,h=e.x,u=e.y,l=e.z,c=e.w,d=s*c+a*h+n*u+o*l;if(d<0?(i.w=-c,i.x=-h,i.y=-u,i.z=-l,d=-d):(i.w=c,i.x=h,i.y=u,i.z=l),1<=d)return i.w=s,i.x=a,i.y=n,i.z=o,i;var p=1-d*d;if(p<x.MathUtil.EPSILON)return this.lerp(t,i,r,i);var f=Math.sqrt(p),m=Math.atan2(f,d),_=Math.sin((1-r)*m)/f,g=Math.sin(r*m)/f;return i.w=s*_+i.w*g,i.x=a*_+i.x*g,i.y=n*_+i.y*g,i.z=o*_+i.z*g,i},y.prototype.fromMatrix=function(t){var e=t.rawData,r=e[0],i=e[4],a=e[8],n=e[1],o=e[5],s=e[9],h=e[2],u=e[6],l=e[10],c=r+o+l,d=0;return 0<c?(d=.5/Math.sqrt(c+1),this.w=.25/d,this.x=(u-s)*d,this.y=(a-h)*d,this.z=(n-i)*d):o<r&&l<r?(d=2*Math.sqrt(1+r-o-l),this.w=(u-s)/d,this.x=.25*d,this.y=(i+n)/d,this.z=(a+h)/d):l<o?(d=2*Math.sqrt(1+o-r-l),this.w=(a-h)/d,this.x=(i+n)/d,this.y=.25*d,this.z=(s+u)/d):(d=2*Math.sqrt(1+l-r-o),this.w=(n-i)/d,this.x=(a+h)/d,this.y=(s+u)/d,this.z=.25*d),this},y.prototype.fromEuler=function(t,e,r,i){void 0===i&&(i=3);var a=Math.cos,n=Math.sin,o=a(.5*t),s=a(.5*e),h=a(.5*r),u=n(.5*t),l=n(.5*e),c=n(.5*r);switch(i){case 1:this.x=u*s*h+o*l*c,this.y=o*l*h-u*s*c,this.z=o*s*c+u*l*h,this.w=o*s*h-u*l*c;break;case 2:this.x=u*s*h-o*l*c,this.y=o*l*h-u*s*c,this.z=o*s*c+u*l*h,this.w=o*s*h+u*l*c;break;case 3:this.x=u*s*h+o*l*c,this.y=o*l*h-u*s*c,this.z=o*s*c-u*l*h,this.w=o*s*h+u*l*c;break;case 4:this.x=u*s*h+o*l*c,this.y=o*l*h+u*s*c,this.z=o*s*c-u*l*h,this.w=o*s*h-u*l*c;break;case 5:this.x=u*s*h-o*l*c,this.y=o*l*h+u*s*c,this.z=o*s*c+u*l*h,this.w=o*s*h-u*l*c;break;case 6:this.x=u*s*h-o*l*c,this.y=o*l*h+u*s*c,this.z=o*s*c-u*l*h,this.w=o*s*h+u*l*c}return this},y.prototype.fromAxis=function(t,e){var r=.5*e,i=Math.sin(r);return this.x=t.x*i,this.y=t.y*i,this.z=t.z*i,this.w=Math.cos(r),this},y.prototype.fromVectors=function(t,e){var r=t.dot(e)+1,i=dou.recyclable(x.Vector3);return r<x.MathUtil.EPSILON?(r=0,Math.abs(t.x)>Math.abs(t.z)?i.set(-t.y,t.x,0):i.set(0,-t.z,t.y)):i.cross(t,e),this.x=i.x,this.y=i.y,this.z=i.z,this.w=r,i.recycle(),this.normalize()},y.prototype.toEuler=function(t,e){void 0===e&&(e=3),t=t||new x.Vector3;var r=dou.recyclable(x.Matrix4),i=r.fromRotation(this).toEuler(e,t);return r.recycle(),i},y.prototype.multiply=function(t,e){e||(e=t,t=this);var r=t.x,i=t.y,a=t.z,n=t.w,o=e.x,s=e.y,h=e.z,u=e.w;return this.x=r*u+n*o+i*h-a*s,this.y=i*u+n*s+a*o-r*h,this.z=a*u+n*h+r*s-i*o,this.w=n*u-r*o-i*s-a*h,this},y.prototype.transformVector=function(t,e){e=e||new x.Vector3;var r=this.x,i=this.y,a=this.z,n=this.w,o=t.x,s=t.y,h=t.z,u=-r*o-i*s-a*h,l=n*o+i*h-a*s,c=n*s-r*h+a*o,d=n*h+r*s-i*o;return e.x=-u*r+l*n-c*a+d*i,e.y=-u*i+l*a+c*n-d*r,e.z=-u*a-l*i+c*r+d*n,e},y.prototype.lookAt=function(t,e,r){var i=dou.recyclable(x.Matrix4),a=this.fromMatrix(i.lookAt(t,e,r));return i.recycle(),a},y.prototype.lookRotation=function(t,e){var r=dou.recyclable(x.Matrix4),i=this.fromMatrix(r.lookRotation(t,e));return r.recycle(),i},y.prototype.getAngle=function(t){return 2*Math.acos(Math.abs(x.MathUtil.clamp(this.dot(t),-1,1)))},y.prototype.identity=function(){return this.x=this.y=this.z=0,this.w=1,this},y.prototype.clone=function(){return new y(this.x,this.y,this.z,this.w)},y.IDENTITY=new y,y}(x.Vector4);x.Quaternion=t}(dou3d||(dou3d={})),function(t){var e=function(){function e(t,e){void 0===e&&(e=0),t&&t instanceof ArrayBuffer?this.fromBuffer(t,e):(this.rawData=new Float32Array(9),this.fromArray(t||[1,0,0,0,1,0,0,0,1]))}return Object.defineProperty(e.prototype,"determinant",{get:function(){var t=this.rawData,e=t[0],r=t[1],i=t[2],a=t[3],n=t[4],o=t[5],s=t[6],h=t[7],u=t[8];return e*n*u-e*o*h-r*a*u+r*o*s+i*a*h-i*n*s},enumerable:!0,configurable:!0}),e.prototype.set=function(t,e,r,i,a,n,o,s,h){var u=this.rawData;return u[0]=t,u[1]=i,u[2]=o,u[3]=e,u[4]=a,u[5]=s,u[6]=r,u[7]=n,u[8]=h,this},e.prototype.getNormalMatrix=function(t){return this.fromMatrix4(t).inverse().transpose()},e.prototype.inverse=function(t){var e=(t=t||this).rawData,r=this.rawData,i=e[0],a=e[1],n=e[2],o=e[3],s=e[4],h=e[5],u=e[6],l=e[7],c=e[8],d=c*s-h*l,p=h*u-c*o,f=l*o-s*u,m=i*d+a*p+n*f;if(0==m)return this.identity();var _=1/m;return r[0]=d*_,r[1]=(n*l-c*a)*_,r[2]=(h*a-n*s)*_,r[3]=p*_,r[4]=(c*i-n*u)*_,r[5]=(n*o-h*i)*_,r[6]=f*_,r[7]=(a*u-l*i)*_,r[8]=(s*i-a*o)*_,this},e.prototype.transpose=function(){var t=0,e=this.rawData;return t=e[1],e[1]=e[3],e[3]=t,t=e[2],e[2]=e[6],e[6]=t,t=e[5],e[5]=e[7],e[7]=t,this},e.prototype.multiply=function(t,e){e||(e=t,t=this);var r=t.rawData,i=e.rawData,a=this.rawData,n=r[0],o=r[3],s=r[6],h=r[1],u=r[4],l=r[7],c=r[2],d=r[5],p=r[8],f=i[0],m=i[3],_=i[6],g=i[1],y=i[4],x=i[7],v=i[2],b=i[5],D=i[8];return a[0]=n*f+o*g+s*v,a[3]=n*m+o*y+s*b,a[6]=n*_+o*x+s*D,a[1]=h*f+u*g+l*v,a[4]=h*m+u*y+l*b,a[7]=h*_+u*x+l*D,a[2]=c*f+d*g+p*v,a[5]=c*m+d*y+p*b,a[8]=c*_+d*x+p*D,this},e.prototype.fromArray=function(t,e){void 0===e&&(e=0);for(var r=0;r<9;++r)this.rawData[r]=t[r+e];return this},e.prototype.fromBuffer=function(t,e){return void 0===e&&(e=0),this.rawData=new Float32Array(t,e,9),this},e.prototype.fromScale=function(t){var e=this.rawData;return e[0]=t.x,e[1]=0,e[2]=0,e[3]=0,e[4]=t.y,e[5]=0,e[6]=0,e[7]=0,e[8]=t.z,this},e.prototype.fromUVTransform=function(t,e,r,i,a,n,o){void 0===a&&(a=0),void 0===n&&(n=0),void 0===o&&(o=0);var s=Math.cos(a),h=Math.sin(a);return this.set(r*s,r*h,-r*(s*n+h*o)+n+t,-i*h,i*s,-i*(-h*n+s*o)+o+e,0,0,1)},e.prototype.fromMatrix4=function(t){var e=t.rawData;return this.set(e[0],e[4],e[8],e[1],e[5],e[9],e[2],e[6],e[10]),this},e.prototype.toArray=function(t,e){void 0===e&&(e=0),t=t||[];for(var r=0;r<9;++r)t[r+e]=this.rawData[r];return t},e.prototype.copy=function(t){return this.fromArray(t.rawData),this},e.prototype.clone=function(){var t=new e;return t.copy(this),t},e.prototype.identity=function(){var t=this.rawData;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,this},e.prototype.onRecycle=function(){this.identity()},e.IDENTITY=new e,e}();t.Matrix3=e}(dou3d||(dou3d={})),function(p){var t=function(){function S(t,e){void 0===e&&(e=0),t&&t instanceof ArrayBuffer?this.fromBuffer(t,e):(this.rawData=new Float32Array(16),this.fromArray(t||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]))}return S.lerp=function(t,e,r,i){var a=(i=i||new S).rawData;if(0==r){for(var n=0;n<16;n++)a[n]=t.rawData[n];return i}if(1==r){for(n=0;n<16;n++)a[n]=e.rawData[n];return i}for(n=0;n<16;n++){var o=t.rawData[n];a[n]=o+(e.rawData[n]-o)*r}return i},Object.defineProperty(S.prototype,"determinant",{get:function(){var t=this.rawData,e=t[0],r=t[4],i=t[8],a=t[12],n=t[1],o=t[5],s=t[9],h=t[13],u=t[2],l=t[6],c=t[10],d=t[14],p=s*l,f=h*l,m=o*c,_=h*c,g=o*d,y=s*d,x=n*c,v=n*d,b=h*u,D=s*u,P=n*l,w=o*u;return t[3]*(a*p-i*f-a*m+r*_+i*g-r*y)+t[7]*(e*y-e*_+a*x-i*v+i*b-a*D)+t[11]*(e*f-e*g-a*P+r*v+a*w-r*b)+t[15]*(-i*w-e*p+e*m+i*P-r*x+r*D)},enumerable:!0,configurable:!0}),Object.defineProperty(S.prototype,"maxScaleOnAxis",{get:function(){var t=this.rawData,e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],r=t[4]*t[4]+t[5]*t[5]+t[6]*t[6],i=t[8]*t[8]+t[9]*t[9]+t[10]*t[10];return Math.sqrt(Math.max(e,r,i))},enumerable:!0,configurable:!0}),S.prototype.set=function(t,e,r,i,a,n,o,s,h,u,l,c,d,p,f,m){var _=this.rawData;return _[0]=t,_[4]=e,_[8]=r,_[12]=i,_[1]=a,_[5]=n,_[9]=o,_[13]=s,_[2]=h,_[6]=u,_[10]=l,_[14]=c,_[3]=d,_[7]=p,_[11]=f,_[15]=m,this},S.prototype.forward=function(t){return this.copyColumnTo(2,t).normalize()},S.prototype.up=function(t){return this.copyColumnTo(1,t).normalize()},S.prototype.right=function(t){return this.copyColumnTo(0,t).normalize()},S.prototype.back=function(t){return this.copyColumnTo(2,t).normalize().negate()},S.prototype.down=function(t){return this.copyColumnTo(1,t).normalize().negate()},S.prototype.left=function(t){return this.copyColumnTo(0,t).normalize().negate()},S.prototype.copyColumnTo=function(t,e){return(e=e||new p.Vector3).x=this.rawData[4*t+0],e.y=this.rawData[4*t+1],e.z=this.rawData[4*t+2],e},S.prototype.compose=function(t,e,r){var i=e.x,a=e.y,n=e.z,o=e.w,s=r.x,h=r.y,u=r.z,l=i+i,c=a+a,d=n+n,p=i*l,f=i*c,m=i*d,_=a*c,g=a*d,y=n*d,x=o*l,v=o*c,b=o*d,D=this.rawData;return D[0]=(1-(_+y))*s,D[1]=(f+b)*s,D[2]=(m-v)*s,D[4]=(f-b)*h,D[5]=(1-(p+y))*h,D[6]=(g+x)*h,D[8]=(m+v)*u,D[9]=(g-x)*u,D[10]=(1-(p+_))*u,D[12]=t.x,D[13]=t.y,D[14]=t.z,D[3]=D[7]=D[11]=0,D[15]=1,this},S.prototype.decompose=function(t,e,r){var i=this.rawData;if(t&&(t.x=i[12],t.y=i[13],t.z=i[14]),e||r){var a=dou.recyclable(p.Vector3),n=a.set(i[0],i[1],i[2]).length,o=a.set(i[4],i[5],i[6]).length,s=a.set(i[8],i[9],i[10]).length;if(this.determinant<0&&(n=-n),e){var h=dou.recyclable(S),u=h.rawData,l=1/n,c=1/o,d=1/s;h.copy(this),u[0]*=l,u[1]*=l,u[2]*=l,u[4]*=c,u[5]*=c,u[6]*=c,u[8]*=d,u[9]*=d,u[10]*=d,e.fromMatrix(h),h.recycle()}r&&(r.x=n,r.y=o,r.z=s),a.recycle()}return this},S.prototype.extractRotation=function(t){t=t||this;var e=this.rawData,r=t.rawData,i=dou.recyclable(p.Vector3),a=1/i.fromMatrixColumn(t,0).length,n=1/i.fromMatrixColumn(t,1).length,o=1/i.fromMatrixColumn(t,2).length;return e[0]=r[0]*a,e[1]=r[1]*a,e[2]=r[2]*a,e[3]=0,e[4]=r[4]*n,e[5]=r[5]*n,e[6]=r[6]*n,e[7]=0,e[8]=r[8]*o,e[9]=r[9]*o,e[10]=r[10]*o,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,i.recycle(),this},S.prototype.transpose=function(t){t=t||this;var e=this.rawData,r=t.rawData,i=0;return i=r[1],e[1]=r[4],e[4]=i,i=r[2],e[2]=r[8],e[8]=i,i=r[6],e[6]=r[9],e[9]=i,i=r[3],e[3]=r[12],e[12]=i,i=r[7],e[7]=r[13],e[13]=i,i=r[11],e[11]=r[14],e[14]=i,this},S.prototype.inverse=function(t){t=t||this;var e=this.rawData,r=t.rawData,i=r[0],a=r[4],n=r[8],o=r[12],s=r[1],h=r[5],u=r[9],l=r[13],c=r[2],d=r[6],p=r[10],f=r[14],m=r[3],_=r[7],g=r[11],y=r[15],x=u*d,v=l*d,b=h*p,D=l*p,P=h*f,w=u*f,S=s*p,A=s*f,T=l*c,L=u*c,M=s*d,E=h*c,C=w*_-D*_+v*g-P*g-x*y+b*y,I=o*p*_-n*f*_-o*d*g+a*f*g+n*d*y-a*p*y,U=n*l*_-o*u*_+o*h*g-a*l*g-n*h*y+a*u*y,z=o*x-n*v-o*b+a*D+n*P-a*w,R=i*C+s*I+c*U+m*z;if(0==R)return DEBUG&&console.warn("Cannot invert matrix, determinant is 0."),this.identity();var O=1/R;return e[0]=C*O,e[1]=(D*m-w*m-T*g+A*g+L*y-S*y)*O,e[2]=(P*m-v*m+T*_-A*_-E*y+M*y)*O,e[3]=(x*m-b*m-L*_+S*_+E*g-M*g)*O,e[4]=I*O,e[5]=(n*f*m-o*p*m+o*c*g-i*f*g-n*c*y+i*p*y)*O,e[6]=(o*d*m-a*f*m-o*c*_+i*f*_+a*c*y-i*d*y)*O,e[7]=(a*p*m-n*d*m+n*c*_-i*p*_-a*c*g+i*d*g)*O,e[8]=U*O,e[9]=(o*u*m-n*l*m-o*s*g+i*l*g+n*s*y-i*u*y)*O,e[10]=(a*l*m-o*h*m+o*s*_-i*l*_-a*s*y+i*h*y)*O,e[11]=(n*h*m-a*u*m-n*s*_+i*u*_+a*s*g-i*h*g)*O,e[12]=z*O,e[13]=(n*T-o*L+o*S-i*D-n*A+i*w)*O,e[14]=(o*E-a*T-o*M+i*v+a*A-i*P)*O,e[15]=(a*L-n*E+n*M-i*x-a*S+i*b)*O,this},S.prototype.multiplyScalar=function(t,e){e=e||this;var r=this.rawData,i=e.rawData;return r[0]=i[0]*t,r[1]=i[1]*t,r[2]=i[2]*t,r[3]=i[3]*t,r[4]=i[4]*t,r[5]=i[5]*t,r[6]=i[6]*t,r[7]=i[7]*t,r[8]=i[8]*t,r[9]=i[9]*t,r[10]=i[10]*t,r[11]=i[11]*t,r[12]=i[12]*t,r[13]=i[13]*t,r[14]=i[14]*t,r[15]=i[15]*t,this},S.prototype.multiply=function(t,e){e||(e=t,t=this);var r=this.rawData,i=t.rawData,a=e.rawData,n=i[0],o=i[4],s=i[8],h=i[12],u=i[1],l=i[5],c=i[9],d=i[13],p=i[2],f=i[6],m=i[10],_=i[14],g=i[3],y=i[7],x=i[11],v=i[15],b=a[0],D=a[4],P=a[8],w=a[12],S=a[1],A=a[5],T=a[9],L=a[13],M=a[2],E=a[6],C=a[10],I=a[14],U=a[3],z=a[7],R=a[11],O=a[15];return r[0]=n*b+o*S+s*M+h*U,r[4]=n*D+o*A+s*E+h*z,r[8]=n*P+o*T+s*C+h*R,r[12]=n*w+o*L+s*I+h*O,r[1]=u*b+l*S+c*M+d*U,r[5]=u*D+l*A+c*E+d*z,r[9]=u*P+l*T+c*C+d*R,r[13]=u*w+l*L+c*I+d*O,r[2]=p*b+f*S+m*M+_*U,r[6]=p*D+f*A+m*E+_*z,r[10]=p*P+f*T+m*C+_*R,r[14]=p*w+f*L+m*I+_*O,r[3]=g*b+y*S+x*M+v*U,r[7]=g*D+y*A+x*E+v*z,r[11]=g*P+y*T+x*C+v*R,r[15]=g*w+y*L+x*I+v*O,this},S.prototype.append=function(t,e){e||(e=t,t=this);var r=this.rawData,i=t.rawData,a=e.rawData,n=i[0],o=i[4],s=i[8],h=i[12],u=i[1],l=i[5],c=i[9],d=i[13],p=i[2],f=i[6],m=i[10],_=i[14],g=i[3],y=i[7],x=i[11],v=i[15],b=a[0],D=a[4],P=a[8],w=a[12],S=a[1],A=a[5],T=a[9],L=a[13],M=a[2],E=a[6],C=a[10],I=a[14],U=a[3],z=a[7],R=a[11],O=a[15];return r[0]=n*b+u*D+p*P+g*w,r[1]=n*S+u*A+p*T+g*L,r[2]=n*M+u*E+p*C+g*I,r[3]=n*U+u*z+p*R+g*O,r[4]=o*b+l*D+f*P+y*w,r[5]=o*S+l*A+f*T+y*L,r[6]=o*M+l*E+f*C+y*I,r[7]=o*U+l*z+f*R+y*O,r[8]=s*b+c*D+m*P+x*w,r[9]=s*S+c*A+m*T+x*L,r[10]=s*M+c*E+m*C+x*I,r[11]=s*U+c*z+m*R+x*O,r[12]=h*b+d*D+_*P+v*w,r[13]=h*S+d*A+_*T+v*L,r[14]=h*M+d*E+_*C+v*I,r[15]=h*U+d*z+_*R+v*O,this},S.prototype.transformVector=function(t,e){e=e||new p.Vector4;var r=t.x,i=t.y,a=t.z,n=this.rawData;return e.x=r*n[0]+i*n[4]+a*n[8]+n[12],e.y=r*n[1]+i*n[5]+a*n[9]+n[13],e.z=r*n[2]+i*n[6]+a*n[10]+n[14],e.w=r*n[3]+i*n[7]+a*n[11]+n[15],e},S.prototype.fromProjection=function(t,e,r,i,a,n,o,s){var h=dou.recyclable(S);o=1-o;var u=(s?-s.x:0)-.5,l=(s?s.y:0)+.5,c=s?s.w:1,d=s?s.h:1;if(0<a){var p=2*t*Math.tan(.5*r),f=(v=u*(y=n*(x=p)))+(u*(D=p)-v)*o,m=(b=l*x)+(l*(P=D/n)-b)*o,_=(y+(D-y)*o)*c,g=(x+(P-x)*o)*d;this.perspectiveProjectMatrix(f,f+_,m,m-g,t,e)}if(a<1){f=(v=u*(y=i*n))+(u*(D=i)-v)*o;var y,x,v,b,D,P,w=(b=l*(x=i))+(l*(P=i/n)-b)*o;_=(y+(D-y)*o)*c,g=(x+(P-x)*o)*d;h.orthographicProjectMatrix(f,f+_,w,w-g,t,e)}return 0==a?this.copy(h):1==a||S.lerp(h,this,Math.pow(a,8),this),h.recycle(),this},S.prototype.perspectiveProjectMatrix=function(t,e,r,i,a,n){var o=1/(e-t),s=1/(r-i),h=1/(a-n),u=2*a,l=this.rawData;return l[0]=u*o,l[1]=l[2]=l[3]=0,l[4]=l[6]=l[7]=0,l[5]=u*s,l[8]=(e+t)*o,l[9]=(r+i)*s,l[10]=-(n+a)*h,l[11]=1,l[12]=l[13]=l[15]=0,l[14]=u*n*h,this},S.prototype.orthographicProjectMatrix=function(t,e,r,i,a,n){var o=1/(e-t),s=1/(r-i),h=1/(a-n),u=this.rawData;return u[0]=2*o,u[1]=u[2]=u[3]=0,u[4]=u[6]=u[7]=0,u[5]=2*s,u[8]=u[9]=u[11]=0,u[10]=-2*h,u[12]=-(e+t)*o,u[13]=-(r+i)*s,u[14]=(n+a)*h,u[15]=1,this},S.prototype.lookAt=function(t,e,r){var i=dou.recyclable(p.Vector3);return this.lookRotation(i.subtract(e,t),r),i.recycle(),this},S.prototype.lookRotation=function(t,e){var r=dou.recyclable(p.Vector3),i=dou.recyclable(p.Vector3),a=dou.recyclable(p.Vector3),n=r.normalize(t),o=i.cross(e,n).normalize(i),s=a.cross(n,o),h=this.rawData;return h[0]=o.x,h[4]=s.x,h[8]=n.x,h[1]=o.y,h[5]=s.y,h[9]=n.y,h[2]=o.z,h[6]=s.z,h[10]=n.z,r.recycle(),i.recycle(),a.recycle(),this},S.prototype.fromArray=function(t,e){void 0===e&&(e=0);var r=this.rawData;if(0<e)for(var i=0;i<16;++i)r[i]=t[i+e];else for(i=0;i<16;++i)r[i]=t[i];return this},S.prototype.fromBuffer=function(t,e){return void 0===e&&(e=0),this.rawData=new Float32Array(t,e,16),this},S.prototype.fromTranslate=function(t,e){void 0===e&&(e=!1),e||this.identity();var r=this.rawData;return r[12]=t.x,r[13]=t.y,r[14]=t.z,this},S.prototype.fromRotation=function(t,e){void 0===e&&(e=!1);var r=dou.recyclable(p.Vector3),i=this.compose(e?r.fromArray(this.rawData,12):p.Vector3.ZERO,t,p.Vector3.ONE);return r.recycle(),i},S.prototype.fromEuler=function(t,e,r){void 0===e&&(e=3),void 0===r&&(r=!1);var i=Math.cos,a=Math.sin,n=t.x,o=t.y,s=t.z,h=i(n),u=a(n),l=i(o),c=a(o),d=i(s),p=a(s),f=this.rawData;switch(e){case 1:var m=h*d,_=h*p,g=u*d,y=u*p;f[0]=l*d,f[4]=-l*p,f[8]=c,f[1]=_+g*c,f[5]=m-y*c,f[9]=-u*l,f[2]=y-m*c,f[6]=g+_*c,f[10]=h*l;break;case 2:var x=h*l,v=h*c,b=u*l,D=u*c;f[0]=l*d,f[4]=-p,f[8]=c*d,f[1]=x*p+D,f[5]=h*d,f[9]=v*p-b,f[2]=b*p-v,f[6]=u*d,f[10]=D*p+x;break;case 3:var P=l*d,w=l*p,S=c*d,A=c*p;f[0]=P+A*u,f[4]=S*u-w,f[8]=h*c,f[1]=h*p,f[5]=h*d,f[9]=-u,f[2]=w*u-S,f[6]=A+P*u,f[10]=h*l;break;case 4:x=h*l,v=h*c,b=u*l,D=u*c;f[0]=l*d,f[4]=D-x*p,f[8]=b*p+v,f[1]=p,f[5]=h*d,f[9]=-u*d,f[2]=-c*d,f[6]=v*p+b,f[10]=x-D*p;break;case 5:P=l*d,w=l*p,S=c*d,A=c*p;f[0]=P-A*u,f[4]=-h*p,f[8]=S+w*u,f[1]=w+S*u,f[5]=h*d,f[9]=A-P*u,f[2]=-h*c,f[6]=u,f[10]=h*l;break;case 6:m=h*d,_=h*p,g=u*d,y=u*p;f[0]=l*d,f[4]=g*c-_,f[8]=m*c+y,f[1]=l*p,f[5]=y*c+m,f[9]=_*c-g,f[2]=-c,f[6]=u*l,f[10]=h*l}return f[3]=f[7]=f[11]=0,r||(f[12]=f[13]=f[14]=0,f[15]=1),this},S.prototype.fromScale=function(t,e){void 0===e&&(e=!1);var r=dou.recyclable(p.Vector3);e&&r.fromArray(this.rawData,12),this.identity();var i=this.rawData;return i[0]=t.x,i[5]=t.y,i[10]=t.z,e&&(i[12]=r.x,i[13]=r.y,i[14]=r.z),r.recycle(),this},S.prototype.fromRotationX=function(t){var e=Math.cos(t),r=Math.sin(t);return this.set(1,0,0,0,0,e,-r,0,0,r,e,0,0,0,0,1)},S.prototype.fromRotationY=function(t){var e=Math.cos(t),r=Math.sin(t);return this.set(e,0,r,0,0,1,0,0,-r,0,e,0,0,0,0,1)},S.prototype.fromRotationZ=function(t){var e=Math.cos(t),r=Math.sin(t);return this.set(e,-r,0,0,r,e,0,0,0,0,1,0,0,0,0,1)},S.prototype.fromAxis=function(t,e){var r=Math.cos(e),i=Math.sin(e),a=1-r,n=t.x,o=t.y,s=t.z,h=a*n,u=a*o;return this.set(h*n+r,h*o-i*s,h*s+i*o,0,h*o+i*s,u*o+r,u*s-i*n,0,h*s-i*o,u*s+i*n,a*s*s+r,0,0,0,0,1)},S.prototype.fromAxises=function(t,e,r){return this.set(t.x,e.x,r.x,0,t.y,e.y,r.y,0,t.z,e.z,r.z,0,0,0,0,1)},S.prototype.toArray=function(t,e){void 0===e&&(e=0),t=t||[];var r=this.rawData;if(0<e)for(var i=0;i<16;++i)t[i+e]=r[i];else for(i=0;i<16;++i)t[i]=r[i];return t},S.prototype.toEuler=function(t,e){void 0===t&&(t=3),e=e||new p.Vector3;var r=this.rawData,i=r[0],a=r[4],n=r[8],o=r[1],s=r[5],h=r[9],u=r[2],l=r[6],c=r[10];switch(t){case 1:e.y=Math.asin(p.MathUtil.clamp(n,-1,1)),Math.abs(n)<.999999?(e.x=Math.atan2(-h,c),e.z=Math.atan2(-a,i)):(e.x=Math.atan2(l,s),e.z=0);break;case 2:e.z=Math.asin(-p.MathUtil.clamp(a,-1,1)),Math.abs(a)<.999999?(e.x=Math.atan2(l,s),e.y=Math.atan2(n,i)):(e.x=Math.atan2(-h,c),e.y=0);break;case 3:e.x=Math.asin(-p.MathUtil.clamp(h,-1,1)),Math.abs(h)<.999999?(e.y=Math.atan2(n,c),e.z=Math.atan2(o,s)):(e.y=Math.atan2(-u,i),e.z=0);break;case 4:e.z=Math.asin(p.MathUtil.clamp(o,-1,1)),Math.abs(o)<.999999?(e.x=Math.atan2(-h,s),e.y=Math.atan2(-u,i)):(e.x=0,e.y=Math.atan2(n,c));break;case 5:e.x=Math.asin(p.MathUtil.clamp(l,-1,1)),Math.abs(l)<.999999?(e.y=Math.atan2(-u,c),e.z=Math.atan2(-a,s)):(e.y=0,e.z=Math.atan2(o,i));break;case 6:e.y=Math.asin(-p.MathUtil.clamp(u,-1,1)),Math.abs(u)<.999999?(e.x=Math.atan2(l,c),e.z=Math.atan2(o,i)):(e.x=0,e.z=Math.atan2(-a,s))}return e},S.prototype.copy=function(t){return this.fromArray(t.rawData)},S.prototype.clone=function(){var t=new S;return t.copy(this),t},S.prototype.identity=function(){var t=this.rawData;return t[0]=1,t[1]=t[2]=t[3]=0,t[4]=t[6]=t[7]=0,t[5]=1,t[8]=t[9]=t[11]=0,t[10]=1,t[12]=t[13]=t[14]=0,t[15]=1,this},S.prototype.onRecycle=function(){this.identity()},S.IDENTITY=new S,S}();p.Matrix4=t}(dou3d||(dou3d={})),function(t){var e=function(){function u(t,e,r,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===r&&(r=0),void 0===i&&(i=0),this.x=t,this.y=e,this.w=r,this.h=i}return u.prototype.set=function(t,e,r,i){return this.x=t,this.y=e,this.w=r,this.h=i,this},u.prototype.contains=function(t){var e=this.x,r=this.y,i=this.x+this.w,a=this.y+this.h;if(t instanceof u){var n=t.x,o=t.y,s=t.x+t.w,h=t.y+t.h;return e<=n&&s<=i&&r<=o&&h<=a}return t.x>e&&t.x<i&&t.y>r&&t.y<a},u.prototype.multiplyScalar=function(t,e){return e=e||this,this.x=t*e.x,this.y=t*e.y,this.w=t*e.w,this.h=t*e.h,this},u.prototype.copy=function(t){return this.set(t.x,t.y,t.w,t.h)},u.prototype.clone=function(){return new u(this.x,this.y,this.w,this.h)},u.prototype.clear=function(){return this.x=0,this.y=0,this.w=0,this.h=0,this},u.prototype.onRecycle=function(){this.clear()},u}();t.Rectangle=e}(dou3d||(dou3d={})),function(o){var t=function(){function t(t,e){void 0===e&&(e=0),this.normal=new o.Vector3,this.constant=0,this.normal.copy(t),this.constant=e}return t.prototype.set=function(t,e){return void 0===e&&(e=0),this.constant=e,this.normal.copy(t),this},t.prototype.getDistance=function(t){return this.normal.dot(t)+this.constant},t.prototype.normalize=function(t){var e=1/(t=t||this).normal.length;return this.constant=t.constant*e,this.normal.multiplyScalar(e,t.normal),this},t.prototype.negate=function(t){return t=t||this,this.constant=-t.constant,this.normal.negate(t.normal),this},t.prototype.getProjectionPoint=function(t,e){return(e=e||new o.Vector3).multiplyScalar(-this.getDistance(t),this.normal).add(t)},t.prototype.getCoplanarPoint=function(t){return(t=t||new o.Vector3).copy(this.normal).multiplyScalar(-this.constant)},t.prototype.applyMatrix=function(t,e){if(!e){var r=dou.recyclable(o.Matrix3);e=r.getNormalMatrix(t),r.recycle()}var i=dou.recyclable(o.Vector3),a=this.getCoplanarPoint(i).applyMatrix(t),n=this.normal.applyMatrix3(e).normalize();return this.constant=-a.dot(n),i.recycle(),this},t.prototype.raycast=function(t,e){var r=t.getDistanceToPlane(this);if(0<r){if(e){var i=e.normal;e.distance=r,t.getPointAt(r,e.position),i&&i.copy(this.normal)}return!0}return!1},t.prototype.fromArray=function(t,e){return void 0===e&&(e=0),this.normal.fromArray(t,e),this.constant=t[e+3],this},t.prototype.fromPoint=function(t,e){return void 0===e&&(e=o.Vector3.UP),this.constant=-e.dot(t),this.normal.copy(e),this},t.prototype.fromPoints=function(t,e,r){var i=dou.recyclable(o.Vector3),a=dou.recyclable(o.Vector3),n=i.subtract(r,e).cross(a.subtract(t,e)).normalize();return this.fromPoint(t,n),i.recycle(),a.recycle(),this},t.prototype.toArray=function(t,e){return void 0===e&&(e=0),t=t||[],this.normal.toArray(t,e),t[e+3]=this.constant,t},t.prototype.copy=function(t){return this.set(t.normal,t.constant)},t.prototype.clone=function(){return new t(this.normal,this.constant)},t.prototype.clear=function(){return this.normal.clear(),this.constant=0,this},t.prototype.onRecycle=function(){this.clear()},t.UP=new t(o.Vector3.UP,0),t.DOWN=new t(o.Vector3.DOWN,0),t.LEFT=new t(o.Vector3.BACK,0),t.RIGHT=new t(o.Vector3.BACK,0),t.FORWARD=new t(o.Vector3.FORWARD,0),t.BACK=new t(o.Vector3.BACK,0),t}();o.Plane=t}(dou3d||(dou3d={})),function(n){var t=function(){function t(t,e){this.origin=new n.Vector3,this.direction=new n.Vector3,this.origin.copy(t||new n.Vector3),this.direction.copy(e||new n.Vector3)}return t.prototype.set=function(t,e){return this.origin.copy(t),this.direction.copy(e),this},t.prototype.applyMatrix=function(t,e){return e=e||this,this.origin.applyMatrix(t,e.origin),this.direction.applyDirection(t,e.direction),this},t.prototype.getClosestPointToPoint=function(t,e){var r=(e=e||new n.Vector3)!=this.origin?this.origin:(new n.Vector3).copy(this.origin),i=this.direction,a=e.subtract(t,r).dot(i);return a<0?e.copy(r):e.copy(i).multiplyScalar(a).add(r)},t.prototype.getPointAt=function(t,e){var r=(e=e||new n.Vector3)!=this.origin?this.origin:(new n.Vector3).copy(this.origin);return e.multiplyScalar(t,this.direction).add(r)},t.prototype.getSquaredDistance=function(t){var e=dou.recyclable(n.Vector3),r=e.subtract(t,this.origin).dot(this.direction);if(r<0)return this.origin.getSquaredDistance(t);var i=this.getPointAt(r,e).getSquaredDistance(t);return e.recycle(),i},t.prototype.getDistance=function(t){return Math.sqrt(this.getSquaredDistance(t))},t.prototype.getDistanceToPlane=function(t){var e=this.origin,r=t.normal,i=r.dot(this.direction);if(0==i)return 0==t.getDistance(e)?0:-1;var a=-(e.dot(r)+t.constant)/i;return 0<=a?a:-1},t.prototype.fromArray=function(t,e){return void 0===e&&(e=0),this.origin.fromArray(t,e),this.direction.fromArray(t,e+3),this},t.prototype.fromPoints=function(t,e){return this.direction.subtract(e,this.origin.copy(t)).normalize(),this},t.prototype.copy=function(t){return this.set(t.origin,t.direction)},t.prototype.clone=function(){return new t(this.origin,this.direction)},t.prototype.clear=function(){return this.origin.clear(),this.direction.clear(),this},t.prototype.onRecycle=function(){this.clear()},t}();n.Ray=t}(dou3d||(dou3d={})),function(e){var t=function(){function t(){this.distance=-1,this.position=new e.Vector3,this.coord=new e.Vector2,this.normal=null}return t.prototype.copy=function(t){return this.distance=t.distance,this.position.copy(t.position),this.coord.copy(t.coord),this.normal&&t.normal&&this.normal.copy(t.normal),this},t.prototype.clear=function(){return this.distance=-1,this.position.set(0,0,0),this.coord.set(0,0),this.normal=null,this},t.prototype.onRecycle=function(){this.clear()},t}();e.RaycastInfo=t}(dou3d||(dou3d={})),function(t){var e=function(){function a(t,e,r,i){void 0===t&&(t=1),void 0===e&&(e=1),void 0===r&&(r=1),void 0===i&&(i=1),this.r=t,this.g=e,this.b=r,this.a=i}return a.lerp=function(t,e,r,i){return(i=i||new a).r=r*(e.r-t.r)+t.r,i.g=r*(e.g-t.g)+t.g,i.b=r*(e.b-t.b)+t.b,i.a=r*(e.a-t.a)+t.a,i},a.prototype.set=function(t,e,r,i){return this.r=t,this.g=e,this.b=r,isNaN(i)||(this.a=i),this},a.prototype.multiply=function(t,e){return e||(e=t),(t=this).r=t.r*e.r,this.g=t.g*e.g,this.b=t.b*e.b,this.a=t.a*e.a,this},a.prototype.scale=function(t,e){return e=e||this,this.r=e.r*t,this.g=e.g*t,this.b=e.b*t,this.a=e.a*t,this},a.prototype.fromArray=function(t,e){return void 0===e&&(e=0),this.r=t[0+e],this.g=t[1+e],this.b=t[2+e],this.a=t[3+e],this},a.prototype.fromHex=function(t){return this.r=(t>>16&255)/255,this.g=(t>>8&255)/255,this.b=(255&t)/255,this},a.prototype.copy=function(t){return this.set(t.r,t.g,t.b,t.a)},a.prototype.clone=function(){return new a(this.r,this.g,this.b,this.a)},a.prototype.clear=function(){return this.r=1,this.g=1,this.b=1,this.a=1,this},a.prototype.onRecycle=function(){this.clear()},a.ZERO=new a(0,0,0,0),a.BLACK=new a(0,0,0,1),a.GRAY=new a(.5,.5,.5,1),a.WHITE=new a(1,1,1,1),a.RED=new a(1,0,0,1),a.GREEN=new a(0,1,0,1),a.BLUE=new a(0,0,1,1),a.YELLOW=new a(1,1,0,1),a.INDIGO=new a(0,1,1,1),a.PURPLE=new a(1,0,1,1),a}();t.Color=e}(dou3d||(dou3d={})),function(e){var t=function(){function t(){this._alpha=1,this._matrix=new e.Matrix4}return Object.defineProperty(t.prototype,"matrix",{get:function(){return this._matrix},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"alpha",{get:function(){return this._alpha},set:function(t){this._alpha=t},enumerable:!0,configurable:!0}),t.prototype.setColor=function(t){var e=16711680&t;e>>=16;var r=65280&t;r>>=8;var i=255&t;e/=255,r/=255,i/=255,this.matrix.identity(),this.scale(e,r,i,this._alpha)},t.prototype.multiply=function(t){this.matrix.multiply(t.matrix),this.alpha*=t.alpha},t.prototype.scale=function(t,e,r,i){void 0===t&&(t=1),void 0===e&&(e=1),void 0===r&&(r=1),void 0===i&&(i=1);var a=this.matrix.rawData;a[0]=t,a[5]=e,a[10]=r,this.alpha*=i},t.prototype.offset=function(t,e,r,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===r&&(r=0),void 0===i&&(i=0);var a=this.matrix.rawData;a[12]+=t,a[13]+=e,a[14]+=r,this.alpha+=i},t.prototype.gray=function(){var t=this.matrix.rawData;t[0]=.2126,t[1]=.7152,t[2]=.0722,t[3]=1,t[4]=.2126,t[5]=.7152,t[6]=.0722,t[7]=1,t[8]=.2126,t[9]=.7152,t[10]=.0722,t[11]=1,t[12]=0,t[13]=0,t[14]=0,t[15]=1},t.prototype.clear=function(){this.matrix.identity(),this.alpha=1},t.prototype.onRecycle=function(){this.clear()},t}();e.ColorTransform=t}(dou3d||(dou3d={})),function(u){var t=function(){function h(t,e){this.beizerPoints=t,this.bezierPointNum=e}return h.createLinearBezier=function(t,e,r){r=2<r?r:3;var i=[],a=function(t,e,r){return(1-t)*e+t*r};i.push(t);for(var n=1;n<=r;n++)i.push(new u.Vector3(a(n/r,t.x,e.x),a(n/r,t.y,t.y),a(n/r,t.z,t.z)));return new h(i,r)},h.createQuadraticBezier=function(t,e,r,i){i=2<i?i:3;for(var a=[],n=function(t,e,r,i){return(1-t)*(1-t)*e+2*t*(1-t)*r+t*t*i},o=1;o<=i;o++)a.push(new u.Vector3(n(o/i,t.x,e.x,r.x),n(o/i,t.y,e.y,r.y),n(o/i,t.z,e.z,r.z)));return new h(a,i)},h.createCubicBezier=function(t,e,r,i,a){a=3<a?a:4;for(var n=[],o=function(t,e,r,i,a){return(1-t)*(1-t)*(1-t)*e+3*t*(1-t)*(1-t)*r+3*t*t*(1-t)*i+t*t*t*a},s=1;s<=a;s++)n.push(new u.Vector3(o(s/a,t.x,e.x,r.x,i.x),o(s/a,t.y,e.y,r.y,i.y),o(s/a,t.z,e.z,r.z,i.z)));return new h(n,a)},h}();u.Curve3=t}(dou3d||(dou3d={})),function(r){var t=function(e){function h(){var t=null!==e&&e.apply(this,arguments)||this;return t.drawType=r.Context3DProxy.gl.STATIC_DRAW,t._vertexFormat=0,t.vertexAttLength=0,t.faceOrBack=!1,t.subGeometrys=[],t._bufferDiry=!0,t._vertexCount=0,t._indexCount=0,t._totalIndexCount=0,t._faceCount=0,t}return __extends(h,e),Object.defineProperty(h.prototype,"bufferDiry",{get:function(){return this._bufferDiry},set:function(t){this._bufferDiry=t},enumerable:!0,configurable:!0}),Object.defineProperty(h.prototype,"vertexCount",{get:function(){return this._vertexCount},set:function(t){if(this._vertexCount!=t){var e=t*this.vertexAttLength,r=null;this.vertexArray?this.vertexCount<t?(r=new Float32Array(e)).set(this.vertexArray):r=this.vertexArray:r=new Float32Array(e),this.vertexArray=r,this._vertexCount=t}},enumerable:!0,configurable:!0}),Object.defineProperty(h.prototype,"indexCount",{get:function(){return this._indexCount},set:function(t){if(this._indexCount=t,this._faceCount=t/3,!(this._totalIndexCount>=t)){var e=new Uint16Array(t);this.indexArray&&e.set(this.indexArray),this.indexArray=e,this._totalIndexCount=t}},enumerable:!0,configurable:!0}),Object.defineProperty(h.prototype,"faceCount",{get:function(){return this._faceCount},set:function(t){this._faceCount!=t&&(this.indexCount=3*t,this._faceCount=t)},enumerable:!0,configurable:!0}),Object.defineProperty(h.prototype,"vertexFormat",{get:function(){return this._vertexFormat},set:function(t){this._vertexFormat=t,1&this.vertexFormat&&(this.vertexAttLength+=h.positionSize),2&this.vertexFormat&&(this.vertexAttLength+=h.normalSize),4&this.vertexFormat&&(this.vertexAttLength+=h.tangentSize),8&this.vertexFormat&&(this.vertexAttLength+=h.colorSize),16&this.vertexFormat&&(this.vertexAttLength+=h.uvSize),32&this.vertexFormat&&(this.vertexAttLength+=h.uv2Size),64&this.vertexFormat&&(this.vertexAttLength+=h.skinSize),this.vertexSizeInBytes=4*this.vertexAttLength},enumerable:!0,configurable:!0}),Object.defineProperty(h.prototype,"skeleton",{get:function(){return this._skeleton},set:function(t){if(t){this._skeleton=t,this.skeletonGPUData=new Float32Array(8*t.jointNum);for(var e=0;e<t.jointNum;++e)this.skeletonGPUData[8*e+3]=1,this.skeletonGPUData[8*e+7]=1}},enumerable:!0,configurable:!0}),h.prototype.getVertexForIndex=function(t,e,r,i){if(void 0===i&&(i=1),r=r||[],t<0||t>=this.vertexCount)return r;for(var a=0;a<i;++a){var n=0;if(1&e&&(1&this.vertexFormat?(r.push(this.vertexArray[t*this.vertexAttLength+n+0]),r.push(this.vertexArray[t*this.vertexAttLength+n+1]),r.push(this.vertexArray[t*this.vertexAttLength+n+2])):r.push(0,0,0)),1&this.vertexFormat&&(n+=h.positionSize),2&e&&(2&this.vertexFormat?(r.push(this.vertexArray[t*this.vertexAttLength+n+0]),r.push(this.vertexArray[t*this.vertexAttLength+n+1]),r.push(this.vertexArray[t*this.vertexAttLength+n+2])):r.push(0,0,0)),2&this.vertexFormat&&(n+=h.normalSize),4&e&&(4&this.vertexFormat?(r.push(this.vertexArray[t*this.vertexAttLength+n+0]),r.push(this.vertexArray[t*this.vertexAttLength+n+1]),r.push(this.vertexArray[t*this.vertexAttLength+n+2])):r.push(0,0,0)),4&this.vertexFormat&&(n+=h.tangentSize),8&e&&(8&this.vertexFormat?(r.push(this.vertexArray[t*this.vertexAttLength+n+0]),r.push(this.vertexArray[t*this.vertexAttLength+n+1]),r.push(this.vertexArray[t*this.vertexAttLength+n+2]),r.push(this.vertexArray[t*this.vertexAttLength+n+3])):r.push(0,0,0,0)),8&this.vertexFormat&&(n+=h.colorSize),16&e&&(16&this.vertexFormat?(r.push(this.vertexArray[t*this.vertexAttLength+n+0]),r.push(this.vertexArray[t*this.vertexAttLength+n+1])):r.push(0,0)),16&this.vertexFormat&&(n+=h.uvSize),32&e&&(32&this.vertexFormat?(r.push(this.vertexArray[t*this.vertexAttLength+n+0]),r.push(this.vertexArray[t*this.vertexAttLength+n+1])):r.push(0,0)),32&this.vertexFormat&&(n+=h.uv2Size),64&e)if(64&this.vertexFormat)for(var o=0;o<h.skinSize;++o)r.push(this.vertexArray[t*this.vertexAttLength+n+o]);else r.push(0,0,0,0,0,0,0,0);64&this.vertexFormat&&(n+=h.skinSize),t++}return r},h.prototype.setVerticesForIndex=function(t,e,r,i){void 0===i&&(i=1),t+i>this.vertexCount&&(this.vertexCount=t+i),this._bufferDiry=!0;for(var a=0,n=0,o=0;o<i;++o){if(a=0,1&this.vertexFormat&&(1&e&&(this.vertexArray[t*this.vertexAttLength+a+0]=r[n+0],this.vertexArray[t*this.vertexAttLength+a+1]=r[n+1],this.vertexArray[t*this.vertexAttLength+a+2]=r[n+2]),a+=h.positionSize),1&e&&(n+=h.positionSize),2&this.vertexFormat&&(2&e&&(this.vertexArray[t*this.vertexAttLength+a+0]=r[n+0],this.vertexArray[t*this.vertexAttLength+a+1]=r[n+1],this.vertexArray[t*this.vertexAttLength+a+2]=r[n+2]),a+=h.normalSize),2&e&&(n+=h.normalSize),4&this.vertexFormat&&(4&e&&(this.vertexArray[t*this.vertexAttLength+a+0]=r[n+0],this.vertexArray[t*this.vertexAttLength+a+1]=r[n+1],this.vertexArray[t*this.vertexAttLength+a+2]=r[n+2]),a+=h.tangentSize),4&e&&(n+=h.tangentSize),8&this.vertexFormat&&(8&e?(this.vertexArray[t*this.vertexAttLength+a+0]=r[n+0],this.vertexArray[t*this.vertexAttLength+a+1]=r[n+1],this.vertexArray[t*this.vertexAttLength+a+2]=r[n+2],this.vertexArray[t*this.vertexAttLength+a+3]=r[n+3]):(this.vertexArray[t*this.vertexAttLength+a+0]=1,this.vertexArray[t*this.vertexAttLength+a+1]=1,this.vertexArray[t*this.vertexAttLength+a+2]=1,this.vertexArray[t*this.vertexAttLength+a+3]=1),a+=h.colorSize),8&e&&(n+=h.colorSize),16&this.vertexFormat&&(16&e&&(this.vertexArray[t*this.vertexAttLength+a+0]=r[n+0],this.vertexArray[t*this.vertexAttLength+a+1]=r[n+1]),a+=h.uvSize),16&e&&(n+=h.uvSize),32&this.vertexFormat&&(32&e&&(this.vertexArray[t*this.vertexAttLength+a+0]=r[n+0],this.vertexArray[t*this.vertexAttLength+a+1]=r[n+1]),a+=h.uv2Size),32&e&&(n+=h.uv2Size),64&this.vertexFormat){if(64&e)for(var s=0;s<h.skinSize;++s)this.vertexArray[t*this.vertexAttLength+a+s]=r[n+s];a+=h.skinSize}64&e&&(n+=h.skinSize),t++}},h.prototype.getVertexIndices=function(t,e,r){if(void 0===e&&(e=-1),void 0===r&&(r=null),r=r||[],t>=this.indexCount)return r;-1==e&&(e=this.indexCount),t+e>this.indexCount&&(e=this.indexCount-t);for(var i=0;i<e;++i)r[i]=this.indexArray[i+t];return r},h.prototype.setVertexIndices=function(t,e){t+e.length>this.indexCount&&(this.indexCount=t+e.length);for(var r=0;r<e.length;++r)this.indexArray[t+r]=e[r]},h.prototype.activeState=function(t){this._bufferDiry&&(this._bufferDiry=!1,this.upload(t,this.drawType)),t.bindVertexBuffer(this.sharedVertexBuffer),t.bindIndexBuffer(this.sharedIndexBuffer)},h.prototype.upload=function(t,e){void 0===e&&(e=r.Context3DProxy.gl.STATIC_DRAW),this.sharedIndexBuffer||this.sharedVertexBuffer?(t.uploadVertexBuffer(this.sharedVertexBuffer),t.uploadIndexBuffer(this.sharedIndexBuffer)):(this.sharedIndexBuffer=t.createIndexBuffer(this.indexArray),this.sharedVertexBuffer=t.createVertexBuffer(this.vertexArray,e))},h.prototype.buildDefaultSubGeometry=function(){var t=new r.SubGeometry;t.matID=0,t.geometry=this,t.start=0,t.count=this.indexCount,this.subGeometrys.push(t)},h.prototype.dispose=function(){this.decRef(),this.canDispose&&(this.sharedIndexBuffer&&(this.sharedIndexBuffer.dispose(),this.sharedIndexBuffer=null),this.sharedVertexBuffer&&(this.sharedVertexBuffer.dispose(),this.sharedVertexBuffer=null),this.vertexArray=null,this.indexArray=null,this.subGeometrys=[])},h.positionSize=3,h.normalSize=3,h.tangentSize=3,h.colorSize=4,h.uvSize=2,h.uv2Size=2,h.skinSize=8,h}(r.Reference);r.Geometry=t}(dou3d||(dou3d={})),function(o){var t=function(){function t(){this._useVertexAttributeList={},this.start=0,this.count=0,this.matID=0,this.preAttList=[]}return t.prototype.activeState=function(t,e){t.attributeDiry&&this.upload(t,e),e.disableAllVertexAttribArray();for(var r=0;r<t.attributeList.length;r++){var i=t.attributeList[r];0<=i.uniformIndex&&e.vertexAttribPointer(i.uniformIndex,i.size,i.dataType,i.normalized,i.stride,i.offsetBytes)}},t.prototype.upload=function(t,e){t.attributeDiry=!1;var r=0;t.attributeList=[],1&this.geometry.vertexFormat&&(t.attribute_position&&(t.attribute_position.uniformIndex||(t.attribute_position.uniformIndex=e.getShaderAttribLocation(t.program3D,t.attribute_position.varName)),t.attribute_position.size=o.Geometry.positionSize,t.attribute_position.dataType=o.Context3DProxy.gl.FLOAT,t.attribute_position.normalized=!1,t.attribute_position.stride=this.geometry.vertexSizeInBytes,t.attribute_position.offsetBytes=r,t.attributeList.push(t.attribute_position),this._useVertexAttributeList[t.attribute_position.uniformIndex]=t.attribute_position.uniformIndex),r+=o.Geometry.positionSize*Float32Array.BYTES_PER_ELEMENT),2&this.geometry.vertexFormat&&(t.attribute_normal&&(t.attribute_normal.uniformIndex||(t.attribute_normal.uniformIndex=e.getShaderAttribLocation(t.program3D,t.attribute_normal.varName)),t.attribute_normal.size=o.Geometry.normalSize,t.attribute_normal.dataType=o.Context3DProxy.gl.FLOAT,t.attribute_normal.normalized=!1,t.attribute_normal.stride=this.geometry.vertexSizeInBytes,t.attribute_normal.offsetBytes=r,t.attributeList.push(t.attribute_normal),this._useVertexAttributeList[t.attribute_normal.uniformIndex]=t.attribute_normal.uniformIndex),r+=o.Geometry.normalSize*Float32Array.BYTES_PER_ELEMENT),4&this.geometry.vertexFormat&&(t.attribute_tangent&&(t.attribute_tangent.uniformIndex||(t.attribute_tangent.uniformIndex=e.getShaderAttribLocation(t.program3D,t.attribute_tangent.varName)),t.attribute_tangent.size=o.Geometry.tangentSize,t.attribute_tangent.dataType=o.Context3DProxy.gl.FLOAT,t.attribute_tangent.normalized=!1,t.attribute_tangent.stride=this.geometry.vertexSizeInBytes,t.attribute_tangent.offsetBytes=r,t.attributeList.push(t.attribute_tangent),this._useVertexAttributeList[t.attribute_tangent.uniformIndex]=t.attribute_tangent.uniformIndex),r+=o.Geometry.tangentSize*Float32Array.BYTES_PER_ELEMENT),8&this.geometry.vertexFormat&&(t.attribute_color&&(t.attribute_color.uniformIndex||(t.attribute_color.uniformIndex=e.getShaderAttribLocation(t.program3D,t.attribute_color.varName)),t.attribute_color.size=o.Geometry.colorSize,t.attribute_color.dataType=o.Context3DProxy.gl.FLOAT,t.attribute_color.normalized=!1,t.attribute_color.stride=this.geometry.vertexSizeInBytes,t.attribute_color.offsetBytes=r,t.attributeList.push(t.attribute_color),this._useVertexAttributeList[t.attribute_color.uniformIndex]=t.attribute_color.uniformIndex),r+=o.Geometry.colorSize*Float32Array.BYTES_PER_ELEMENT),16&this.geometry.vertexFormat&&(t.attribute_uv0&&(t.attribute_uv0.uniformIndex||(t.attribute_uv0.uniformIndex=e.getShaderAttribLocation(t.program3D,t.attribute_uv0.varName)),t.attribute_uv0.size=o.Geometry.uvSize,t.attribute_uv0.dataType=o.Context3DProxy.gl.FLOAT,t.attribute_uv0.normalized=!1,t.attribute_uv0.stride=this.geometry.vertexSizeInBytes,t.attribute_uv0.offsetBytes=r,t.attributeList.push(t.attribute_uv0),this._useVertexAttributeList[t.attribute_uv0.uniformIndex]=t.attribute_uv0.uniformIndex),r+=o.Geometry.uvSize*Float32Array.BYTES_PER_ELEMENT),32&this.geometry.vertexFormat&&(t.attribute_uv1&&(t.attribute_uv1.uniformIndex||(t.attribute_uv1.uniformIndex=e.getShaderAttribLocation(t.program3D,t.attribute_uv1.varName)),t.attribute_uv1.size=o.Geometry.uv2Size,t.attribute_uv1.dataType=o.Context3DProxy.gl.FLOAT,t.attribute_uv1.normalized=!1,t.attribute_uv1.stride=this.geometry.vertexSizeInBytes,t.attribute_uv1.offsetBytes=r,t.attributeList.push(t.attribute_uv1),this._useVertexAttributeList[t.attribute_uv1.uniformIndex]=t.attribute_uv1.uniformIndex),r+=o.Geometry.uv2Size*Float32Array.BYTES_PER_ELEMENT),64&this.geometry.vertexFormat&&(t.attribute_boneIndex&&(t.attribute_boneIndex.uniformIndex||(t.attribute_boneIndex.uniformIndex=e.getShaderAttribLocation(t.program3D,t.attribute_boneIndex.varName)),t.attribute_boneIndex.size=o.Geometry.skinSize/2,t.attribute_boneIndex.dataType=o.Context3DProxy.gl.FLOAT,t.attribute_boneIndex.normalized=!1,t.attribute_boneIndex.stride=this.geometry.vertexSizeInBytes,t.attribute_boneIndex.offsetBytes=r,t.attributeList.push(t.attribute_boneIndex),this._useVertexAttributeList[t.attribute_boneIndex.uniformIndex]=t.attribute_boneIndex.uniformIndex),r+=o.Geometry.skinSize/2*Float32Array.BYTES_PER_ELEMENT,t.attribute_boneWeight&&(t.attribute_boneWeight.uniformIndex||(t.attribute_boneWeight.uniformIndex=e.getShaderAttribLocation(t.program3D,t.attribute_boneWeight.varName)),t.attribute_boneWeight.size=o.Geometry.skinSize/2,t.attribute_boneWeight.dataType=o.Context3DProxy.gl.FLOAT,t.attribute_boneWeight.normalized=!1,t.attribute_boneWeight.stride=this.geometry.vertexSizeInBytes,t.attribute_boneWeight.offsetBytes=r,t.attributeList.push(t.attribute_boneWeight),this._useVertexAttributeList[t.attribute_boneWeight.uniformIndex]=t.attribute_boneWeight.uniformIndex),r+=o.Geometry.skinSize/2*Float32Array.BYTES_PER_ELEMENT);for(var i=0;i<this.preAttList.length;++i){var a=this.preAttList[i],n=t[a.name];n&&(n.uniformIndex||(n.uniformIndex=e.getShaderAttribLocation(t.program3D,n.varName),n.size=a.size,n.dataType=o.Context3DProxy.gl.FLOAT,n.normalized=!1,n.stride=this.geometry.vertexSizeInBytes,n.offsetBytes=r,t.attributeList.push(n),this._useVertexAttributeList[n.uniformIndex]=n.uniformIndex)),r+=a.size*Float32Array.BYTES_PER_ELEMENT}},t}();o.SubGeometry=t}(dou3d||(dou3d={})),function(t){var e=function(a){function t(t,e,r){void 0===t&&(t=80),void 0===e&&(e=80),void 0===r&&(r=80);var i=a.call(this)||this;return i._width=t,i._height=e,i._depth=r,i.buildGeomtry(!0),i}return __extends(t,a),Object.defineProperty(t.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"depth",{get:function(){return this._depth},enumerable:!0,configurable:!0}),t.prototype.buildGeomtry=function(t){this.vertexFormat=63,this.vertexCount=36,this.indexCount=36,this.vertexArray.set([.5*-this._width,.5*-this._height,.5*-this._depth,0,0,-10,1,0,0,1,1,1,1,1,0,0,0,.5*-this._width,.5*this._height,.5*-this._depth,0,0,-10,1,0,0,1,1,1,1,1,1,0,0,.5*this._width,.5*this._height,.5*-this._depth,0,0,-10,1,0,0,1,1,1,1,0,1,0,0,.5*this._width,.5*this._height,.5*-this._depth,0,0,-10,1,0,0,1,1,1,1,0,1,0,0,.5*this._width,.5*-this._height,.5*-this._depth,0,0,-10,1,0,0,1,1,1,1,0,0,0,0,.5*-this._width,.5*-this._height,.5*-this._depth,0,0,-10,1,0,0,1,1,1,1,1,0,0,0,.5*-this._width,.5*-this._height,.5*this._depth,0,0,10,1,0,0,1,1,1,1,0,0,0,0,.5*this._width,.5*-this._height,.5*this._depth,0,0,10,1,0,0,1,1,1,1,1,0,0,0,.5*this._width,.5*this._height,.5*this._depth,0,0,10,1,0,0,1,1,1,1,1,1,0,0,.5*this._width,.5*this._height,.5*this._depth,0,0,10,1,0,0,1,1,1,1,1,1,0,0,.5*-this._width,.5*this._height,.5*this._depth,0,0,10,1,0,0,1,1,1,1,0,1,0,0,.5*-this._width,.5*-this._height,.5*this._depth,0,0,10,1,0,0,1,1,1,1,0,0,0,0,.5*-this._width,.5*-this._height,.5*-this._depth,0,-10,0,1,0,0,1,1,1,1,0,0,0,0,.5*this._width,.5*-this._height,.5*-this._depth,0,-10,0,1,0,0,1,1,1,1,1,0,0,0,.5*this._width,.5*-this._height,.5*this._depth,0,-10,0,1,0,0,1,1,1,1,1,1,0,0,.5*this._width,.5*-this._height,.5*this._depth,0,-10,0,1,0,0,1,1,1,1,1,1,0,0,.5*-this._width,.5*-this._height,.5*this._depth,0,-10,0,1,0,0,1,1,1,1,0,1,0,0,.5*-this._width,.5*-this._height,.5*-this._depth,0,-10,0,1,0,0,1,1,1,1,0,0,0,0,.5*this._width,.5*-this._height,.5*-this._depth,10,0,0,1,0,0,1,1,1,1,0,0,0,0,.5*this._width,.5*this._height,.5*-this._depth,10,0,0,1,0,0,1,1,1,1,1,0,0,0,.5*this._width,.5*this._height,.5*this._depth,10,0,0,1,0,0,1,1,1,1,1,1,0,0,.5*this._width,.5*this._height,.5*this._depth,10,0,0,1,0,0,1,1,1,1,1,1,0,0,.5*this._width,.5*-this._height,.5*this._depth,10,0,0,1,0,0,1,1,1,1,0,1,0,0,.5*this._width,.5*-this._height,.5*-this._depth,10,0,0,1,0,0,1,1,1,1,0,0,0,0,.5*this._width,.5*this._height,.5*-this._depth,0,10,0,1,0,0,1,1,1,1,0,0,0,0,.5*-this._width,.5*this._height,.5*-this._depth,0,10,0,1,0,0,1,1,1,1,1,0,0,0,.5*-this._width,.5*this._height,.5*this._depth,0,10,0,1,0,0,1,1,1,1,1,1,0,0,.5*-this._width,.5*this._height,.5*this._depth,0,10,0,1,0,0,1,1,1,1,1,1,0,0,.5*this._width,.5*this._height,.5*this._depth,0,10,0,1,0,0,1,1,1,1,0,1,0,0,.5*this._width,.5*this._height,.5*-this._depth,0,10,0,1,0,0,1,1,1,1,0,0,0,0,.5*-this._width,.5*this._height,.5*-this._depth,-10,0,0,1,0,0,1,1,1,1,0,0,0,0,.5*-this._width,.5*-this._height,.5*-this._depth,-10,0,0,1,0,0,1,1,1,1,1,0,0,0,.5*-this._width,.5*-this._height,.5*this._depth,-10,0,0,1,0,0,1,1,1,1,1,1,0,0,.5*-this._width,.5*-this._height,.5*this._depth,-10,0,0,1,0,0,1,1,1,1,1,1,0,0,.5*-this._width,.5*this._height,.5*this._depth,-10,0,0,1,0,0,1,1,1,1,0,1,0,0,.5*-this._width,.5*this._height,.5*-this._depth,-10,0,0,1,0,0,1,1,1,1,0,0,0,0]),t?this.indexArray.set([0,2,1,3,5,4,6,8,7,9,11,10,12,14,13,15,17,16,18,20,19,21,23,22,24,26,25,27,29,28,30,32,31,33,35,34]):this.indexArray.set([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35]),this.buildDefaultSubGeometry()},t}(t.Geometry);t.CubeGeometry=e}(dou3d||(dou3d={})),function(c){var t=function(i){function t(t,e){void 0===t&&(t=100),void 0===e&&(e=200);var r=i.call(this)||this;return r._height=t,r._radius=e,r.buildGeomtry(),r}return __extends(t,i),Object.defineProperty(t.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"radius",{get:function(){return this._radius},enumerable:!0,configurable:!0}),t.prototype.buildGeomtry=function(){this.vertexFormat=63;var t=[],e=[],r=20,i=2*Math.PI/20;for(r=0;r<20;r++){var a=this._radius*Math.sin(r*i),n=this._radius*Math.cos(r*i);t.push(a,0+this._height/2,n,a,0,n,1,0,0,1,1,1,1,1,0,0,0,a,0-this._height/2,n,a,0,n,1,0,0,1,1,1,1,1,0,0,0)}var o=t.length/this.vertexAttLength,s=o;t.push(0,0-this._height/2,0,0,-1,0,1,0,0,1,1,1,1,1,0,0,0);var h=1+o;t.push(0,0+this._height/2,0,0,1,0,1,0,0,1,1,1,1,1,0,0,0);for(var u=0;u<o;u++)0!=(1&u)?e.push(u,o<=u+1?u+1-o:u+1,o<=u+2?u+2-o:u+2,s,u,o<=u+2?u+2-o:u+2):e.push(o<=u+1?u+1-o:u+1,u,o<=u+2?u+2-o:u+2,u,h,o<=u+2?u+2-o:u+2);this.setVerticesForIndex(0,this.vertexFormat,t,t.length/this.vertexAttLength),this.setVertexIndices(0,e);var l=new c.SubGeometry;l.geometry=this,l.start=0,l.count=this.indexCount,this.subGeometrys.push(l)},t}(c.Geometry);c.CylinderGeometry=t}(dou3d||(dou3d={})),function(c){var t=function(u){function t(t,e,r,i,a,n,o,s){void 0===t&&(t=500),void 0===e&&(e=500),void 0===r&&(r=1),void 0===i&&(i=1),void 0===a&&(a=1),void 0===n&&(n=1),void 0===o&&(o=!0),void 0===s&&(s=!0);var h=u.call(this)||this;return h._width=t,h._height=e,h._segmentsW=r,h._segmentsH=i,h._scaleU=a,h._scaleV=n,h._wCenter=o,h._hCenter=s,h.buildGeometry(),h}return __extends(t,u),Object.defineProperty(t.prototype,"segmentsW",{get:function(){return this._segmentsW},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"segmentsH",{get:function(){return this._segmentsH},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"scaleU",{get:function(){return this._scaleU},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"scaleV",{get:function(){return this._scaleV},enumerable:!0,configurable:!0}),t.prototype.buildGeometry=function(){var t,e,r,i;this.vertexFormat=31;var a=this._segmentsW+1,n=(this._segmentsH+1)*a,o=this.vertexAttLength-15;r=this._segmentsH*this._segmentsW*6,this.vertexCount=n,this.indexCount=r;for(var s=r=0,h=0;h<=this._segmentsH;++h)for(var u=0;u<=this._segmentsW;++u)if(t=(u/this._segmentsW-.5)*this._width,e=(h/this._segmentsH-.5)*this._height,0==this._wCenter&&(t+=this._width/2),0==this._hCenter&&(e+=this._height/2),this.vertexArray[s++]=t,this.vertexArray[s++]=0,this.vertexArray[s++]=e,this.vertexArray[s++]=0,this.vertexArray[s++]=1,this.vertexArray[s++]=0,this.vertexArray[s++]=1,this.vertexArray[s++]=0,this.vertexArray[s++]=0,this.vertexArray[s++]=1,this.vertexArray[s++]=1,this.vertexArray[s++]=1,this.vertexArray[s++]=1,this.vertexArray[s++]=u/this._segmentsW*this._scaleU,this.vertexArray[s++]=(1-h/this._segmentsH)*this._scaleV,s+=o,u!=this._segmentsW&&h!=this._segmentsH){i=u+h*a;this.indexArray[r++]=1*i,this.indexArray[r++]=1*(i+a+1),this.indexArray[r++]=1*(i+a),this.indexArray[r++]=1*i,this.indexArray[r++]=1*(i+1),this.indexArray[r++]=1*(i+a+1)}var l=new c.SubGeometry;l.geometry=this,l.start=0,l.count=this.indexCount,this.subGeometrys.push(l)},t}(c.Geometry);c.PlaneGeometry=t}(dou3d||(dou3d={})),function(A){var t=function(a){function t(t,e,r){void 0===t&&(t=100),void 0===e&&(e=15),void 0===r&&(r=15);var i=a.call(this)||this;return i._radius=t,i._segmentsW=e,i._segmentsH=r,i.buildSphere(!0),i}return __extends(t,a),Object.defineProperty(t.prototype,"segmentsW",{get:function(){return this._segmentsW},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"segmentsH",{get:function(){return this._segmentsH},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"radius",{get:function(){return this._radius},enumerable:!0,configurable:!0}),t.prototype.buildSphere=function(t){void 0===t&&(t=!0),this.vertexFormat=63;var e=0,r=0,i=0,a=(this._segmentsH+1)*(this._segmentsW+1),n=this.vertexAttLength,o=n-9;this.vertexCount=a,this.indexCount=(this._segmentsH-1)*this._segmentsW*6;var s=0,h=0,u=0,l=0,c=0,d=0;for(r=0;r<=this._segmentsH;++r){s=h;var p=Math.PI*r/this._segmentsH,f=-this._radius*Math.cos(p),m=this._radius*Math.sin(p);for(e=0;e<=this._segmentsW;++e){var _=2*Math.PI*e/this._segmentsW,g=m*Math.cos(_),y=m*Math.sin(_),x=1/Math.sqrt(g*g+y*y+f*f),v=Math.sqrt(y*y+g*g);if(c=0,d=.007<v?g/v:0,u=-f,l=y,e==this._segmentsW?(this.vertexArray[h++]=this.vertexArray[s],this.vertexArray[h++]=this.vertexArray[s+1],this.vertexArray[h++]=this.vertexArray[s+2],this.vertexArray[h++]=g*x,this.vertexArray[h++]=u*x,this.vertexArray[h++]=l*x,this.vertexArray[h++]=.007<v?-y/v:1,this.vertexArray[h++]=c,this.vertexArray[h++]=d,this.vertexArray[h+0]=1):(this.vertexArray[h++]=g,this.vertexArray[h++]=u,this.vertexArray[h++]=l,this.vertexArray[h++]=g*x,this.vertexArray[h++]=u*x,this.vertexArray[h++]=l*x,this.vertexArray[h++]=.007<v?-y/v:1,this.vertexArray[h++]=c,this.vertexArray[h++]=d,this.vertexArray[h]=1),this.vertexArray[h+1]=1,this.vertexArray[h+2]=1,this.vertexArray[h+3]=1,0<e&&0<r){var b=(this._segmentsW+1)*r+e,D=(this._segmentsW+1)*r+e-1,P=(this._segmentsW+1)*(r-1)+e-1,w=(this._segmentsW+1)*(r-1)+e;r==this._segmentsH?(this.vertexArray[h-9]=this.vertexArray[s],this.vertexArray[h-8]=this.vertexArray[s+1],this.vertexArray[h-7]=this.vertexArray[s+2],t?(this.indexArray[i++]=b,this.indexArray[i++]=w,this.indexArray[i++]=P):(this.indexArray[i++]=b,this.indexArray[i++]=P,this.indexArray[i++]=w)):1==r?t?(this.indexArray[i++]=b,this.indexArray[i++]=P,this.indexArray[i++]=D):(this.indexArray[i++]=b,this.indexArray[i++]=D,this.indexArray[i++]=P):t?(this.indexArray[i++]=b,this.indexArray[i++]=w,this.indexArray[i++]=P,this.indexArray[i++]=b,this.indexArray[i++]=P,this.indexArray[i++]=D):(this.indexArray[i++]=b,this.indexArray[i++]=P,this.indexArray[i++]=w,this.indexArray[i++]=b,this.indexArray[i++]=D,this.indexArray[i++]=P)}h+=o}}n=17;this._segmentsH,this._segmentsW;for(o=n-2,h=13,r=0;r<=this._segmentsH;++r)for(e=0;e<=this._segmentsW;++e)this.vertexArray[h++]=e/this._segmentsW,this.vertexArray[h++]=r/this._segmentsH,h+=o;var S=new A.SubGeometry;S.geometry=this,S.start=0,S.count=this.indexCount,this.subGeometrys.push(S)},t}(A.Geometry);A.SphereGeometry=t}(dou3d||(dou3d={})),function(f){var t=function(){function t(){this.vertexAttLength=17,this.vertLen=0,this.faces=0,this.source_indexData=[],this.source_vertexData=[],this.source_vertexColorData=[],this.source_normalData=[],this.source_tangtData=[],this.source_uvData=[],this.source_uv2Data=[],this.source_skinData=[],this.vertexIndex=0,this.indices=[],this.vertices=[],this.normals=[],this.tangts=[],this.verticesColor=[],this.uvs=[],this.uv2s=[],this.skinMesh=[],this.faceNormals=[],this.faceWeights=[],this.vertexIndices=[],this.uvIndices=[],this.uv2Indices=[],this.normalIndices=[],this.colorIndices=[],this.indexIds=[],this.matCount=0,this.material={}}return t.buildGeomtry=function(t,e){var r=new f.Geometry;r.vertexFormat=e,r.vertexCount=3*t.faces,r.indexCount=3*t.faces,r.faceCount=t.faces,r.skeleton=t.skeleton;for(var i=new f.Vector3,a=new f.Vector3(1,1,1),n=new f.Vector4(1,1,1,1),o={u:1,v:0},s={u:1,v:0},h=0,u=0,l=0,c=0;c<t.faces;c++){r.indexArray[3*c+0]=3*c+0,r.indexArray[3*c+1]=3*c+2,r.indexArray[3*c+2]=3*c+1;for(var d=0;d<3;d++)u=3*c+d,u*=r.vertexAttLength,l=0,h=t.vertexIndices[3*c+d]*f.Geometry.positionSize,1&e&&(i.x=t.source_vertexData[h+0],i.y=t.source_vertexData[h+1],i.z=t.source_vertexData[h+2],r.vertexArray[u+l+0]=i.x,r.vertexArray[u+l+1]=i.y,r.vertexArray[u+l+2]=i.z,l+=f.Geometry.positionSize),2&e&&(t.normalIndices&&t.source_normalData&&0<t.source_normalData.length&&(h=t.normalIndices[3*c+d]*f.Geometry.normalSize,a.x=t.source_normalData[h+0],a.y=t.source_normalData[h+1],a.z=t.source_normalData[h+2]),r.vertexArray[u+l+0]=a.x,r.vertexArray[u+l+1]=a.y,r.vertexArray[u+l+2]=a.z,l+=f.Geometry.normalSize),4&e&&(r.vertexArray[u+l+0]=0,r.vertexArray[u+l+1]=0,r.vertexArray[u+l+2]=0,l+=f.Geometry.tangentSize),8&e&&(t.colorIndices&&t.source_vertexColorData&&0<t.source_vertexColorData.length&&(h=t.colorIndices[3*c+d]*f.Geometry.colorSize,n.x=t.source_vertexColorData[h+0],n.y=t.source_vertexColorData[h+1],n.z=t.source_vertexColorData[h+2],n.w=t.source_vertexColorData[h+3]),r.vertexArray[u+l+0]=n.x,r.vertexArray[u+l+1]=n.y,r.vertexArray[u+l+2]=n.z,r.vertexArray[u+l+3]=n.w,l+=f.Geometry.colorSize),16&e&&(t.uvIndices&&t.source_uvData&&0<t.source_uvData.length&&(h=t.uvIndices[3*c+d]*f.Geometry.uvSize,o.u=t.source_uvData[h+0],o.v=t.source_uvData[h+1]),r.vertexArray[u+l+0]=o.u,r.vertexArray[u+l+1]=o.v,l+=f.Geometry.uvSize),32&e&&(t.uv2Indices&&t.source_uv2Data&&0<t.source_uv2Data.length&&(h=t.uv2Indices[3*c+d]*f.Geometry.uv2Size,s.u=t.source_uv2Data[h+0],s.v=t.source_uv2Data[h+1]),r.vertexArray[u+l+0]=s.u,r.vertexArray[u+l+1]=s.v,l+=f.Geometry.uv2Size),64&e&&(t.source_skinData&&0<t.source_skinData.length?(h=t.vertexIndices[3*c+d]*f.Geometry.skinSize,r.vertexArray[u+l+0]=t.source_skinData[h+0],r.vertexArray[u+l+1]=t.source_skinData[h+2],r.vertexArray[u+l+2]=t.source_skinData[h+4],r.vertexArray[u+l+3]=t.source_skinData[h+6],r.vertexArray[u+l+4]=t.source_skinData[h+1],r.vertexArray[u+l+5]=t.source_skinData[h+3],r.vertexArray[u+l+6]=t.source_skinData[h+5],r.vertexArray[u+l+7]=t.source_skinData[h+7]):(r.vertexArray[u+l+0]=0,r.vertexArray[u+l+1]=0,r.vertexArray[u+l+2]=0,r.vertexArray[u+l+3]=0,r.vertexArray[u+l+4]=0,r.vertexArray[u+l+5]=0,r.vertexArray[u+l+6]=0,r.vertexArray[u+l+7]=0))}for(d=0;d<t.matCount;++d){var p=new f.SubGeometry;p.matID=d,p.geometry=r,p.start=3*t.material[d].start*Uint16Array.BYTES_PER_ELEMENT,p.count=3*t.material[d].count,p.textureDiffuse=t.material[d].textureDiffuse,p.textureNormal=t.material[d].textureNormal,p.textureSpecular=t.material[d].textureSpecular,r.subGeometrys.push(p)}return r},t}();f.GeometryCreator=t}(dou3d||(dou3d={})),function(r){var t=function(e){function t(){var t=e.call(this)||this;return t._color=16777215,t._intensity=1,t._change=!0,t._colorVec4=new r.Vector4(1,1,1),t._direction=new r.Vector3,t}return __extends(t,e),Object.defineProperty(t.prototype,"lightType",{get:function(){return this._lightType},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"intensity",{get:function(){return this._intensity},set:function(t){this._intensity!=t&&(this._intensity=t,this._change=!1)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"color",{get:function(){return this._color},set:function(t){this._color=t,this._colorVec4.w=(t>>24&255)/255,this._colorVec4.x=(t>>16&255)/255,this._colorVec4.y=(t>>8&255)/255,this._colorVec4.z=(255&t)/255,this._change=!1},enumerable:!0,configurable:!0}),t.prototype.onTransformUpdate=function(){e.prototype.onTransformUpdate.call(this),this._globalMatrix.forward(this._direction)},t.prototype.updateLightData=function(t,e,r){this.validateTransformNow()},t}(r.ObjectContainer3D);r.LightBase=t}(dou3d||(dou3d={})),function(t){var e=function(i){function a(t){void 0===t&&(t=16777215);var e=i.call(this)||this;return e._lightType=1,e.color=t,e}return __extends(a,i),a.prototype.updateLightData=function(t,e,r){i.prototype.updateLightData.call(this,t,e,r),r[e*a.stride]=this._direction.x,r[e*a.stride+1]=this._direction.y,r[e*a.stride+2]=this._direction.z,r[e*a.stride+3]=this._colorVec4.x*this._intensity,r[e*a.stride+4]=this._colorVec4.y*this._intensity,r[e*a.stride+5]=this._colorVec4.z*this._intensity},a.stride=6,a}(t.LightBase);t.DirectLight=e}(dou3d||(dou3d={})),function(t){var e=function(i){function a(t){void 0===t&&(t=16777215);var e=i.call(this)||this;return e._radius=100,e._lightType=0,e.color=t,e}return __extends(a,i),Object.defineProperty(a.prototype,"radius",{get:function(){return this._radius},set:function(t){this._radius=t},enumerable:!0,configurable:!0}),a.prototype.updateLightData=function(t,e,r){i.prototype.updateLightData.call(this,t,e,r),r[e*a.stride]=this.globalPosition.x,r[e*a.stride+1]=this.globalPosition.y,r[e*a.stride+2]=this.globalPosition.z,r[e*a.stride+3]=this._colorVec4.x*this._intensity,r[e*a.stride+4]=this._colorVec4.y*this._intensity,r[e*a.stride+5]=this._colorVec4.z*this._intensity,r[e*a.stride+6]=this._radius},a.stride=7,a}(t.LightBase);t.PointLight=e}(dou3d||(dou3d={})),function(n){var t=function(i){function a(t){void 0===t&&(t=16777215);var e=i.call(this)||this;return e._range=10,e._angle=60,e._penumbra=0,e._lightType=2,e.color=t,e}return __extends(a,i),Object.defineProperty(a.prototype,"range",{get:function(){return this._range},set:function(t){this._range=t},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"angle",{get:function(){return this._angle},set:function(t){this._angle=t},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"penumbra",{get:function(){return this._penumbra},set:function(t){this._penumbra=t},enumerable:!0,configurable:!0}),a.prototype.updateLightData=function(t,e,r){i.prototype.updateLightData.call(this,t,e,r),r[e*a.stride]=this.globalPosition.x,r[e*a.stride+1]=this.globalPosition.y,r[e*a.stride+2]=this.globalPosition.z,r[e*a.stride+3]=this._direction.x,r[e*a.stride+4]=this._direction.y,r[e*a.stride+5]=this._direction.z,r[e*a.stride+6]=this._colorVec4.x*this._intensity,r[e*a.stride+7]=this._colorVec4.y*this._intensity,r[e*a.stride+8]=this._colorVec4.z*this._intensity,r[e*n.PointLight.stride+9]=this._range,r[e*n.PointLight.stride+10]=Math.cos(.5*this._angle*n.MathUtil.DEG_RAD),r[e*n.PointLight.stride+11]=Math.cos(.5*this._angle*n.MathUtil.DEG_RAD*(1-this._penumbra))},a.stride=12,a}(n.LightBase);n.SpotLight=t}(dou3d||(dou3d={})),function(t){var e=function(){function t(){this._lightNum=0,this._directList=[],this._spotList=[],this._pointList=[]}return Object.defineProperty(t.prototype,"lightNum",{get:function(){return this._lightNum},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"directList",{get:function(){return this._directList},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"spotList",{get:function(){return this._spotList},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"pointList",{get:function(){return this._pointList},enumerable:!0,configurable:!0}),t.prototype.addLight=function(t){switch(t.lightType){case 1:this._directList.push(t),this._lightNum++;break;case 0:this._pointList.push(t),this._lightNum++;break;case 2:this._spotList.push(t),this._lightNum++}},t.prototype.removeLight=function(t){switch(t.lightType){case 1:0<=(e=this._directList.indexOf(t))&&e<this._directList.length&&(this._directList.splice(e,1),this._lightNum--);break;case 0:0<=(e=this._pointList.indexOf(t))&&e<this._pointList.length&&(this._pointList.splice(e,1),this._lightNum--);break;case 2:var e;0<=(e=this._spotList.indexOf(t))&&e<this._spotList.length&&(this._spotList.splice(e,1),this._lightNum--)}},t}();t.LightGroup=e}(dou3d||(dou3d={})),function(e){var t=function(){function t(){}return t.prototype.load=function(t,e,r){var i=this,a=new dou.ImageLoader;a.crossOrigin=!0,a.on(dou.Event.COMPLETE,function(){e.call(r,t,i.createTexture(a.data))}),a.on(dou.IOErrorEvent.IO_ERROR,function(){e.call(r,t)}),a.load(t)},t.prototype.createTexture=function(t){return new e.ImageTexture(t)},t.prototype.release=function(t){return!!t&&(t.dispose(),!0)},t}();e.TextureAnalyzer=t}(dou3d||(dou3d={})),function(_){var t=function(){function t(){}return t.prototype.load=function(e,r,i){var a=this,n=new dou.HttpRequest;n.responseType=dou.HttpResponseType.arraybuffer,n.on(dou.Event.COMPLETE,function(t){r.call(i,e,a.createGeometry(n.response))},this),n.on(dou.IOErrorEvent.IO_ERROR,function(t){r.call(i,e)},this),n.open(e,dou.HttpMethod.GET),n.send()},t.prototype.createGeometry=function(t){var e=new dou.ByteArray(t);e.position=3;var r=e.readUnsignedInt(),i=new _.GeometryCreator;switch(r){case 1:this.parseVersion_1(e,i);break;case 2:this.parseVersion_2(e,i);break;case 3:this.parseVersion_3(e,i);break;default:return console.error("ESM version error : "+r),null}var a=0;return a=0<i.source_skinData.length?95:63,_.GeometryCreator.buildGeomtry(i,a)},t.prototype.parseVersion_1=function(t,e){var r=t.readInt();e.matCount=t.readInt();for(var i=0;i<e.matCount;++i)e.material[i]={},e.material[i].matID=t.readInt(),e.material[i].start=t.readInt(),e.material[i].count=t.readInt(),e.material[i].textureDiffuse=t.readUTF(),e.material[i].textureNormal=t.readUTF(),e.material[i].textureSpecular=t.readUTF();if(1&r){var a=t.readInt();for(i=0;i<a;i++)e.source_vertexData.push(t.readFloat()),e.source_vertexData.push(t.readFloat()),e.source_vertexData.push(t.readFloat())}if(2&r){var n=t.readInt();for(i=0;i<n;i++)e.source_normalData.push(t.readFloat()),e.source_normalData.push(t.readFloat()),e.source_normalData.push(t.readFloat())}if(8&r){var o=t.readInt();for(i=0;i<o;i++)e.source_vertexColorData.push(t.readFloat()),e.source_vertexColorData.push(t.readFloat()),e.source_vertexColorData.push(t.readFloat()),e.source_vertexColorData.push(t.readFloat())}if(16&r){var s=t.readInt();for(i=0;i<s;i++)e.source_uvData.push(t.readFloat()),e.source_uvData.push(t.readFloat())}if(32&r)for(s=t.readInt(),i=0;i<s;i++)e.source_uv2Data.push(t.readFloat()),e.source_uv2Data.push(t.readFloat());e.faces=t.readInt();for(i=0;i<e.faces;i++)e.vertexIndices.push(t.readUnsignedInt()),e.vertexIndices.push(t.readUnsignedInt()),e.vertexIndices.push(t.readUnsignedInt()),2&r&&(e.normalIndices.push(t.readUnsignedInt()),e.normalIndices.push(t.readUnsignedInt()),e.normalIndices.push(t.readUnsignedInt())),8&r&&(e.colorIndices.push(t.readUnsignedInt()),e.colorIndices.push(t.readUnsignedInt()),e.colorIndices.push(t.readUnsignedInt())),16&r&&(e.uvIndices.push(t.readUnsignedInt()),e.uvIndices.push(t.readUnsignedInt()),e.uvIndices.push(t.readUnsignedInt())),32&r&&(e.uv2Indices.push(t.readUnsignedInt()),e.uv2Indices.push(t.readUnsignedInt()),e.uv2Indices.push(t.readUnsignedInt()));var h=t.readUnsignedByte();0<h&&(e.skeleton=new _.Skeleton);var u=new _.Vector3,l=new _.Vector3,c=new _.Vector3;for(i=0;i<h;++i){var d=new _.Joint(null);t.readInt(),d.parentIndex=t.readInt(),d.name=t.readUTF(),u.x=t.readFloat()*_.MathUtil.RAD_DEG,u.y=t.readFloat()*_.MathUtil.RAD_DEG,u.z=t.readFloat()*_.MathUtil.RAD_DEG,l.x=t.readFloat(),l.y=t.readFloat(),l.z=t.readFloat(),c.x=t.readFloat(),c.y=t.readFloat(),c.z=t.readFloat(),d.buildInverseMatrix(l,u,c),e.skeleton.joints.push(d)}var p=t.readInt();for(i=0;i<p;i++){for(var f=t.readUnsignedByte(),m=0;m<f;m++)e.source_skinData.push(t.readUnsignedByte()),e.source_skinData.push(t.readFloat());for(m=f;m<4;m++)e.source_skinData.push(0),e.source_skinData.push(0)}},t.prototype.parseVersion_2=function(t,e){var r=t.readInt();e.matCount=t.readInt();for(var i=0;i<e.matCount;++i)e.material[i]={},e.material[i].matID=t.readInt(),e.material[i].start=t.readInt(),e.material[i].count=t.readInt(),e.material[i].textureDiffuse=t.readUTF(),e.material[i].textureNormal=t.readUTF(),e.material[i].textureSpecular=t.readUTF();if(1&r){var a=t.readInt();for(i=0;i<a;i++)e.source_vertexData.push(t.readFloat()),e.source_vertexData.push(t.readFloat()),e.source_vertexData.push(t.readFloat())}if(2&r){var n=t.readInt();for(i=0;i<n;i++)e.source_normalData.push(t.readFloat()),e.source_normalData.push(t.readFloat()),e.source_normalData.push(t.readFloat())}if(8&r){var o=t.readInt();for(i=0;i<o;i++)e.source_vertexColorData.push(t.readUnsignedByte()/255),e.source_vertexColorData.push(t.readUnsignedByte()/255),e.source_vertexColorData.push(t.readUnsignedByte()/255),e.source_vertexColorData.push(t.readUnsignedByte()/255)}if(16&r){var s=t.readInt();for(i=0;i<s;i++)e.source_uvData.push(t.readFloat()),e.source_uvData.push(t.readFloat())}if(32&r)for(s=t.readInt(),i=0;i<s;i++)e.source_uv2Data.push(t.readFloat()),e.source_uv2Data.push(t.readFloat());e.faces=t.readInt();for(i=0;i<e.faces;i++)e.vertexIndices.push(t.readUnsignedShort()),e.vertexIndices.push(t.readUnsignedShort()),e.vertexIndices.push(t.readUnsignedShort()),2&r&&(e.normalIndices.push(t.readUnsignedShort()),e.normalIndices.push(t.readUnsignedShort()),e.normalIndices.push(t.readUnsignedShort())),8&r&&(e.colorIndices.push(t.readUnsignedShort()),e.colorIndices.push(t.readUnsignedShort()),e.colorIndices.push(t.readUnsignedShort())),16&r&&(e.uvIndices.push(t.readUnsignedShort()),e.uvIndices.push(t.readUnsignedShort()),e.uvIndices.push(t.readUnsignedShort())),32&r&&(e.uv2Indices.push(t.readUnsignedShort()),e.uv2Indices.push(t.readUnsignedShort()),e.uv2Indices.push(t.readUnsignedShort()));var h=t.readUnsignedByte();0<h&&(e.skeleton=new _.Skeleton);var u=new _.Vector3,l=new _.Vector3,c=new _.Vector3;for(i=0;i<h;++i){var d=new _.Joint(null);t.readInt(),d.parentIndex=t.readInt(),d.name=t.readUTF(),u.x=t.readFloat()*_.MathUtil.RAD_DEG,u.y=t.readFloat()*_.MathUtil.RAD_DEG,u.z=t.readFloat()*_.MathUtil.RAD_DEG,l.x=t.readFloat(),l.y=t.readFloat(),l.z=t.readFloat(),c.x=t.readFloat(),c.y=t.readFloat(),c.z=t.readFloat(),d.buildInverseMatrix(l,u,c),e.skeleton.joints.push(d)}var p=t.readInt();for(i=0;i<p;i++){for(var f=t.readUnsignedByte(),m=0;m<f;m++)e.source_skinData.push(t.readUnsignedByte()),e.source_skinData.push(t.readFloat());for(m=f;m<4;m++)e.source_skinData.push(0),e.source_skinData.push(0)}},t.prototype.parseVersion_3=function(t,e){var r=t.readInt();e.matCount=t.readInt();for(var i=0;i<e.matCount;++i)e.material[i]={},e.material[i].matID=t.readInt(),e.material[i].start=t.readInt(),e.material[i].count=t.readInt(),e.material[i].textureDiffuse=t.readUTF(),e.material[i].textureNormal=t.readUTF(),e.material[i].textureSpecular=t.readUTF();if(1&r){var a=t.readInt();for(i=0;i<a;i++)e.source_vertexData.push(t.readFloat()),e.source_vertexData.push(t.readFloat()),e.source_vertexData.push(t.readFloat())}if(2&r){var n=t.readInt();for(i=0;i<n;i++)e.source_normalData.push(t.readFloat()),e.source_normalData.push(t.readFloat()),e.source_normalData.push(t.readFloat())}if(8&r){var o=t.readInt();for(i=0;i<o;i++)e.source_vertexColorData.push(t.readUnsignedByte()/255),e.source_vertexColorData.push(t.readUnsignedByte()/255),e.source_vertexColorData.push(t.readUnsignedByte()/255),e.source_vertexColorData.push(t.readUnsignedByte()/255)}if(16&r){var s=t.readInt();for(i=0;i<s;i++)e.source_uvData.push(t.readFloat()),e.source_uvData.push(t.readFloat())}if(32&r)for(s=t.readInt(),i=0;i<s;i++)e.source_uv2Data.push(t.readFloat()),e.source_uv2Data.push(t.readFloat());e.faces=t.readInt();for(i=0;i<e.faces;i++)e.vertexIndices.push(t.readUnsignedShort()),e.vertexIndices.push(t.readUnsignedShort()),e.vertexIndices.push(t.readUnsignedShort()),2&r&&(e.normalIndices.push(t.readUnsignedShort()),e.normalIndices.push(t.readUnsignedShort()),e.normalIndices.push(t.readUnsignedShort())),8&r&&(e.colorIndices.push(t.readUnsignedShort()),e.colorIndices.push(t.readUnsignedShort()),e.colorIndices.push(t.readUnsignedShort())),16&r&&(e.uvIndices.push(t.readUnsignedShort()),e.uvIndices.push(t.readUnsignedShort()),e.uvIndices.push(t.readUnsignedShort())),32&r&&(e.uv2Indices.push(t.readUnsignedShort()),e.uv2Indices.push(t.readUnsignedShort()),e.uv2Indices.push(t.readUnsignedShort()));var h=t.readUnsignedByte();0<h&&(e.skeleton=new _.Skeleton);var u=new _.Quaternion,l=new _.Vector3,c=new _.Vector3;for(i=0;i<h;++i){var d=new _.Joint(null);t.readInt(),d.parentIndex=t.readInt(),d.name=t.readUTF(),u.x=t.readFloat(),u.y=t.readFloat(),u.z=t.readFloat(),u.w=t.readFloat(),l.x=t.readFloat(),l.y=t.readFloat(),l.z=t.readFloat(),c.x=t.readFloat(),c.y=t.readFloat(),c.z=t.readFloat(),d.buildInverseMatrix(l,u,c),e.skeleton.joints.push(d)}var p=t.readInt();for(i=0;i<p;i++){for(var f=t.readUnsignedByte(),m=0;m<f;m++)e.source_skinData.push(t.readUnsignedByte()),e.source_skinData.push(t.readFloat());for(m=f;m<4;m++)e.source_skinData.push(0),e.source_skinData.push(0)}},t.prototype.release=function(t){return!0},t}();_.ESMAnalyzer=t}(dou3d||(dou3d={})),function(p){var t=function(){function t(){}return t.prototype.load=function(e,r,i){var a=this,n=new dou.HttpRequest;n.responseType=dou.HttpResponseType.arraybuffer,n.on(dou.Event.COMPLETE,function(t){r.call(i,e,a.createClip(n.response))},this),n.on(dou.IOErrorEvent.IO_ERROR,function(t){r.call(i,e)},this),n.open(e,dou.HttpMethod.GET),n.send()},t.prototype.createClip=function(t){var e=new dou.ByteArray(t);e.position=3;var r,i=e.readUnsignedInt();switch(i){case 1:r=this.parseVersion_1(e);break;case 2:r=this.parseVersion_2(e);break;default:return console.error("EAM version error : "+i),null}return r},t.prototype.parseVersion_1=function(t){var e=t.readUnsignedByte();t.readUnsignedByte();if(e<=0)return null;for(var r=new p.SkeletonAnimationClip,i=[],a=[],n=0;n<e;n++)i.push(t.readUTF()),a.push(t.readUTF());t.readInt();var o=t.readInt(),s=new p.Quaternion,h=new p.Vector3,u=new p.Vector3;for(n=0;n<o;n++){var l=new p.SkeletonPose;l.frameTime=t.readInt()/60/80*1e3;for(var c=0;c<e;c++){var d=new p.Joint(i[c]);d.parent=a[c],d.parentIndex=l.findJointIndex(d.parent),s.fromEuler(t.readFloat(),t.readFloat(),t.readFloat(),6),h.x=t.readFloat(),h.y=t.readFloat(),h.z=t.readFloat(),u.x=t.readFloat(),u.y=t.readFloat(),u.z=t.readFloat(),d.buildLocalMatrix(h,s,u),l.joints.push(d)}l.calculateJointWorldMatrix(),r.addSkeletonPose(l)}return r},t.prototype.parseVersion_2=function(t){var e=t.readUnsignedByte();t.readUnsignedByte();if(e<=0)return null;for(var r=new p.SkeletonAnimationClip,i=[],a=[],n=0;n<e;n++)i.push(t.readUTF()),a.push(t.readUTF());t.readInt();var o=t.readInt(),s=new p.Quaternion,h=new p.Vector3,u=new p.Vector3;for(n=0;n<o;n++){var l=new p.SkeletonPose;l.frameTime=t.readInt()/60/80*1e3;for(var c=0;c<e;c++){var d=new p.Joint(i[c]);d.parent=a[c],d.parentIndex=l.findJointIndex(d.parent),s.x=t.readFloat(),s.y=t.readFloat(),s.z=t.readFloat(),s.w=t.readFloat(),h.x=t.readFloat(),h.y=t.readFloat(),h.z=t.readFloat(),u.x=t.readFloat(),u.y=t.readFloat(),u.z=t.readFloat(),d.buildLocalMatrix(h,s,u),l.joints.push(d)}l.calculateJointWorldMatrix(),r.addSkeletonPose(l)}return r},t.prototype.release=function(t){return!0},t}();p.EAMAnalyzer=t}(dou3d||(dou3d={})),function(t){var e=function(){function r(){this.shaderPhaseTypes={},this.drawMode=t.Context3DProxy.gl.TRIANGLES,this.useMipmap=!0,this.castShadow=!1,this.acceptShadow=!1,this.shadowColor=new Float32Array([.2,.2,.2,.003]),this.depthTest=!0,this.depthMode=0,this.blendMode=2,this.alphaBlending=!1,this.ambientColor=3355443,this.diffuseColor=16777215,this.specularColor=16777215,this.tintColor=2155905152,this.specularLevel=50,this.gloss=20,this.cutAlpha=0,this.repeat=!1,this.bothside=!1,this.alpha=1,this.albedo=.95,this.uvRectangle=new t.Rectangle(0,0,1,1),this.materialDataNeedChange=!0,this.textureChange=!1,this.textureStateChage=!0,this.cullFrontOrBack=t.Context3DProxy.gl.BACK,this.materialSourceData=new Float32Array(20)}return r.prototype.clone=function(){var t=new r;t.drawMode=this.drawMode,t.diffuseTexture=this.diffuseTexture,t.diffuseTexture3D=this.diffuseTexture3D,t.shadowMapTexture=this.shadowMapTexture;for(var e=0;e<4;++e)t.shadowColor[e]=this.shadowColor[e];return t.castShadow=this.castShadow,t.acceptShadow=this.acceptShadow,t.depthTest=this.depthTest,t.blendMode=this.blendMode,t.blendSrc=this.blendSrc,t.blendDest=this.blendDest,t.ambientColor=this.ambientColor,t.diffuseColor=this.diffuseColor,t.specularColor=this.specularColor,t.cutAlpha=this.cutAlpha,t.alpha=this.alpha,t.specularLevel=this.specularLevel,t.gloss=this.gloss,t.albedo=this.albedo,t.materialDataNeedChange=this.materialDataNeedChange,t.textureChange=!0,t.cullFrontOrBack=this.cullFrontOrBack,t},r.prototype.dispose=function(){},r}();t.MaterialData=e}(dou3d||(dou3d={})),function(e){var t=function(){function t(t){this._passes=[],this.materialData=t||new e.MaterialData}return Object.defineProperty(t.prototype,"passes",{get:function(){return this._passes},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"diffusePass",{get:function(){return this._passes[0][0]},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"materialData",{get:function(){return this._materialData},set:function(t){this._materialData=t,this.initPass(),this.blendMode=2},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"lightGroup",{get:function(){return this._lightGroup},set:function(t){if(this._lightGroup=t,this._passes[0]&&0<this._passes[0].length)for(var e=0;e<this._passes[0].length;e++)this._passes[0][e].lightGroup=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"depth",{get:function(){return this._materialData.depthTest},set:function(t){this._materialData.depthTest=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"depthMode",{get:function(){return this._materialData.depthMode},set:function(t){this._materialData.depthMode=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"diffuseTexture",{get:function(){return this._materialData.diffuseTexture},set:function(t){t&&(this._materialData.diffuseTexture=t,this._materialData.textureChange=!0,this._materialData.shaderPhaseTypes[0]&&!this._materialData.shaderPhaseTypes[0].contains(e.ShaderPhaseType.diffuse_fragment)&&this._materialData.shaderPhaseTypes[0].push(e.ShaderPhaseType.diffuse_fragment),this._materialData.shaderPhaseTypes[1]&&!this._materialData.shaderPhaseTypes[1].contains(e.ShaderPhaseType.diffuse_fragment)&&this._materialData.shaderPhaseTypes[1].push(e.ShaderPhaseType.diffuse_fragment))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"normalTexture",{get:function(){return this._materialData.normalTexture},set:function(t){t&&(this._materialData.normalTexture=t,this._materialData.textureChange=!0,this._materialData.shaderPhaseTypes[0]&&!this._materialData.shaderPhaseTypes[0].contains(e.ShaderPhaseType.normal_fragment)&&(this._materialData.shaderPhaseTypes[0].push(e.ShaderPhaseType.normal_fragment),this.passInvalid(0)))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"specularTexture",{get:function(){return this._materialData.specularTexture},set:function(t){t&&(this._materialData.specularTexture=t,this._materialData.textureChange=!0,this._materialData.shaderPhaseTypes[0]&&!this._materialData.shaderPhaseTypes[0].contains(e.ShaderPhaseType.specular_fragment)&&this._materialData.shaderPhaseTypes[0].push(e.ShaderPhaseType.specular_fragment))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"drawMode",{get:function(){return this._materialData.drawMode},set:function(t){this._materialData.drawMode=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"cutAlpha",{get:function(){return this._materialData.cutAlpha},set:function(t){this._materialData.cutAlpha=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"diffuseColor",{get:function(){return this._materialData.diffuseColor},set:function(t){this._materialData.materialDataNeedChange=!0,this._materialData.diffuseColor=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"ambientColor",{get:function(){return this._materialData.ambientColor},set:function(t){this._materialData.materialDataNeedChange=!0,this._materialData.ambientColor=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"specularColor",{get:function(){return this._materialData.specularColor},set:function(t){this._materialData.materialDataNeedChange=!0,this._materialData.specularColor=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"tintColor",{get:function(){return this._materialData.tintColor},set:function(t){this._materialData.materialDataNeedChange=!0,this._materialData.tintColor=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"alpha",{get:function(){return this._materialData.alpha},set:function(t){this._materialData.alpha!=t&&(this._materialData.alpha=t,this._materialData.materialDataNeedChange=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"alphaBlending",{get:function(){return this._materialData.alphaBlending},set:function(t){this._materialData.alphaBlending!=t&&(this._materialData.alphaBlending=t,this._materialData.materialDataNeedChange=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"specularLevel",{get:function(){return this._materialData.specularLevel},set:function(t){this._materialData.specularLevel!=t&&(this._materialData.specularLevel=t,this._materialData.materialDataNeedChange=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"gloss",{get:function(){return this._materialData.gloss},set:function(t){this._materialData.gloss!=t&&(this._materialData.gloss=t,this._materialData.materialDataNeedChange=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"uvRectangle",{get:function(){return this._materialData.uvRectangle},set:function(t){this._materialData.uvRectangle.x=t.x,this._materialData.uvRectangle.y=t.y,this._materialData.uvRectangle.w=t.w,this._materialData.uvRectangle.h=t.h,this._materialData.materialDataNeedChange=!0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"castShadow",{get:function(){return this._materialData.castShadow},set:function(t){(this._materialData.castShadow=t)?(e.ShadowCast.instance.enableShadow=!0,this.addPass(1)):this._passes[1]&&(this.disposePass(1),this._passes[1]=null)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"acceptShadow",{get:function(){return this._materialData.acceptShadow},set:function(t){this._materialData.acceptShadow!=t&&(this._materialData.acceptShadow=t,this._materialData.acceptShadow?(this._shadowMethod=new e.ShadowMethod(this),this._shadowMethod.shadowMapTexture=e.ShadowCast.instance.shadowRender.renderTexture,this.diffusePass.addMethod(this._shadowMethod)):this._shadowMethod&&this.diffusePass.removeMethod(this._shadowMethod))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"shadowColor",{get:function(){var t=0;return t|=255*this._materialData.shadowColor[0]<<16,t|=255*this._materialData.shadowColor[1]<<8,t|=255*this._materialData.shadowColor[2]},set:function(t){this._materialData.shadowColor[0]=t>>16&1,this._materialData.shadowColor[1]=t>>8&1,this._materialData.shadowColor[2]=1&t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"shadowOffset",{get:function(){return this._materialData.shadowColor[3]},set:function(t){this._materialData.shadowColor[3]=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"repeat",{get:function(){return this._materialData.repeat},set:function(t){this._materialData.repeat=t,this._materialData.textureStateChage=!0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"bothside",{get:function(){return this._materialData.bothside},set:function(t){this._materialData.textureStateChage=!0,this._materialData.bothside=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"cullMode",{get:function(){return this._materialData.cullFrontOrBack},set:function(t){this._materialData.textureStateChage=!0,this._materialData.cullFrontOrBack=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"blendMode",{get:function(){return this._materialData.blendMode},set:function(t){switch(this._materialData.textureStateChage=!0,this._materialData.blendMode=t){case 2:this._materialData.blendSrc=e.Context3DProxy.gl.ONE,this._materialData.blendDest=e.Context3DProxy.gl.ONE_MINUS_SRC_ALPHA,this._materialData.alphaBlending=!1;break;case 1:this._materialData.blendSrc=e.Context3DProxy.gl.SRC_ALPHA,this._materialData.blendDest=e.Context3DProxy.gl.ZERO,this._materialData.alphaBlending=!0;break;case 3:this._materialData.blendSrc=e.Context3DProxy.gl.ZERO,this._materialData.blendDest=e.Context3DProxy.gl.SRC_COLOR,this._materialData.alphaBlending=!0;break;case 4:this._materialData.blendSrc=e.Context3DProxy.gl.SRC_ALPHA,this._materialData.blendDest=e.Context3DProxy.gl.ONE,this._materialData.alphaBlending=!0;break;case 8:this._materialData.blendSrc=e.Context3DProxy.gl.SRC_COLOR,this._materialData.blendDest=e.Context3DProxy.gl.ONE,this._materialData.alphaBlending=!0;break;case 0:this._materialData.blendSrc=e.Context3DProxy.gl.ONE,this._materialData.blendDest=e.Context3DProxy.gl.ONE_MINUS_SRC_ALPHA,this._materialData.alphaBlending=!0;break;case 7:this._materialData.blendSrc=e.Context3DProxy.gl.ONE,this._materialData.blendDest=e.Context3DProxy.gl.ONE_MINUS_SRC_COLOR}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"pointSize",{get:function(){return this._materialData.specularLevel},set:function(t){t!=this._materialData.specularLevel&&(this._materialData.specularLevel=t,this._materialData.textureStateChage=!0)},enumerable:!0,configurable:!0}),t.prototype.initPass=function(){this.addPass(0)},t.prototype.passInvalid=function(t){if(this._passes[t]&&0<this._passes[t].length)for(var e=0;e<this._passes[t].length;e++)this._passes[t][e].passInvalid()},t.prototype.addPass=function(t){this._passes[t]=e.PassUtil.createPass(t,this._materialData)},t.prototype.disposePass=function(t){for(var e=0;e<this._passes[t].length;e++)this._passes[t][e].dispose()},t.prototype.dispose=function(){for(var t in this._passes)for(var e=0;e<this._passes[t].length;++e)this._passes[t][e].dispose()},t}();e.MaterialBase=t}(dou3d||(dou3d={})),function(_){var t=function(){function t(t){this._passChange=!0,this._vs_shader_methods={},this._fs_shader_methods={},this.methodList=[],this.methodDatas=[],this.vsShaderNames=[],this.fsShaderNames=[],this._materialData=t}return t.prototype.addMethod=function(t){-1==this.methodList.indexOf(t)&&(this.methodList.push(t),t.materialData=this._materialData,this._passChange=!0)},t.prototype.getMethod=function(t){for(var e=0;e<this.methodList.length;++e)if(this.methodList[e]instanceof t)return this.methodList[e];return null},t.prototype.removeMethod=function(t){var e=this.methodList.indexOf(t);-1!=e&&(this.methodList.slice(e),this._passChange=!0)},t.prototype.passInvalid=function(){this._passChange=!0},t.prototype.resetTexture=function(t){var e,r;for(var i in this._passUsage.sampler2DList)e=this._passUsage.sampler2DList[i],this._materialData[e.varName]&&(e.texture=this._materialData[e.varName]);for(var i in this._passUsage.sampler3DList)r=this._passUsage.sampler3DList[i],this._materialData[r.varName]&&(r.texture=this._materialData[r.varName]);this._materialData.textureChange=!1},t.prototype.addMethodShaders=function(t,e){for(var r=0;r<e.length;r++)t.addUseShaderName(e[r])},t.prototype.initUseMethod=function(t){this._passChange=!1,this._passUsage=new _.PassUsage,this._vs_shader_methods={},this._fs_shader_methods={},t&&t instanceof _.SkeletonAnimation&&(this._passUsage.maxBone=2*t.jointNum,this._vs_shader_methods[_.ShaderPhaseType.start_vertex]=[],this._vs_shader_methods[_.ShaderPhaseType.start_vertex].push("skeleton_vs")),this._materialData.acceptShadow&&(this._vs_shader_methods[_.ShaderPhaseType.vertex_2]=this._vs_shader_methods[_.ShaderPhaseType.vertex_2]||[],this._fs_shader_methods[_.ShaderPhaseType.shadow_fragment]=this._fs_shader_methods[_.ShaderPhaseType.shadow_fragment]||[]),this._materialData.shaderPhaseTypes[0].contains(_.ShaderPhaseType.diffuse_fragment)&&(this._fs_shader_methods[_.ShaderPhaseType.diffuse_fragment]=[],this._fs_shader_methods[_.ShaderPhaseType.diffuse_fragment].push("diffuse_fs")),this._materialData.shaderPhaseTypes[0].contains(_.ShaderPhaseType.normal_fragment)&&(this._fs_shader_methods[_.ShaderPhaseType.normal_fragment]=[],this._fs_shader_methods[_.ShaderPhaseType.normal_fragment].push("normalMap_fs")),this._materialData.shaderPhaseTypes[0].contains(_.ShaderPhaseType.specular_fragment)&&(this._fs_shader_methods[_.ShaderPhaseType.specular_fragment]=[],this._fs_shader_methods[_.ShaderPhaseType.specular_fragment].push("specularMap_fs")),this.lightGroup&&(this._passUsage.maxDirectLight=this.lightGroup.directList.length,this._passUsage.maxSpotLight=this.lightGroup.spotList.length,this._passUsage.maxPointLight=this.lightGroup.pointList.length,this._vs_shader_methods[_.ShaderPhaseType.vertex_1]=this._vs_shader_methods[_.ShaderPhaseType.vertex_1]||[],this._fs_shader_methods[_.ShaderPhaseType.lighting_fragment]=[],this._fs_shader_methods[_.ShaderPhaseType.lighting_fragment].push("lightingBase_fs"),this.lightGroup.directList.length&&(this._passUsage.directLightData=new Float32Array(_.DirectLight.stride*this.lightGroup.directList.length),this._fs_shader_methods[_.ShaderPhaseType.lighting_fragment].push("directLight_fs")),this.lightGroup.pointList.length&&(this._passUsage.pointLightData=new Float32Array(_.PointLight.stride*this.lightGroup.pointList.length),this._fs_shader_methods[_.ShaderPhaseType.lighting_fragment].push("pointLight_fs")),this.lightGroup.spotList.length&&(this._passUsage.spotLightData=new Float32Array(_.SpotLight.stride*this.lightGroup.spotList.length),this._fs_shader_methods[_.ShaderPhaseType.lighting_fragment].push("spotLight_fs"))),this.initMethodShader(),this.phaseEnd()},t.prototype.initMethodShader=function(){for(var t,e,r=0;r<this.methodList.length;r++){var i=this.methodList[r];for(t in i.vsShaderList){e=i.vsShaderList[t];for(var a=0;a<e.length;a++)this._vs_shader_methods[t]=this._vs_shader_methods[t]||[],this._vs_shader_methods[t].push(e[a])}for(t in i.fsShaderList){e=i.fsShaderList[t];for(a=0;a<e.length;a++)this._fs_shader_methods[t]=this._fs_shader_methods[t]||[],this._fs_shader_methods[t].push(e[a])}}},t.prototype.phaseEnd=function(){var t;(t=this._vs_shader_methods[_.ShaderPhaseType.custom_vertex])&&0<t.length?this.addMethodShaders(this._passUsage.vertexShader,t):(this.addMethodShaders(this._passUsage.vertexShader,["base_vs"]),(t=this._vs_shader_methods[_.ShaderPhaseType.start_vertex])&&0<t.length?this.addMethodShaders(this._passUsage.vertexShader,t):this.addMethodShaders(this._passUsage.vertexShader,["diffuse_vs"]),(t=this._vs_shader_methods[_.ShaderPhaseType.vertex_1])&&0<t.length&&this.addMethodShaders(this._passUsage.vertexShader,t),(t=this._vs_shader_methods[_.ShaderPhaseType.vertex_2])&&0<t.length&&this.addMethodShaders(this._passUsage.vertexShader,t),(t=this._vs_shader_methods[_.ShaderPhaseType.end_vertex])&&0<t.length?this.addMethodShaders(this._passUsage.vertexShader,t):this.addMethodShaders(this._passUsage.vertexShader,["end_vs"])),(t=this._fs_shader_methods[_.ShaderPhaseType.custom_fragment])&&0<t.length?this.addMethodShaders(this._passUsage.fragmentShader,t):(this.addMethodShaders(this._passUsage.fragmentShader,["base_fs"]),(t=this._fs_shader_methods[_.ShaderPhaseType.start_fragment])&&0<t.length&&this.addMethodShaders(this._passUsage.fragmentShader,t),(t=this._fs_shader_methods[_.ShaderPhaseType.materialsource_fragment])&&0<t.length?this.addMethodShaders(this._passUsage.fragmentShader,t):this.addMethodShaders(this._passUsage.fragmentShader,["materialSource_fs"]),(t=this._fs_shader_methods[_.ShaderPhaseType.diffuse_fragment])&&0<t.length?this.addMethodShaders(this._passUsage.fragmentShader,t):this.addMethodShaders(this._passUsage.fragmentShader,["diffuse_fs"]),(t=this._fs_shader_methods[_.ShaderPhaseType.normal_fragment])&&0<t.length&&this.addMethodShaders(this._passUsage.fragmentShader,t),(t=this._fs_shader_methods[_.ShaderPhaseType.shadow_fragment])&&0<t.length&&this.addMethodShaders(this._passUsage.fragmentShader,t),(t=this._fs_shader_methods[_.ShaderPhaseType.lighting_fragment])&&0<t.length&&this.addMethodShaders(this._passUsage.fragmentShader,t),(t=this._fs_shader_methods[_.ShaderPhaseType.specular_fragment])&&0<t.length&&this.addMethodShaders(this._passUsage.fragmentShader,t),(t=this._fs_shader_methods[_.ShaderPhaseType.end_fragment])&&0<t.length?this.addMethodShaders(this._passUsage.fragmentShader,t):this.addMethodShaders(this._passUsage.fragmentShader,["end_fs"]))},t.prototype.upload=function(t,e,r,i,a,n){for(var o in this._passChange=!1,this.initUseMethod(n),this._passUsage.vertexShader.shader=this._passUsage.vertexShader.getShader(this._passUsage),this._passUsage.fragmentShader.shader=this._passUsage.fragmentShader.getShader(this._passUsage),this._passUsage.program3D=_.ShaderPool.getProgram(this._passUsage.vertexShader.shader.id,this._passUsage.fragmentShader.shader.id),this._passUsage)-1!=o.indexOf("uniform")&&this._passUsage[o]&&(this._passUsage[o].uniformIndex=r.getUniformLocation(this._passUsage.program3D,o));var s,h;for(var u in this._passUsage.sampler2DList)(s=this._passUsage.sampler2DList[u]).uniformIndex=r.getUniformLocation(this._passUsage.program3D,s.varName),s.texture=this._materialData[s.varName];for(var u in this._passUsage.sampler3DList)(h=this._passUsage.sampler3DList[u]).uniformIndex=r.getUniformLocation(this._passUsage.program3D,h.varName);if(this.methodList)for(var l=0;l<this.methodList.length;l++)this.methodList[l].upload(t,e,this._passUsage,null,r,i,a)},t.prototype.draw=function(t,e,r,i,a,n,o){if(this._materialData.materialDataNeedChange){var s=this._materialData.tintColor,h=Math.floor(s/16777216),u=(16711680&s)/65536,l=(65280&s)/256,c=255&s;h/=128,u/=128,l/=128,c/=128,this._materialData.materialSourceData[0]=u*(this._materialData.diffuseColor>>16&255)/255,this._materialData.materialSourceData[1]=l*(this._materialData.diffuseColor>>8&255)/255,this._materialData.materialSourceData[2]=c*(255&this._materialData.diffuseColor)/255,this._materialData.materialSourceData[3]=(this._materialData.ambientColor>>16&255)/255,this._materialData.materialSourceData[4]=(this._materialData.ambientColor>>8&255)/255,this._materialData.materialSourceData[5]=(255&this._materialData.ambientColor)/255,this._materialData.materialSourceData[6]=(this._materialData.specularColor>>16&255)/255,this._materialData.materialSourceData[7]=(this._materialData.specularColor>>8&255)/255,this._materialData.materialSourceData[8]=(255&this._materialData.specularColor)/255,this._materialData.materialSourceData[9]=h*this._materialData.alpha,this._materialData.materialSourceData[10]=this._materialData.cutAlpha,this._materialData.materialSourceData[11]=this._materialData.gloss,this._materialData.materialSourceData[12]=this._materialData.specularLevel,this._materialData.materialSourceData[13]=this._materialData.albedo,this._materialData.materialSourceData[14]=this._materialData.uvRectangle.x,this._materialData.materialSourceData[15]=this._materialData.uvRectangle.y,this._materialData.materialSourceData[16]=this._materialData.uvRectangle.w,this._materialData.materialSourceData[17]=this._materialData.uvRectangle.h,this._materialData.materialSourceData[18]=this._materialData.specularLevel,this._materialData.materialSourceData[19]=window.devicePixelRatio}var d,p;for(var f in this._passChange&&this.upload(t,e,r,i,a,o.animation),r.setProgram(this._passUsage.program3D),n.activeState(this._passUsage,r),this._materialData.depthTest?r.enableDepth():r.disableDepth(),r.depthFunc(_.Context3DProxy.gl.LEQUAL),r.setCulling(this._materialData.cullFrontOrBack),this._materialData.bothside?r.disableCullFace():r.enableCullFace(),1==this._passID?(r.disableBlend(),r.setBlendFactors(_.Context3DProxy.gl.ONE,_.Context3DProxy.gl.ZERO)):(this._materialData.alphaBlending&&_.Context3DProxy.gl.depthMask(!1),r.enableBlend(),r.setBlendFactors(this._materialData.blendSrc,this._materialData.blendDest)),this._passUsage.uniform_materialSource&&r.uniform1fv(this._passUsage.uniform_materialSource.uniformIndex,this._materialData.materialSourceData),this._materialData.textureChange&&this.resetTexture(r),this._passUsage.sampler2DList)(d=this._passUsage.sampler2DList[f]).texture=this._materialData[d.varName],d.texture&&(d.texture.upload(r),r.setTexture2DAt(d.activeTextureIndex,d.uniformIndex,d.index,d.texture.texture2D),d.texture.useMipmap&&(d.texture.useMipmap=this._materialData.useMipmap),d.texture.repeat=this._materialData.repeat,d.texture.activeState(r),this._materialData.textureStateChage=!1);for(var f in this._passUsage.sampler3DList)(p=this._passUsage.sampler3DList[f]).texture=this._materialData[p.varName],p.texture&&(p.texture.upload(r),r.setCubeTextureAt(p.activeTextureIndex,p.uniformIndex,p.index,p.texture.texture3D));if(this.lightGroup){for(var m=0;m<this._passUsage.maxDirectLight;m++)this.lightGroup.directList[m].updateLightData(a,m,this._passUsage.directLightData);for(m=0;m<this._passUsage.maxSpotLight;m++)this.lightGroup.spotList[m].updateLightData(a,m,this._passUsage.spotLightData);for(m=0;m<this._passUsage.maxPointLight;m++)this.lightGroup.pointList[m].updateLightData(a,m,this._passUsage.pointLightData);this._passUsage.uniform_directLightSource&&r.uniform1fv(this._passUsage.uniform_directLightSource.uniformIndex,this._passUsage.directLightData),this._passUsage.uniform_spotLightSource&&r.uniform1fv(this._passUsage.uniform_spotLightSource.uniformIndex,this._passUsage.spotLightData),this._passUsage.uniform_pointLightSource&&r.uniform1fv(this._passUsage.uniform_pointLightSource.uniformIndex,this._passUsage.pointLightData)}if(this._passUsage.uniform_ModelMatrix&&r.uniformMatrix4fv(this._passUsage.uniform_ModelMatrix.uniformIndex,!1,i.rawData),this._passUsage.uniform_ViewMatrix&&r.uniformMatrix4fv(this._passUsage.uniform_ViewMatrix.uniformIndex,!1,a.viewMatrix.rawData),this._passUsage.uniform_ProjectionMatrix&&r.uniformMatrix4fv(this._passUsage.uniform_ProjectionMatrix.uniformIndex,!1,a.projectMatrix.rawData),this._passUsage.uniform_ViewProjectionMatrix&&r.uniformMatrix4fv(this._passUsage.uniform_ViewProjectionMatrix.uniformIndex,!1,a.viewProjectionMatrix.rawData),this._passUsage.uniform_orthProectMatrix&&r.uniformMatrix4fv(this._passUsage.uniform_orthProectMatrix.uniformIndex,!1,a.orthProjectionMatrix.rawData),o.animation&&o.animation.activeState(t,e,this._passUsage,n,r,i,a),this.methodList)for(m=0;m<this.methodList.length;m++)this.methodList[m].activeState(t,e,this._passUsage,null,r,i,a);this._passUsage.uniform_eyepos&&r.uniform3f(this._passUsage.uniform_eyepos.uniformIndex,a.globalPosition.x,a.globalPosition.y,a.globalPosition.z),this._passUsage.uniform_cameraMatrix&&r.uniformMatrix4fv(this._passUsage.uniform_cameraMatrix.uniformIndex,!1,a.globalMatrix.rawData),r.drawElement(this._materialData.drawMode,n.start,n.count),this._materialData.alphaBlending&&_.Context3DProxy.gl.depthMask(!0)},t.prototype.deactiveState=function(t,e){for(var r in t.sampler2DList)this._passUsage.sampler2DList[r].texture},t.prototype.dispose=function(){this._passUsage&&this._passUsage.dispose(),this._passUsage=null},t}();_.MaterialPass=t}(dou3d||(dou3d={})),function(e){var t=function(){function t(){this.sampler2DList=[],this.sampler3DList=[],this.maxDirectLight=0,this.maxPointLight=0,this.maxSpotLight=0,this.maxBone=0,this.attributeDiry=!0,this.vertexShader=new e.ShaderComposer(0),this.fragmentShader=new e.ShaderComposer(1)}return t.prototype.dispose=function(){this.program3D&&this.program3D.dispose(),this.program3D=null,this.vertexShader&&this.vertexShader.shader&&this.vertexShader.shader.dispose(),this.vertexShader=null,this.fragmentShader&&this.fragmentShader.shader&&this.fragmentShader.shader.dispose(),this.fragmentShader=null},t}();e.PassUsage=t}(dou3d||(dou3d={})),function(r){var t;(t=r.PassUtil||(r.PassUtil={})).passAuto=[!0,!0],t.createPass=function(t,e){switch(t){case 0:return e.shaderPhaseTypes[0]=[],[new r.DiffusePass(e)];case 1:return e.shaderPhaseTypes[1]=[],[new r.ShadowPass(e)]}return null}}(dou3d||(dou3d={})),function(t){var e=function(){};(dou3d||(dou3d={})).MethodData=e}(),function(t){var e=function(){function t(){this.vsShaderList=[],this.fsShaderList=[]}return t.prototype.dispose=function(){},t}();t.MethodBase=e}(dou3d||(dou3d={})),function(r){var t=function(e){function t(){var t=e.call(this)||this;return t.fsShaderList[r.ShaderPhaseType.diffuse_fragment]=t.fsShaderList[r.ShaderPhaseType.diffuse_fragment]||[],t.fsShaderList[r.ShaderPhaseType.diffuse_fragment].push("color_fs"),t}return __extends(t,e),t.prototype.upload=function(t,e,r,i,a,n,o){},t.prototype.activeState=function(t,e,r,i,a,n,o){},t}(r.MethodBase);r.ColorMethod=t}(dou3d||(dou3d={})),function(h){var t=function(r){function t(t){var e=r.call(this)||this;return e.materialData=t.materialData,e.vsShaderList[h.ShaderPhaseType.vertex_1]=e.vsShaderList[h.ShaderPhaseType.vertex_1]||[],e.vsShaderList[h.ShaderPhaseType.vertex_1].push("shadowMapping_vs"),e.fsShaderList[h.ShaderPhaseType.shadow_fragment]=e.fsShaderList[h.ShaderPhaseType.shadow_fragment]||[],e.fsShaderList[h.ShaderPhaseType.shadow_fragment].push("shadowMapping_fs"),e}return __extends(t,r),Object.defineProperty(t.prototype,"shadowMapTexture",{get:function(){return this.materialData.shadowMapTexture},set:function(t){this.materialData.shadowMapTexture!=t&&(this.materialData.shadowMapTexture=t,this.materialData.textureChange=!0)},enumerable:!0,configurable:!0}),t.prototype.upload=function(t,e,r,i,a,n,o){r.uniform_ShadowMatrix&&(r.uniform_ShadowMatrix.uniformIndex=a.getUniformLocation(r.program3D,"uniform_ShadowMatrix"))},t.prototype.activeState=function(t,e,r,i,a,n,o){var s=h.ShadowCast.instance.shadowCamera;s&&r.uniform_ShadowMatrix&&r.uniform_ShadowMatrix.uniformIndex&&a.uniformMatrix4fv(r.uniform_ShadowMatrix.uniformIndex,!1,s.viewProjectionMatrix.rawData),a.uniform4fv(r.uniform_ShadowColor.uniformIndex,this.materialData.shadowColor)},t}(h.MethodBase);h.ShadowMethod=t}(dou3d||(dou3d={})),function(r){var t=function(e){function t(){var t=e.call(this)||this;return t.vsShaderList[r.ShaderPhaseType.vertex_2]=t.fsShaderList[r.ShaderPhaseType.vertex_2]||[],t.vsShaderList[r.ShaderPhaseType.vertex_2].push("cube_vs"),t.fsShaderList[r.ShaderPhaseType.diffuse_fragment]=t.fsShaderList[r.ShaderPhaseType.diffuse_fragment]||[],t.fsShaderList[r.ShaderPhaseType.diffuse_fragment].push("cube_fs"),t}return __extends(t,e),t.prototype.upload=function(t,e,r,i,a,n,o){},t.prototype.activeState=function(t,e,r,i,a,n,o){},t}(r.MethodBase);r.CubeMethod=t}(dou3d||(dou3d={})),function(t){var e=function(r){function t(t){var e=r.call(this,t)||this;return e._passID=0,e}return __extends(t,r),t}(t.MaterialPass);t.DiffusePass=e}(dou3d||(dou3d={})),function(e){var t=function(r){function t(t){var e=r.call(this,t)||this;return e._passID=1,e}return __extends(t,r),t.prototype.initUseMethod=function(){this._passChange=!1,this._passUsage=new e.PassUsage,this._vs_shader_methods={},this._fs_shader_methods={},this.addMethodShaders(this._passUsage.vertexShader,["shadowPass_vs"]),this.addMethodShaders(this._passUsage.fragmentShader,["shadowPass_fs"])},t}(e.MaterialPass);e.ShadowPass=t}(dou3d||(dou3d={})),function(e){var t=function(r){function t(t){void 0===t&&(t=13421772);var e=r.call(this)||this;return e.color=t,e.initMatPass(),e}return __extends(t,r),t.prototype.initMatPass=function(){this.addPass(0),this.diffusePass.addMethod(new e.ColorMethod)},Object.defineProperty(t.prototype,"color",{get:function(){return this.materialData.diffuseColor},set:function(t){this.materialData.diffuseColor=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"alpha",{get:function(){return this.materialData.alpha},set:function(t){this.materialData.alpha=t},enumerable:!0,configurable:!0}),t}(e.MaterialBase);e.ColorMaterial=t}(dou3d||(dou3d={})),function(a){var t=function(i){function t(t,e){var r=i.call(this,e)||this;return t||(t=a.CheckerboardTexture.texture),r.diffuseTexture=t,r.initMatPass(),r}return __extends(t,i),t.prototype.initMatPass=function(){this.addPass(0)},t.prototype.clone=function(){return new t(this.diffuseTexture,this.materialData.clone())},t}(a.MaterialBase);a.TextureMaterial=t}(dou3d||(dou3d={})),function(e){var t=function(i){function t(t,e){var r=i.call(this,e)||this;return r.initMatPass(),r.materialData.diffuseTexture3D=t,r}return __extends(t,i),t.prototype.initMatPass=function(){this.addPass(0),this.diffusePass.addMethod(new e.CubeMethod)},t.prototype.clone=function(){return new t(this.diffuseTexture,this.materialData.clone())},t}(e.MaterialBase);e.CubeTextureMaterial=t}(dou3d||(dou3d={})),function(i){var t=function(){function t(){this.numEntity=0}return t.prototype.setRenderToTexture=function(t,e,r){void 0===r&&(r=2),this.renderTexture=new i.RenderTexture(t,e,r)},t}();i.RendererBase=t}(dou3d||(dou3d={})),function(p){var t=function(r){function t(t){void 0===t&&(t=0);var e=r.call(this)||this;return e._pass=t,e}return __extends(t,r),t.prototype.draw=function(t,e,r,i,a,n){var o;this.numEntity=i.renderList.length,this.renderTexture&&(this.renderTexture.upload(r),r.setRenderToTexture(this.renderTexture.texture2D));for(var s=0;s<this.numEntity;s++){var h=i.renderList[s];h.geometry.activeState(r);for(var u=0;u<h.geometry.subGeometrys.length;u++){var l=h.geometry.subGeometrys[u],c=l.matID;if(null!=(o=h.multiMaterial[c])){if(o.passes[this._pass])for(var d=o.passes[this._pass].length-1;0<=d;d--)o.passes[this._pass][d].draw(t,e,r,h.globalMatrix,a,l,h);else if(p.PassUtil.passAuto[this._pass]){o.passes[this._pass]||o.addPass(this._pass);for(d=o.passes[this._pass].length-1;0<=d;d--)o.passes[this._pass]=p.PassUtil.createPass(this._pass,o.materialData),o.passes[this._pass][d].draw(t,e,r,h.globalMatrix,a,l,h)}o=null}}}this.drawOver&&this.drawOver(i,a,t,e,n),this.renderTexture&&(r.setRenderToBackBuffer(),n&&(r.viewPort(n.x,n.y,n.w,n.h),r.setScissorRectangle(n.x,n.y,n.w,n.h)))},t}(p.RendererBase);p.MultiRenderer=t}(dou3d||(dou3d={})),function(e){var t=function(){function t(){this._root=new e.ObjectContainer3D}return Object.defineProperty(t.prototype,"root",{get:function(){return this._root},enumerable:!0,configurable:!0}),t}();e.Scene3D=t}(dou3d||(dou3d={})),function(t){var e=function(){function e(){this.varName="",this.name="",this.key="",this.valueType="",this.value="",this.activeTextureIndex=-1,this.index=-1,this.size=0,this.dataType=0,this.normalized=!1,this.stride=0,this.offsetBytes=0}return e.prototype.computeVarName=function(){var t=this.name.indexOf("[");this.varName=0<=t?this.name.substr(0,t):this.name},e.prototype.clone=function(){var t=new e;return t.name=this.name,t.valueType=this.valueType,t.varName=this.varName,t.value=this.value,t.key=this.key,t},e}();t.VarRegister=e}(dou3d||(dou3d={})),function(t){var e=function(i){function t(t,e){var r=i.call(this)||this;return r.name=t,r.computeVarName(),r.key="attribute",r.valueType=e,r}return __extends(t,i),t}(t.VarRegister);t.Attribute=e}(dou3d||(dou3d={})),function(t){var e=function(a){function t(t,e,r){var i=a.call(this)||this;return i.name=t,i.computeVarName(),i.key="const",i.valueType=e,i.value=r,i}return __extends(t,a),t}(t.VarRegister);t.ConstVar=e}(dou3d||(dou3d={})),function(t){var e=function(i){function t(t,e){var r=i.call(this)||this;return r.name=t,r.computeVarName(),r.key="#define",r.value=e,r}return __extends(t,i),t}(t.VarRegister);t.DefineVar=e}(dou3d||(dou3d={})),function(t){var e=function(r){function t(t){var e=r.call(this)||this;return e.name=t,e.computeVarName(),e.key="#extension",e}return __extends(t,r),t}(t.VarRegister);t.Extension=e}(dou3d||(dou3d={})),function(t){var e=function(r){function t(t){var e=r.call(this)||this;return e.name=t,e.computeVarName(),e.key="sampler2D",e}return __extends(t,r),t}(t.VarRegister);t.Sampler2D=e}(dou3d||(dou3d={})),function(t){var e=function(r){function t(t){var e=r.call(this)||this;return e.name=t,e.computeVarName(),e.key="samplerCube",e}return __extends(t,r),t}(t.VarRegister);t.Sampler3D=e}(dou3d||(dou3d={})),function(t){var e=function(i){function t(t,e){var r=i.call(this)||this;return r.name=t,r.computeVarName(),r.key="",r.valueType=e,r}return __extends(t,i),t}(t.VarRegister);t.TmpVar=e}(dou3d||(dou3d={})),function(t){var e=function(i){function t(t,e){var r=i.call(this)||this;return r.name=t,r.computeVarName(),r.key="uniform",r.valueType=e,r}return __extends(t,i),t}(t.VarRegister);t.Uniform=e}(dou3d||(dou3d={})),function(t){var e=function(i){function t(t,e){var r=i.call(this)||this;return r.name=t,r.computeVarName(),r.key="varying",r.valueType=e,r}return __extends(t,i),t}(t.VarRegister);t.Varying=e}(dou3d||(dou3d={})),function(e){var t=function(){function t(t){this._shadersName=[],this._endShadername="",this._shaderType=-1,this._shaderType=t}return Object.defineProperty(t.prototype,"shaderType",{get:function(){return this._shaderType},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"shader",{get:function(){return this._shader},set:function(t){this._shader=t},enumerable:!0,configurable:!0}),t.prototype.addUseShaderName=function(t){this._shadersName.push(t)},t.prototype.addEndShaderName=function(t){this._endShadername=t},t.prototype.getShader=function(t){this._endShadername&&(-1==this._shadersName.indexOf(this._endShadername)&&this._shadersName.push(this._endShadername));return e.ShaderUtil.fillShaderContent(this,this._shadersName,t)},t}();e.ShaderComposer=t}(dou3d||(dou3d={})),function(t){var e=function(){function i(){this.name="",this.source="",this.funcNames=[],this.funcDict={},this.structNames=[],this.structDict={},this.attributeList=[],this.varyingList=[],this.uniformList=[],this.constList=[],this.tempList=[],this.sampler2DList=[],this.sampler3DList=[],this.extensionList=[],this.defineList=[]}return i.prototype.addVar=function(t){"attribute"==t.key?this.attributeList.push(t):"varying"==t.key?this.varyingList.push(t):"uniform"==t.key?this.uniformList.push(t):"const"==t.key?this.constList.push(t):"sampler2D"==t.key?this.sampler2DList.push(t):"samplerCube"==t.key?this.sampler3DList.push(t):"#extension"==t.key?this.extensionList.push(t):"#define"==t.key?this.defineList.push(t):this.tempList.push(t)},i.prototype.addFunc=function(t,e){if(this.funcDict[t]){var r=this.mergeMainFunc(this.funcDict[t],e);this.funcDict[t]=r}else this.funcDict[t]=e,this.funcNames.push(t);if(this.funcDict.main){var i=this.funcNames.indexOf("main");this.funcNames.splice(i,1),this.funcNames.push("main")}},i.prototype.addStruct=function(t,e){this.structDict[t]?DEBUG&&console.log("<"+t+">struct重复"):(this.structDict[t]=e,this.structNames.push(t))},i.prototype.addContent=function(t){for(var e=0;e<t.structNames.length;++e)this.addStruct(t.structNames[e],t.structDict[t.structNames[e]]);for(e=0;e<t.funcNames.length;++e)this.addFunc(t.funcNames[e],t.funcDict[t.funcNames[e]]);for(e=0;e<t.attributeList.length;++e){for(var r=!0,i=0;i<this.attributeList.length;++i)if(t.attributeList[e].name==this.attributeList[i].name){DEBUG&&(t.attributeList[e].valueType==this.attributeList[i].valueType&&t.attributeList[e].key==this.attributeList[i].key||console.log(t.attributeList[e].name+"=> type:"+t.attributeList[e].valueType+" "+this.attributeList[i].valueType+" => key:"+t.attributeList[e].key+" "+this.attributeList[i].key)),r=!1;break}r&&this.attributeList.push(t.attributeList[e].clone())}for(e=0;e<t.varyingList.length;++e){for(r=!0,i=0;i<this.varyingList.length;++i)if(t.varyingList[e].name==this.varyingList[i].name){DEBUG&&(t.varyingList[e].valueType==this.varyingList[i].valueType&&t.varyingList[e].key==this.varyingList[i].key||console.log(t.varyingList[e].name+"=> type:"+t.varyingList[e].valueType+" "+this.varyingList[i].valueType+" => key:"+t.varyingList[e].key+" "+this.varyingList[i].key)),r=!1;break}r&&this.varyingList.push(t.varyingList[e].clone())}for(e=0;e<t.uniformList.length;++e){for(r=!0,i=0;i<this.uniformList.length;++i)if(t.uniformList[e].name==this.uniformList[i].name){DEBUG&&(t.uniformList[e].valueType==this.uniformList[i].valueType&&t.uniformList[e].key==this.uniformList[i].key||console.log(t.uniformList[e].name+"=> type:"+t.uniformList[e].valueType+" "+this.uniformList[i].valueType+" => key:"+t.uniformList[e].key+" "+this.uniformList[i].key)),r=!1;break}r&&this.uniformList.push(t.uniformList[e].clone())}for(e=0;e<t.constList.length;++e){for(r=!0,i=0;i<this.constList.length;++i)if(t.constList[e].name==this.constList[i].name){DEBUG&&(t.constList[e].valueType==this.constList[i].valueType&&t.constList[e].key==this.constList[i].key||console.log(t.constList[e].name+"=> type:"+t.constList[e].valueType+" "+this.constList[i].valueType+" => key:"+t.constList[e].key+" "+this.constList[i].key)),r=!1;break}r&&this.constList.push(t.constList[e].clone())}for(e=0;e<t.tempList.length;++e){for(r=!0,i=0;i<this.tempList.length;++i)if(t.tempList[e].name==this.tempList[i].name){DEBUG&&(t.tempList[e].valueType==this.tempList[i].valueType&&t.tempList[e].key==this.tempList[i].key||console.log(t.tempList[e].name+"=> type:"+t.tempList[e].valueType+" "+this.tempList[i].valueType+" => key:"+t.tempList[e].key+" "+this.tempList[i].key)),r=!1;break}r&&this.tempList.push(t.tempList[e].clone())}for(e=0;e<t.sampler2DList.length;++e){for(r=!0,i=0;i<this.sampler2DList.length;++i)if(t.sampler2DList[e].name==this.sampler2DList[i].name){DEBUG&&(t.sampler2DList[e].valueType==this.sampler2DList[i].valueType&&t.sampler2DList[e].key==this.sampler2DList[i].key||console.log(t.sampler2DList[e].name+"=> type:"+t.sampler2DList[e].valueType+" "+this.sampler2DList[i].valueType+" => key:"+t.sampler2DList[e].key+" "+this.sampler2DList[i].key)),r=!1;break}r&&this.sampler2DList.push(t.sampler2DList[e].clone())}for(e=0;e<t.sampler3DList.length;++e){for(r=!0,i=0;i<this.sampler3DList.length;++i)if(t.sampler3DList[e].name==this.sampler3DList[i].name){DEBUG&&(t.sampler2DList[e].valueType==this.sampler3DList[i].valueType&&t.sampler3DList[e].key==this.sampler3DList[i].key||console.log(t.sampler3DList[e].name+"=> type:"+t.sampler3DList[e].valueType+" "+this.sampler3DList[i].valueType+" => key:"+t.sampler3DList[e].key+" "+this.sampler3DList[i].key)),r=!1;break}r&&this.sampler3DList.push(t.sampler3DList[e].clone())}for(e=0;e<t.extensionList.length;++e){for(r=!0,i=0;i<this.extensionList.length;++i)if(t.extensionList[e].name==this.extensionList[i].name){r=!1;break}r&&this.extensionList.push(t.extensionList[e].clone())}for(e=0;e<t.defineList.length;++e){for(r=!0,i=0;i<this.defineList.length;++i)if(t.defineList[e].name==this.defineList[i].name){r=!1;break}r&&this.defineList.push(t.defineList[e].clone())}},i.prototype.mergeMainFunc=function(t,e){var r,i=t,a=e.indexOf("{"),n=e.lastIndexOf("}");a++,r=e.slice(a,n),a=i.lastIndexOf("}");var o=i.substr(0,a),s=i.substr(a,i.length-a);i=o,i+=r;return i+="",i+=s},i.prototype.clone=function(){var t=new i;t.name=this.name,t.source=this.source;for(var e=0;e<this.funcNames.length;++e)t.funcNames.push(this.funcNames[e]);for(var r in this.funcDict)t.funcDict[r]=this.funcDict[r];for(e=0;e<this.structNames.length;++e)t.structNames.push(this.structNames[e]);for(var r in this.structDict)t.structDict[r]=this.structDict[r];for(e=0;e<this.attributeList.length;++e)t.attributeList.push(this.attributeList[e].clone());for(e=0;e<this.varyingList.length;++e)t.varyingList.push(this.varyingList[e].clone());for(e=0;e<this.uniformList.length;++e)t.uniformList.push(this.uniformList[e].clone());for(e=0;e<this.constList.length;++e)t.constList.push(this.constList[e].clone());for(e=0;e<this.tempList.length;++e)t.tempList.push(this.tempList[e].clone());for(e=0;e<this.sampler2DList.length;++e)t.sampler2DList.push(this.sampler2DList[e].clone());for(e=0;e<this.sampler3DList.length;++e)t.sampler3DList.push(this.sampler3DList[e].clone());for(e=0;e<this.attributeList.length;++e)t.attributeList.push(this.attributeList[e].clone());for(e=0;e<this.extensionList.length;++e)t.extensionList.push(this.extensionList[e].clone());for(e=0;e<this.defineList.length;++e)t.defineList.push(this.defineList[e].clone());return t},i}();t.ShaderContent=e}(dou3d||(dou3d={})),function(t){var e,o,s,h,u;e=t.ShaderPool||(t.ShaderPool={}),s={},h={},u={},e.register=function(t){o=t},e.getGPUShader=function(t,e,r){var i=h[e];return i||(i=u[e]),i||(0==t?((i=o.createVertexShader(r)).id=e,h[e]=i):1==t&&((i=o.createFragmentShader(r)).id=e,u[e]=i)),i},e.getProgram=function(t,e){var r,i=h[t],a=u[e],n=i.id+"_"+a.id;return s[n]?r=s[n]:(r=function(t,e){return o.createProgram(t,e)}(i,a),s[n]=r),s[n]}}(dou3d||(dou3d={})),function(t){var e;(e=t.ShaderLib||(t.ShaderLib={})).base_fs="#extension GL_OES_standard_derivatives:enable\nvarying vec3 varying_eyeNormal;\nvarying vec2 varying_uv0;\nvarying vec4 varying_color;\nvarying vec4 varying_worldPosition;\nvarying vec3 varying_worldNormal;\nuniform mat4 uniform_ViewMatrix;\nuniform vec3 uniform_eyepos;\nvec4 diffuseColor;\nvec4 specularColor;\nvec4 ambientColor;\nvec4 light;\nvec3 normal;\nvec2 uv_0;\nvoid main(){\ndiffuseColor=vec4(1.0,1.0,1.0,1.0);\nspecularColor=vec4(0.0,0.0,0.0,0.0);\nambientColor=vec4(0.0,0.0,0.0,0.0);\nlight=vec4(1.0,1.0,1.0,1.0);\nnormal=normalize(varying_eyeNormal);\nuv_0=varying_uv0;\n}",e.base_vs="attribute vec3 attribute_position;\nattribute vec3 attribute_normal;\nattribute vec4 attribute_color;\nattribute vec2 attribute_uv0;\nvec3 e_position=vec3(0.0,0.0,0.0);\nuniform mat4 uniform_ModelMatrix;\nuniform mat4 uniform_ViewMatrix;\nuniform mat4 uniform_ProjectionMatrix;\nvarying vec3 varying_eyeNormal;\nvarying vec2 varying_uv0;\nvarying vec4 varying_color;\nvarying vec4 varying_worldPosition;\nvarying vec3 varying_worldNormal;\nvec4 outPosition;\nmat4 transpose(mat4 inMatrix){\nvec4 i0=inMatrix[0];\nvec4 i1=inMatrix[1];\nvec4 i2=inMatrix[2];\nvec4 i3=inMatrix[3];\nmat4 outMatrix=mat4(\nvec4(i0.x,i1.x,i2.x,i3.x),\nvec4(i0.y,i1.y,i2.y,i3.y),\nvec4(i0.z,i1.z,i2.z,i3.z),\nvec4(i0.w,i1.w,i2.w,i3.w)\n);\nreturn outMatrix;\n}\nmat4 inverse(mat4 m){\nfloat\na00=m[0][0],a01=m[0][1],a02=m[0][2],a03=m[0][3],\na10=m[1][0],a11=m[1][1],a12=m[1][2],a13=m[1][3],\na20=m[2][0],a21=m[2][1],a22=m[2][2],a23=m[2][3],\na30=m[3][0],a31=m[3][1],a32=m[3][2],a33=m[3][3],\nb00=a00*a11-a01*a10,\nb01=a00*a12-a02*a10,\nb02=a00*a13-a03*a10,\nb03=a01*a12-a02*a11,\nb04=a01*a13-a03*a11,\nb05=a02*a13-a03*a12,\nb06=a20*a31-a21*a30,\nb07=a20*a32-a22*a30,\nb08=a20*a33-a23*a30,\nb09=a21*a32-a22*a31,\nb10=a21*a33-a23*a31,\nb11=a22*a33-a23*a32,\ndet=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;\nreturn mat4(\na11*b11-a12*b10+a13*b09,\na02*b10-a01*b11-a03*b09,\na31*b05-a32*b04+a33*b03,\na22*b04-a21*b05-a23*b03,\na12*b08-a10*b11-a13*b07,\na00*b11-a02*b08+a03*b07,\na32*b02-a30*b05-a33*b01,\na20*b05-a22*b02+a23*b01,\na10*b10-a11*b08+a13*b06,\na01*b08-a00*b10-a03*b06,\na30*b04-a31*b02+a33*b00,\na21*b02-a20*b04-a23*b00,\na11*b07-a10*b09-a12*b06,\na00*b09-a01*b07+a02*b06,\na31*b01-a30*b03-a32*b00,\na20*b03-a21*b01+a22*b00)/det;\n}\nvoid main(){\ne_position=attribute_position;\nvarying_color=attribute_color;\nvarying_uv0=attribute_uv0;\nvarying_worldPosition=uniform_ModelMatrix*vec4(e_position,1.0);\nvarying_worldNormal=normalize((uniform_ModelMatrix*vec4(attribute_normal,0.0)).xyz);\n}",e.color_fs="void main(){\n}",e.cube_fs="uniform samplerCube diffuseTexture3D;\nvarying vec3 varying_pos;\nvec4 diffuseColor;\nvoid main(){\nvec3 uvw=normalize(varying_pos.xyz);\ndiffuseColor=vec4(textureCube(diffuseTexture3D,uvw.xyz));\nif(diffuseColor.w<materialSource.cutAlpha){\ndiscard;\n}\nelse{\ndiffuseColor.xyz*=diffuseColor.w;\n}\n}",e.cube_vs="varying vec3 varying_pos;\nvoid main(){\nvarying_pos=e_position;\n}",e.diffuse_fs="uniform sampler2D diffuseTexture;\nvec4 diffuseColor;\nvoid main(){\ndiffuseColor=texture2D(diffuseTexture,uv_0);\nif(diffuseColor.w<materialSource.cutAlpha){\ndiscard;\n}\n}",e.diffuse_vs="attribute vec3 attribute_normal;\nattribute vec4 attribute_color;\nvarying vec4 varying_modelViewPosition;\nvarying vec4 varying_color;\nvoid main(){\nmat4 mvMatrix=mat4(uniform_ViewMatrix*uniform_ModelMatrix);\nvarying_modelViewPosition=mvMatrix*vec4(e_position,1.0);\nmat4 normalMatrix=inverse(mvMatrix);\nnormalMatrix=transpose(normalMatrix);\nvarying_eyeNormal=mat3(normalMatrix)*-attribute_normal;\noutPosition=varying_modelViewPosition;\nvarying_color=attribute_color;\n}",e.directLight_fs="const int max_directLight=0;\nuniform float uniform_directLightSource[6*max_directLight];\nstruct DirectLight{\nvec3 direction;\nvec3 diffuse;\nvec3 ambient;\n};\nvoid calculateDirectLight(MaterialSource materialSource){\nvec3 viewDir=normalize(uniform_eyepos-varying_worldPosition.xyz);\nfor(int i=0;i<max_directLight;i++){\nDirectLight directLight;\ndirectLight.direction=vec3(uniform_directLightSource[i*6],uniform_directLightSource[i*6+1],uniform_directLightSource[i*6+2]);\ndirectLight.diffuse=vec3(uniform_directLightSource[i*6+3],uniform_directLightSource[i*6+4],uniform_directLightSource[i*6+5]);\nvec3 lightDir=-directLight.direction;\nfloat diffuse=calculateLightDiffuse(varying_worldNormal,lightDir);\nfloat specular=calculateLightSpecular(varying_worldNormal,lightDir,viewDir,materialSource.specularScale);\nlight.xyz+=(materialSource.ambient+diffuse*materialSource.diffuse+specular*materialSource.specular)*directLight.diffuse;\n}\n}\nvoid main(){\ncalculateDirectLight(materialSource);\n}",e.end_fs="varying vec4 varying_color;\nvec4 outColor;\nvec4 diffuseColor;\nvec4 specularColor;\nvec4 ambientColor;\nvec4 light;\nvoid main(){\noutColor.xyz=(light.xyz+materialSource.ambient)*diffuseColor.xyz*materialSource.diffuse*varying_color.xyz;\noutColor.w=materialSource.alpha*diffuseColor.w*varying_color.w;\noutColor.xyz*=outColor.w;\ngl_FragColor=outColor;\n}",e.end_vs="uniform float uniform_materialSource[20];\nvoid main(){\ngl_PointSize=uniform_materialSource[18];\ngl_Position=uniform_ProjectionMatrix*outPosition;\n}",e.lightingBase_fs="float computeDistanceLightFalloff(float lightDistance,float range){\nreturn max(0.0,1.0-lightDistance/range);\n}\nfloat calculateLightDiffuse(vec3 normal,vec3 lightDir){\nreturn clamp(dot(normal,lightDir),0.0,1.0);\n}\nfloat calculateLightSpecular(vec3 normal,vec3 lightDir,vec3 viewDir,float glossiness){\nvec3 halfVec=normalize(lightDir+viewDir);\nfloat specComp=max(dot(normal,halfVec),0.0);\nspecComp=pow(specComp,glossiness);\nreturn specComp;\n}\nvoid main(){\nlight.xyzw=vec4(0.0,0.0,0.0,1.0);\n}",e.materialSource_fs="struct MaterialSource{\nvec3 diffuse;\nvec3 ambient;\nvec3 specular;\nfloat alpha;\nfloat cutAlpha;\nfloat shininess;\nfloat roughness;\nfloat albedo;\nvec4 uvRectangle;\nfloat specularScale;\nfloat normalScale;\n};\nuniform float uniform_materialSource[20];\nvarying vec2 varying_uv0;\nMaterialSource materialSource;\nvec2 uv_0;\nvoid main(){\nmaterialSource.diffuse.x=uniform_materialSource[0];\nmaterialSource.diffuse.y=uniform_materialSource[1];\nmaterialSource.diffuse.z=uniform_materialSource[2];\nmaterialSource.ambient.x=uniform_materialSource[3];\nmaterialSource.ambient.y=uniform_materialSource[4];\nmaterialSource.ambient.z=uniform_materialSource[5];\nmaterialSource.specular.x=uniform_materialSource[6];\nmaterialSource.specular.y=uniform_materialSource[7];\nmaterialSource.specular.z=uniform_materialSource[8];\nmaterialSource.alpha=uniform_materialSource[9];\nmaterialSource.cutAlpha=uniform_materialSource[10];\nmaterialSource.shininess=uniform_materialSource[11];\nmaterialSource.specularScale=uniform_materialSource[12];\nmaterialSource.albedo=uniform_materialSource[13];\nmaterialSource.uvRectangle.x=uniform_materialSource[14];\nmaterialSource.uvRectangle.y=uniform_materialSource[15];\nmaterialSource.uvRectangle.z=uniform_materialSource[16];\nmaterialSource.uvRectangle.w=uniform_materialSource[17];\nmaterialSource.specularScale=uniform_materialSource[18];\nmaterialSource.normalScale=uniform_materialSource[19];\nuv_0=varying_uv0.xy*materialSource.uvRectangle.zw+materialSource.uvRectangle.xy;\n}",e.normalMap_fs="uniform sampler2D normalTexture;\nvarying vec2 varying_uv0;\nvarying vec4 varying_modelViewPosition;\nmat3 cotangentFrame(vec3 N,vec3 p,vec2 uv){\nvec3 dp1=dFdx(p);\nvec3 dp2=dFdy(p);\nvec2 duv1=dFdx(uv);\nvec2 duv2=dFdy(uv);\nvec3 dp2perp=cross(dp2,N);\nvec3 dp1perp=cross(N,dp1);\nvec3 T=dp2perp*duv1.x+dp1perp*duv2.x;\nvec3 B=dp2perp*duv1.y+dp1perp*duv2.y;\nfloat invmax=1.0/sqrt(max(dot(T,T),dot(B,B)));\nreturn mat3(T*invmax,B*invmax,N);\n}\nvec3 tbn(vec3 map,vec3 N,vec3 V,vec2 texcoord){\nmat3 TBN=cotangentFrame(N,-V,texcoord);\nreturn normalize(TBN*map);\n}\nvoid main(){\nvec3 normalTex=texture2D(normalTexture,uv_0).xyz*2.0-1.0;\nnormalTex.y*=-1.0;\nnormal.xyz=tbn(normalTex.xyz,normal.xyz,varying_modelViewPosition.xyz,uv_0);\n}",e.pointLight_fs="const int max_pointLight=0;\nuniform float uniform_pointLightSource[7*max_pointLight];\nstruct PointLight{\nvec3 position;\nvec3 diffuse;\nvec3 ambient;\nfloat intensity;\nfloat radius;\n};\nvoid calculatePointLight(MaterialSource materialSource){\nvec3 viewDir=normalize(uniform_eyepos-varying_worldPosition.xyz);\nfor(int i=0;i<max_pointLight;i++){\nPointLight pointLight;\npointLight.position=vec3(uniform_pointLightSource[i*7],uniform_pointLightSource[i*7+1],uniform_pointLightSource[i*7+2]);\npointLight.diffuse=vec3(uniform_pointLightSource[i*7+3],uniform_pointLightSource[i*7+4],uniform_pointLightSource[i*7+5]);\npointLight.radius=uniform_pointLightSource[i*7+6];\nvec3 lightOffset=pointLight.position-varying_worldPosition.xyz;\nvec3 lightDir=normalize(lightOffset);\nfloat falloff=computeDistanceLightFalloff(length(lightOffset),pointLight.radius);\nfloat diffuse=calculateLightDiffuse(varying_worldNormal,lightDir);\nfloat specular=calculateLightSpecular(varying_worldNormal,lightDir,viewDir,materialSource.specularScale);\nlight.xyz+=(materialSource.ambient+diffuse*materialSource.diffuse+specular*materialSource.specular)*pointLight.diffuse*falloff;\n}\n}\nvoid main(){\ncalculatePointLight(materialSource);\n}",e.shadowMapping_fs="uniform sampler2D shadowMapTexture;\nuniform vec4 uniform_ShadowColor;\nvarying vec4 varying_ShadowCoord;\nvoid main(){\nvec3 shadowColor=vec3(1.0,1.0,1.0);\nfloat offset=uniform_ShadowColor.w;\nvec2 sample=varying_ShadowCoord.xy/varying_ShadowCoord.w*0.5+0.5;\nif(sample.x>=0.0 && sample.x<=1.0 && sample.y>=0.0 && sample.y<=1.0){\nvec4 sampleDepth=texture2D(shadowMapTexture,sample).xyzw;\nfloat depth=varying_ShadowCoord.z;\nif(sampleDepth.z !=0.0){\nif(sampleDepth.z<depth-offset){\nshadowColor=uniform_ShadowColor.xyz;\n}\n}\n}\ndiffuseColor.xyz=diffuseColor.xyz*shadowColor;\n}",e.shadowMapping_vs="uniform mat4 uniform_ShadowMatrix;\nuniform mat4 uniform_ModelMatrix;\nvarying vec4 varying_ShadowCoord;\nvoid main(){\nvarying_ShadowCoord=uniform_ShadowMatrix*uniform_ModelMatrix*vec4(e_position,1.0);\n}",e.shadowPass_fs="uniform sampler2D diffuseTexture;\nvec4 diffuseColor;\nvarying vec2 varying_uv0;\nvarying vec4 varying_color;\nvarying vec4 varying_pos;\nvoid main(){\ndiffuseColor=varying_color;\nif(diffuseColor.w==0.0){\ndiscard;\n}\ndiffuseColor=texture2D(diffuseTexture,varying_uv0);\nif(diffuseColor.w<=0.3){\ndiscard;\n}\ngl_FragColor=vec4(varying_pos.zzz,1.0);\n}",e.shadowPass_vs="attribute vec3 attribute_position;\nattribute vec4 attribute_color;\nattribute vec2 attribute_uv0;\nuniform mat4 uniform_ModelMatrix;\nuniform mat4 uniform_ViewMatrix;\nuniform mat4 uniform_ProjectionMatrix;\nvarying vec2 varying_uv0;\nvarying vec4 varying_color;\nvarying vec4 varying_pos;\nvoid main(){\nmat4 mvMatrix=mat4(uniform_ViewMatrix*uniform_ModelMatrix);\nvarying_color=attribute_color;\nvarying_uv0=attribute_uv0;\nvarying_pos=uniform_ProjectionMatrix*uniform_ViewMatrix*uniform_ModelMatrix*vec4(attribute_position,1.0);\ngl_Position=varying_pos;\n}",e.skeleton_vs="attribute vec4 attribute_boneIndex;\nattribute vec4 attribute_boneWeight;\nattribute vec3 attribute_normal;\nattribute vec4 attribute_color;\nvec4 e_boneIndex=vec4(0.0,0.0,0.0,0.0);\nvec4 e_boneWeight=vec4(0.0,0.0,0.0,0.0);\nconst int bonesNumber=0;\nuniform vec4 uniform_PoseMatrix[bonesNumber];\nvarying vec4 varying_modelViewPosition;\nmat4 buildMat4(int index){\nvec4 quat=uniform_PoseMatrix[index*2+0];\nvec4 translation=uniform_PoseMatrix[index*2+1];\nfloat xy2=2.0*quat.x*quat.y;\nfloat xz2=2.0*quat.x*quat.z;\nfloat xw2=2.0*quat.x*quat.w;\nfloat yz2=2.0*quat.y*quat.z;\nfloat yw2=2.0*quat.y*quat.w;\nfloat zw2=2.0*quat.z*quat.w;\nfloat xx=quat.x*quat.x;\nfloat yy=quat.y*quat.y;\nfloat zz=quat.z*quat.z;\nfloat ww=quat.w*quat.w;\nmat4 matrix=mat4(\nxx-yy-zz+ww,xy2+zw2,xz2-yw2,0,\nxy2-zw2,-xx+yy-zz+ww,yz2+xw2,0,\nxz2+yw2,yz2-xw2,-xx-yy+zz+ww,0,\ntranslation.x,translation.y,translation.z,1\n);\nreturn matrix;\n}\nvoid main(){\ne_boneIndex=attribute_boneIndex;\ne_boneWeight=attribute_boneWeight;\nvec4 temp_position=vec4(attribute_position,1.0);\nvec4 temp_normal=vec4(attribute_normal,0.0);\nmat4 m0=buildMat4(int(e_boneIndex.x));\nmat4 m1=buildMat4(int(e_boneIndex.y));\nmat4 m2=buildMat4(int(e_boneIndex.z));\nmat4 m3=buildMat4(int(e_boneIndex.w));\noutPosition=m0*temp_position*e_boneWeight.x;\noutPosition+=m1*temp_position*e_boneWeight.y;\noutPosition+=m2*temp_position*e_boneWeight.z;\noutPosition+=m3*temp_position*e_boneWeight.w;\ne_position=outPosition.xyz;\nvec4 temp_n;\ntemp_n=m0*temp_normal*e_boneWeight.x;\ntemp_n+=m1*temp_normal*e_boneWeight.y;\ntemp_n+=m2*temp_normal*e_boneWeight.z;\ntemp_n+=m3*temp_normal*e_boneWeight.w;\nmat4 mvMatrix=mat4(uniform_ViewMatrix*uniform_ModelMatrix);\nvarying_modelViewPosition=mvMatrix*vec4(e_position,1.0);\nmat4 normalMatrix=inverse(mvMatrix);\nnormalMatrix=transpose(normalMatrix);\nvarying_eyeNormal=mat3(normalMatrix)*-attribute_normal;\noutPosition.xyzw=varying_modelViewPosition.xyzw;\nvarying_color=attribute_color;\n}",e.spotLight_fs="const int max_spotLight=0;\nuniform float uniform_spotLightSource[12*max_spotLight];\nstruct SpotLight{\nvec3 position;\nvec3 direction;\nvec3 diffuse;\nvec3 ambient;\nfloat range;\nfloat coneCos;\nfloat penumbraCos;\n};\nvoid calculateSpotLight(MaterialSource materialSource){\nvec3 viewDir=normalize(uniform_eyepos-varying_worldPosition.xyz);\nfor(int i=0;i<max_spotLight;i++){\nSpotLight spotLight;\nspotLight.position=vec3(uniform_spotLightSource[i*12],uniform_spotLightSource[i*12+1],uniform_spotLightSource[i*12+2]);\nspotLight.direction=vec3(uniform_spotLightSource[i*12+3],uniform_spotLightSource[i*12+4],uniform_spotLightSource[i*12+5]);\nspotLight.diffuse=vec3(uniform_spotLightSource[i*12+6],uniform_spotLightSource[i*12+7],uniform_spotLightSource[i*12+8]);\nspotLight.range=uniform_spotLightSource[i*12+9];\nspotLight.coneCos=uniform_spotLightSource[i*12+10];\nspotLight.penumbraCos=uniform_spotLightSource[i*12+11];\nvec3 lightOffset=spotLight.position-varying_worldPosition.xyz;\nvec3 lightDir=normalize(lightOffset);\nfloat angleCos=dot(lightDir,-spotLight.direction);\nif(angleCos>spotLight.coneCos){\nfloat spotEffect=smoothstep(spotLight.coneCos,spotLight.penumbraCos,angleCos);\nfloat falloff=computeDistanceLightFalloff(length(lightOffset)*angleCos,spotLight.range);\nfloat diffuse=calculateLightDiffuse(varying_worldNormal,lightDir);\nfloat specular=calculateLightSpecular(varying_worldNormal,lightDir,viewDir,materialSource.specularScale);\nlight.xyz+=(materialSource.ambient+diffuse*materialSource.diffuse+specular*materialSource.specular)*spotLight.diffuse*falloff*spotEffect;\n}\n}\n}\nvoid main(){\ncalculateSpotLight(materialSource);\n}"}(dou3d||(dou3d={})),function(I){!function(t){var l=[];function r(t){for(var e=new I.ShaderContent,r=function(t){for(var e=[],r="",i=";",a=0;a<t.length;++a)if("{"==t.charAt(a)&&r.indexOf("=")<0&&(i="}"),(""!=r||" "!=t.charAt(a)&&"    "!=t.charAt(a)&&"\t"!=t.charAt(a))&&(r+=t.charAt(a),"\n"!=i&&(0<=r.indexOf("#extension")?i="\n":0<=r.indexOf("#define")&&(i="\n")),i==t.charAt(a))){if("}"==i){for(var n=0,o=0,s=0;s<r.length;++s)"{"==r.charAt(s)?n++:"}"==r.charAt(s)&&o++;if(n!=o)continue;if(0<=r.indexOf("struct")){i=";";continue}}0<r.length&&e.push(r),r="",i=";"}return e}(t);0<r.length;){var i=r[0];r.shift();var a=y(i);if(-1==a.indexOf("struct"))if(-1==a.indexOf("function"))if(-1==a.indexOf("unknown"));else{var n=b(m=v(i)),o=D(m);if("sampler2D"==o){var s=P(i);s&&e.addVar(s)}else if("samplerCube"==o){var h=w(i);h&&e.addVar(h)}else if("attribute"==n){var u=S(i);u&&e.addVar(u)}else if("varying"==n){var l=A(i);l&&e.addVar(l)}else if("uniform"==n){var c=T(i);c&&e.addVar(c)}else if("const"==n){var d=L(i);d&&e.addVar(d)}else if("#extension"==n){var p=M(i);p&&e.addVar(p)}else if("#define"==n){var f=E(i);f&&e.addVar(f)}else e.addVar(C(i))}else{var m=a.split(" "),_=i;e.addFunc(m[1],_)}else{var m=a.split(" "),g=i;e.addStruct(m[1],g),x(m[1],g,e)}}return e}function y(t){var e=t.indexOf("{");if(0<e){var r=t.substr(0,e);if(0<=r.indexOf("struct")){var i=r.lastIndexOf(" ");return i++,"struct "+r.substr(i,r.length-i)}if(r.indexOf("=")<0){var a=t.indexOf("(");i=t.lastIndexOf(" ",a);return i++,"function "+t.substr(i,a-i)}}return"unknown"}function x(t,e,r){var i=e.lastIndexOf("}");i++;for(var a=e.lastIndexOf(";"),n=v(e.substr(i,a-i)),o=0;o<n.length;++o){var s=C(t+" "+n[o]+";");s&&r.addVar(s)}}function v(t){for(var e=[],r="",i=!1,a=0;a<t.length;++a)if(i){if(";"==t.charAt(a)){i=!1,0<r.length&&(e.push(r),r="");break}r+=t.charAt(a)}else if(" "!=t.charAt(a)&&"\t"!=t.charAt(a)&&","!=t.charAt(a)&&"\r"!=t.charAt(a)&&"\n"!=t.charAt(a)&&":"!=t.charAt(a)){if(";"==t.charAt(a)){0<r.length&&(e.push(r),r="");break}if("="==t.charAt(a)){0<r.length&&(e.push(r),r=""),e.push("="),i=!0;continue}r+=t.charAt(a),a==t.length-1&&""!=t&&(e.push(r),r="")}else""!=r&&(e.push(r),r="");return e}function i(t,e){for(var r=0;r<t.length;++r)if(t[r]==e)return r;return-1}function s(t,e,r){for(var i=t,a=!1;!a;){a=!0;for(var n=0;n<e.length;++n)if(0<=i.indexOf(e[n])){a=!1;break}for(n=0;n<e.length;++n)i=i.replace(e[n],r)}return i}function b(t){var e=i(t,"=");return 0<=e?0<=(e-=3)&&e<t.length?t[e]:"":0<=(e=t.length-3)&&e<t.length?t[e]:t[0]}function D(t){var e=i(t,"=");if(0<=e){if(0<=(e-=2)&&e<t.length)return t[e]}else if(0<=(e=t.length-2)&&e<t.length)return t[e];return""}function n(t){var e=i(t,"=");if(0<=e){if(0<=(e-=1)&&e<t.length)return t[e]}else if(0<=(e=t.length-1)&&e<t.length)return t[e];return""}function o(t){var e=i(t,"=");return 0<=e&&0<=(e+=1)&&e<t.length?t[e]:""}function P(t){var e;return e=n(v(t)),new I.Sampler2D(e)}function w(t){var e;return e=n(v(t)),new I.Sampler3D(e)}function S(t){var e,r,i,a=v(t);return e=n(a),r=D(a),(i=new I.Attribute(e,r)).value=o(a),i}function A(t){var e,r,i=v(t);return e=n(i),r=D(i),new I.Varying(e,r)}function T(t){var e,r,i=v(t);return e=n(i),r=D(i),new I.Uniform(e,r)}function L(t){var e,r,i,a=v(t);return e=n(a),r=D(a),i=o(a),new I.ConstVar(e,r,i)}function M(t){var e=t.indexOf("#"),r=t.indexOf(" "),i=(t.substr(e,r),t.indexOf(":")),a=t.substr(r,i-r);a=s(a,[" "],""),i+=1;var n=t.substr(i,t.length-i);n=s(n,[" ",":","\n","\r"],"");var o=new I.Extension(a);return o.value=n,o}function E(t){var e,r="",i=v(t);return e=i[1],3<=i.length&&(r=i[2]),new I.DefineVar(e,r)}function C(t){var e,r,i,a=v(t);return e=n(a),r=D(a),(i=new I.TmpVar(e,r)).value=o(a),i}function d(t){return t.value?t.valueType+" "+t.name+" = "+t.value+"; \r\n":t.valueType+" "+t.name+"; \r\n"}function c(t){switch(t){case 0:return I.ContextSamplerType.TEXTURE_0;case 1:return I.ContextSamplerType.TEXTURE_1;case 2:return I.ContextSamplerType.TEXTURE_2;case 3:return I.ContextSamplerType.TEXTURE_3;case 4:return I.ContextSamplerType.TEXTURE_4;case 5:return I.ContextSamplerType.TEXTURE_5;case 6:return I.ContextSamplerType.TEXTURE_6;case 7:return I.ContextSamplerType.TEXTURE_7;case 8:return I.ContextSamplerType.TEXTURE_8}throw new Error("texture not big then 8")}t.load=function(){for(var t in I.ShaderLib){var e=r(I.ShaderLib[t]);(l[t]=e).name=t}},t.fillShaderContent=function(t,e,r){var i,a,n=0,o="";for(n=0;n<e.length;++n)""!=o&&(o+="/"),o+=e[n];if(o+="/d"+r.maxDirectLight,o+="/s"+r.maxSpotLight,o+="/p"+r.maxPointLight,o+="/b"+r.maxBone,l[o])i=l[o].clone();else for((i=new I.ShaderContent).name=o,n=0;n<e.length;++n){var s=l[e[n]];i.addContent(s)}for(n=0;n<i.attributeList.length;n++)r[o=i.attributeList[n].varName]=i.attributeList[n];for(n=0;n<i.varyingList.length;n++)r[o=i.varyingList[n].varName]||(r[o]=i.varyingList[n]);for(n=0;n<i.tempList.length;n++)r[o=i.tempList[n].varName]=i.tempList[n];for(n=0;n<i.uniformList.length;n++)r[o=i.uniformList[n].varName]=i.uniformList[n];for(n=0;n<i.constList.length;n++)switch(o=i.constList[n].varName,a=i.constList[n],r[o]=a,o){case"max_directLight":a.value=r.maxDirectLight;break;case"max_pointLight":a.value=r.maxPointLight;break;case"max_spotLight":a.value=r.maxSpotLight;break;case"bonesNumber":a.value=r.maxBone}for(n=0;n<i.sampler2DList.length;n++){var h=i.sampler2DList[n];h.index=n,r.sampler2DList.push(h),h.activeTextureIndex=c(n)}for(n=0;n<i.sampler3DList.length;n++){var u=i.sampler3DList[n];u.activeTextureIndex=c(i.sampler2DList.length+n),u.index=i.sampler2DList.length+n,r.sampler3DList.push(u)}return function(t,e){var r,i,a,n,o,s,h,u="";for(r=0;r<t.extensionList.length;r++)u+="#extension "+(i=t.extensionList[r]).name+":"+i.value+"\r\n";for(u+="precision highp float;\n",r=0;r<t.defineList.length;r++)u+=(a=t.defineList[r]).key+" "+a.name+" "+a.value+"\r\n";for(r=0;r<t.attributeList.length;r++)u+="attribute "+(n=t.attributeList[r]).valueType+" "+n.name+"; \r\n";for(r=0;r<t.structNames.length;r++)u+=t.structDict[t.structNames[r]]+" \r\n";for(r=0;r<t.varyingList.length;r++)u+="varying "+(o=t.varyingList[r]).valueType+" "+o.name+"; \r\n";for(r=0;r<t.tempList.length;r++)u+=d(t.tempList[r]);for(r=0;r<t.constList.length;r++)u+="const "+(s=t.constList[r]).valueType+" "+s.name+" = "+s.value+"; \r\n";for(r=0;r<t.uniformList.length;r++)u+="uniform "+(h=t.uniformList[r]).valueType+" "+h.name+"; \r\n";for(r=0;r<t.sampler2DList.length;r++){var l=t.sampler2DList[r];u+="uniform sampler2D "+l.name+"; \r\n"}for(r=0;r<t.sampler3DList.length;r++){var c=t.sampler3DList[r];u+="uniform samplerCube "+c.name+"; \r\n"}for(r=0;r<t.funcNames.length;r++)u+=t.funcDict[t.funcNames[r]];t.source=u}(i),I.ShaderPool.getGPUShader(t.shaderType,i.name,i.source)}}(I.ShaderUtil||(I.ShaderUtil={}))}(dou3d||(dou3d={})),function(n){var t=function(){function t(){this._enableShadow=!1,this._textureWidth=4096,this._textureHeight=4096}return Object.defineProperty(t,"instance",{get:function(){return t._instance||(t._instance=new t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"enableShadow",{get:function(){return this._enableShadow},set:function(t){this._enableShadow=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"textureWidth",{get:function(){return this._textureWidth},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"textureHeight",{get:function(){return this._textureHeight},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"shadowCamera",{get:function(){return this._shadowCamera},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"shadowRender",{get:function(){return this._shadowRender},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"directLight",{get:function(){return this._directLight},enumerable:!0,configurable:!0}),t.prototype.setTextureSize=function(t,e){this._textureWidth=t,this._textureHeight=e,this._shadowRender.setRenderToTexture(this._textureWidth,this._textureHeight,3)},t.prototype.castShadowLight=function(t){this._directLight=t,this._shadowCamera.updateViewport(0,0,2048,2048),this._shadowCamera.near=1,this._shadowCamera.far=3e3,t.addChild(this._shadowCamera)},t.prototype.update=function(t,e,r,i,a){n.Engine.context3DProxy.clearColor(1,1,1,1),n.Engine.context3DProxy.clear(n.Context3DProxy.gl.COLOR_BUFFER_BIT|n.Context3DProxy.gl.DEPTH_BUFFER_BIT),this._shadowRender.draw(r,i,n.Engine.context3DProxy,t,this._shadowCamera,a)},t}();n.ShadowCast=t}(dou3d||(dou3d={})),function(n){var t=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.useMipmap=!0,t.smooth=!0,t.repeat=!1,t.hasMipmap=!1,t._ready=!1,t}return __extends(t,e),t.prototype.copyFromTexture=function(t,e,r,i,a){(this.parentTexture=t).width=i,t.height=a,this.texture2D=t.texture2D,this.uvRectangle=this.uvRectangle||new n.Rectangle,this.uvRectangle.x=e,this.uvRectangle.y=r,this.uvRectangle.w=i,this.uvRectangle.h=a},t.prototype.activeState=function(t){this._ready||(this._ready=!0,this.premultiplyAlpha||n.Context3DProxy.gl.pixelStorei(n.Context3DProxy.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this.useMipmap&&!this.hasMipmap&&(n.Context3DProxy.gl.generateMipmap(n.Context3DProxy.gl.TEXTURE_2D),this.hasMipmap=!0),this.smooth?(this.hasMipmap?t.texParameteri(n.Context3DProxy.gl.TEXTURE_2D,n.Context3DProxy.gl.TEXTURE_MIN_FILTER,n.Context3DProxy.gl.LINEAR_MIPMAP_LINEAR):t.texParameteri(n.Context3DProxy.gl.TEXTURE_2D,n.Context3DProxy.gl.TEXTURE_MIN_FILTER,n.Context3DProxy.gl.LINEAR),t.texParameteri(n.Context3DProxy.gl.TEXTURE_2D,n.Context3DProxy.gl.TEXTURE_MAG_FILTER,n.Context3DProxy.gl.LINEAR)):(t.texParameteri(n.Context3DProxy.gl.TEXTURE_2D,n.Context3DProxy.gl.TEXTURE_MIN_FILTER,n.Context3DProxy.gl.NEAREST),t.texParameteri(n.Context3DProxy.gl.TEXTURE_2D,n.Context3DProxy.gl.TEXTURE_MAG_FILTER,n.Context3DProxy.gl.NEAREST)),this.repeat?(t.texParameteri(n.Context3DProxy.gl.TEXTURE_2D,n.Context3DProxy.gl.TEXTURE_WRAP_S,n.Context3DProxy.gl.REPEAT),t.texParameteri(n.Context3DProxy.gl.TEXTURE_2D,n.Context3DProxy.gl.TEXTURE_WRAP_T,n.Context3DProxy.gl.REPEAT)):(t.texParameteri(n.Context3DProxy.gl.TEXTURE_2D,n.Context3DProxy.gl.TEXTURE_WRAP_S,n.Context3DProxy.gl.CLAMP_TO_EDGE),t.texParameteri(n.Context3DProxy.gl.TEXTURE_2D,n.Context3DProxy.gl.TEXTURE_WRAP_T,n.Context3DProxy.gl.CLAMP_TO_EDGE)),this.filp_y&&n.Context3DProxy.gl.pixelStorei(n.Context3DProxy.gl.UNPACK_FLIP_Y_WEBGL,this.filp_y))},t.prototype.dispose=function(){this.texture2D&&this.texture2D.dispose(),this.texture2D=null,this.texture3D&&this.texture3D.dispose(),this.texture3D=null},t}(dou.HashObject);n.TextureBase=t}(dou3d||(dou3d={})),function(i){var t=function(r){function t(t){var e=r.call(this)||this;return e._imageData=t,e.texture2D=new i.ContextTexture2D,e.texture2D.imageData=t,e}return __extends(t,r),Object.defineProperty(t.prototype,"width",{get:function(){return this._imageData.width},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return this._imageData.height},enumerable:!0,configurable:!0}),t.prototype.upload=function(t){this.texture2D.texture||(this.texture2D.texture=t.createTexture(),this.texture2D.internalFormat=0,this.texture2D.imageData=this._imageData,this.texture2D.dataFormat=i.Context3DProxy.gl.UNSIGNED_BYTE,this.texture2D.colorFormat=i.Context3DProxy.gl.RGBA,t.upLoadTextureData(0,this))},t.prototype.uploadForcing=function(t){t.upLoadTextureData(0,this)},t}(i.TextureBase);i.ImageTexture=t}(dou3d||(dou3d={})),function(r){var t=function(e){function t(){var t=e.call(this)||this;return t.smooth=!0,t.texture2D=new r.ContextTexture2D,t}return __extends(t,e),t.prototype.upload=function(t){if(!this.texture2D.texture){if(this.texture2D.texture=this.texture2D.texture||t.createTexture(),this.texture2D.internalFormat=this.internalFormat,this.texture2D.colorFormat=this.colorFormat,this.texture2D.mimapData=this.mimapData,this.texture2D.dataFormat=r.Context3DProxy.gl.UNSIGNED_BYTE,this.mimapData&&0<this.mimapData.length)for(var e=0;e<this.mimapData.length;e++)t.upLoadTextureData(e,this);else t.upLoadTextureData(0,this);this.parentTexture&&(this.parentTexture.texture2D||this.parentTexture.upload(t),this.texture2D=this.parentTexture.texture2D,this.texture2D.internalFormat=this.parentTexture.internalFormat,this.texture2D.colorFormat=this.parentTexture.colorFormat,this.texture2D.mimapData=this.parentTexture.mimapData)}},t.prototype.uploadForcing=function(t){t.upLoadTextureData(0,this)},t}(r.TextureBase);r.Texture=t}(dou3d||(dou3d={})),function(h){var t=function(s){function t(t,e,r,i,a,n){var o=s.call(this)||this;return o.image_front=t,o.image_back=e,o.image_left=r,o.image_right=i,o.image_up=a,o.image_down=n,o.texture3D=new h.ContextTexture3D,o}return __extends(t,s),t.prototype.upload=function(t){this.image_front&&this.image_back&&this.image_left&&this.image_right&&this.image_up&&this.image_down&&(this.texture3D.texture||(this.texture3D.texture=this.texture3D.texture||t.createTexture(),this.texture3D.border=0,this.texture3D.image_front=this.image_front,this.texture3D.image_back=this.image_back,this.texture3D.image_left=this.image_left,this.texture3D.image_right=this.image_right,this.texture3D.image_up=this.image_up,this.texture3D.image_down=this.image_down,t.uploadCubetexture(this.texture3D)))},t.prototype.uploadForcing=function(t){},t}(h.TextureBase);h.CubeTexture=t}(dou3d||(dou3d={})),function(n){var t=function(a){function t(t,e,r){void 0===t&&(t=512),void 0===e&&(e=512),void 0===r&&(r=2);var i=a.call(this)||this;return i.useMipmap=!1,i.smooth=!1,i.width=t,i.height=e,i.frameBufferFormat=r,i.uvRectangle=new n.Rectangle(0,0,1,1),i}return __extends(t,a),t.prototype.upload=function(t){this.texture2D||(this.texture2D=t.createFramebuffer(this.width,this.height,this.frameBufferFormat))},t.prototype.uploadForcing=function(t){},t}(n.TextureBase);n.RenderTexture=t}(dou3d||(dou3d={})),function(n){var t=function(i){function t(t,e){void 0===t&&(t=32),void 0===e&&(e=32);var r=i.call(this)||this;return r.width=t,r.height=e,r.uvRectangle=new n.Rectangle(0,0,1,1),r.buildCheckerboard(),r.texture2D=new n.ContextTexture2D,r}return __extends(t,i),t.prototype.buildCheckerboard=function(){if(!this._pixelArray){this._pixelArray=new Uint8Array(this.width*this.height*4);for(var t=[n.Color.WHITE,n.Color.BLACK],e=0,r=0;r<this.height;r++)for(var i=0;i<this.width;i++){if(i%4==0&&(e=(e+1)%2),r%4==0&&0==i){var a=t[0];t[0]=t[1],t[1]=a,e=0}this._pixelArray[r*(4*this.width)+4*i+0]=255*t[e].r,this._pixelArray[r*(4*this.width)+4*i+1]=255*t[e].g,this._pixelArray[r*(4*this.width)+4*i+2]=255*t[e].b,this._pixelArray[r*(4*this.width)+4*i+3]=255*t[e].a}}},t.prototype.upload=function(t){this.texture2D.texture||(this.texture2D.texture=this.texture2D.texture||t.createTexture(),this.texture2D.border=0,this.texture2D.internalFormat=2,this.texture2D.dataFormat=n.Context3DProxy.gl.UNSIGNED_BYTE,this.texture2D.colorFormat=n.Context3DProxy.gl.RGBA,this.texture2D.mimapData=[],this.texture2D.mimapData.push(new n.MipmapData(this._pixelArray,this.width,this.height)),this.texture2D.width=this.width,this.texture2D.height=this.height,this.useMipmap=!1,t.upLoadTextureData(0,this))},t.prototype.uploadForcing=function(t){t.upLoadTextureData(0,this)},t.prototype.dispose=function(){i.prototype.dispose.call(this),this._pixelArray=null},t.texture=new t,t}(n.TextureBase);n.CheckerboardTexture=t}(dou3d||(dou3d={})),function(t){var e;(e=t.MathUtil||(t.MathUtil={})).PI_HALF=.5*Math.PI,e.PI_QUARTER=.25*Math.PI,e.PI_DOUBLE=2*Math.PI,e.RAD_DEG=180/Math.PI,e.DEG_RAD=Math.PI/180,e.EPSILON=2220446049250313e-31,e.SQRT_2=1.4142135623731,e.SQRT1_2=.5*e.SQRT_2,e.INT_MAX=2147483647,e.INT_MIN=-2147483647,e.clamp=function(t,e,r){return void 0===e&&(e=0),void 0===r&&(r=1),t<e?e:r<t?r:t},e.lerp=function(t,e,r){return t+(e-t)*r},e.toRadians=function(t){return t*Math.PI/180},e.toDegrees=function(t){return 180*t/Math.PI}}(dou3d||(dou3d={})),function(r){(r.GeometryUtil||(r.GeometryUtil={})).fromVertexFormatToLength=function(t){var e=0;return 1&t&&(e+=r.Geometry.positionSize),2&t&&(e+=r.Geometry.normalSize),4&t&&(e+=r.Geometry.tangentSize),8&t&&(e+=r.Geometry.colorSize),16&t&&(e+=r.Geometry.uvSize),32&t&&(e+=r.Geometry.uv2Size),64&t&&(e+=r.Geometry.skinSize),e}}(dou3d||(dou3d={})),function(u){var t=function(){function r(t){var i=this;t||((t=document.createElement("canvas")).style.position="fixed",t.style.left="0px",t.style.top="0px",t.style.width="100%",t.style.height="100%",document.body.appendChild(t)),this._canvas=u.canvas=t;var e=t.getContext("experimental-webgl")||t.getContext("webgl");e?(u.Context3DProxy.gl=e,window.addEventListener("mousedown",function(t){i.onTouchEvent("mousedown",t)}),window.addEventListener("mousemove",function(t){i.onTouchEvent("mousemove",t)}),window.addEventListener("mouseup",function(t){i.onTouchEvent("mouseup",t)}),window.addEventListener("touchstart",function(t){i.onTouchEvent("touchstart",t)}),window.addEventListener("touchmove",function(t){i.onTouchEvent("touchmove",t)}),window.addEventListener("touchend",function(t){i.onTouchEvent("touchend",t)}),window.addEventListener("touchcancel",function(t){i.onTouchEvent("touchcancel",t)}),window.addEventListener("resize",function(){setTimeout(function(){for(var t=0,e=i._view3Ds;t<e.length;t++){var r=e[t];u.Event3D.dispatch(r,u.Event3D.RESIZE)}},300)}),this._viewRect=new u.Rectangle,this._view3Ds=[],(r.context3DProxy=new u.Context3DProxy).register(),u.ticker=new u.Ticker(this),this.startTicker()):console.error("You drivers not suport WEBGL!")}return Object.defineProperty(r.prototype,"viewRect",{get:function(){var t=this._canvas.getBoundingClientRect();return this._viewRect.set(t.left,t.top,t.width,t.height),this._canvas.width=t.width,this._canvas.height=t.height,this._viewRect},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"view3Ds",{get:function(){return this._view3Ds},enumerable:!0,configurable:!0}),r.prototype.addView3D=function(t){-1==this._view3Ds.indexOf(t)&&this._view3Ds.push(t)},r.prototype.removeView3D=function(t){var e=this._view3Ds.indexOf(t);-1!=e&&this._view3Ds.splice(e,1)},r.prototype.startTicker=function(){requestAnimationFrame(function t(){u.ticker.update();requestAnimationFrame(t)})},r.prototype.onTouchEvent=function(t,e){var r,i=this._canvas.getBoundingClientRect(),a=dou.recyclable(u.Vector2);if(e instanceof MouseEvent){switch(t){case"mousedown":r=u.Event3D.TOUCH_BEGIN;break;case"mousemove":r=u.Event3D.TOUCH_MOVE;break;case"mouseup":r=u.Event3D.TOUCH_END}a.set(e.clientX-i.left,e.clientY-i.top)}else{switch(t){case"touchstart":r=u.Event3D.TOUCH_BEGIN;break;case"touchmove":r=u.Event3D.TOUCH_MOVE;break;case"touchend":case"touchcancel":r=u.Event3D.TOUCH_END}if(0<e.touches.length){var n=e.touches[0];a.set(n.clientX-i.left,n.clientY-i.top)}}for(var o=0,s=this._view3Ds;o<s.length;o++){var h=s[o];u.Event3D.dispatch(h,r,a)}a.recycle()},r}();u.Engine=t}(dou3d||(dou3d={}));