var dou3d,__extends=this&&this.__extends||function(){var r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)};return function(t,e){function i(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}}();!function(t){var e=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._count=0,t}return __extends(t,e),Object.defineProperty(t.prototype,"canDispose",{get:function(){return this._count<=0},enumerable:!0,configurable:!0}),t.prototype.incRef=function(){this._count++},t.prototype.decRef=function(){0<=this._count-1&&this._count--},t}(dou.HashObject);t.Reference=e}(dou3d||(dou3d={})),function(r){var t=function(i){function t(t){var e=i.call(this)||this;return e._vexLength=3,e._owner=t,e._defaultMatrix=new r.Matrix4,e}return __extends(t,i),Object.defineProperty(t.prototype,"owner",{get:function(){return this._owner},set:function(t){this._owner=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"vexData",{get:function(){return this._vexData},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"indexData",{get:function(){return this._indexData},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"vexLength",{get:function(){return this._vexLength},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"childBound",{get:function(){return this._childBound},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"transform",{get:function(){return this._owner?this._owner.globalMatrix:this._defaultMatrix},enumerable:!0,configurable:!0}),t.prototype.calculateTransform=function(){for(var t=dou.recyclable(r.Vector4),e=0;e<this._vexData.length;e+=3)t.set(this._vexData[e],this._vexData[e+1],this._vexData[e+2],0),this.transform.transformVector(t,t),this._vexData[e+0]=t.x,this._vexData[e+1]=t.y,this._vexData[e+2]=t.z;t.recycle()},t.prototype.copyVertex=function(t){for(var e=0;e<t.vexData.length;++e)this._vexData[e]=t.vexData[e];for(e=0;e<t.indexData.length;++e)this._indexData[e]=t.indexData[e];this._vexLength=t.vexLength},t.prototype.dispose=function(){this._childBound&&this._childBound.dispose()},t}(dou.HashObject);r.Bound=t}(dou3d||(dou3d={})),function(n){var t=function(a){function i(t,e,i){var r=a.call(this,t)||this;return r._width=0,r._heigth=0,r._depth=0,r._volume=0,r._radius=0,r._min=new n.Vector3,r._min.copy(e),r._max=new n.Vector3,r._max.copy(i),r._center=new n.Vector3,r.calculateBox(),r}return __extends(i,a),Object.defineProperty(i.prototype,"min",{get:function(){return this._min},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"max",{get:function(){return this._max},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"height",{get:function(){return this._heigth},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"depth",{get:function(){return this._depth},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"volume",{get:function(){return this._volume},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"center",{get:function(){return this._center},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"radius",{get:function(){return this._radius},enumerable:!0,configurable:!0}),i.prototype.copy=function(t){this._min.copy(t._min),this._max.copy(t._max),this.calculateBox()},i.prototype.fillBox=function(t,e){this._min.copy(t),this._max.copy(e),this.calculateBox()},i.prototype.createChild=function(){this._childBound=new i(this.owner,new n.Vector3,new n.Vector3);var t=new n.Vector3,e=new n.Vector3;t.x=this._center.x+this._width/4,t.y=this._center.y+this._heigth/4,t.z=this._center.z+this._depth/4,e.x=this._center.x-this._width/4,e.y=this._center.y-this._heigth/4,e.z=this._center.z-this._depth/4,this.childBound.fillBox(e,t)},i.prototype.updateAABB=function(){this._min.copy(new n.Vector3(n.MathUtil.INT_MAX,n.MathUtil.INT_MAX,n.MathUtil.INT_MAX)),this._max.copy(new n.Vector3(n.MathUtil.INT_MIN,n.MathUtil.INT_MIN,n.MathUtil.INT_MIN));for(var t=0;t<this.vexData.length;t+=this.vexLength)this._max.x<this.vexData[t]&&(this._max.x=this.vexData[t]),this._max.y<this.vexData[t+1]&&(this._max.y=this.vexData[t+1]),this._max.z<this.vexData[t+2]&&(this._max.z=this.vexData[t+2]),this._min.x>this.vexData[t]&&(this._min.x=this.vexData[t]),this._min.y>this.vexData[t+1]&&(this._min.y=this.vexData[t+1]),this._min.z>this.vexData[t+2]&&(this._min.z=this.vexData[t+2])},i.prototype.calculateBox=function(){var t=this._max.subtract(this._min);this._vexData=this.vexData||new Float32Array(24),this._indexData=this.indexData||new Uint16Array(36),this.vexData[0]=this._min.x,this.vexData[1]=this._min.y,this.vexData[2]=this._min.z,this.vexData[3]=this._min.x,this.vexData[4]=this._min.y,this.vexData[5]=this._min.z+t.z,this.vexData[6]=this._min.x+t.x,this.vexData[7]=this._min.y,this.vexData[8]=this._min.z+t.z,this.vexData[9]=this._min.x+t.x,this.vexData[10]=this._min.y,this.vexData[11]=this._min.z,this.vexData[12]=this._max.x-t.x,this.vexData[13]=this._max.y,this.vexData[14]=this._max.z-t.z,this.vexData[15]=this._max.x-t.x,this.vexData[16]=this._max.y,this.vexData[17]=this._max.z,this.vexData[18]=this._max.x,this.vexData[19]=this._max.y,this.vexData[20]=this._max.z,this.vexData[21]=this._max.x,this.vexData[22]=this._max.y,this.vexData[23]=this._max.z-t.z,this.indexData[0]=0,this.indexData[1]=4,this.indexData[2]=7,this.indexData[3]=0,this.indexData[4]=7,this.indexData[5]=3,this.indexData[6]=2,this.indexData[7]=6,this.indexData[8]=5,this.indexData[9]=2,this.indexData[10]=5,this.indexData[11]=1,this.indexData[12]=4,this.indexData[13]=5,this.indexData[14]=6,this.indexData[15]=4,this.indexData[16]=6,this.indexData[17]=7,this.indexData[18]=0,this.indexData[19]=3,this.indexData[20]=2,this.indexData[21]=0,this.indexData[22]=2,this.indexData[23]=1,this.indexData[24]=0,this.indexData[25]=1,this.indexData[26]=5,this.indexData[27]=0,this.indexData[28]=5,this.indexData[29]=4,this.indexData[30]=3,this.indexData[31]=7,this.indexData[32]=6,this.indexData[33]=3,this.indexData[34]=6,this.indexData[35]=2,this._width=this._max.x-this._min.x,this._heigth=this._max.y-this._min.y,this._depth=this._max.z-this._min.z,this._volume=this._width*this._heigth*this._depth;var e=this._max.subtract(this._min);e.multiplyScalar(.5),this._radius=e.length,this._center.copy(this._min);var i=this._center.add(e);this._center.copy(i)},i.prototype.pointIntersect=function(t){return t.x<=this._max.x&&t.x>=this._min.x&&t.y<=this._max.y&&t.y>=this._min.y&&t.z<=this._max.z&&t.z>=this._min.z},i.prototype.intersectAABBs=function(t,e){return!(this._min.x>t._max.x)&&(!(this._max.x<t._min.x)&&(!(this._min.y>t._max.y)&&(!(this._max.y<t._min.y)&&(!(this._min.z>t._max.z)&&(!(this._max.z<t._min.z)&&(e&&(e._min.x=Math.max(this._min.x,t._min.x),e._max.x=Math.min(this._max.x,t._max.x),e._min.y=Math.max(this._min.y,t._min.y),e._max.y=Math.min(this._max.y,t._max.y),e._min.z=Math.max(this._min.z,t._min.z),e._max.z=Math.min(this._max.z,t._max.z),e.calculateBox()),!0))))))},i.prototype.intersect=function(t,e){return void 0===e&&(e=null),this._box1?(this._box1.copyVertex(this),this._box1.owner=this.owner):this._box1=this.clone(),this._box1.calculateTransform(),this._box1.updateAABB(),this._box2?(this._box2.copyVertex(this),this._box2.owner=t.owner):this._box2=t.clone(),this._box2.calculateTransform(),this._box2.updateAABB(),this._box1.intersectAABBs(this._box2,e)},i.prototype.inBound=function(t){var e=dou.recyclable(n.Vector4);this.transform.transformVector(this._center,e);var i=t.inSphere(e,this._radius);return e.recycle(),i},i.prototype.toString=function(){return"BoundBox [min:("+this._min.x+", "+this._min.y+", "+this._min.z+") max:("+this._max.x+", "+this._max.y+", "+this._max.z+")]"},i.prototype.clone=function(){return new i(this.owner,this._min,this._max)},i}(n.Bound);n.BoundBox=t}(dou3d||(dou3d={})),function(u){var t=function(){function h(){}return h.prototype.register=function(){h.gl.getExtension("WEBGL_depth_texture")||h.gl.getExtension("MOZ_WEBGL_depth_texture")||h.gl.getExtension("WEBKIT_WEBGL_depth_texture"),h.gl.getExtension("EXT_texture_filter_anisotropic")||h.gl.getExtension("MOZ_EXT_texture_filter_anisotropic")||h.gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),h.gl.getExtension("WEBGL_compressed_texture_pvrtc")||h.gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),h.gl.getExtension("WEBGL_compressed_texture_etc1"),h.gl.getExtension("OES_element_index_uint"),h.gl.getExtension("OES_texture_float_linear"),h.gl.getExtension("OES_texture_float"),h.gl.getExtension("OES_texture_half_float"),h.gl.getExtension("OES_texture_half_float_linear"),h.gl.getExtension("OES_standard_derivatives"),h.gl.getExtension("GL_OES_standard_derivatives"),h.gl.getExtension("WEBGL_draw_buffers"),h.gl.getExtension("WEBGL_depth_texture"),h.gl.getExtension("WEBGL_lose_context"),u.ContextConfig.register(h.gl)},h.prototype.viewPort=function(t,e,i,r){h.gl.viewport(t,e,i,r)},h.prototype.setScissorRectangle=function(t,e,i,r){h.gl.scissor(t,u.ContextConfig.canvasRectangle.h-r-e,i,r)},h.prototype.createVertexShader=function(t){var e=h.gl.createShader(h.gl.VERTEX_SHADER);return h.gl.shaderSource(e,t),h.gl.compileShader(e),new u.Shader(e)},h.prototype.createFragmentShader=function(t){var e=h.gl.createShader(h.gl.FRAGMENT_SHADER);return h.gl.shaderSource(e,t),h.gl.compileShader(e),new u.Shader(e)},h.prototype.createProgram=function(t,e){var i=h.gl.createProgram();h.gl.attachShader(i,t.shader),h.gl.attachShader(i,e.shader),h.gl.linkProgram(i);var r=h.gl.getProgramParameter(i,h.gl.LINK_STATUS);return DEBUG&&!r&&(console.error("vsShader error"+h.gl.getShaderInfoLog(t.shader)),console.error("fsShader error"+h.gl.getShaderInfoLog(e.shader))),new u.Program3D(i)},h.prototype.setProgram=function(t){this._program!=t&&(this._program=t,h.gl.useProgram(t.program))},h.prototype.createVertexBuffer=function(t,e){void 0===e&&(e=h.gl.STATIC_DRAW);var i=h.gl.createBuffer();return h.gl.bindBuffer(h.gl.ARRAY_BUFFER,i),h.gl.bufferData(h.gl.ARRAY_BUFFER,t,e),new u.VertexBuffer3D(i,t)},h.prototype.uploadVertexBuffer=function(t){h.gl.bindBuffer(h.gl.ARRAY_BUFFER,t.buffer),h.gl.bufferData(h.gl.ARRAY_BUFFER,t.arrayBuffer,h.gl.DYNAMIC_DRAW)},h.prototype.createIndexBuffer=function(t){var e=h.gl.createBuffer();return h.gl.bindBuffer(h.gl.ELEMENT_ARRAY_BUFFER,e),h.gl.bufferData(h.gl.ELEMENT_ARRAY_BUFFER,t,h.gl.STATIC_DRAW),new u.IndexBuffer3D(e,t)},h.prototype.uploadIndexBuffer=function(t){h.gl.bindBuffer(h.gl.ELEMENT_ARRAY_BUFFER,t.buffer),h.gl.bufferData(h.gl.ELEMENT_ARRAY_BUFFER,t.arrayBuffer,h.gl.DYNAMIC_DRAW)},h.prototype.getUniformLocation=function(t,e){return h.gl.getUniformLocation(t.program,e)},h.prototype.uniform1f=function(t,e){h.gl.uniform1f(t,e)},h.prototype.uniform1fv=function(t,e){h.gl.uniform1fv(t,e)},h.prototype.uniform1i=function(t,e){h.gl.uniform1i(t,e)},h.prototype.uniform1iv=function(t,e){h.gl.uniform1iv(t,e)},h.prototype.uniform2f=function(t,e,i){h.gl.uniform2f(t,e,i)},h.prototype.uniform2fv=function(t,e){h.gl.uniform2fv(t,e)},h.prototype.uniform2i=function(t,e,i){h.gl.uniform2i(t,e,i)},h.prototype.uniform2iv=function(t,e){h.gl.uniform2iv(t,e)},h.prototype.uniform3f=function(t,e,i,r){h.gl.uniform3f(t,e,i,r)},h.prototype.uniform3fv=function(t,e){h.gl.uniform3fv(t,e)},h.prototype.uniform3i=function(t,e,i,r){h.gl.uniform3i(t,e,i,r)},h.prototype.uniform3iv=function(t,e){h.gl.uniform3iv(t,e)},h.prototype.uniform4f=function(t,e,i,r,a){h.gl.uniform4f(t,e,i,r,a)},h.prototype.uniform4fv=function(t,e){h.gl.uniform4fv(t,e)},h.prototype.uniform4i=function(t,e,i,r,a){h.gl.uniform4i(t,e,i,r,a)},h.prototype.uniform4iv=function(t,e){h.gl.uniform4iv(t,e)},h.prototype.uniformMatrix2fv=function(t,e,i){h.gl.uniformMatrix2fv(t,e,i)},h.prototype.uniformMatrix3fv=function(t,e,i){h.gl.uniformMatrix3fv(t,e,i)},h.prototype.uniformMatrix4fv=function(t,e,i){h.gl.uniformMatrix4fv(t,e,i)},h.prototype.getShaderAttribLocation=function(t,e){return h.gl.getAttribLocation(t.program,e)},h.prototype.disableAllVertexAttribArray=function(){for(var t=0;t<8;t++)h.gl.disableVertexAttribArray(t)},h.prototype.vertexAttribPointer=function(t,e,i,r,a,n){h.gl.vertexAttribPointer(t,e,i,r,a,n),h.gl.enableVertexAttribArray(t)},h.prototype.setVertexShaderConstData=function(t,e,i){h.gl.vertexAttrib4fv(e,t.subarray(e,i))},h.prototype.bindVertexBuffer=function(t){h.gl.bindBuffer(h.gl.ARRAY_BUFFER,t.buffer)},h.prototype.bindIndexBuffer=function(t){h.gl.bindBuffer(h.gl.ELEMENT_ARRAY_BUFFER,t.buffer)},h.prototype.createTexture=function(){return h.gl.createTexture()},h.prototype.texParameteri=function(t,e,i){h.gl.texParameteri(t,e,i)},h.prototype.upLoadTextureData=function(t,e){h.gl.bindTexture(h.gl.TEXTURE_2D,e.texture2D.texture),2==e.texture2D.internalFormat?h.gl.texImage2D(h.gl.TEXTURE_2D,0,h.gl.RGBA,h.gl.RGBA,e.texture2D.dataFormat,e.texture2D.imageData):1==e.texture2D.internalFormat?this.upLoadCompressedTexture2D(t,e.texture2D):0==e.texture2D.internalFormat&&h.gl.texImage2D(h.gl.TEXTURE_2D,t,e.texture2D.colorFormat,e.texture2D.mimapData[t].width,e.texture2D.mimapData[t].height,e.texture2D.border,e.texture2D.colorFormat,e.texture2D.dataFormat,e.texture2D.mimapData[t].data),e.useMipmap&&h.gl.generateMipmap(h.gl.TEXTURE_2D)},h.prototype.upLoadCompressedTexture2D=function(t,e){h.gl.compressedTexImage2D(h.gl.TEXTURE_2D,t,e.colorFormat,e.mimapData[t].width,e.mimapData[t].height,e.border,e.mimapData[t].data)},h.prototype.uploadCubetexture=function(t){h.gl.bindTexture(h.gl.TEXTURE_CUBE_MAP,t.texture),t.image_right.mimapData&&0<t.image_right.mimapData.length?h.gl.texImage2D(h.gl.TEXTURE_CUBE_MAP_POSITIVE_X,0,h.gl.RGB,t.image_right.mimapData[0].width,t.image_right.mimapData[0].height,0,h.gl.RGB,h.gl.UNSIGNED_BYTE,t.image_right.mimapData[0].data):h.gl.texImage2D(h.gl.TEXTURE_CUBE_MAP_POSITIVE_X,0,h.gl.RGB,h.gl.RGB,h.gl.UNSIGNED_BYTE,t.image_right.imageData),t.image_left.mimapData&&0<t.image_left.mimapData.length?h.gl.texImage2D(h.gl.TEXTURE_CUBE_MAP_NEGATIVE_X,0,h.gl.RGB,t.image_right.mimapData[0].width,t.image_right.mimapData[0].height,0,h.gl.RGB,h.gl.UNSIGNED_BYTE,t.image_right.mimapData[0].data):h.gl.texImage2D(h.gl.TEXTURE_CUBE_MAP_NEGATIVE_X,0,h.gl.RGB,h.gl.RGB,h.gl.UNSIGNED_BYTE,t.image_left.imageData),t.image_up.mimapData&&0<t.image_up.mimapData.length?h.gl.texImage2D(h.gl.TEXTURE_CUBE_MAP_POSITIVE_Y,0,h.gl.RGB,t.image_up.mimapData[0].width,t.image_up.mimapData[0].height,0,h.gl.RGB,h.gl.UNSIGNED_BYTE,t.image_up.mimapData[0].data):h.gl.texImage2D(h.gl.TEXTURE_CUBE_MAP_POSITIVE_Y,0,h.gl.RGB,h.gl.RGB,h.gl.UNSIGNED_BYTE,t.image_up.imageData),t.image_down.mimapData&&0<t.image_down.mimapData.length?h.gl.texImage2D(h.gl.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,h.gl.RGB,t.image_down.mimapData[0].width,t.image_down.mimapData[0].height,0,h.gl.RGB,h.gl.UNSIGNED_BYTE,t.image_down.mimapData[0].data):h.gl.texImage2D(h.gl.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,h.gl.RGB,h.gl.RGB,h.gl.UNSIGNED_BYTE,t.image_down.imageData),t.image_back.mimapData&&0<t.image_back.mimapData.length?h.gl.texImage2D(h.gl.TEXTURE_CUBE_MAP_POSITIVE_Z,0,h.gl.RGB,t.image_back.mimapData[0].width,t.image_back.mimapData[0].height,0,h.gl.RGB,h.gl.UNSIGNED_BYTE,t.image_back.mimapData[0].data):h.gl.texImage2D(h.gl.TEXTURE_CUBE_MAP_POSITIVE_Z,0,h.gl.RGB,h.gl.RGB,h.gl.UNSIGNED_BYTE,t.image_back.imageData),t.image_front.mimapData&&0<t.image_front.mimapData.length?h.gl.texImage2D(h.gl.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,h.gl.RGB,t.image_front.mimapData[0].width,t.image_front.mimapData[0].height,0,h.gl.RGB,h.gl.UNSIGNED_BYTE,t.image_front.mimapData[0].data):h.gl.texImage2D(h.gl.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,h.gl.RGB,h.gl.RGB,h.gl.UNSIGNED_BYTE,t.image_front.imageData),h.gl.texParameteri(h.gl.TEXTURE_CUBE_MAP,h.gl.TEXTURE_MAG_FILTER,h.gl.LINEAR),h.gl.texParameteri(h.gl.TEXTURE_CUBE_MAP,h.gl.TEXTURE_MIN_FILTER,h.gl.LINEAR),h.gl.texParameteri(h.gl.TEXTURE_CUBE_MAP,h.gl.TEXTURE_WRAP_S,h.gl.CLAMP_TO_EDGE),h.gl.texParameteri(h.gl.TEXTURE_CUBE_MAP,h.gl.TEXTURE_WRAP_T,h.gl.CLAMP_TO_EDGE)},h.prototype.createFramebuffer=function(t,e,i){var r=h.gl.createFramebuffer(),a=new u.ContextTexture2D,n=h.gl.createRenderbuffer();switch(a.texture=a.texture||h.gl.createTexture(),h.gl.bindTexture(h.gl.TEXTURE_2D,a.texture),i){case 2:h.gl.texImage2D(h.gl.TEXTURE_2D,0,h.gl.RGB,t,e,0,h.gl.RGB,h.gl.UNSIGNED_BYTE,null);break;case 3:h.gl.texImage2D(h.gl.TEXTURE_2D,0,h.gl.RGBA,t,e,0,h.gl.RGBA,h.gl.UNSIGNED_BYTE,null);break;case 0:for(var o=new Float32Array(t*e*4),s=0;s<t*e;s++)o[s]=Math.random(),o[s+1]=Math.random(),o[s+2]=Math.random();h.gl.texImage2D(h.gl.TEXTURE_2D,0,h.gl.RGB,t,e,0,h.gl.RGB,h.gl.FLOAT,o);break;case 1:for(o=new Float32Array(t*e*4),s=0;s<t*e;s++)o[s]=Math.random(),o[s+1]=Math.random(),o[s+2]=Math.random(),o[s+3]=Math.random();h.gl.texImage2D(h.gl.TEXTURE_2D,0,h.gl.RGBA,t,e,0,h.gl.RGBA,h.gl.FLOAT,o)}return h.gl.texParameteri(h.gl.TEXTURE_2D,h.gl.TEXTURE_MAG_FILTER,h.gl.NEAREST),h.gl.texParameteri(h.gl.TEXTURE_2D,h.gl.TEXTURE_MIN_FILTER,h.gl.NEAREST),h.gl.texParameteri(h.gl.TEXTURE_2D,h.gl.TEXTURE_WRAP_S,h.gl.CLAMP_TO_EDGE),h.gl.texParameteri(h.gl.TEXTURE_2D,h.gl.TEXTURE_WRAP_T,h.gl.CLAMP_TO_EDGE),h.gl.bindFramebuffer(h.gl.FRAMEBUFFER,r),h.gl.framebufferTexture2D(h.gl.FRAMEBUFFER,h.gl.COLOR_ATTACHMENT0,h.gl.TEXTURE_2D,a.texture,0),h.gl.bindRenderbuffer(h.gl.RENDERBUFFER,n),h.gl.renderbufferStorage(h.gl.RENDERBUFFER,h.gl.DEPTH_COMPONENT16,t,e),a.width=t,a.height=e,a.frameBuffer=r,a.renderbuffer=n,h.gl.bindFramebuffer(h.gl.FRAMEBUFFER,null),h.gl.bindTexture(h.gl.TEXTURE_2D,null),h.gl.bindRenderbuffer(h.gl.RENDERBUFFER,null),a},h.prototype.setRenderToTexture=function(t){h.gl.viewport(0,0,t.width,t.height),h.gl.scissor(0,0,t.width,t.height),h.gl.bindFramebuffer(h.gl.FRAMEBUFFER,t.frameBuffer),h.gl.clearColor(0,0,0,0),h.gl.clear(h.gl.COLOR_BUFFER_BIT|h.gl.DEPTH_BUFFER_BIT),h.gl.framebufferTexture2D(h.gl.FRAMEBUFFER,h.gl.COLOR_ATTACHMENT0,h.gl.TEXTURE_2D,t.texture,0),h.gl.framebufferRenderbuffer(h.gl.FRAMEBUFFER,h.gl.DEPTH_ATTACHMENT,h.gl.RENDERBUFFER,t.renderbuffer)},h.prototype.setRenderToBackBuffer=function(){h.gl.bindTexture(h.gl.TEXTURE_2D,null),h.gl.bindFramebuffer(h.gl.FRAMEBUFFER,null),h.gl.bindRenderbuffer(h.gl.RENDERBUFFER,null)},h.prototype.setTexture2DAt=function(t,e,i,r){h.gl.activeTexture(t),h.gl.bindTexture(h.gl.TEXTURE_2D,r.texture),h.gl.uniform1i(e,i)},h.prototype.setCubeTextureAt=function(t,e,i,r){r&&(h.gl.activeTexture(t),h.gl.bindTexture(h.gl.TEXTURE_CUBE_MAP,r.texture),h.gl.uniform1i(e,i))},h.prototype.setBlendFactors=function(t,e){this._sfactor==t&&this._dfactor==e||(this._sfactor=t,this._dfactor=e,h.gl.blendFunc(t,e))},h.prototype.setCulling=function(t){this._cullingMode!=t&&(this._cullingMode=t,h.gl.cullFace(t))},h.prototype.enableDepth=function(){this._depthTest||(this._depthTest=!0,h.gl.enable(u.ContextConfig.DEPTH_TEST))},h.prototype.disableDepth=function(){this._depthTest&&(this._depthTest=!1,h.gl.disable(u.ContextConfig.DEPTH_TEST))},h.prototype.enableCullFace=function(){this._cullFace||(this._cullFace=!0,h.gl.enable(u.ContextConfig.CULL_FACE))},h.prototype.disableCullFace=function(){this._cullFace&&(this._cullFace=!1,h.gl.disable(u.ContextConfig.CULL_FACE))},h.prototype.enableBlend=function(){h.gl.enable(u.ContextConfig.BLEND)},h.prototype.disableBlend=function(){h.gl.disable(u.ContextConfig.BLEND)},h.prototype.depthFunc=function(t){void 0===t&&(t=0),this._depthCompareMode!=t&&(this._depthCompareMode=t,h.gl.depthFunc(t))},h.prototype.drawArrays=function(t,e,i){h.gl.drawArrays(t,e,i)},h.prototype.drawElement=function(t,e,i){h.gl.drawElements(t,i,h.gl.UNSIGNED_SHORT,e)},h.prototype.flush=function(){h.gl.flush()},h.prototype.clear=function(t){h.gl.clear(t)},h.prototype.clearColor=function(t,e,i,r){h.gl.clearColor(t,e,i,r)},h.prototype.clearStencil=function(t){h.gl.clearStencil(t)},h}();u.Context3DProxy=t}(dou3d||(dou3d={})),function(e){var i;(i=e.ContextConfig||(e.ContextConfig={})).register=function(t){i.BLEND=t.BLEND,i.DEPTH_TEST=t.DEPTH_TEST,i.CULL_FACE=t.CULL_FACE,i.FRONT=t.FRONT,i.BACK=t.BACK,i.FRONT_AND_BACK=t.FRONT_AND_BACK,i.ColorFormat_RGB565=t.RGB565,i.ColorFormat_RGBA5551=t.RGB5_A1,i.ColorFormat_RGBA4444=t.RGBA4,i.ColorFormat_RGBA8888=t.RGBA,i.BYTE=t.BYTE,i.SHORT=t.SHORT,i.INT=t.INT,i.UNSIGNED_BYTE=t.UNSIGNED_BYTE,i.UNSIGNED_SHORT=t.UNSIGNED_SHORT,i.UNSIGNED_INT=t.UNSIGNED_INT,i.FLOAT=t.FLOAT,i.LEQUAL=t.LEQUAL,i.POINTS=t.POINTS,i.LINES=t.LINES,i.LINE_STRIP=t.LINE_STRIP,i.TRIANGLES=t.TRIANGLES,i.ONE=t.ONE,i.ZERO=t.ZERO,i.SRC_ALPHA=t.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA=t.ONE_MINUS_SRC_ALPHA,i.SRC_COLOR=t.SRC_COLOR,i.ONE_MINUS_SRC_COLOR=t.ONE_MINUS_SRC_COLOR,e.ContextSamplerType.TEXTURE_0=t.TEXTURE0,e.ContextSamplerType.TEXTURE_1=t.TEXTURE1,e.ContextSamplerType.TEXTURE_2=t.TEXTURE2,e.ContextSamplerType.TEXTURE_3=t.TEXTURE3,e.ContextSamplerType.TEXTURE_4=t.TEXTURE4,e.ContextSamplerType.TEXTURE_5=t.TEXTURE5,e.ContextSamplerType.TEXTURE_6=t.TEXTURE6,e.ContextSamplerType.TEXTURE_7=t.TEXTURE7,e.ContextSamplerType.TEXTURE_8=t.TEXTURE8}}(dou3d||(dou3d={})),function(e){var t=function(){function t(){this.border=0}return t.prototype.dispose=function(){this.texture&&(e.Context3DProxy.gl.deleteTexture(this.texture),this.texture=null),this.frameBuffer&&(e.Context3DProxy.gl.deleteFramebuffer(this.frameBuffer),this.frameBuffer=null),this.renderbuffer&&(e.Context3DProxy.gl.deleteRenderbuffer(this.renderbuffer),this.renderbuffer=null)},t}();e.ContextTexture2D=t}(dou3d||(dou3d={})),function(e){var t=function(){function t(){this.border=0}return t.prototype.dispose=function(){this.texture&&(e.Context3DProxy.gl.deleteTexture(this.texture),this.texture=null),this.image_front&&(this.image_front.dispose(),this.image_front=null),this.image_back&&(this.image_back.dispose(),this.image_back=null),this.image_left&&(this.image_left.dispose(),this.image_left=null),this.image_right&&(this.image_right.dispose(),this.image_right=null),this.image_up&&(this.image_up.dispose(),this.image_up=null),this.image_down&&(this.image_down.dispose(),this.image_down=null)},t}();e.ContextTexture3D=t}(dou3d||(dou3d={})),function(t){var e=function(){};(dou3d||(dou3d={})).FrameBuffer=e}(),function(e){var t=function(){function t(t,e){this._buffer=t,this._arrayBuffer=e}return Object.defineProperty(t.prototype,"buffer",{get:function(){return this._buffer},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"arrayBuffer",{get:function(){return this._arrayBuffer},enumerable:!0,configurable:!0}),t.prototype.dispose=function(){this._buffer&&(e.Context3DProxy.gl.deleteBuffer(this._buffer),this._buffer=null),this._arrayBuffer&&(this._arrayBuffer=null)},t}();e.IndexBuffer3D=t}(dou3d||(dou3d={})),function(t){var e=function(t,e,i){this.data=t,this.width=e,this.height=i};(dou3d||(dou3d={})).MipmapData=e}(),function(t){var e=function(){function e(t){this._id=e.ID++,this._program=t}return Object.defineProperty(e.prototype,"id",{get:function(){return this._id},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"program",{get:function(){return this._program},enumerable:!0,configurable:!0}),e.prototype.dispose=function(){this._program&&(t.Context3DProxy.gl.deleteProgram(this._program),this._program=null)},e.ID=0,e}();t.Program3D=e}(dou3d||(dou3d={})),function(t){var e=function(){function e(t){this._id=""+e.ID++,this._shader=t}return Object.defineProperty(e.prototype,"id",{get:function(){return this._id},set:function(t){this._id=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"shader",{get:function(){return this._shader},enumerable:!0,configurable:!0}),e.prototype.dispose=function(){this._shader&&(t.Context3DProxy.gl.deleteShader(this._shader),this._shader=null)},e.ID=0,e}();t.Shader=e}(dou3d||(dou3d={})),function(e){var t=function(){function t(t,e){this._buffer=t,this._arrayBuffer=e}return Object.defineProperty(t.prototype,"buffer",{get:function(){return this._buffer},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"arrayBuffer",{get:function(){return this._arrayBuffer},enumerable:!0,configurable:!0}),t.prototype.dispose=function(){this._buffer&&(e.Context3DProxy.gl.deleteBuffer(this._buffer),this._buffer=null),this._arrayBuffer&&(this._arrayBuffer=null)},t}();e.VertexBuffer3D=t}(dou3d||(dou3d={})),function(n){var t=function(e){function t(){var t=e.call(this)||this;return t._visible=!0,t._enableCulling=!0,t._layer=0,t._globalMatrix=new n.Matrix4,t._position=new n.Vector3,t._rotation=new n.Vector3,t._scale=new n.Vector3(1,1,1),t._orientation=new n.Quaternion,t._globalPosition=new n.Vector3,t._globalRotation=new n.Vector3,t._globalScale=new n.Vector3(1,1,1),t._globalOrientation=new n.Quaternion,t}return __extends(t,e),Object.defineProperty(t.prototype,"position",{get:function(){return this._position},set:function(t){this._position.equal(t)||(this._position.copy(t),this.invalidTransform())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"x",{get:function(){return this._position.x},set:function(t){this._position.x!=t&&(this._position.x=t,this.invalidTransform())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return this._position.y},set:function(t){this._position.y!=t&&(this._position.y=t,this.invalidTransform())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"z",{get:function(){return this._position.z},set:function(t){this._position.z!=t&&(this._position.z=t,this.invalidTransform())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rotation",{get:function(){return this._rotation},set:function(t){this._rotation.equal(t)||(this._rotation.copy(t),this._orientation.fromEuler(this._rotation.x,this._rotation.y,this._rotation.z),this.invalidTransform())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rotationX",{get:function(){return this._rotation.x},set:function(t){this._rotation.x!=t&&(this._rotation.x=t,this._orientation.fromEuler(this._rotation.x,this._rotation.y,this._rotation.z),this.invalidTransform())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rotationY",{get:function(){return this._rotation.y},set:function(t){this._rotation.y!=t&&(this._rotation.y=t,this._orientation.fromEuler(this._rotation.x,this._rotation.y,this._rotation.z),this.invalidTransform())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rotationZ",{get:function(){return this._rotation.z},set:function(t){this._rotation.z!=t&&(this._rotation.z=t,this._orientation.fromEuler(this._rotation.x,this._rotation.y,this._rotation.z),this.invalidTransform())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"scale",{get:function(){return this._scale},set:function(t){this._scale.equal(t)||(this._scale.copy(t),this.invalidTransform())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"scaleX",{get:function(){return this._scale.x},set:function(t){this._scale.x!=t&&(this._scale.x=t,this.invalidTransform())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"scaleY",{get:function(){return this._scale.y},set:function(t){this._scale.y!=t&&(this._scale.y=t,this.invalidTransform())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"scaleZ",{get:function(){return this._scale.z},set:function(t){this._scale.z!=t&&(this._scale.z=t,this.invalidTransform())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"orientation",{get:function(){return this._orientation},set:function(t){this._orientation.equal(t)||(this._orientation.copy(t),this.invalidTransform())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"orientationX",{get:function(){return this._orientation.x},set:function(t){this._orientation.x!=t&&(this._orientation.x=t,this.invalidTransform())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"orientationY",{get:function(){return this._orientation.y},set:function(t){this._orientation.y!=t&&(this._orientation.y=t,this.invalidTransform())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"orientationZ",{get:function(){return this._orientation.z},set:function(t){this._orientation.z!=t&&(this._orientation.z=t,this.invalidTransform())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"orientationW",{get:function(){return this._orientation.w},set:function(t){this._orientation.w!=t&&(this._orientation.w=t,this.invalidTransform())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"globalPosition",{get:function(){return this.validateTransformNow(),this._globalPosition},set:function(t){if(this._parent){var e=dou.recyclable(n.Quaternion);e.inverse(this._parent.globalOrientation);var i=dou.recyclable(n.Vector3);i.subtract(this._parent._globalPosition,t),e.transformVector(i,i),i.divide(this._parent._globalScale),this._position.copy(i),e.recycle(),i.recycle(),this.invalidTransform()}else this._position.copy(t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"globalRotation",{get:function(){return this.validateTransformNow(),this._globalRotation},set:function(t){var e=dou.recyclable(n.Quaternion);e.fromEuler(t.x,t.y,t.z),this._globalOrientation.copy(e),e.recycle(),this.invalidTransform()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"globalScale",{get:function(){return this.validateTransformNow(),this._globalScale},set:function(t){if(this._parent){var e=dou.recyclable(n.Vector3);e.divide(t,this._parent._globalScale),this._scale.copy(e),e.recycle(),this.invalidTransform()}else this._scale.copy(t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"globalOrientation",{get:function(){return this.validateTransformNow(),this._globalOrientation},set:function(t){if(this._parent){var e=dou.recyclable(n.Quaternion);e.inverse(this._parent.globalOrientation),e.multiply(e,t),this._orientation.copy(e),e.recycle(),this.invalidTransform()}else this._orientation.copy(t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"globalMatrix",{get:function(){return this.validateTransformNow(),this._globalMatrix},set:function(t){t.decompose(this._globalPosition,this._globalOrientation,this._globalScale),this.invalidTransform()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"visible",{get:function(){return this._visible},set:function(t){this._visible=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"parent",{get:function(){return this._parent},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"bound",{get:function(){return this._bound},set:function(t){this._bound!=t&&(this._bound&&this._bound.dispose(),this._bound=t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"enableCulling",{get:function(){return this._enableCulling},set:function(t){this._enableCulling=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"name",{get:function(){return this._name},set:function(t){this._name=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"layer",{get:function(){return this._layer},set:function(t){this._layer=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"controller",{get:function(){return this._controller},set:function(t){this._controller=t},enumerable:!0,configurable:!0}),t.prototype.setParent=function(t){this._parent=t},t.prototype.invalidTransform=function(){this.invalidGlobalTransform()},t.prototype.invalidGlobalTransform=function(){this._globalTransformChanged=!0},t.prototype.validateTransformNow=function(){this.updateGlobalTransform()},t.prototype.updateGlobalTransform=function(){this._globalTransformChanged&&(this._parent?(this._globalOrientation.multiply(this._parent.globalOrientation,this._orientation),this._globalOrientation.toEuler(this._globalRotation),this._globalScale.multiply(this._parent.globalScale,this._scale),this._globalPosition.multiply(this._parent.globalScale,this._position),this._parent.globalOrientation.transformVector(this._globalPosition,this._globalPosition),this._globalPosition.add(this._parent.globalPosition,this._globalPosition)):(this._globalOrientation.copy(this._orientation),this._globalPosition.copy(this._position),this._globalScale.copy(this._scale),this._globalRotation.copy(this._rotation)),this._globalTransformChanged=!1,this.markTransform(),this.onTransformUpdate())},t.prototype.markTransform=function(){this._globalMatrix.compose(this._globalPosition,this._globalOrientation,this._globalScale)},t.prototype.onTransformUpdate=function(){},t.prototype.lookAt=function(t,e,i){void 0===i&&(i=n.Vector3.UP),this.globalPosition=t;var r=dou.recyclable(n.Matrix4);r.lookAt(t,e,i),r.inverse();var a=dou.recyclable(n.Quaternion);r.decompose(null,a),this.globalOrientation=a,r.recycle(),a.recycle()},t.prototype.lookAtTarget=function(t){var e=dou.recyclable(n.Vector4);t.globalMatrix.transformVector(n.Vector3.UP,e);var i=dou.recyclable(n.Matrix4);i.lookAt(this._globalPosition,this._globalPosition,e),i.inverse();var r=dou.recyclable(n.Quaternion);i.decompose(null,r),this.globalOrientation=r,e.recycle(),i.recycle(),r.recycle()},t.prototype.localToGlobal=function(t,e){return e=e||dou.recyclable(n.Vector4),this._parent?this.globalMatrix.transformVector(t,e):(e.x=t.x,e.y=t.y,e.z=t.z),e},t.prototype.globalToLocal=function(t,e){if(e=e||dou.recyclable(n.Vector4),this._parent){var i=dou.recyclable(n.Matrix4);i.copy(this.globalMatrix),i.inverse(),i.transformVector(t,e),i.recycle()}else e.x=t.x,e.y=t.y,e.z=t.z;return e},t.prototype.update=function(t,e,i){this._controller&&this._controller.autoUpdate&&this._controller.update(t,e)},t.prototype.dispose=function(){this._controller=null},t}(dou.EventDispatcher);n.Object3D=t}(dou3d||(dou3d={})),function(t){var e=function(r){function t(){var t=null!==r&&r.apply(this,arguments)||this;return t._materialCount=0,t._order=0,t.multiMaterial={},t.type="",t}return __extends(t,r),Object.defineProperty(t.prototype,"order",{get:function(){return this._order},set:function(t){this._order=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"geometry",{get:function(){return this._geometry},set:function(t){this._geometry!=t&&(t&&t.incRef(),this._geometry&&this._geometry.dispose(),this._geometry=t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"lightGroup",{get:function(){return this._lightGroup},set:function(t){for(var e in this._lightGroup=t,this.multiMaterial)this.multiMaterial[e].lightGroup=this._lightGroup},enumerable:!0,configurable:!0}),t.prototype.addSubMaterial=function(t,e){this.multiMaterial[t]||this._materialCount++,(this.multiMaterial[t]=e).lightGroup=this._lightGroup},t.prototype.removeSubMaterial=function(t){this.multiMaterial[t]&&(delete this.multiMaterial[t],this._materialCount--)},t.prototype.getMaterial=function(t){return this.multiMaterial[t]},t.prototype.materialCount=function(){return this._materialCount},t.prototype.update=function(t,e,i){r.prototype.update.call(this,t,e,i),this.animation&&this.animation.update(t,e,this._geometry),this.geometry.subGeometrys.length<=0&&this.geometry.buildDefaultSubGeometry()},t.prototype.dispose=function(){this.geometry=null,this.multiMaterial={}},t}(t.Object3D);t.RenderBase=e}(dou3d||(dou3d={})),function(t){var e=function(i){function t(){var t=i.call(this)||this;return t._children=[],t}return __extends(t,i),Object.defineProperty(t.prototype,"children",{get:function(){return this._children},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"numChildren",{get:function(){return this._children.length},enumerable:!0,configurable:!0}),t.prototype.invalidGlobalTransform=function(){i.prototype.invalidGlobalTransform.call(this);for(var t=0,e=this._children;t<e.length;t++){e[t].invalidTransform()}},t.prototype.addChild=function(t){return-1!=this._children.indexOf(t)||(t.parent&&t.parent.removeChild(t),t.setParent(this),t.invalidTransform(),this._children.push(t)),t},t.prototype.getChildAt=function(t){return this._children[t]},t.prototype.getChildIndex=function(t){return this._children.indexOf(t)},t.prototype.removeChild=function(t){var e=this._children.indexOf(t);return-1==e||(this._children.splice(e,1),t.setParent(null),t.invalidTransform()),t},t.prototype.removeChildAt=function(t){if(t<0||t>=this._children.length)return null;var e=this._children[t];return this._children.splice(t,1),e.setParent(null),e.invalidTransform(),e},t.prototype.removeAllChildren=function(){for(;0<this._children.length;)this.removeChildAt(0)},t.prototype.dispose=function(){i.prototype.dispose.call(this);for(var t=0,e=this._children;t<e.length;t++){e[t].dispose()}this.removeAllChildren()},t}(t.Object3D);t.ObjectContainer3D=e}(dou3d||(dou3d={})),function(n){var t=function(a){function e(t,e,i){var r=a.call(this)||this;return r.type="mesh",r.geometry=t,r.material=e||new n.TextureMaterial,r.addSubMaterial(0,r.material),r.bound=r.buildBoundBox(),i?r.animation=i:t&&64&r.geometry.vertexFormat&&(r.animation=new n.SkeletonAnimation),r}return __extends(e,a),e.prototype.buildBoundBox=function(){var t=new n.BoundBox(this,new n.Vector3,new n.Vector3);if(this.geometry&&this.geometry.vertexArray){t.min.copy(new n.Vector3(n.MathUtil.INT_MAX,n.MathUtil.INT_MAX,n.MathUtil.INT_MAX)),t.max.copy(new n.Vector3(-n.MathUtil.INT_MAX,-n.MathUtil.INT_MAX,-n.MathUtil.INT_MAX));for(var e=0;e<this.geometry.vertexArray.length;e+=this.geometry.vertexAttLength)t.max.x<this.geometry.vertexArray[e]&&(t.max.x=this.geometry.vertexArray[e]),t.max.y<this.geometry.vertexArray[e+1]&&(t.max.y=this.geometry.vertexArray[e+1]),t.max.z<this.geometry.vertexArray[e+2]&&(t.max.z=this.geometry.vertexArray[e+2]),t.min.x>this.geometry.vertexArray[e]&&(t.min.x=this.geometry.vertexArray[e]),t.min.y>this.geometry.vertexArray[e+1]&&(t.min.y=this.geometry.vertexArray[e+1]),t.min.z>this.geometry.vertexArray[e+2]&&(t.min.z=this.geometry.vertexArray[e+2])}return t.fillBox(t.min,t.max),t.createChild(),this.bound=t},e.prototype.clone=function(){var t=new e(this.geometry,this.material,this.animation?this.animation.clone():null);return t.multiMaterial=this.multiMaterial,t},e}(n.RenderBase);n.Mesh=t}(dou3d||(dou3d={})),function(o){var t=function(n){function e(t,e,i,r){void 0===i&&(i=100),void 0===r&&(r=100);var a=this;return e||(e=new o.PlaneGeometry(i,r,1,1,1,1)),(a=n.call(this,e,t)||this)._plane=a.geometry,a.bound||(a.bound=a.buildBoundBox()),a}return __extends(e,n),e.prototype.update=function(t,e,i){n.prototype.update.call(this,t,e,i),this.globalOrientation=i.globalOrientation},e.prototype.clone=function(){var t=new e(this.material,this.geometry,this._plane.width,this._plane.height);return t.multiMaterial=this.multiMaterial,t},e}(o.Mesh);o.Billboard=t}(dou3d||(dou3d={})),function(a){var t=function(r){function t(t,e){void 0===e&&(e=1);var i=r.call(this)||this;return i.type="wireframe",i.geometry=new a.Geometry,i.material=new a.ColorMaterial(16711680),i.addSubMaterial(0,i.material),i.material.drawMode=a.ContextConfig.LINES,i.geometry.vertexFormat=27,i.fromVertexs(t,e),i}return __extends(t,r),t.prototype.fromVertexs=function(t,e){if(void 0===e&&(e=1),t){this.geometry.setVerticesForIndex(0,e,t,t.length/a.GeometryUtil.fromVertexFormatToLength(e)),this.geometry.indexCount=2*(this.geometry.vertexCount-1);for(var i=0;i<this.geometry.vertexCount-1;++i)this.geometry.indexArray[2*i+0]=i,this.geometry.indexArray[2*i+1]=i+1}},t.prototype.fromVertexsEx=function(t,e){if(void 0===e&&(e=1),t){this.geometry.setVerticesForIndex(0,e,t,t.length/a.GeometryUtil.fromVertexFormatToLength(e)),this.geometry.indexCount=this.geometry.vertexCount;for(var i=0;i<this.geometry.vertexCount;++i)this.geometry.indexArray[i]=i}},t.prototype.fromGeometry=function(t){var e=[];t.getVertexForIndex(0,9,e,t.vertexCount),this.geometry.setVerticesForIndex(0,9,e,t.vertexCount),this.geometry.indexCount=6*t.faceCount;for(var i=0;i<t.faceCount;++i){var r=t.indexArray[3*i+0],a=t.indexArray[3*i+1],n=t.indexArray[3*i+2];this.geometry.indexArray[6*i+0]=r,this.geometry.indexArray[6*i+1]=a,this.geometry.indexArray[6*i+2]=a,this.geometry.indexArray[6*i+3]=n,this.geometry.indexArray[6*i+4]=n,this.geometry.indexArray[6*i+5]=r}},t}(a.RenderBase);a.Wireframe=t}(dou3d||(dou3d={})),function(n){var t=function(a){function t(t,e,i){var r=a.call(this,t,e)||this;return r.camera=i,e.cullMode=n.ContextConfig.FRONT,r.bound||(r.bound=r.buildBoundBox()),r}return __extends(t,a),t.prototype.update=function(t,e,i){a.prototype.update.call(this,t,e,i),this.camera&&(this.position=this.camera.globalPosition)},t}(n.Mesh);n.SkyBox=t}(dou3d||(dou3d={})),function(t){var e=function(){function t(){this._renderList=[]}return Object.defineProperty(t.prototype,"renderList",{get:function(){return this._renderList},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"scene",{get:function(){return this._scene},set:function(t){this._scene=t},enumerable:!0,configurable:!0}),t.prototype.findRenderObject=function(t){for(var e=0;e<this._renderList.length;++e)if(this._renderList[e]===t)return e;return-1},t.prototype.update=function(t){t.validateTransformNow(),this._renderList.length=0},t}();t.CollectBase=e}(dou3d||(dou3d={})),function(n){var t=function(a){function t(){var t=null!==a&&a.apply(this,arguments)||this;return t.layerMap={},t}return __extends(t,a),t.prototype.update=function(t){a.prototype.update.call(this,t),this.clearLayerList(),this.applyRender(this._scene.root,t);for(var e=0;e<2;e++){this.layerMap[e].sort(this.sortByOrder);for(var i=this.layerMap[e].length,r=0;r<i;r++)this._renderList.push(this.layerMap[e][r])}},t.prototype.clearLayerList=function(){for(var t=0;t<2;t++)this.layerMap[t]?this.layerMap[t].length=0:this.layerMap[t]=[]},t.prototype.applyRender=function(t,e){if(t.visible)if(t instanceof n.ObjectContainer3D)for(var i=0;i<t.children.length;i++)this.applyRender(t.children[i],e);else t instanceof n.RenderBase&&t.material&&this.addRenderList(t,e)},t.prototype.addRenderList=function(t,e,i){if(void 0===i&&(i=!0),t.enableCulling,t.material)if(0==t.layer&&t.material.materialData.alphaBlending)this.layerMap[1].push(t);else for(var r=0;r<2;r++)t.layer==r&&this.layerMap[r].push(t)},t.prototype.sort=function(t,e,i){var r=n.Vector3.getDistance(t.globalPosition,i.position),a=n.Vector3.getDistance(e.globalPosition,i.position);return a<r?-1:r<a?1:0},t.prototype.sortByOrder=function(t,e){return e.order-t.order},t}(n.CollectBase);n.EntityCollect=t}(dou3d||(dou3d={})),function(a){var t=function(i){function t(t){var e=i.call(this)||this;return e._deltaTime=0,e._engine=t,a.Engine.context3DProxy.enableBlend(),a.Engine.context3DProxy.enableCullFace(),a.Context3DProxy.gl.enable(a.Context3DProxy.gl.SCISSOR_TEST),a.Context3DProxy.gl.enableVertexAttribArray(0),a.Context3DProxy.gl.enableVertexAttribArray(1),a.Context3DProxy.gl.enableVertexAttribArray(2),a.Context3DProxy.gl.enableVertexAttribArray(3),a.Context3DProxy.gl.enableVertexAttribArray(4),a.Context3DProxy.gl.enableVertexAttribArray(5),a.Context3DProxy.gl.enableVertexAttribArray(6),a.ShaderUtil.load(),a.ShaderPool.register(a.Engine.context3DProxy),e}return __extends(t,i),Object.defineProperty(t.prototype,"deltaTime",{get:function(){return this._deltaTime},enumerable:!0,configurable:!0}),t.prototype.updateLogic=function(t){this._deltaTime=t;var e=this._engine.viewRect,i=this._engine.view3Ds;a.ContextConfig.canvasRectangle=e,a.Engine.context3DProxy.viewPort(0,0,e.w,e.h),a.Engine.context3DProxy.setScissorRectangle(0,0,e.w,e.h);for(var r=0;r<i.length;r++)i[r].update(dou.getTimer(),t);a.Context3DProxy.gl.flush()},t}(dou.TickerBase);a.Ticker=t}(dou3d||(dou3d={})),function(s){var t=function(o){function t(t,e,i,r,a){var n=o.call(this)||this;return n._cleanParmerts=s.Context3DProxy.gl.COLOR_BUFFER_BIT|s.Context3DProxy.gl.DEPTH_BUFFER_BIT,n._viewPort=new s.Rectangle,n._camera=a||new s.Camera3D(0),n._camera.name="MainCamera",n._scene=new s.Scene3D,n._scene.root.addChild(n._camera),n._render=new s.MultiRenderer(0),n._entityCollect=new s.EntityCollect,n._entityCollect.scene=n._scene,n._backColor=new s.Vector4(.3,.3,.6,1),n.x=t,n.y=e,n.width=i,n.height=r,n._camera.aspectRatio=n._viewPort.w/n._viewPort.h,n._camera.updateViewport(n._viewPort.x,n._viewPort.y,n._viewPort.w,n._viewPort.h),n}return __extends(t,o),Object.defineProperty(t.prototype,"x",{get:function(){return this._viewPort.x},set:function(t){this._viewPort.x=t,this._camera.updateViewport(this._viewPort.x,this._viewPort.y,this._viewPort.w,this._viewPort.h)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return this._viewPort.y},set:function(t){this._viewPort.y=t,this._camera.updateViewport(this._viewPort.x,this._viewPort.y,this._viewPort.w,this._viewPort.h)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"width",{get:function(){return this._viewPort.w},set:function(t){this._viewPort.w=t,this._camera.aspectRatio=this._viewPort.w/this._viewPort.h,this._camera.updateViewport(this._viewPort.x,this._viewPort.y,this._viewPort.w,this._viewPort.h)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return this._viewPort.h},set:function(t){this._viewPort.h=t,this._camera.aspectRatio=this._viewPort.w/this._viewPort.h,this._camera.updateViewport(this._viewPort.x,this._viewPort.y,this._viewPort.w,this._viewPort.h)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"viewPort",{get:function(){return this._viewPort},enumerable:!0,configurable:!0}),t.prototype.inView3D=function(t,e){var i=dou.recyclable(s.Vector2);i.set(t,e);var r=this._viewPort.contains(i);return i.recycle(),r},t.prototype.blender=function(t,e){this._cleanParmerts=(t?s.Context3DProxy.gl.COLOR_BUFFER_BIT:0)|(e?s.Context3DProxy.gl.DEPTH_BUFFER_BIT:0)},Object.defineProperty(t.prototype,"backColor",{get:function(){return 255*this._backColor.w<<24|255*this._backColor.x<<16|255*this._backColor.y<<8|255*this._backColor.z},set:function(t){this._backColor.w=(t>>24&255)/255,this._backColor.x=(t>>16&255)/255,this._backColor.y=(t>>8&255)/255,this._backColor.z=(255&t)/255},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"scene",{get:function(){return this._scene},set:function(t){this._scene=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"camera3D",{get:function(){return this._camera},set:function(t){this._camera=t,this._camera.aspectRatio=this._viewPort.w/this._viewPort.h,this._camera.updateViewport(this._viewPort.x,this._viewPort.y,this._viewPort.w,this._viewPort.h)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"entityCollect",{get:function(){return this._entityCollect},enumerable:!0,configurable:!0}),t.prototype.update=function(t,e){this._camera.viewPort=this._viewPort,this.updateObject3D(this._scene.root,t,e),s.Engine.context3DProxy.viewPort(this._viewPort.x,this._viewPort.y,this._viewPort.w,this._viewPort.h),s.Engine.context3DProxy.setScissorRectangle(this._viewPort.x,this._viewPort.y,this._viewPort.w,this._viewPort.h),this._entityCollect.update(this._camera),s.ShadowCast.instance.enableShadow&&s.ShadowCast.instance.update(this._entityCollect,this._camera,t,e,this._viewPort),this._cleanParmerts&s.Context3DProxy.gl.COLOR_BUFFER_BIT&&s.Engine.context3DProxy.clearColor(this._backColor.x,this._backColor.y,this._backColor.z,this._backColor.w),s.Engine.context3DProxy.clear(this._cleanParmerts),this._render.draw(t,e,s.Engine.context3DProxy,this._entityCollect,this._camera,this._viewPort)},t.prototype.updateObject3D=function(t,e,i){if(t){if(t.dispatch(s.Event3D.ENTER_FRAME),t.update(e,i,this.camera3D),t instanceof s.ObjectContainer3D)for(var r=0;r<t.children.length;++r)this.updateObject3D(t.children[r],e,i);t.dispatch(s.Event3D.EXIT_FRAME)}},t}(dou.EventDispatcher);s.View3D=t}(dou3d||(dou3d={})),function(a){var t=function(){function e(t){this.name=t,this.parentIndex=-1,this.scale=new a.Vector3(1,1,1),this.orientation=new a.Quaternion,this.translation=new a.Vector3,this.localMatrix=new a.Matrix4,this.worldMatrix=new a.Matrix4,this.worldMatrixValid=!1}return e.prototype.buildLocalMatrix=function(t,e,i){this.scale.copy(t),this.translation.copy(i),e instanceof a.Vector3?this.orientation.fromEuler(e.x*a.MathUtil.DEG_RAD,e.y*a.MathUtil.DEG_RAD,e.z*a.MathUtil.DEG_RAD,6):this.orientation.copy(e),this.localMatrix.compose(this.translation,this.orientation,this.scale),this.worldMatrixValid=!1},e.prototype.buildInverseMatrix=function(t,e,i){if(this.inverseMatrix=this.inverseMatrix||new a.Matrix4,e instanceof a.Vector3){var r=dou.recyclable(a.Quaternion);r.fromEuler(e.x*a.MathUtil.DEG_RAD,e.y*a.MathUtil.DEG_RAD,e.z*a.MathUtil.DEG_RAD,6),this.inverseMatrix.compose(i,r,t),r.recycle()}else this.inverseMatrix.compose(i,e,t)},e.prototype.clone=function(){var t=new e(this.name);return t.parent=this.parent,t.parentIndex=this.parentIndex,t.scale.copy(this.scale),t.orientation.copy(this.orientation),t.translation.copy(this.translation),t.localMatrix.copy(this.localMatrix),t.worldMatrix.copy(this.worldMatrix),t.worldMatrixValid=this.worldMatrixValid,t},e}();a.Joint=t}(dou3d||(dou3d={})),function(t){var e=function(){function i(){this.joints=[]}return Object.defineProperty(i.prototype,"jointNum",{get:function(){return this.joints.length},enumerable:!0,configurable:!0}),i.prototype.findJoint=function(t){for(var e=0;e<this.joints.length;e++)if(this.joints[e].name==t)return this.joints[e];return null},i.prototype.findJointIndex=function(t){for(var e=0;e<this.joints.length;e++)if(this.joints[e].name==t)return e;return-1},i.prototype.clone=function(){for(var t=new i,e=0;e<this.joints.length;e++)t.joints.push(this.joints[e].clone());return t},i}();t.Skeleton=e}(dou3d||(dou3d={})),function(l){var t=function(e){function u(){var t=e.call(this)||this;return t.speed=1,t.isLoop=!0,t._isPlay=!1,t._animTime=0,t._animStateNames=[],t._animStates=[],t._blendSpeed=0,t._blendSkeleton=null,t._blendList=[],t._bindList={},t._changeFrameTime=0,t._oldFrameIndex=0,t._movePosIndex=-1,t._movePosObject3D=null,t._movePosition=new l.Vector3,t._resetMovePos=!0,t._currentSkeletonPose=null,t._oldTime=0,t._isPlay=!1,t}return __extends(u,e),Object.defineProperty(u.prototype,"jointNum",{get:function(){return 48},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"animStateNames",{get:function(){return this._animStateNames},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"animStates",{get:function(){return this._animStates},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"animTime",{get:function(){return this._animTime},set:function(t){if(!(this._blendList.length<=0)&&this._blendList[this._blendList.length-1].timePosition!=t){var e=t-this._animTime;if(this._blendSpeed<=0)1<this._blendList.length&&this._blendList.splice(0,this._blendList.length-1),this._blendList[0].weight=1,this._blendList[0].timePosition+=e;else{for(var i=Math.abs(e/this._blendSpeed),r=0;r<this._blendList.length;++r){var a=this._blendList[r];if(r!=this._blendList.length-1){if(a.weight=Math.max(0,a.weight-i),a.weight<=0){this._blendList.splice(r,1),--r;continue}}else a.weight=Math.min(1,a.weight+i)}this._blendList[this._blendList.length-1].timePosition+=e}this._animTime=this._blendList[this._blendList.length-1].timePosition;var n=this._blendList[0].currentSkeletonPose;if(this._blendList.length<=1)this._blendSkeleton||(this._blendSkeleton=n.clone()),this.updateBindList(n),this.updateMovePos(n),this._currentSkeletonPose=n;else{var o=this._blendList[1],s=o.currentSkeletonPose;this._blendSkeleton||(this._blendSkeleton=n.clone()),this._blendSkeleton.lerp(n,s,o.weight),this._blendSkeleton.resetWorldMatrix(),this._blendSkeleton.calculateJointWorldMatrix(),this.updateBindList(this._blendSkeleton),this.updateMovePos(this._blendSkeleton),this._currentSkeletonPose=this._blendSkeleton}}},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"timeLength",{get:function(){return this._blendList.length<=0?0:this._blendList[this._blendList.length-1].timeLength},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"frameIndex",{get:function(){return this.animTime/u.fps},set:function(t){this.animTime=t*u.fps},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"blendSpeed",{get:function(){return this._blendSpeed},set:function(t){this._blendSpeed=Math.max(t,0)},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"currentAnimName",{get:function(){return this._currentAnimName},enumerable:!0,configurable:!0}),u.prototype.isPlay=function(){return this._isPlay},u.prototype.addSkeletonAnimationClip=function(t){var e=new l.SkeletonAnimationState(t.animationName);e.skeletonAnimation=this,e.addAnimationClip(t),this.addAnimState(e)},u.prototype.addAnimState=function(t){for(var e=0;e<this._animStates.length;e++)if(this._animStates[e].name==t.name)return;this._animStates.push(t),this._animStateNames.push(t.name)},u.prototype.removeAnimState=function(t){for(var e=0;e<this._animStates.length;e++)if(this._animStates[e].name==t.name)return this._animStates.slice(e,1),void this._animStateNames.slice(e,1)},u.prototype.play=function(t,e,i,r){if(void 0===e&&(e=1),void 0===i&&(i=!0),void 0===r&&(r=!0),!(this._animStates.length<=0)){var a;t||(t=this._animStates[0].name);for(var n=0;n<this._animStates.length;n++)if(this._animStates[n].name==t){a=this._animStates[n];break}if(a&&(this._currentAnimName=t,this._blendList.push(a),this._blendSpeed<=0&&1<this._blendList.length&&this._blendList.splice(0,this._blendList.length-1),a.weight=1<this._blendList.length?0:1,i&&(this._animTime=a.timePosition=0),this._changeFrameTime=a.timePosition,this._oldFrameIndex=Math.floor(this._changeFrameTime/u.fps),this.speed=e,this._isPlay=!0,this._resetMovePos=!0,-1!=this._movePosIndex)){var o=dou.recyclable(l.Vector3);a.getSkeletonPose(0).joints[this._movePosIndex].worldMatrix.decompose(o),this._movePosition.copy(o),o.recycle()}}},u.prototype.pause=function(){this._isPlay=!1},u.prototype.stop=function(){this._isPlay=!1},u.prototype.update=function(t,e,i){if(this._oldTime!=t&&(this._oldTime=t,this._isPlay&&!(this._blendList.length<=0))){var r=this._blendList[this._blendList.length-1],a=e*this.speed;this._changeFrameTime+=a;for(var n=Math.floor(Math.abs(this._changeFrameTime/u.fps)),o=this.currentAnimName,s=0,h=0;h<n;++h){if(a<0?(s=(this._oldFrameIndex-1-h)%r.frameNum)<0&&(s+=r.frameNum):s=(this._oldFrameIndex+1+h)%r.frameNum,this.dispatch(l.Event3D.ENTER_FRAME,s),this.currentAnimName!=o){s=Math.floor(this._changeFrameTime/u.fps);break}this._changeFrameTime+=0<a?-u.fps:u.fps}this._oldFrameIndex=s,this.animTime+=e*this.speed}},u.prototype.activeState=function(t,e,i,r,a,n,o){this._currentSkeletonPose&&this._currentSkeletonPose.updateGPUCacheData(r.geometry.skeleton,r.geometry.skeletonGPUData,this._movePosition),i.uniform_time&&a.uniform1f(i.uniform_time.uniformIndex,this.animTime),a.uniform4fv(i.uniform_PoseMatrix.uniformIndex,r.geometry.skeletonGPUData)},u.prototype.bindToJointPose=function(t,e){var i,r=this._animStates[0].skeletonAnimationClip.findJointIndex(t);return!(r<0)&&(this._bindList[r]?i=this._bindList[r]:(i=[],this._bindList[r]=i),i.push(e),!0)},u.prototype.setMovePosJointName=function(t,e){var i=this._animStates[0].skeletonAnimationClip.findJointIndex(t);return!(i<0)&&(this._movePosIndex=i,this._movePosObject3D=e,this._resetMovePos=!0)},u.prototype.updateBindList=function(t){var e,i,r;for(var a in this._bindList)if(!((e=this._bindList[a]).length<=0)&&(i=t.joints[a]))for(var n=0;n<e.length;n++){r=e[n];var o=dou.recyclable(l.Vector3),s=dou.recyclable(l.Quaternion);i.worldMatrix.decompose(o,s),r.orientation=s,r.x=o.x-this._movePosition.x,r.y=o.y-this._movePosition.y,r.z=o.z-this._movePosition.z,o.recycle(),s.recycle()}},u.prototype.updateMovePos=function(t){var e;if(-1!=this._movePosIndex){e=t.joints[this._movePosIndex];var i=dou.recyclable(l.Vector3);e.worldMatrix.decompose(i),this._movePosObject3D&&(this._movePosition.x=i.x-this._movePosition.x,this._movePosition.y=i.y-this._movePosition.y,this._movePosition.z=i.z-this._movePosition.z,this._movePosObject3D.orientation.transformVector(this._movePosition,this._movePosition),this._movePosObject3D.x+=this._movePosition.x,this._movePosObject3D.y+=this._movePosition.y,this._movePosObject3D.z+=this._movePosition.z,this._resetMovePos&&(this._resetMovePos=!1,this._movePosObject3D.x-=this._movePosition.x,this._movePosObject3D.y+=this._movePosition.y,this._movePosObject3D.z-=this._movePosition.z)),this._movePosition.copy(i),i.recycle()}},u.prototype.clone=function(){var t=new u;t._blendSpeed=this._blendSpeed,t.isLoop=this.isLoop,t._animStateNames=this._animStateNames.concat([]);for(var e=0;e<this._animStates.length;e++)t._animStates.push(this._animStates[e].clone());return t},u.fps=1e3/60,u}(dou.EventDispatcher);l.SkeletonAnimation=t}(dou3d||(dou3d={})),function(o){var t=function(){function e(){this.animationName="",this.sampling=0,this.boneCount=0,this.frameDataOffset=0,this._frameCount=0,this._timeLength=0,this.poseArray=[]}return Object.defineProperty(e.prototype,"currentSkeletonPose",{get:function(){return this._skeletonPose},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"frameCount",{get:function(){return 0<this.poseArray.length?this.poseArray.length:this._frameCount},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"timeLength",{get:function(){return 0<this.poseArray.length?this.poseArray[this.poseArray.length-1].frameTime:this._timeLength},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"jointNum",{get:function(){return 0<this.poseArray.length?this.poseArray[0].joints.length:this.boneCount},enumerable:!0,configurable:!0}),e.prototype.findJointIndex=function(t){return this._skeletonPose?this._skeletonPose.findJointIndex(t):this.poseArray.length<=0?-1:this.poseArray[0].findJointIndex(t)},e.prototype.addSkeletonPose=function(t){this.poseArray.push(t)},e.prototype.buildInitialSkeleton=function(t,e,i){if(!this._skeletonPose){this._frameCount=i,this._skeletonPose=new o.SkeletonPose;for(var r=0;r<this.boneCount;r++){var a=new o.Joint(t[r]);a.parent=e[r],a.parentIndex=this._skeletonPose.findJointIndex(a.parent),this._skeletonPose.joints.push(a)}this.sourceData.position=this.frameDataOffset+(40*this.boneCount+4)*(this.frameCount-1),this._timeLength=this.sourceData.readInt()/60/80*1e3}},e.prototype.getSkeletonPose=function(t){return 0<this.poseArray.length?this.poseArray[t]:t<0||t>=2*this.frameCount?null:(t=Math.floor(t/2),this.readSkeletonPose(t,this._skeletonPose))},e.prototype.readSkeletonPose=function(t,e){this.sourceData.position=this.frameDataOffset+(40*this.boneCount+4)*t,e.frameTime=this.sourceData.readInt()/60/80*1e3;for(var i=0;i<this.boneCount;i++){var r=dou.recyclable(o.Quaternion);r.x=this.sourceData.readFloat(),r.y=this.sourceData.readFloat(),r.z=this.sourceData.readFloat(),r.w=this.sourceData.readFloat();var a=dou.recyclable(o.Vector3);a.x=this.sourceData.readFloat(),a.y=this.sourceData.readFloat(),a.z=this.sourceData.readFloat();var n=dou.recyclable(o.Vector3);n.x=this.sourceData.readFloat(),n.y=this.sourceData.readFloat(),n.z=this.sourceData.readFloat(),e.joints[i].worldMatrixValid=!1,e.joints[i].buildLocalMatrix(a,r,n),r.recycle(),a.recycle(),n.recycle()}return e.calculateJointWorldMatrix(),e},e.prototype.clone=function(){var t=new e;return t.animationName=this.animationName,t.poseArray=this.poseArray,t.sampling=this.sampling,t.boneCount=this.boneCount,t._frameCount=this._frameCount,t.frameDataOffset=this.frameDataOffset,t.sourceData=this.sourceData,t._timeLength=this._timeLength,t._skeletonPose=this._skeletonPose,this._skeletonPose&&(t._skeletonPose=this._skeletonPose.clone()),t},e}();o.SkeletonAnimationClip=t}(dou3d||(dou3d={})),function(s){var t=function(){function e(t){this.name="",this.weight=1,this._timeLength=0,this._timePosition=0,this._skeletonAnimation=null,this._skeletonAnimationClip=null,this.name=t}return Object.defineProperty(e.prototype,"skeletonAnimation",{get:function(){return this._skeletonAnimation},set:function(t){this._skeletonAnimation=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"skeletonAnimationClip",{get:function(){return this._skeletonAnimationClip},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"timeLength",{get:function(){return this._timeLength},enumerable:!0,configurable:!0}),e.prototype.addAnimationClip=function(t){if(t.sourceData)this._skeletonAnimationClip=t,this._timeLength=this._skeletonAnimationClip.timeLength;else{if(this._skeletonAnimationClip?this._skeletonAnimationClip.poseArray=[]:this._skeletonAnimationClip=new s.SkeletonAnimationClip,t.poseArray.length<2)this._skeletonAnimationClip.poseArray=t.poseArray;else{var e=t.poseArray[0],i=t.poseArray[1],r=Math.round((i.frameTime-e.frameTime)/s.SkeletonAnimation.fps);if(r<=1)this._skeletonAnimationClip.poseArray=t.poseArray;else{for(var a=1;a<t.poseArray.length;++a){e=t.poseArray[a-1],i=t.poseArray[a];for(var n=0;n<r;n++){var o=new s.SkeletonPose;o.lerp(e,i,n/r),this._skeletonAnimationClip.poseArray.push(o)}}this._skeletonAnimationClip.poseArray.push(t.poseArray[t.poseArray.length-1].clone())}}this._timeLength=this._skeletonAnimationClip.poseArray[this._skeletonAnimationClip.poseArray.length-1].frameTime}},Object.defineProperty(e.prototype,"timePosition",{get:function(){return this._timePosition},set:function(t){t!=this._timePosition&&(this._timePosition=t,this._skeletonAnimation.isLoop?(this._timePosition=t%this._timeLength,this._timePosition<0&&(this._timePosition+=this._timeLength)):this._timePosition<0?(this._timePosition=0,this.name==this._skeletonAnimation.currentAnimName&&(this._skeletonAnimation.stop(),this._skeletonAnimation.dispatch(dou.Event.COMPLETE))):this._timePosition>this._timeLength&&(this._timePosition=this._timeLength,this.name==this._skeletonAnimation.currentAnimName&&(this._skeletonAnimation.stop(),this._skeletonAnimation.dispatch(dou.Event.COMPLETE))))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"currentSkeletonPose",{get:function(){return this._skeletonAnimationClip.getSkeletonPose(this.currentFrameIndex)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"previousSkeletonPose",{get:function(){var t=this.currentFrameIndex;return 0<this._skeletonAnimation.speed?--t<0&&(t=this.frameNum-t):t=(t+1)%this.frameNum,this._skeletonAnimationClip.getSkeletonPose(t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"currentFrameIndex",{get:function(){return Math.floor(this._timePosition/s.SkeletonAnimation.fps)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"frameNum",{get:function(){return this._skeletonAnimationClip?this._skeletonAnimationClip.frameCount:0},enumerable:!0,configurable:!0}),e.prototype.getSkeletonPose=function(t){return this._skeletonAnimationClip.getSkeletonPose(t)},e.prototype.clone=function(){var t=new e(this.name);return t._timeLength=this._timeLength,t._skeletonAnimation=this._skeletonAnimation,t._skeletonAnimationClip=this._skeletonAnimationClip,t},e}();s.SkeletonAnimationState=t}(dou3d||(dou3d={})),function(m){var t=function(){function i(){this.joints=[]}return i.prototype.lerp=function(t,e,i){if(t.joints.length!=e.joints.length)throw Error("Bone number does not match!");if(this.joints.length<t.joints.length)for(var r=this.joints.length;r<=t.joints.length;++r)this.joints.push(new m.Joint(""));this.frameTime=(e.frameTime-t.frameTime)*i+t.frameTime;for(r=0;r<t.joints.length;++r){var a=t.joints[r],n=e.joints[r],o=this.joints[r];if(o.name=a.name,o.parent=a.parent,o.parentIndex=a.parentIndex,m.Vector3.lerp(a.scale,n.scale,i,o.scale),m.Quaternion.slerp(a.orientation,n.orientation,i,o.orientation),m.Vector3.slerp(a.translation,n.translation,i,o.translation),o.buildLocalMatrix(o.scale,o.orientation,o.translation),o.worldMatrixValid=a.worldMatrixValid,o.worldMatrixValid){var s=dou.recyclable(m.Vector3),h=dou.recyclable(m.Quaternion),u=dou.recyclable(m.Vector3);a.worldMatrix.decompose(s,h,u);var l=dou.recyclable(m.Vector3),c=dou.recyclable(m.Quaternion),d=dou.recyclable(m.Vector3);n.worldMatrix.decompose(l,c,d);var p=dou.recyclable(m.Vector3);m.Vector3.slerp(s,l,i,p);var f=dou.recyclable(m.Quaternion);m.Quaternion.slerp(h,c,i,f);var _=dou.recyclable(m.Vector3);m.Vector3.lerp(u,d,i,_),o.worldMatrix.compose(p,f,_),s.recycle(),h.recycle(),u.recycle(),l.recycle(),c.recycle(),d.recycle(),p.recycle(),f.recycle(),_.recycle()}}return this},i.prototype.calculateJointWorldMatrix=function(){for(var t=0;t<this.joints.length;++t)this.calculateAbsoluteMatrix(t)},i.prototype.calculateAbsoluteMatrix=function(t){var e=this.joints[t];0<=e.parentIndex&&this.calculateAbsoluteMatrix(e.parentIndex),e.worldMatrixValid||(e.worldMatrix.copy(e.localMatrix),0<=e.parentIndex&&e.worldMatrix.append(this.joints[e.parentIndex].worldMatrix),e.worldMatrixValid=!0)},i.prototype.updateGPUCacheData=function(t,e,i){for(var r=0;r<t.joints.length;++r)for(var a=0;a<this.joints.length;++a)if(t.joints[r].name==this.joints[a].name){var n=dou.recyclable(m.Matrix4);n.copy(t.joints[r].inverseMatrix),n.append(this.joints[a].worldMatrix);var o=dou.recyclable(m.Vector3),s=dou.recyclable(m.Quaternion),h=dou.recyclable(m.Vector3);n.decompose(o,s,h),e[8*r+0]=s.x,e[8*r+1]=s.y,e[8*r+2]=s.z,e[8*r+3]=s.w,e[8*r+4]=o.x-i.x,e[8*r+5]=o.y-i.y,e[8*r+6]=o.z-i.z,e[8*r+7]=1,n.recycle(),o.recycle(),s.recycle(),h.recycle();break}return e},i.prototype.findJoint=function(t){for(var e=0;e<this.joints.length;e++)if(this.joints[e].name==t)return this.joints[e];return null},i.prototype.findJointIndex=function(t){for(var e=0;e<this.joints.length;e++)if(this.joints[e].name==t)return e;return-1},i.prototype.resetWorldMatrix=function(){for(var t=0;t<this.joints.length;t++)this.joints[t].worldMatrixValid=!1},i.prototype.clone=function(){var t=new i;t.frameTime=this.frameTime;for(var e=0;e<this.joints.length;e++)t.joints.push(this.joints[e].clone());return t},i}();m.SkeletonPose=t}(dou3d||(dou3d={})),function(o){var t=function(i){function t(t){void 0===t&&(t=0);var e=i.call(this)||this;return e._aspectRatio=1,e._fov=.78,e._near=1,e._far=1e4,e._orthProjectChange=!0,e._projectMatrix=new o.Matrix4,e._orthProjectMatrix=new o.Matrix4,e._viewPort=new o.Rectangle,e._lookAtPosition=new o.Vector3,e._viewMatrix=new o.Matrix4,e._viewMatrix.identity(),e._viewProjectionMatrix=new o.Matrix4,e._viewProjectionMatrix.identity(),e._frustum=new o.Frustum(e),e._orthProjectMatrix.orthographicProjectMatrix(0,0,e._viewPort.w,e._viewPort.h,e._near,e._far),e.cameraType=t,e}return __extends(t,i),Object.defineProperty(t.prototype,"projectMatrix",{get:function(){return this._projectMatrix},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"frustum",{get:function(){return this._frustum},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"cameraType",{get:function(){return this._cameraType},set:function(t){switch(this._cameraType=t){case 1:this._projectMatrix.orthographicProjectMatrix(0,0,this._viewPort.w,this._viewPort.h,this._near,this._far);break;case 0:this._projectMatrix.fromProjection(this._near,this._far,this._fov,1,1,this._aspectRatio,1)}this._orthProjectMatrix.orthographicProjectMatrix(0,0,this._viewPort.w,this._viewPort.h,this._near,this._far),this._frustum.updateFrustum()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"aspectRatio",{get:function(){return this._aspectRatio},set:function(t){this._aspectRatio!=t&&(this._aspectRatio=t,this.cameraType=this._cameraType)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"fieldOfView",{get:function(){return this._fov},set:function(t){this._fov!=t&&(this._fov=t,this.cameraType=this._cameraType)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"near",{get:function(){return this._near},set:function(t){this._near!=t&&(this._near=t,this.cameraType=this._cameraType)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"far",{get:function(){return this._far},set:function(t){this._far!=t&&(this._far=t,this.cameraType=this._cameraType)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"viewPort",{get:function(){return this._viewPort},set:function(t){this._viewPort.copy(t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"viewProjectionMatrix",{get:function(){return this._viewProjectionMatrix.copy(this._viewMatrix),this._viewProjectionMatrix.multiply(this._projectMatrix),this._viewProjectionMatrix},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"orthProjectionMatrix",{get:function(){return this._orthProjectChange&&(this._orthProjectChange=!1,this._orthProjectMatrix.orthographicProjectMatrix(0,0,this._viewPort.w,this._viewPort.h,this._near,this._far)),this._orthProjectMatrix},enumerable:!0,configurable:!0}),t.prototype.updateViewport=function(t,e,i,r){t==this._viewPort.x&&e==this._viewPort.y&&i==this._viewPort.w&&r==this._viewPort.h||(this._orthProjectChange=!0,this._viewPort.x=t,this._viewPort.y=e,this._viewPort.w=i,this._viewPort.h=r)},t.prototype.lookAt=function(t,e,i){void 0===i&&(i=o.Vector3.UP),this.position=t,this._lookAtPosition.copy(e),this._viewMatrix.lookAt(t,e,i);var r=dou.recyclable(o.Quaternion);r.fromMatrix(this._viewMatrix),(this.globalOrientation=r).recycle()},t.prototype.onTransformUpdate=function(){i.prototype.onTransformUpdate.call(this),this._viewMatrix.copy(this._globalMatrix),this._viewMatrix.inverse(),this._frustum.update()},Object.defineProperty(t.prototype,"viewMatrix",{get:function(){return this.validateTransformNow(),this._viewMatrix},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"lookAtPosition",{get:function(){return this._lookAtPosition},enumerable:!0,configurable:!0}),t.prototype.isVisibleToCamera=function(t){return this.validateTransformNow(),t.validateTransformNow(),!t.bound||t.bound.inBound(this._frustum)},t.prototype.spaceToScreen=function(t,e){e=e||new o.Vector2;var i=.5*this._viewPort.w,r=.5*this._viewPort.h,a=dou.recyclable(o.Vector4);return this.viewMatrix.transformVector(t,a),this.project(a,a),e.x=i+a.x*i,e.y=this._viewPort.h-(r-a.y*r),a.recycle(),e},t.prototype.project=function(t,e){this._projectMatrix.transformVector(t,e),e.x=e.x/e.w,e.y=-e.y/e.w,e.z=t.z},t.prototype.screenToSpace=function(t,e,i){void 0===e&&(e=0),i=i||new o.Vector3;var r=.5*this._viewPort.w,a=.5*this._viewPort.h,n=dou.recyclable(o.Vector4);return n.x=(t.x-r)/r,n.y=(a-(this._viewPort.h-t.y))/a,this.unproject(n.x,n.y,e,n),this._globalMatrix.transformVector(n,n),i.x=n.x,i.y=n.y,i.z=n.z,n.recycle(),i},t.prototype.unproject=function(t,e,i,r){r.x=t,r.y=-e,r.z=i,r.w=1,r.x*=i,r.y*=i;var a=dou.recyclable(o.Matrix4);a.copy(this._projectMatrix),a.inverse(),a.transformVector(r,r),a.recycle(),r.z=i},t.prototype.markTransform=function(){var t=dou.recyclable(o.Vector3);t.set(1,1,1),this._globalMatrix.compose(this._globalPosition,this._globalOrientation,t),t.recycle()},t.prototype.dispose=function(){i.prototype.dispose.call(this),this._frustum&&this._frustum.dispose()},t}(o.Object3D);o.Camera3D=t}(dou3d||(dou3d={})),function(s){var t=function(){function t(t){this._vtxNum=8,this._planeNum=6,this._camera=t,this._vertex=[];for(var e=0;e<this._vtxNum;++e)this._vertex.push(new s.Vector3);this._plane=[];for(e=0;e<6;++e)this._plane.push(new s.Plane(s.Vector3.UP));this._box=new s.BoundBox(null,new s.Vector3,new s.Vector3),this._center=new s.Vector3}return Object.defineProperty(t.prototype,"box",{get:function(){return this._box},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"center",{get:function(){return this._center},enumerable:!0,configurable:!0}),t.prototype.updateFrustum=function(){switch(this._camera.cameraType){case 0:this.makeFrustum(this._camera.fieldOfView,this._camera.aspectRatio,this._camera.near,this._camera.far);break;case 1:this.makeOrthoFrustum(this._camera.viewPort.w,this._camera.viewPort.h,this._camera.near,this._camera.far)}},t.prototype.makeFrustum=function(t,e,i,r){var a=Math.tan(t/2*(Math.PI/180)),n=i*a,o=n*e,s=r*a,h=s*e;this._vertex[0].x=o,this._vertex[0].y=n,this._vertex[0].z=i,this._vertex[1].x=-o,this._vertex[1].y=n,this._vertex[1].z=i,this._vertex[2].x=-o,this._vertex[2].y=-n,this._vertex[2].z=i,this._vertex[3].x=o,this._vertex[3].y=-n,this._vertex[3].z=i,this._vertex[4].x=h,this._vertex[4].y=s,this._vertex[4].z=r,this._vertex[5].x=-h,this._vertex[5].y=s,this._vertex[5].z=r,this._vertex[6].x=-h,this._vertex[6].y=-s,this._vertex[6].z=r,this._vertex[7].x=h,this._vertex[7].y=-s,this._vertex[7].z=r},t.prototype.makeOrthoFrustum=function(t,e,i,r){this._vertex[0].x=t/2,this._vertex[0].y=e/2,this._vertex[0].z=i,this._vertex[1].x=-t/2,this._vertex[1].y=e/2,this._vertex[1].z=i,this._vertex[2].x=-t/2,this._vertex[2].y=-e/2,this._vertex[2].z=i,this._vertex[3].x=t/2,this._vertex[3].y=-e/2,this._vertex[3].z=i,this._vertex[4].x=t/2,this._vertex[4].y=e/2,this._vertex[4].z=r,this._vertex[5].x=-t/2,this._vertex[5].y=e/2,this._vertex[5].z=r,this._vertex[6].x=-t/2,this._vertex[6].y=-e/2,this._vertex[6].z=r,this._vertex[7].x=t/2,this._vertex[7].y=-e/2,this._vertex[7].z=r},t.prototype.update=function(){var t=dou.recyclable(s.Matrix4);t.copy(this._camera.globalMatrix);for(var e=[],i=0;i<this._vtxNum;++i){var r=dou.recyclable(s.Vector4);t.transformVector(this._vertex[i],r);var a=dou.recyclable(s.Vector3);a.set(r.x,r.y,r.z),e.push(a),r.recycle()}this._box.max.x=this._box.max.y=this._box.max.z=s.MathUtil.INT_MIN,this._box.min.x=this._box.min.y=this._box.min.z=s.MathUtil.INT_MAX;for(i=0;i<e.length;++i)this._box.max.x<e[i].x&&(this._box.max.x=e[i].x),this._box.max.y<e[i].y&&(this._box.max.y=e[i].y),this._box.max.z<e[i].z&&(this._box.max.z=e[i].z),this._box.min.x>e[i].x&&(this._box.min.x=e[i].x),this._box.min.y>e[i].y&&(this._box.min.y=e[i].y),this._box.min.z>e[i].z&&(this._box.min.z=e[i].z);this._box.calculateBox(),this._plane[0].fromPoints(e[4],e[5],e[6]),this._plane[1].fromPoints(e[1],e[6],e[5]),this._plane[2].fromPoints(e[0],e[4],e[7]),this._plane[3].fromPoints(e[1],e[0],e[3]),this._plane[4].fromPoints(e[1],e[5],e[4]),this._plane[5].fromPoints(e[3],e[7],e[6]);for(i=0;i<this._planeNum;i++)this._plane[i].normalize();var n=dou.recyclable(s.Vector3),o=dou.recyclable(s.Vector3);n.copy(e[0].subtract(e[2])),n.multiplyScalar(.5),n.copy(e[2].add(n)),o.copy(e[4].subtract(e[6])),o.multiplyScalar(.5),o.copy(e[6].add(o)),this._center.copy(o.subtract(n)),this._center.multiplyScalar(.5),this._center.copy(n.add(this._center)),n.recycle(),o.recycle();for(i=0;i<e.length;++i)e[i].recycle()},t.prototype.inPoint=function(t){for(var e=0;e<this._plane.length;++e)if(0<this._plane[e].getDistance(t))return!1;return!0},t.prototype.inSphere=function(t,e){for(var i=0;i<this._plane.length;++i)if(e<this._plane[i].getDistance(t))return!1;return!0},t.prototype.inBox=function(t){for(var e=this._plane.length,i=dou.recyclable(s.Vector4),r=0;r<e;++r){for(var a=t.vexData.length/3,n=t.vexData.length,o=0;o<n;o+=3)i.set(t.vexData[o],t.vexData[o+1],t.vexData[o+2],0),t.transform.transformVector(i,i),0<this._plane[r].getDistance(i)&&a--;if(a<=0)return i.recycle(),!1}return i.recycle(),!0},t.prototype.dispose=function(){},t}();s.Frustum=t}(dou3d||(dou3d={})),function(t){var e=function(){function t(t){this._autoUpdate=!0,this.target=t}return Object.defineProperty(t.prototype,"autoUpdate",{get:function(){return this._autoUpdate},set:function(t){this._autoUpdate!=t&&(this._autoUpdate=t,this._target&&(this._target.controller=this._autoUpdate?this:null))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"target",{get:function(){return this._target},set:function(t){this._target!=t&&(this._target&&this._autoUpdate&&(this._target.controller=null),this._target=t,this._target&&this._autoUpdate&&(this._target.controller=this))},enumerable:!0,configurable:!0}),t}();t.ControllerBase=e}(dou3d||(dou3d={})),function(a){var t=function(r){function t(t,e){var i=r.call(this,t)||this;return i._upAxis=a.Vector3.UP,e&&(e instanceof a.Object3D?i.lookAtObject=e:i.lookAtPosition=e),i}return __extends(t,r),Object.defineProperty(t.prototype,"lookAtPosition",{get:function(){return this._lookAtPosition},set:function(t){this._lookAtPosition=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"lookAtObject",{get:function(){return this._lookAtObject},set:function(t){this._lookAtObject=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"upAxis",{get:function(){return this._upAxis},set:function(t){this._upAxis=t},enumerable:!0,configurable:!0}),t.prototype.update=function(t,e){if(this._target)if(this._lookAtPosition)this._target.lookAt(this._target.globalPosition,this._lookAtPosition,this._upAxis);else if(this._lookAtObject)if(this._target.parent===this._lookAtObject.parent)this._target.lookAt(this._target.position,this._lookAtObject.position,this._upAxis);else{var i=dou.recyclable(a.Vector4);this._target.parent.globalToLocal(this._lookAtObject.globalPosition,i);var r=dou.recyclable(a.Vector3);r.set(i.x,i.y,i.z),this._target.lookAt(this._target.position,r,this._upAxis),i.recycle(),r.recycle()}else this._target.lookAt(this._target.globalPosition,a.Vector3.ZERO,this._upAxis)},t}(a.ControllerBase);a.LookAtController=t}(dou3d||(dou3d={})),function(a){var t=function(p){function t(t,e,i,r,a,n,o,s,h,u,l,c){void 0===i&&(i=0),void 0===r&&(r=90),void 0===a&&(a=1e3),void 0===n&&(n=NaN),void 0===o&&(o=NaN),void 0===s&&(s=-90),void 0===h&&(h=90),void 0===u&&(u=8),void 0===l&&(l=2),void 0===c&&(c=!1);var d=p.call(this,t,e)||this;return d._panAngle=0,d._tiltAngle=90,d._distance=1e3,d._minPanAngle=-1/0,d._maxPanAngle=1/0,d._minTiltAngle=-90,d._maxTiltAngle=90,d._steps=8,d._yFactor=2,d._wrapPanAngle=!1,d.distance=a,d.panAngle=i,d.tiltAngle=r,d.minPanAngle=n||-1/0,d.maxPanAngle=o||1/0,d.minTiltAngle=s,d.maxTiltAngle=h,d.steps=u,d.yFactor=l,d.wrapPanAngle=c,d._currentPanAngle=d._panAngle,d._currentTiltAngle=d._tiltAngle,d}return __extends(t,p),Object.defineProperty(t.prototype,"panAngle",{get:function(){return this._panAngle},set:function(t){t=a.MathUtil.clamp(t,this._minPanAngle,this._maxPanAngle),this._panAngle!=t&&(this._panAngle=t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"tiltAngle",{get:function(){return this._tiltAngle},set:function(t){t=a.MathUtil.clamp(t,this._minTiltAngle,this._maxTiltAngle),this._tiltAngle!=t&&(this._tiltAngle=t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"distance",{get:function(){return this._distance},set:function(t){this._distance!=t&&(this._distance=t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"minPanAngle",{get:function(){return this._minPanAngle},set:function(t){this._minPanAngle!=t&&(this._minPanAngle=t,this.panAngle=a.MathUtil.clamp(t,this._minPanAngle,this._maxPanAngle))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"maxPanAngle",{get:function(){return this._maxPanAngle},set:function(t){this._maxPanAngle!=t&&(this._maxPanAngle=t,this.panAngle=a.MathUtil.clamp(t,this._minPanAngle,this._maxPanAngle))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"minTiltAngle",{get:function(){return this._minTiltAngle},set:function(t){this._minTiltAngle!=t&&(this._minTiltAngle=t,this.tiltAngle=a.MathUtil.clamp(t,this._minTiltAngle,this._maxTiltAngle))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"maxTiltAngle",{get:function(){return this._maxTiltAngle},set:function(t){this._maxTiltAngle!=t&&(this._maxTiltAngle=t,this.tiltAngle=a.MathUtil.clamp(t,this._minTiltAngle,this._maxTiltAngle))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"steps",{get:function(){return this._steps},set:function(t){this._steps!=t&&(this._steps=t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"yFactor",{get:function(){return this._yFactor},set:function(t){this._yFactor!=t&&(this._yFactor=t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"wrapPanAngle",{get:function(){return this._wrapPanAngle},set:function(t){this._wrapPanAngle!=t&&(this._wrapPanAngle=t)},enumerable:!0,configurable:!0}),t.prototype.update=function(t,e){if(this._tiltAngle!=this._currentTiltAngle||this._panAngle!=this._currentPanAngle){if(this._wrapPanAngle){for(this._panAngle<0?(this._currentPanAngle+=this._panAngle%360+360-this._panAngle,this._panAngle=this._panAngle%360+360):(this._currentPanAngle+=this._panAngle%360-this._panAngle,this._panAngle=this._panAngle%360);this._panAngle-this._currentPanAngle<-180;)this._currentPanAngle-=360;for(;180<this._panAngle-this._currentPanAngle;)this._currentPanAngle+=360}0<this._steps?(this._currentTiltAngle+=(this._tiltAngle-this._currentTiltAngle)/(this._steps+1),this._currentPanAngle+=(this._panAngle-this._currentPanAngle)/(this._steps+1)):(this._currentPanAngle=this._panAngle,this._currentTiltAngle=this._tiltAngle),Math.abs(this._tiltAngle-this._currentTiltAngle)<.01&&Math.abs(this._panAngle-this._currentPanAngle)<.01&&(this._currentTiltAngle=this._tiltAngle,this._currentPanAngle=this._panAngle)}if(this._target){var i=dou.recyclable(a.Vector3);if(this._lookAtPosition)i.x=this._lookAtPosition.x,i.y=this._lookAtPosition.y,i.z=this._lookAtPosition.z;else if(this._lookAtObject)if(this._target.parent===this._lookAtObject.parent)i.x=this._lookAtObject.x,i.y=this._lookAtObject.y,i.z=this._lookAtObject.z;else{var r=dou.recyclable(a.Vector4);this._target.parent.globalToLocal(this._lookAtObject.globalPosition,r),i.set(r.x,r.y,r.z),r.recycle()}else i.x=0,i.y=0,i.z=0;this._target.x=i.x+this._distance*Math.sin(this._currentPanAngle*a.MathUtil.DEG_RAD)*Math.cos(this._currentTiltAngle*a.MathUtil.DEG_RAD),this._target.z=i.z+this._distance*Math.cos(this._currentPanAngle*a.MathUtil.DEG_RAD)*Math.cos(this._currentTiltAngle*a.MathUtil.DEG_RAD),this._target.y=i.y+this._distance*Math.sin(this._currentTiltAngle*a.MathUtil.DEG_RAD)*this._yFactor,i.recycle(),p.prototype.update.call(this,t,e)}},t}(a.LookAtController);a.HoverController=t}(dou3d||(dou3d={})),function(t){t.ContextSamplerType||(t.ContextSamplerType={})}(dou3d||(dou3d={})),function(t){var e;(e=t.ShaderPhaseType||(t.ShaderPhaseType={}))[e.base_vertex=0]="base_vertex",e[e.start_vertex=1]="start_vertex",e[e.local_vertex=2]="local_vertex",e[e.global_vertex=3]="global_vertex",e[e.end_vertex=4]="end_vertex",e[e.base_fragment=5]="base_fragment",e[e.start_fragment=6]="start_fragment",e[e.materialsource_fragment=7]="materialsource_fragment",e[e.diffuse_fragment=8]="diffuse_fragment",e[e.normal_fragment=9]="normal_fragment",e[e.matCap_fragment=10]="matCap_fragment",e[e.specular_fragment=11]="specular_fragment",e[e.shadow_fragment=12]="shadow_fragment",e[e.lighting_fragment=13]="lighting_fragment",e[e.multi_end_fragment=14]="multi_end_fragment",e[e.end_fragment=15]="end_fragment"}(dou3d||(dou3d={})),function(t){var e=function(t){function o(){return null!==t&&t.apply(this,arguments)||this}return __extends(o,t),o.dispatch=function(t,e,i,r){var a=dou.recyclable(o);a.initEvent(e,i,r);var n=t.dispatchEvent(a);return a.recycle(),n},o.prototype.initEvent=function(t,e,i){this.init(t,e,i)},o.prototype.onRecycle=function(){t.prototype.onRecycle.call(this)},o.ENTER_FRAME="enterFrame",o.EXIT_FRAME="exitFrame",o.RESIZE="resize",o.TOUCH_BEGIN="touchBegin",o.TOUCH_MOVE="touchMove",o.TOUCH_END="touchEnd",o}(dou.Event);t.Event3D=e}(dou3d||(dou3d={})),function(n){var t=function(){function a(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e}return a.distance=function(t,e){var i=t.x-e.x,r=t.y-e.y;return Math.sqrt(i*i+r*r)},a.polar=function(t,e,i){return(i=i||new a).x=t*Math.sin(e),i.y=t*Math.cos(e),i},a.intersection=function(t,e,i,r,a){var n=(r.y-i.y)*(e.x-t.x)-(r.x-i.x)*(e.y-t.y);if(0==n)return!1;if(a){var o=((r.x-i.x)*(t.y-i.y)-(r.y-i.y)*(t.x-i.x))/n;a.x=t.x+o*(e.x-t.x),a.y=t.y+o*(e.y-t.y)}return!0},a.lerp=function(t,e,i,r){return(r=r||new a).x=t.x*(1-i)+e.x*i,r.y=t.y*(1-i)+e.y*i,r},Object.defineProperty(a.prototype,"sqrtLength",{get:function(){var t=this.x,e=this.y;return t*t+e*e},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"length",{get:function(){var t=this.x,e=this.y;return Math.sqrt(t*t+e*e)},enumerable:!0,configurable:!0}),a.prototype.set=function(t,e){return this.x=t,this.y=e,this},a.prototype.add=function(t,e){return e||(e=t,t=this),this.x=t.x+e.x,this.y=t.y+e.y,this},a.prototype.subtract=function(t,e){return e||(e=t,t=this),this.x=t.x-e.x,this.y=t.y-e.y,this},a.prototype.multiply=function(t,e){return e||(e=t,t=this),this.x=t.x*e.x,this.y=t.y*e.y,this},a.prototype.addScalar=function(t,e){return e=e||this,this.x=e.x+t,this.y=e.y+t,this},a.prototype.multiplyScalar=function(t,e){return e=e||this,this.x=t*e.x,this.y=t*e.y,this},a.prototype.dot=function(t){return this.x*t.x+this.y*t.y},a.prototype.getAngle=function(t){var e=dou.recyclable(a);e.normalize(this);var i=dou.recyclable(a);i.normalize(t);var r=Math.acos(e.dot(i));return e.recycle(),i.recycle(),r},a.prototype.cross=function(t){return this.x*t.y-this.y*t.x},a.prototype.normalize=function(t){var e=(t=t||this).x,i=t.y,r=Math.sqrt(e*e+i*i);return r>n.MathUtil.EPSILON?(r=1/r,this.x=e*r,this.y=i*r):(this.x=1,this.y=0),this},a.prototype.equal=function(t,e){return void 0===e&&(e=n.MathUtil.EPSILON),Math.abs(this.x-t.x)<=e&&Math.abs(this.y-t.y)<=e},a.prototype.copy=function(t){return this.set(t.x,t.y)},a.prototype.clone=function(){return new a(this.x,this.y)},a.prototype.clear=function(){return this.x=0,this.y=0,this},a.prototype.onRecycle=function(){this.clear()},a.ZERO=new a(0,0),a.ONE=new a(1,1),a.MINUS_ONE=new a(-1,-1),a}();n.Vector2=t}(dou3d||(dou3d={})),function(d){var t=function(){function c(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this.x=t,this.y=e,this.z=i}return c.getDistance=function(t,e){var i=t.x-e.x,r=t.y-e.y,a=t.z-e.z;return Math.sqrt(i*i+r*r+a*a)},c.intersection=function(t,e,i,r,a){if(1==e.dot(r))return!1;var n=dou.recyclable(c);n.subtract(i,t);var o=dou.recyclable(c);o.cross(e,r);var s=dou.recyclable(c);s.cross(n,r);var h=n.dot(o);if(1e-5<=h||h<=1e-5)return n.recycle(),o.recycle(),s.recycle(),!1;var u=s.dot(o)/o.squaredLength;return a&&(a.copy(e),a.multiplyScalar(u),a.add(t)),n.recycle(),o.recycle(),s.recycle(),!0},c.lerp=function(t,e,i,r){return(r=r||new c).x=t.x+(e.x-t.x)*i,r.y=t.y+(e.y-t.y)*i,r.z=t.z+(e.z-t.z)*i,r},c.slerp=function(t,e,i,r){r=r||new c;var a=t.length,n=e.length;if(a<d.MathUtil.EPSILON||n<d.MathUtil.EPSILON)return this.lerp(t,e,i,r);var o=t.dot(e)/(a*n);if(o>1-d.MathUtil.EPSILON)return this.lerp(t,e,i,r);var s=d.MathUtil.lerp(a,n,i),h=dou.recyclable(d.Matrix3),u=dou.recyclable(d.Matrix4);if(o<-1+d.MathUtil.EPSILON){var l=r.orthoNormal(t);h.fromMatrix4(u.fromAxis(l,Math.PI*i)),r.multiplyScalar(1/a,t).applyMatrix3(h).multiplyScalar(s)}else{l=r.cross(t,e).normalize();h.fromMatrix4(u.fromAxis(l,Math.acos(o)*i)),r.multiplyScalar(1/a,t).applyMatrix3(h).multiplyScalar(s)}return h.recycle(),u.recycle(),r},Object.defineProperty(c.prototype,"squaredLength",{get:function(){var t=this.x,e=this.y,i=this.z;return t*t+e*e+i*i},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"length",{get:function(){var t=this.x,e=this.y,i=this.z;return Math.sqrt(t*t+e*e+i*i)},enumerable:!0,configurable:!0}),c.prototype.set=function(t,e,i){return this.x=t,this.y=e,this.z=i,this},c.prototype.addScalar=function(t,e){return e=e||this,this.x=e.x+t,this.y=e.y+t,this.z=e.z+t,this},c.prototype.multiplyScalar=function(t,e){return e=e||this,this.x=t*e.x,this.y=t*e.y,this.z=t*e.z,this},c.prototype.add=function(t,e){return e||(e=t,t=this),this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this},c.prototype.subtract=function(t,e){return e||(e=t,t=this),this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this},c.prototype.multiply=function(t,e){return e||(e=t,t=this),this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this},c.prototype.divide=function(t,e){return e||(e=t,t=this),!DEBUG||0!==e.x&&0!==e.y&&0!==e.z||console.warn(" 0"),this.x=t.x/e.x,this.y=t.y/e.y,this.z=t.z/e.z,this},c.prototype.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},c.prototype.getAngle=function(t){var e=this.squaredLength*t.squaredLength;if(e<d.MathUtil.EPSILON)return DEBUG&&console.warn(" 0"),0;var i=this.dot(t)/Math.sqrt(e);return Math.acos(Math.max(-1,Math.min(1,i)))},c.prototype.cross=function(t,e){e||(e=t,t=this);var i=t.x,r=t.y,a=t.z,n=e.x,o=e.y,s=e.z;return this.x=r*s-a*o,this.y=a*n-i*s,this.z=i*o-r*n,this},c.prototype.reflect=function(t,e){e=e||this;var i=dou.recyclable(c);return this.subtract(e,i.multiplyScalar(2*e.dot(t),t)),i.recycle(),this},c.prototype.getSquaredDistance=function(t){var e=dou.recyclable(c),i=e.subtract(t,this).squaredLength;return e.recycle(),i},c.prototype.getPointDistance=function(t){var e=dou.recyclable(c),i=e.subtract(t,this).length;return e.recycle(),i},c.prototype.fromSphericalCoords=function(t,e,i){void 0===e&&(e=0),void 0===i&&(i=0);var r=Math.sin(e)*t;return this.x=r*Math.sin(i),this.y=Math.cos(e)*t,this.z=r*Math.cos(i),this},c.prototype.applyMatrix3=function(t,e){var i=(e=e||this).x,r=e.y,a=e.z,n=t.rawData;return t instanceof d.Matrix3?(this.x=n[0]*i+n[3]*r+n[6]*a,this.y=n[1]*i+n[4]*r+n[7]*a,this.z=n[2]*i+n[5]*r+n[8]*a):(this.x=n[0]*i+n[4]*r+n[8]*a,this.y=n[1]*i+n[5]*r+n[9]*a,this.z=n[2]*i+n[6]*r+n[10]*a),this},c.prototype.applyMatrix=function(t,e){var i=(e=e||this).x,r=e.y,a=e.z,n=t.rawData,o=n[3]*i+n[7]*r+n[11]*a+n[15];return o<-d.MathUtil.EPSILON||d.MathUtil.EPSILON<o?(o=1/o,this.x=(n[0]*i+n[4]*r+n[8]*a+n[12])*o,this.y=(n[1]*i+n[5]*r+n[9]*a+n[13])*o,this.z=(n[2]*i+n[6]*r+n[10]*a+n[14])*o):(DEBUG&&console.warn(" 0"),this.x=0,this.y=0,this.z=0),this},c.prototype.applyDirection=function(t,e){var i=(e=e||this).x,r=e.y,a=e.z,n=t.rawData;return this.x=n[0]*i+n[4]*r+n[8]*a,this.y=n[1]*i+n[5]*r+n[9]*a,this.z=n[2]*i+n[6]*r+n[10]*a,this.normalize()},c.prototype.applyQuaternion=function(t,e){var i=(e=e||this).x,r=e.y,a=e.z,n=t.x,o=t.y,s=t.z,h=t.w,u=h*i+o*a-s*r,l=h*r+s*i-n*a,c=h*a+n*r-o*i,d=-n*i-o*r-s*a;return this.x=u*h+d*-n+l*-s-c*-o,this.y=l*h+d*-o+c*-n-u*-s,this.z=c*h+d*-s+u*-o-l*-n,this},c.prototype.normalize=function(t){var e=(t=t||this).x,i=t.y,r=t.z,a=Math.sqrt(e*e+i*i+r*r);return a>d.MathUtil.EPSILON?(a=1/a,this.x=e*a,this.y=i*a,this.z=r*a):(this.x=1,this.y=0,this.z=0),this},c.prototype.orthoNormal=function(t){var e=(t=t||this).x,i=t.y,r=t.z;if(0<r?r>d.MathUtil.SQRT1_2:r<d.MathUtil.SQRT1_2){var a=1/Math.sqrt(i*i+r*r);this.x=0,this.y=-r*a,this.z=i*a}else{a=1/Math.sqrt(e*e+i*i);this.x=-i*a,this.y=e*a,this.z=0}return this},c.prototype.negate=function(t){return t=t||this,this.x=-t.x,this.y=-t.y,this.z=-t.z,this},c.prototype.equal=function(t,e){return void 0===e&&(e=d.MathUtil.EPSILON),Math.abs(this.x-t.x)<=e&&Math.abs(this.y-t.y)<=e&&Math.abs(this.z-t.z)<=e},c.prototype.fromArray=function(t,e){return void 0===e&&(e=0),this.x=t[e],this.y=t[e+1],this.z=t[e+2],this},c.prototype.fromMatrixPosition=function(t){return this.fromArray(t.rawData,12)},c.prototype.fromMatrixColumn=function(t,e){return this.fromArray(t.rawData,4*e)},c.prototype.toArray=function(t,e){return void 0===e&&(e=0),(t=t||[])[0+e]=this.x,t[1+e]=this.y,t[2+e]=this.z,t},c.prototype.copy=function(t){return this.set(t.x,t.y,t.z)},c.prototype.clone=function(){return new c(this.x,this.y,this.z)},c.prototype.clear=function(){return this.x=0,this.y=0,this.z=0,this},c.prototype.onRecycle=function(){this.clear()},c.ZERO=new c(0,0,0),c.ONE=new c(1,1,1),c.MINUS_ONE=new c(-1,-1,-1),c.UP=new c(0,1,0),c.DOWN=new c(0,-1,0),c.LEFT=new c(-1,0,0),c.RIGHT=new c(1,0,0),c.FORWARD=new c(0,0,1),c.BACK=new c(0,0,-1),c}();d.Vector3=t}(dou3d||(dou3d={})),function(o){var t=function(){function a(t,e,i,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===r&&(r=1),this.x=t,this.y=e,this.z=i,this.w=r}return a.lerp=function(t,e,i,r){return(r=r||new a).x=t.x+(e.x-t.x)*i,r.y=t.y+(e.y-t.y)*i,r.z=t.z+(e.z-t.z)*i,r.w=t.w+(e.w-t.w)*i,r},Object.defineProperty(a.prototype,"squaredLength",{get:function(){var t=this.x,e=this.y,i=this.z,r=this.w;return t*t+e*e+i*i+r*r},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"length",{get:function(){var t=this.x,e=this.y,i=this.z,r=this.w;return Math.sqrt(t*t+e*e+i*i+r*r)},enumerable:!0,configurable:!0}),a.prototype.set=function(t,e,i,r){return this.x=t,this.y=e,this.z=i,this.w=r,this},a.prototype.multiplyScalar=function(t,e){return e=e||this,this.x=t*e.x,this.y=t*e.y,this.z=t*e.z,this.w=t*e.w,this},a.prototype.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w},a.prototype.inverse=function(t){return t=t||this,this.x=-1*t.x,this.y=-1*t.y,this.z=-1*t.z,this.w=t.w,this},a.prototype.normalize=function(t){var e=(t=t||this).x,i=t.y,r=t.z,a=t.w,n=Math.sqrt(e*e+i*i+r*r+a*a);return n>o.MathUtil.EPSILON?(n=1/n,this.x=e*n,this.y=i*n,this.z=r*n,this.w=a*n):this.clear(),this},a.prototype.equal=function(t,e){return void 0===e&&(e=o.MathUtil.EPSILON),Math.abs(this.x-t.x)<=e&&Math.abs(this.y-t.y)<=e&&Math.abs(this.z-t.z)<=e&&Math.abs(this.w-t.w)<=e},a.prototype.fromArray=function(t,e){return void 0===e&&(e=0),this.x=t[e],this.y=t[e+1],this.z=t[e+2],this.w=t[e+3],this},a.prototype.toArray=function(t,e){return void 0===e&&(e=0),(t=t||[])[0+e]=this.x,t[1+e]=this.y,t[2+e]=this.z,t[3+e]=this.w,t},a.prototype.copy=function(t){return this.set(t.x,t.y,t.z,t.w)},a.prototype.clone=function(){return new a(this.x,this.y,this.z,this.w)},a.prototype.clear=function(){return this.x=0,this.y=0,this.z=0,this.w=1,this},a.prototype.onRecycle=function(){this.clear()},a}();o.Vector4=t}(dou3d||(dou3d={})),function(x){var t=function(t){function g(){return null!==t&&t.apply(this,arguments)||this}return __extends(g,t),g.lerp=function(t,e,i,r){r=r||new g;var a=t.x,n=t.y,o=t.z,s=t.w,h=e.x,u=e.y,l=e.z,c=e.w;return a*h+n*u+o*l+s*c<0?(r.x=a+(-h-a)*i,r.y=n+(-u-n)*i,r.z=o+(-l-o)*i,r.w=s+(-c-s)*i):(r.x=a+(h-a)*i,r.y=n+(u-n)*i,r.z=o+(l-o)*i,r.w=s+(c-s)*i),r.normalize()},g.slerp=function(t,e,i,r){r=r||new g;var a=t.x,n=t.y,o=t.z,s=t.w,h=e.x,u=e.y,l=e.z,c=e.w,d=s*c+a*h+n*u+o*l;if(d<0?(r.w=-c,r.x=-h,r.y=-u,r.z=-l,d=-d):(r.w=c,r.x=h,r.y=u,r.z=l),1<=d)return r.w=s,r.x=a,r.y=n,r.z=o,r;var p=1-d*d;if(p<x.MathUtil.EPSILON)return this.lerp(t,r,i,r);var f=Math.sqrt(p),_=Math.atan2(f,d),m=Math.sin((1-i)*_)/f,y=Math.sin(i*_)/f;return r.w=s*m+r.w*y,r.x=a*m+r.x*y,r.y=n*m+r.y*y,r.z=o*m+r.z*y,r},g.prototype.fromMatrix=function(t){var e=t.rawData,i=e[0],r=e[4],a=e[8],n=e[1],o=e[5],s=e[9],h=e[2],u=e[6],l=e[10],c=i+o+l,d=0;return 0<c?(d=.5/Math.sqrt(c+1),this.w=.25/d,this.x=(u-s)*d,this.y=(a-h)*d,this.z=(n-r)*d):o<i&&l<i?(d=2*Math.sqrt(1+i-o-l),this.w=(u-s)/d,this.x=.25*d,this.y=(r+n)/d,this.z=(a+h)/d):l<o?(d=2*Math.sqrt(1+o-i-l),this.w=(a-h)/d,this.x=(r+n)/d,this.y=.25*d,this.z=(s+u)/d):(d=2*Math.sqrt(1+l-i-o),this.w=(n-r)/d,this.x=(a+h)/d,this.y=(s+u)/d,this.z=.25*d),this},g.prototype.fromEuler=function(t,e,i,r){void 0===r&&(r=3);var a=Math.cos,n=Math.sin,o=a(.5*t),s=a(.5*e),h=a(.5*i),u=n(.5*t),l=n(.5*e),c=n(.5*i);switch(r){case 1:this.x=u*s*h+o*l*c,this.y=o*l*h-u*s*c,this.z=o*s*c+u*l*h,this.w=o*s*h-u*l*c;break;case 2:this.x=u*s*h-o*l*c,this.y=o*l*h-u*s*c,this.z=o*s*c+u*l*h,this.w=o*s*h+u*l*c;break;case 3:this.x=u*s*h+o*l*c,this.y=o*l*h-u*s*c,this.z=o*s*c-u*l*h,this.w=o*s*h+u*l*c;break;case 4:this.x=u*s*h+o*l*c,this.y=o*l*h+u*s*c,this.z=o*s*c-u*l*h,this.w=o*s*h-u*l*c;break;case 5:this.x=u*s*h-o*l*c,this.y=o*l*h+u*s*c,this.z=o*s*c+u*l*h,this.w=o*s*h-u*l*c;break;case 6:this.x=u*s*h-o*l*c,this.y=o*l*h+u*s*c,this.z=o*s*c-u*l*h,this.w=o*s*h+u*l*c}return this},g.prototype.fromAxis=function(t,e){var i=.5*e,r=Math.sin(i);return this.x=t.x*r,this.y=t.y*r,this.z=t.z*r,this.w=Math.cos(i),this},g.prototype.fromVectors=function(t,e){var i=t.dot(e)+1,r=dou.recyclable(x.Vector3);return i<x.MathUtil.EPSILON?(i=0,Math.abs(t.x)>Math.abs(t.z)?r.set(-t.y,t.x,0):r.set(0,-t.z,t.y)):r.cross(t,e),this.x=r.x,this.y=r.y,this.z=r.z,this.w=i,r.recycle(),this.normalize()},g.prototype.toEuler=function(t,e){void 0===e&&(e=3),t=t||new x.Vector3;var i=dou.recyclable(x.Matrix4),r=i.fromRotation(this).toEuler(e,t);return i.recycle(),r},g.prototype.multiply=function(t,e){e||(e=t,t=this);var i=t.x,r=t.y,a=t.z,n=t.w,o=e.x,s=e.y,h=e.z,u=e.w;return this.x=i*u+n*o+r*h-a*s,this.y=r*u+n*s+a*o-i*h,this.z=a*u+n*h+i*s-r*o,this.w=n*u-i*o-r*s-a*h,this},g.prototype.transformVector=function(t,e){e=e||new x.Vector3;var i=this.x,r=this.y,a=this.z,n=this.w,o=t.x,s=t.y,h=t.z,u=-i*o-r*s-a*h,l=n*o+r*h-a*s,c=n*s-i*h+a*o,d=n*h+i*s-r*o;return e.x=-u*i+l*n-c*a+d*r,e.y=-u*r+l*a+c*n-d*i,e.z=-u*a-l*r+c*i+d*n,e},g.prototype.lookAt=function(t,e,i){var r=dou.recyclable(x.Matrix4),a=this.fromMatrix(r.lookAt(t,e,i));return r.recycle(),a},g.prototype.lookRotation=function(t,e){var i=dou.recyclable(x.Matrix4),r=this.fromMatrix(i.lookRotation(t,e));return i.recycle(),r},g.prototype.getAngle=function(t){return 2*Math.acos(Math.abs(x.MathUtil.clamp(this.dot(t),-1,1)))},g.prototype.identity=function(){return this.x=this.y=this.z=0,this.w=1,this},g.prototype.clone=function(){return new g(this.x,this.y,this.z,this.w)},g.IDENTITY=new g,g}(x.Vector4);x.Quaternion=t}(dou3d||(dou3d={})),function(t){var e=function(){function e(t,e){void 0===e&&(e=0),t&&t instanceof ArrayBuffer?this.fromBuffer(t,e):(this.rawData=new Float32Array(9),this.fromArray(t||[1,0,0,0,1,0,0,0,1]))}return Object.defineProperty(e.prototype,"determinant",{get:function(){var t=this.rawData,e=t[0],i=t[1],r=t[2],a=t[3],n=t[4],o=t[5],s=t[6],h=t[7],u=t[8];return e*n*u-e*o*h-i*a*u+i*o*s+r*a*h-r*n*s},enumerable:!0,configurable:!0}),e.prototype.set=function(t,e,i,r,a,n,o,s,h){var u=this.rawData;return u[0]=t,u[1]=r,u[2]=o,u[3]=e,u[4]=a,u[5]=s,u[6]=i,u[7]=n,u[8]=h,this},e.prototype.getNormalMatrix=function(t){return this.fromMatrix4(t).inverse().transpose()},e.prototype.inverse=function(t){var e=(t=t||this).rawData,i=this.rawData,r=e[0],a=e[1],n=e[2],o=e[3],s=e[4],h=e[5],u=e[6],l=e[7],c=e[8],d=c*s-h*l,p=h*u-c*o,f=l*o-s*u,_=r*d+a*p+n*f;if(0==_)return this.identity();var m=1/_;return i[0]=d*m,i[1]=(n*l-c*a)*m,i[2]=(h*a-n*s)*m,i[3]=p*m,i[4]=(c*r-n*u)*m,i[5]=(n*o-h*r)*m,i[6]=f*m,i[7]=(a*u-l*r)*m,i[8]=(s*r-a*o)*m,this},e.prototype.transpose=function(){var t=0,e=this.rawData;return t=e[1],e[1]=e[3],e[3]=t,t=e[2],e[2]=e[6],e[6]=t,t=e[5],e[5]=e[7],e[7]=t,this},e.prototype.multiply=function(t,e){e||(e=t,t=this);var i=t.rawData,r=e.rawData,a=this.rawData,n=i[0],o=i[3],s=i[6],h=i[1],u=i[4],l=i[7],c=i[2],d=i[5],p=i[8],f=r[0],_=r[3],m=r[6],y=r[1],g=r[4],x=r[7],v=r[2],b=r[5],D=r[8];return a[0]=n*f+o*y+s*v,a[3]=n*_+o*g+s*b,a[6]=n*m+o*x+s*D,a[1]=h*f+u*y+l*v,a[4]=h*_+u*g+l*b,a[7]=h*m+u*x+l*D,a[2]=c*f+d*y+p*v,a[5]=c*_+d*g+p*b,a[8]=c*m+d*x+p*D,this},e.prototype.fromArray=function(t,e){void 0===e&&(e=0);for(var i=0;i<9;++i)this.rawData[i]=t[i+e];return this},e.prototype.fromBuffer=function(t,e){return void 0===e&&(e=0),this.rawData=new Float32Array(t,e,9),this},e.prototype.fromScale=function(t){var e=this.rawData;return e[0]=t.x,e[1]=0,e[2]=0,e[3]=0,e[4]=t.y,e[5]=0,e[6]=0,e[7]=0,e[8]=t.z,this},e.prototype.fromUVTransform=function(t,e,i,r,a,n,o){void 0===a&&(a=0),void 0===n&&(n=0),void 0===o&&(o=0);var s=Math.cos(a),h=Math.sin(a);return this.set(i*s,i*h,-i*(s*n+h*o)+n+t,-r*h,r*s,-r*(-h*n+s*o)+o+e,0,0,1)},e.prototype.fromMatrix4=function(t){var e=t.rawData;return this.set(e[0],e[4],e[8],e[1],e[5],e[9],e[2],e[6],e[10]),this},e.prototype.toArray=function(t,e){void 0===e&&(e=0),t=t||[];for(var i=0;i<9;++i)t[i+e]=this.rawData[i];return t},e.prototype.copy=function(t){return this.fromArray(t.rawData),this},e.prototype.clone=function(){var t=new e;return t.copy(this),t},e.prototype.identity=function(){var t=this.rawData;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,this},e.prototype.onRecycle=function(){this.identity()},e.IDENTITY=new e,e}();t.Matrix3=e}(dou3d||(dou3d={})),function(p){var t=function(){function T(t,e){void 0===e&&(e=0),t&&t instanceof ArrayBuffer?this.fromBuffer(t,e):(this.rawData=new Float32Array(16),this.fromArray(t||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]))}return T.lerp=function(t,e,i,r){var a=(r=r||new T).rawData;if(0==i){for(var n=0;n<16;n++)a[n]=t.rawData[n];return r}if(1==i){for(n=0;n<16;n++)a[n]=e.rawData[n];return r}for(n=0;n<16;n++){var o=t.rawData[n];a[n]=o+(e.rawData[n]-o)*i}return r},Object.defineProperty(T.prototype,"determinant",{get:function(){var t=this.rawData,e=t[0],i=t[4],r=t[8],a=t[12],n=t[1],o=t[5],s=t[9],h=t[13],u=t[2],l=t[6],c=t[10],d=t[14],p=s*l,f=h*l,_=o*c,m=h*c,y=o*d,g=s*d,x=n*c,v=n*d,b=h*u,D=s*u,P=n*l,w=o*u;return t[3]*(a*p-r*f-a*_+i*m+r*y-i*g)+t[7]*(e*g-e*m+a*x-r*v+r*b-a*D)+t[11]*(e*f-e*y-a*P+i*v+a*w-i*b)+t[15]*(-r*w-e*p+e*_+r*P-i*x+i*D)},enumerable:!0,configurable:!0}),Object.defineProperty(T.prototype,"maxScaleOnAxis",{get:function(){var t=this.rawData,e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],i=t[4]*t[4]+t[5]*t[5]+t[6]*t[6],r=t[8]*t[8]+t[9]*t[9]+t[10]*t[10];return Math.sqrt(Math.max(e,i,r))},enumerable:!0,configurable:!0}),T.prototype.set=function(t,e,i,r,a,n,o,s,h,u,l,c,d,p,f,_){var m=this.rawData;return m[0]=t,m[4]=e,m[8]=i,m[12]=r,m[1]=a,m[5]=n,m[9]=o,m[13]=s,m[2]=h,m[6]=u,m[10]=l,m[14]=c,m[3]=d,m[7]=p,m[11]=f,m[15]=_,this},T.prototype.compose=function(t,e,i){var r=e.x,a=e.y,n=e.z,o=e.w,s=i.x,h=i.y,u=i.z,l=r+r,c=a+a,d=n+n,p=r*l,f=r*c,_=r*d,m=a*c,y=a*d,g=n*d,x=o*l,v=o*c,b=o*d,D=this.rawData;return D[0]=(1-(m+g))*s,D[1]=(f+b)*s,D[2]=(_-v)*s,D[4]=(f-b)*h,D[5]=(1-(p+g))*h,D[6]=(y+x)*h,D[8]=(_+v)*u,D[9]=(y-x)*u,D[10]=(1-(p+m))*u,D[12]=t.x,D[13]=t.y,D[14]=t.z,D[3]=D[7]=D[11]=0,D[15]=1,this},T.prototype.decompose=function(t,e,i){var r=this.rawData;if(t&&(t.x=r[12],t.y=r[13],t.z=r[14]),e||i){var a=dou.recyclable(p.Vector3),n=a.set(r[0],r[1],r[2]).length,o=a.set(r[4],r[5],r[6]).length,s=a.set(r[8],r[9],r[10]).length;if(this.determinant<0&&(n=-n),e){var h=dou.recyclable(T),u=h.rawData,l=1/n,c=1/o,d=1/s;h.copy(this),u[0]*=l,u[1]*=l,u[2]*=l,u[4]*=c,u[5]*=c,u[6]*=c,u[8]*=d,u[9]*=d,u[10]*=d,e.fromMatrix(h),h.recycle()}i&&(i.x=n,i.y=o,i.z=s),a.recycle()}return this},T.prototype.extractRotation=function(t){t=t||this;var e=this.rawData,i=t.rawData,r=dou.recyclable(p.Vector3),a=1/r.fromMatrixColumn(t,0).length,n=1/r.fromMatrixColumn(t,1).length,o=1/r.fromMatrixColumn(t,2).length;return e[0]=i[0]*a,e[1]=i[1]*a,e[2]=i[2]*a,e[3]=0,e[4]=i[4]*n,e[5]=i[5]*n,e[6]=i[6]*n,e[7]=0,e[8]=i[8]*o,e[9]=i[9]*o,e[10]=i[10]*o,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,r.recycle(),this},T.prototype.transpose=function(t){t=t||this;var e=this.rawData,i=t.rawData,r=0;return r=i[1],e[1]=i[4],e[4]=r,r=i[2],e[2]=i[8],e[8]=r,r=i[6],e[6]=i[9],e[9]=r,r=i[3],e[3]=i[12],e[12]=r,r=i[7],e[7]=i[13],e[13]=r,r=i[11],e[11]=i[14],e[14]=r,this},T.prototype.inverse=function(t){t=t||this;var e=this.rawData,i=t.rawData,r=i[0],a=i[4],n=i[8],o=i[12],s=i[1],h=i[5],u=i[9],l=i[13],c=i[2],d=i[6],p=i[10],f=i[14],_=i[3],m=i[7],y=i[11],g=i[15],x=u*d,v=l*d,b=h*p,D=l*p,P=h*f,w=u*f,T=s*p,A=s*f,S=l*c,L=u*c,M=s*d,C=h*c,E=w*m-D*m+v*y-P*y-x*g+b*g,z=o*p*m-n*f*m-o*d*y+a*f*y+n*d*g-a*p*g,U=n*l*m-o*u*m+o*h*y-a*l*y-n*h*g+a*u*g,I=o*x-n*v-o*b+a*D+n*P-a*w,R=r*E+s*z+c*U+_*I;if(0==R)return DEBUG&&console.warn("Cannot invert matrix, determinant is 0."),this.identity();var O=1/R;return e[0]=E*O,e[1]=(D*_-w*_-S*y+A*y+L*g-T*g)*O,e[2]=(P*_-v*_+S*m-A*m-C*g+M*g)*O,e[3]=(x*_-b*_-L*m+T*m+C*y-M*y)*O,e[4]=z*O,e[5]=(n*f*_-o*p*_+o*c*y-r*f*y-n*c*g+r*p*g)*O,e[6]=(o*d*_-a*f*_-o*c*m+r*f*m+a*c*g-r*d*g)*O,e[7]=(a*p*_-n*d*_+n*c*m-r*p*m-a*c*y+r*d*y)*O,e[8]=U*O,e[9]=(o*u*_-n*l*_-o*s*y+r*l*y+n*s*g-r*u*g)*O,e[10]=(a*l*_-o*h*_+o*s*m-r*l*m-a*s*g+r*h*g)*O,e[11]=(n*h*_-a*u*_-n*s*m+r*u*m+a*s*y-r*h*y)*O,e[12]=I*O,e[13]=(n*S-o*L+o*T-r*D-n*A+r*w)*O,e[14]=(o*C-a*S-o*M+r*v+a*A-r*P)*O,e[15]=(a*L-n*C+n*M-r*x-a*T+r*b)*O,this},T.prototype.multiplyScalar=function(t,e){e=e||this;var i=this.rawData,r=e.rawData;return i[0]=r[0]*t,i[1]=r[1]*t,i[2]=r[2]*t,i[3]=r[3]*t,i[4]=r[4]*t,i[5]=r[5]*t,i[6]=r[6]*t,i[7]=r[7]*t,i[8]=r[8]*t,i[9]=r[9]*t,i[10]=r[10]*t,i[11]=r[11]*t,i[12]=r[12]*t,i[13]=r[13]*t,i[14]=r[14]*t,i[15]=r[15]*t,this},T.prototype.multiply=function(t,e){e||(e=t,t=this);var i=this.rawData,r=t.rawData,a=e.rawData,n=r[0],o=r[4],s=r[8],h=r[12],u=r[1],l=r[5],c=r[9],d=r[13],p=r[2],f=r[6],_=r[10],m=r[14],y=r[3],g=r[7],x=r[11],v=r[15],b=a[0],D=a[4],P=a[8],w=a[12],T=a[1],A=a[5],S=a[9],L=a[13],M=a[2],C=a[6],E=a[10],z=a[14],U=a[3],I=a[7],R=a[11],O=a[15];return i[0]=n*b+o*T+s*M+h*U,i[4]=n*D+o*A+s*C+h*I,i[8]=n*P+o*S+s*E+h*R,i[12]=n*w+o*L+s*z+h*O,i[1]=u*b+l*T+c*M+d*U,i[5]=u*D+l*A+c*C+d*I,i[9]=u*P+l*S+c*E+d*R,i[13]=u*w+l*L+c*z+d*O,i[2]=p*b+f*T+_*M+m*U,i[6]=p*D+f*A+_*C+m*I,i[10]=p*P+f*S+_*E+m*R,i[14]=p*w+f*L+_*z+m*O,i[3]=y*b+g*T+x*M+v*U,i[7]=y*D+g*A+x*C+v*I,i[11]=y*P+g*S+x*E+v*R,i[15]=y*w+g*L+x*z+v*O,this},T.prototype.append=function(t,e){e||(e=t,t=this);var i=this.rawData,r=t.rawData,a=e.rawData,n=r[0],o=r[4],s=r[8],h=r[12],u=r[1],l=r[5],c=r[9],d=r[13],p=r[2],f=r[6],_=r[10],m=r[14],y=r[3],g=r[7],x=r[11],v=r[15],b=a[0],D=a[4],P=a[8],w=a[12],T=a[1],A=a[5],S=a[9],L=a[13],M=a[2],C=a[6],E=a[10],z=a[14],U=a[3],I=a[7],R=a[11],O=a[15];return i[0]=n*b+u*D+p*P+y*w,i[1]=n*T+u*A+p*S+y*L,i[2]=n*M+u*C+p*E+y*z,i[3]=n*U+u*I+p*R+y*O,i[4]=o*b+l*D+f*P+g*w,i[5]=o*T+l*A+f*S+g*L,i[6]=o*M+l*C+f*E+g*z,i[7]=o*U+l*I+f*R+g*O,i[8]=s*b+c*D+_*P+x*w,i[9]=s*T+c*A+_*S+x*L,i[10]=s*M+c*C+_*E+x*z,i[11]=s*U+c*I+_*R+x*O,i[12]=h*b+d*D+m*P+v*w,i[13]=h*T+d*A+m*S+v*L,i[14]=h*M+d*C+m*E+v*z,i[15]=h*U+d*I+m*R+v*O,this},T.prototype.transformVector=function(t,e){e=e||new p.Vector4;var i=t.x,r=t.y,a=t.z,n=this.rawData;return e.x=i*n[0]+r*n[4]+a*n[8]+n[12],e.y=i*n[1]+r*n[5]+a*n[9]+n[13],e.z=i*n[2]+r*n[6]+a*n[10]+n[14],e.w=i*n[3]+r*n[7]+a*n[11]+n[15],e},T.prototype.fromProjection=function(t,e,i,r,a,n,o,s){var h=dou.recyclable(T);o=1-o;var u=(s?-s.x:0)-.5,l=(s?s.y:0)+.5,c=s?s.w:1,d=s?s.h:1;if(0<a){var p=2*t*Math.tan(.5*i),f=(v=u*(g=n*(x=p)))+(u*(D=p)-v)*o,_=(b=l*x)+(l*(P=D/n)-b)*o,m=(g+(D-g)*o)*c,y=(x+(P-x)*o)*d;this.perspectiveProjectMatrix(f,f+m,_,_-y,t,e)}if(a<1){f=(v=u*(g=r*n))+(u*(D=r)-v)*o;var g,x,v,b,D,P,w=(b=l*(x=r))+(l*(P=r/n)-b)*o;m=(g+(D-g)*o)*c,y=(x+(P-x)*o)*d;h.orthographicProjectMatrix(f,f+m,w,w-y,t,e)}return 0==a?this.copy(h):1==a||T.lerp(h,this,Math.pow(a,8),this),h.recycle(),this},T.prototype.perspectiveProjectMatrix=function(t,e,i,r,a,n){var o=1/(e-t),s=1/(i-r),h=1/(a-n),u=2*a,l=this.rawData;return l[0]=u*o,l[1]=l[2]=l[3]=0,l[4]=l[6]=l[7]=0,l[5]=u*s,l[8]=(e+t)*o,l[9]=(i+r)*s,l[10]=-(n+a)*h,l[11]=1,l[12]=l[13]=l[15]=0,l[14]=u*n*h,this},T.prototype.orthographicProjectMatrix=function(t,e,i,r,a,n){var o=1/(e-t),s=1/(i-r),h=1/(a-n),u=this.rawData;return u[0]=2*o,u[1]=u[2]=u[3]=0,u[4]=u[6]=u[7]=0,u[5]=2*s,u[8]=u[9]=u[11]=0,u[10]=-2*h,u[12]=-(e+t)*o,u[13]=-(i+r)*s,u[14]=(n+a)*h,u[15]=1,this},T.prototype.lookAt=function(t,e,i){var r=dou.recyclable(p.Vector3);return this.lookRotation(r.subtract(e,t),i),r.recycle(),this},T.prototype.lookRotation=function(t,e){var i=dou.recyclable(p.Vector3),r=dou.recyclable(p.Vector3),a=dou.recyclable(p.Vector3),n=i.normalize(t),o=r.cross(e,n).normalize(r),s=a.cross(n,o),h=this.rawData;return h[0]=o.x,h[4]=s.x,h[8]=n.x,h[1]=o.y,h[5]=s.y,h[9]=n.y,h[2]=o.z,h[6]=s.z,h[10]=n.z,i.recycle(),r.recycle(),a.recycle(),this},T.prototype.fromArray=function(t,e){void 0===e&&(e=0);var i=this.rawData;if(0<e)for(var r=0;r<16;++r)i[r]=t[r+e];else for(r=0;r<16;++r)i[r]=t[r];return this},T.prototype.fromBuffer=function(t,e){return void 0===e&&(e=0),this.rawData=new Float32Array(t,e,16),this},T.prototype.fromTranslate=function(t,e){void 0===e&&(e=!1),e||this.identity();var i=this.rawData;return i[12]=t.x,i[13]=t.y,i[14]=t.z,this},T.prototype.fromRotation=function(t,e){void 0===e&&(e=!1);var i=dou.recyclable(p.Vector3),r=this.compose(e?i.fromArray(this.rawData,12):p.Vector3.ZERO,t,p.Vector3.ONE);return i.recycle(),r},T.prototype.fromEuler=function(t,e,i){void 0===e&&(e=3),void 0===i&&(i=!1);var r=Math.cos,a=Math.sin,n=t.x,o=t.y,s=t.z,h=r(n),u=a(n),l=r(o),c=a(o),d=r(s),p=a(s),f=this.rawData;switch(e){case 1:var _=h*d,m=h*p,y=u*d,g=u*p;f[0]=l*d,f[4]=-l*p,f[8]=c,f[1]=m+y*c,f[5]=_-g*c,f[9]=-u*l,f[2]=g-_*c,f[6]=y+m*c,f[10]=h*l;break;case 2:var x=h*l,v=h*c,b=u*l,D=u*c;f[0]=l*d,f[4]=-p,f[8]=c*d,f[1]=x*p+D,f[5]=h*d,f[9]=v*p-b,f[2]=b*p-v,f[6]=u*d,f[10]=D*p+x;break;case 3:var P=l*d,w=l*p,T=c*d,A=c*p;f[0]=P+A*u,f[4]=T*u-w,f[8]=h*c,f[1]=h*p,f[5]=h*d,f[9]=-u,f[2]=w*u-T,f[6]=A+P*u,f[10]=h*l;break;case 4:x=h*l,v=h*c,b=u*l,D=u*c;f[0]=l*d,f[4]=D-x*p,f[8]=b*p+v,f[1]=p,f[5]=h*d,f[9]=-u*d,f[2]=-c*d,f[6]=v*p+b,f[10]=x-D*p;break;case 5:P=l*d,w=l*p,T=c*d,A=c*p;f[0]=P-A*u,f[4]=-h*p,f[8]=T+w*u,f[1]=w+T*u,f[5]=h*d,f[9]=A-P*u,f[2]=-h*c,f[6]=u,f[10]=h*l;break;case 6:_=h*d,m=h*p,y=u*d,g=u*p;f[0]=l*d,f[4]=y*c-m,f[8]=_*c+g,f[1]=l*p,f[5]=g*c+_,f[9]=m*c-y,f[2]=-c,f[6]=u*l,f[10]=h*l}return f[3]=f[7]=f[11]=0,i||(f[12]=f[13]=f[14]=0,f[15]=1),this},T.prototype.fromScale=function(t,e){void 0===e&&(e=!1);var i=dou.recyclable(p.Vector3);e&&i.fromArray(this.rawData,12),this.identity();var r=this.rawData;return r[0]=t.x,r[5]=t.y,r[10]=t.z,e&&(r[12]=i.x,r[13]=i.y,r[14]=i.z),i.recycle(),this},T.prototype.fromRotationX=function(t){var e=Math.cos(t),i=Math.sin(t);return this.set(1,0,0,0,0,e,-i,0,0,i,e,0,0,0,0,1)},T.prototype.fromRotationY=function(t){var e=Math.cos(t),i=Math.sin(t);return this.set(e,0,i,0,0,1,0,0,-i,0,e,0,0,0,0,1)},T.prototype.fromRotationZ=function(t){var e=Math.cos(t),i=Math.sin(t);return this.set(e,-i,0,0,i,e,0,0,0,0,1,0,0,0,0,1)},T.prototype.fromAxis=function(t,e){var i=Math.cos(e),r=Math.sin(e),a=1-i,n=t.x,o=t.y,s=t.z,h=a*n,u=a*o;return this.set(h*n+i,h*o-r*s,h*s+r*o,0,h*o+r*s,u*o+i,u*s-r*n,0,h*s-r*o,u*s+r*n,a*s*s+i,0,0,0,0,1)},T.prototype.fromAxises=function(t,e,i){return this.set(t.x,e.x,i.x,0,t.y,e.y,i.y,0,t.z,e.z,i.z,0,0,0,0,1)},T.prototype.toArray=function(t,e){void 0===e&&(e=0),t=t||[];var i=this.rawData;if(0<e)for(var r=0;r<16;++r)t[r+e]=i[r];else for(r=0;r<16;++r)t[r]=i[r];return t},T.prototype.toEuler=function(t,e){void 0===t&&(t=3),e=e||new p.Vector3;var i=this.rawData,r=i[0],a=i[4],n=i[8],o=i[1],s=i[5],h=i[9],u=i[2],l=i[6],c=i[10];switch(t){case 1:e.y=Math.asin(p.MathUtil.clamp(n,-1,1)),Math.abs(n)<.999999?(e.x=Math.atan2(-h,c),e.z=Math.atan2(-a,r)):(e.x=Math.atan2(l,s),e.z=0);break;case 2:e.z=Math.asin(-p.MathUtil.clamp(a,-1,1)),Math.abs(a)<.999999?(e.x=Math.atan2(l,s),e.y=Math.atan2(n,r)):(e.x=Math.atan2(-h,c),e.y=0);break;case 3:e.x=Math.asin(-p.MathUtil.clamp(h,-1,1)),Math.abs(h)<.999999?(e.y=Math.atan2(n,c),e.z=Math.atan2(o,s)):(e.y=Math.atan2(-u,r),e.z=0);break;case 4:e.z=Math.asin(p.MathUtil.clamp(o,-1,1)),Math.abs(o)<.999999?(e.x=Math.atan2(-h,s),e.y=Math.atan2(-u,r)):(e.x=0,e.y=Math.atan2(n,c));break;case 5:e.x=Math.asin(p.MathUtil.clamp(l,-1,1)),Math.abs(l)<.999999?(e.y=Math.atan2(-u,c),e.z=Math.atan2(-a,s)):(e.y=0,e.z=Math.atan2(o,r));break;case 6:e.y=Math.asin(-p.MathUtil.clamp(u,-1,1)),Math.abs(u)<.999999?(e.x=Math.atan2(l,c),e.z=Math.atan2(o,r)):(e.x=0,e.z=Math.atan2(-a,s))}return e},T.prototype.copy=function(t){return this.fromArray(t.rawData)},T.prototype.clone=function(){var t=new T;return t.copy(this),t},T.prototype.identity=function(){var t=this.rawData;return t[0]=1,t[1]=t[2]=t[3]=0,t[4]=t[6]=t[7]=0,t[5]=1,t[8]=t[9]=t[11]=0,t[10]=1,t[12]=t[13]=t[14]=0,t[15]=1,this},T.prototype.onRecycle=function(){this.identity()},T.IDENTITY=new T,T}();p.Matrix4=t}(dou3d||(dou3d={})),function(t){var e=function(){function u(t,e,i,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===r&&(r=0),this.x=t,this.y=e,this.w=i,this.h=r}return u.prototype.set=function(t,e,i,r){return this.x=t,this.y=e,this.w=i,this.h=r,this},u.prototype.contains=function(t){var e=this.x,i=this.y,r=this.x+this.w,a=this.y+this.h;if(t instanceof u){var n=t.x,o=t.y,s=t.x+t.w,h=t.y+t.h;return e<=n&&s<=r&&i<=o&&h<=a}return t.x>e&&t.x<r&&t.y>i&&t.y<a},u.prototype.multiplyScalar=function(t,e){return e=e||this,this.x=t*e.x,this.y=t*e.y,this.w=t*e.w,this.h=t*e.h,this},u.prototype.copy=function(t){return this.set(t.x,t.y,t.w,t.h)},u.prototype.clone=function(){return new u(this.x,this.y,this.w,this.h)},u.prototype.clear=function(){return this.x=0,this.y=0,this.w=0,this.h=0,this},u.prototype.onRecycle=function(){this.clear()},u}();t.Rectangle=e}(dou3d||(dou3d={})),function(o){var t=function(){function t(t,e){void 0===e&&(e=0),this.normal=new o.Vector3,this.constant=0,this.normal.copy(t),this.constant=e}return t.prototype.set=function(t,e){return void 0===e&&(e=0),this.constant=e,this.normal.copy(t),this},t.prototype.getDistance=function(t){return this.normal.dot(t)+this.constant},t.prototype.normalize=function(t){var e=1/(t=t||this).normal.length;return this.constant=t.constant*e,this.normal.multiplyScalar(e,t.normal),this},t.prototype.negate=function(t){return t=t||this,this.constant=-t.constant,this.normal.negate(t.normal),this},t.prototype.getProjectionPoint=function(t,e){return(e=e||new o.Vector3).multiplyScalar(-this.getDistance(t),this.normal).add(t)},t.prototype.getCoplanarPoint=function(t){return(t=t||new o.Vector3).copy(this.normal).multiplyScalar(-this.constant)},t.prototype.applyMatrix=function(t,e){if(!e){var i=dou.recyclable(o.Matrix3);e=i.getNormalMatrix(t),i.recycle()}var r=dou.recyclable(o.Vector3),a=this.getCoplanarPoint(r).applyMatrix(t),n=this.normal.applyMatrix3(e).normalize();return this.constant=-a.dot(n),r.recycle(),this},t.prototype.raycast=function(t,e){var i=t.getDistanceToPlane(this);if(0<i){if(e){var r=e.normal;e.distance=i,t.getPointAt(i,e.position),r&&r.copy(this.normal)}return!0}return!1},t.prototype.fromArray=function(t,e){return void 0===e&&(e=0),this.normal.fromArray(t,e),this.constant=t[e+3],this},t.prototype.fromPoint=function(t,e){return void 0===e&&(e=o.Vector3.UP),this.constant=-e.dot(t),this.normal.copy(e),this},t.prototype.fromPoints=function(t,e,i){var r=dou.recyclable(o.Vector3),a=dou.recyclable(o.Vector3),n=r.subtract(i,e).cross(a.subtract(t,e)).normalize();return this.fromPoint(t,n),r.recycle(),a.recycle(),this},t.prototype.toArray=function(t,e){return void 0===e&&(e=0),t=t||[],this.normal.toArray(t,e),t[e+3]=this.constant,t},t.prototype.copy=function(t){return this.set(t.normal,t.constant)},t.prototype.clone=function(){return new t(this.normal,this.constant)},t.prototype.clear=function(){return this.normal.clear(),this.constant=0,this},t.prototype.onRecycle=function(){this.clear()},t.UP=new t(o.Vector3.UP,0),t.DOWN=new t(o.Vector3.DOWN,0),t.LEFT=new t(o.Vector3.BACK,0),t.RIGHT=new t(o.Vector3.BACK,0),t.FORWARD=new t(o.Vector3.FORWARD,0),t.BACK=new t(o.Vector3.BACK,0),t}();o.Plane=t}(dou3d||(dou3d={})),function(n){var t=function(){function t(t,e){this.origin=new n.Vector3,this.direction=new n.Vector3,this.origin.copy(t||new n.Vector3),this.direction.copy(e||new n.Vector3)}return t.prototype.set=function(t,e){return this.origin.copy(t),this.direction.copy(e),this},t.prototype.applyMatrix=function(t,e){return e=e||this,this.origin.applyMatrix(t,e.origin),this.direction.applyDirection(t,e.direction),this},t.prototype.getClosestPointToPoint=function(t,e){var i=(e=e||new n.Vector3)!=this.origin?this.origin:(new n.Vector3).copy(this.origin),r=this.direction,a=e.subtract(t,i).dot(r);return a<0?e.copy(i):e.copy(r).multiplyScalar(a).add(i)},t.prototype.getPointAt=function(t,e){var i=(e=e||new n.Vector3)!=this.origin?this.origin:(new n.Vector3).copy(this.origin);return e.multiplyScalar(t,this.direction).add(i)},t.prototype.getSquaredDistance=function(t){var e=dou.recyclable(n.Vector3),i=e.subtract(t,this.origin).dot(this.direction);if(i<0)return this.origin.getSquaredDistance(t);var r=this.getPointAt(i,e).getSquaredDistance(t);return e.recycle(),r},t.prototype.getDistance=function(t){return Math.sqrt(this.getSquaredDistance(t))},t.prototype.getDistanceToPlane=function(t){var e=this.origin,i=t.normal,r=i.dot(this.direction);if(0==r)return 0==t.getDistance(e)?0:-1;var a=-(e.dot(i)+t.constant)/r;return 0<=a?a:-1},t.prototype.fromArray=function(t,e){return void 0===e&&(e=0),this.origin.fromArray(t,e),this.direction.fromArray(t,e+3),this},t.prototype.fromPoints=function(t,e){return this.direction.subtract(e,this.origin.copy(t)).normalize(),this},t.prototype.copy=function(t){return this.set(t.origin,t.direction)},t.prototype.clone=function(){return new t(this.origin,this.direction)},t.prototype.clear=function(){return this.origin.clear(),this.direction.clear(),this},t.prototype.onRecycle=function(){this.clear()},t}();n.Ray=t}(dou3d||(dou3d={})),function(e){var t=function(){function t(){this.distance=-1,this.position=new e.Vector3,this.coord=new e.Vector2,this.normal=null}return t.prototype.copy=function(t){return this.distance=t.distance,this.position.copy(t.position),this.coord.copy(t.coord),this.normal&&t.normal&&this.normal.copy(t.normal),this},t.prototype.clear=function(){return this.distance=-1,this.position.set(0,0,0),this.coord.set(0,0),this.normal=null,this},t.prototype.onRecycle=function(){this.clear()},t}();e.RaycastInfo=t}(dou3d||(dou3d={})),function(t){var e=function(){function a(t,e,i,r){void 0===t&&(t=1),void 0===e&&(e=1),void 0===i&&(i=1),void 0===r&&(r=1),this.r=t,this.g=e,this.b=i,this.a=r}return a.lerp=function(t,e,i,r){return(r=r||new a).r=i*(e.r-t.r)+t.r,r.g=i*(e.g-t.g)+t.g,r.b=i*(e.b-t.b)+t.b,r.a=i*(e.a-t.a)+t.a,r},a.prototype.set=function(t,e,i,r){return this.r=t,this.g=e,this.b=i,isNaN(r)||(this.a=r),this},a.prototype.multiply=function(t,e){return e||(e=t),(t=this).r=t.r*e.r,this.g=t.g*e.g,this.b=t.b*e.b,this.a=t.a*e.a,this},a.prototype.scale=function(t,e){return e=e||this,this.r=e.r*t,this.g=e.g*t,this.b=e.b*t,this.a=e.a*t,this},a.prototype.fromArray=function(t,e){return void 0===e&&(e=0),this.r=t[0+e],this.g=t[1+e],this.b=t[2+e],this.a=t[3+e],this},a.prototype.fromHex=function(t){return this.r=(t>>16&255)/255,this.g=(t>>8&255)/255,this.b=(255&t)/255,this},a.prototype.copy=function(t){return this.set(t.r,t.g,t.b,t.a)},a.prototype.clone=function(){return new a(this.r,this.g,this.b,this.a)},a.prototype.clear=function(){return this.r=1,this.g=1,this.b=1,this.a=1,this},a.prototype.onRecycle=function(){this.clear()},a.ZERO=new a(0,0,0,0),a.BLACK=new a(0,0,0,1),a.GRAY=new a(.5,.5,.5,1),a.WHITE=new a(1,1,1,1),a.RED=new a(1,0,0,1),a.GREEN=new a(0,1,0,1),a.BLUE=new a(0,0,1,1),a.YELLOW=new a(1,1,0,1),a.INDIGO=new a(0,1,1,1),a.PURPLE=new a(1,0,1,1),a}();t.Color=e}(dou3d||(dou3d={})),function(e){var t=function(){function t(){this._alpha=1,this._matrix=new e.Matrix4}return Object.defineProperty(t.prototype,"matrix",{get:function(){return this._matrix},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"alpha",{get:function(){return this._alpha},set:function(t){this._alpha=t},enumerable:!0,configurable:!0}),t.prototype.setColor=function(t){var e=16711680&t;e>>=16;var i=65280&t;i>>=8;var r=255&t;e/=255,i/=255,r/=255,this.matrix.identity(),this.scale(e,i,r,this._alpha)},t.prototype.multiply=function(t){this.matrix.multiply(t.matrix),this.alpha*=t.alpha},t.prototype.scale=function(t,e,i,r){void 0===t&&(t=1),void 0===e&&(e=1),void 0===i&&(i=1),void 0===r&&(r=1);var a=this.matrix.rawData;a[0]=t,a[5]=e,a[10]=i,this.alpha*=r},t.prototype.offset=function(t,e,i,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===r&&(r=0);var a=this.matrix.rawData;a[12]+=t,a[13]+=e,a[14]+=i,this.alpha+=r},t.prototype.gray=function(){var t=this.matrix.rawData;t[0]=.2126,t[1]=.7152,t[2]=.0722,t[3]=1,t[4]=.2126,t[5]=.7152,t[6]=.0722,t[7]=1,t[8]=.2126,t[9]=.7152,t[10]=.0722,t[11]=1,t[12]=0,t[13]=0,t[14]=0,t[15]=1},t.prototype.clear=function(){this.matrix.identity(),this.alpha=1},t.prototype.onRecycle=function(){this.clear()},t}();e.ColorTransform=t}(dou3d||(dou3d={})),function(u){var t=function(){function h(t,e){this.beizerPoints=t,this.bezierPointNum=e}return h.createLinearBezier=function(t,e,i){i=2<i?i:3;var r=[],a=function(t,e,i){return(1-t)*e+t*i};r.push(t);for(var n=1;n<=i;n++)r.push(new u.Vector3(a(n/i,t.x,e.x),a(n/i,t.y,t.y),a(n/i,t.z,t.z)));return new h(r,i)},h.createQuadraticBezier=function(t,e,i,r){r=2<r?r:3;for(var a=[],n=function(t,e,i,r){return(1-t)*(1-t)*e+2*t*(1-t)*i+t*t*r},o=1;o<=r;o++)a.push(new u.Vector3(n(o/r,t.x,e.x,i.x),n(o/r,t.y,e.y,i.y),n(o/r,t.z,e.z,i.z)));return new h(a,r)},h.createCubicBezier=function(t,e,i,r,a){a=3<a?a:4;for(var n=[],o=function(t,e,i,r,a){return(1-t)*(1-t)*(1-t)*e+3*t*(1-t)*(1-t)*i+3*t*t*(1-t)*r+t*t*t*a},s=1;s<=a;s++)n.push(new u.Vector3(o(s/a,t.x,e.x,i.x,r.x),o(s/a,t.y,e.y,i.y,r.y),o(s/a,t.z,e.z,i.z,r.z)));return new h(n,a)},h}();u.Curve3=t}(dou3d||(dou3d={})),function(i){var t=function(e){function h(){var t=null!==e&&e.apply(this,arguments)||this;return t.drawType=i.Context3DProxy.gl.STATIC_DRAW,t._vertexFormat=0,t.vertexAttLength=0,t.faceOrBack=!1,t.subGeometrys=[],t._bufferDiry=!0,t._vertexCount=0,t._indexCount=0,t._totalIndexCount=0,t._faceCount=0,t}return __extends(h,e),Object.defineProperty(h.prototype,"bufferDiry",{get:function(){return this._bufferDiry},set:function(t){this._bufferDiry=t},enumerable:!0,configurable:!0}),Object.defineProperty(h.prototype,"vertexCount",{get:function(){return this._vertexCount},set:function(t){if(this._vertexCount!=t){var e=t*this.vertexAttLength,i=null;this.vertexArray?this.vertexCount<t?(i=new Float32Array(e)).set(this.vertexArray):i=this.vertexArray:i=new Float32Array(e),this.vertexArray=i,this._vertexCount=t}},enumerable:!0,configurable:!0}),Object.defineProperty(h.prototype,"indexCount",{get:function(){return this._indexCount},set:function(t){if(this._indexCount=t,this._faceCount=t/3,!(this._totalIndexCount>=t)){var e=new Uint16Array(t);this.indexArray&&e.set(this.indexArray),this.indexArray=e,this._totalIndexCount=t}},enumerable:!0,configurable:!0}),Object.defineProperty(h.prototype,"faceCount",{get:function(){return this._faceCount},set:function(t){this._faceCount!=t&&(this.indexCount=3*t,this._faceCount=t)},enumerable:!0,configurable:!0}),Object.defineProperty(h.prototype,"vertexFormat",{get:function(){return this._vertexFormat},set:function(t){this._vertexFormat=t,1&this.vertexFormat&&(this.vertexAttLength+=h.positionSize),2&this.vertexFormat&&(this.vertexAttLength+=h.normalSize),4&this.vertexFormat&&(this.vertexAttLength+=h.tangentSize),8&this.vertexFormat&&(this.vertexAttLength+=h.colorSize),16&this.vertexFormat&&(this.vertexAttLength+=h.uvSize),32&this.vertexFormat&&(this.vertexAttLength+=h.uv2Size),64&this.vertexFormat&&(this.vertexAttLength+=h.skinSize),this.vertexSizeInBytes=4*this.vertexAttLength},enumerable:!0,configurable:!0}),Object.defineProperty(h.prototype,"skeleton",{get:function(){return this._skeleton},set:function(t){if(t){this._skeleton=t,this.skeletonGPUData=new Float32Array(8*t.jointNum);for(var e=0;e<t.jointNum;++e)this.skeletonGPUData[8*e+3]=1,this.skeletonGPUData[8*e+7]=1}},enumerable:!0,configurable:!0}),h.prototype.getVertexForIndex=function(t,e,i,r){if(void 0===r&&(r=1),i=i||[],t<0||t>=this.vertexCount)return i;for(var a=0;a<r;++a){var n=0;if(1&e&&(1&this.vertexFormat?(i.push(this.vertexArray[t*this.vertexAttLength+n+0]),i.push(this.vertexArray[t*this.vertexAttLength+n+1]),i.push(this.vertexArray[t*this.vertexAttLength+n+2])):i.push(0,0,0)),1&this.vertexFormat&&(n+=h.positionSize),2&e&&(2&this.vertexFormat?(i.push(this.vertexArray[t*this.vertexAttLength+n+0]),i.push(this.vertexArray[t*this.vertexAttLength+n+1]),i.push(this.vertexArray[t*this.vertexAttLength+n+2])):i.push(0,0,0)),2&this.vertexFormat&&(n+=h.normalSize),4&e&&(4&this.vertexFormat?(i.push(this.vertexArray[t*this.vertexAttLength+n+0]),i.push(this.vertexArray[t*this.vertexAttLength+n+1]),i.push(this.vertexArray[t*this.vertexAttLength+n+2])):i.push(0,0,0)),4&this.vertexFormat&&(n+=h.tangentSize),8&e&&(8&this.vertexFormat?(i.push(this.vertexArray[t*this.vertexAttLength+n+0]),i.push(this.vertexArray[t*this.vertexAttLength+n+1]),i.push(this.vertexArray[t*this.vertexAttLength+n+2]),i.push(this.vertexArray[t*this.vertexAttLength+n+3])):i.push(0,0,0,0)),8&this.vertexFormat&&(n+=h.colorSize),16&e&&(16&this.vertexFormat?(i.push(this.vertexArray[t*this.vertexAttLength+n+0]),i.push(this.vertexArray[t*this.vertexAttLength+n+1])):i.push(0,0)),16&this.vertexFormat&&(n+=h.uvSize),32&e&&(32&this.vertexFormat?(i.push(this.vertexArray[t*this.vertexAttLength+n+0]),i.push(this.vertexArray[t*this.vertexAttLength+n+1])):i.push(0,0)),32&this.vertexFormat&&(n+=h.uv2Size),64&e)if(64&this.vertexFormat)for(var o=0;o<h.skinSize;++o)i.push(this.vertexArray[t*this.vertexAttLength+n+o]);else i.push(0,0,0,0,0,0,0,0);64&this.vertexFormat&&(n+=h.skinSize),t++}return i},h.prototype.setVerticesForIndex=function(t,e,i,r){void 0===r&&(r=1),t+r>this.vertexCount&&(this.vertexCount=t+r),this._bufferDiry=!0;for(var a=0,n=0,o=0;o<r;++o){if(a=0,1&this.vertexFormat&&(1&e&&(this.vertexArray[t*this.vertexAttLength+a+0]=i[n+0],this.vertexArray[t*this.vertexAttLength+a+1]=i[n+1],this.vertexArray[t*this.vertexAttLength+a+2]=i[n+2]),a+=h.positionSize),1&e&&(n+=h.positionSize),2&this.vertexFormat&&(2&e&&(this.vertexArray[t*this.vertexAttLength+a+0]=i[n+0],this.vertexArray[t*this.vertexAttLength+a+1]=i[n+1],this.vertexArray[t*this.vertexAttLength+a+2]=i[n+2]),a+=h.normalSize),2&e&&(n+=h.normalSize),4&this.vertexFormat&&(4&e&&(this.vertexArray[t*this.vertexAttLength+a+0]=i[n+0],this.vertexArray[t*this.vertexAttLength+a+1]=i[n+1],this.vertexArray[t*this.vertexAttLength+a+2]=i[n+2]),a+=h.tangentSize),4&e&&(n+=h.tangentSize),8&this.vertexFormat&&(8&e?(this.vertexArray[t*this.vertexAttLength+a+0]=i[n+0],this.vertexArray[t*this.vertexAttLength+a+1]=i[n+1],this.vertexArray[t*this.vertexAttLength+a+2]=i[n+2],this.vertexArray[t*this.vertexAttLength+a+3]=i[n+3]):(this.vertexArray[t*this.vertexAttLength+a+0]=1,this.vertexArray[t*this.vertexAttLength+a+1]=1,this.vertexArray[t*this.vertexAttLength+a+2]=1,this.vertexArray[t*this.vertexAttLength+a+3]=1),a+=h.colorSize),8&e&&(n+=h.colorSize),16&this.vertexFormat&&(16&e&&(this.vertexArray[t*this.vertexAttLength+a+0]=i[n+0],this.vertexArray[t*this.vertexAttLength+a+1]=i[n+1]),a+=h.uvSize),16&e&&(n+=h.uvSize),32&this.vertexFormat&&(32&e&&(this.vertexArray[t*this.vertexAttLength+a+0]=i[n+0],this.vertexArray[t*this.vertexAttLength+a+1]=i[n+1]),a+=h.uv2Size),32&e&&(n+=h.uv2Size),64&this.vertexFormat){if(64&e)for(var s=0;s<h.skinSize;++s)this.vertexArray[t*this.vertexAttLength+a+s]=i[n+s];a+=h.skinSize}64&e&&(n+=h.skinSize),t++}},h.prototype.getVertexIndices=function(t,e,i){if(void 0===e&&(e=-1),void 0===i&&(i=null),i=i||[],t>=this.indexCount)return i;-1==e&&(e=this.indexCount),t+e>this.indexCount&&(e=this.indexCount-t);for(var r=0;r<e;++r)i[r]=this.indexArray[r+t];return i},h.prototype.setVertexIndices=function(t,e){t+e.length>this.indexCount&&(this.indexCount=t+e.length);for(var i=0;i<e.length;++i)this.indexArray[t+i]=e[i]},h.prototype.activeState=function(t){this._bufferDiry&&(this._bufferDiry=!1,this.upload(t,this.drawType)),t.bindVertexBuffer(this.sharedVertexBuffer),t.bindIndexBuffer(this.sharedIndexBuffer)},h.prototype.upload=function(t,e){void 0===e&&(e=i.Context3DProxy.gl.STATIC_DRAW),this.sharedIndexBuffer||this.sharedVertexBuffer?(t.uploadVertexBuffer(this.sharedVertexBuffer),t.uploadIndexBuffer(this.sharedIndexBuffer)):(this.sharedIndexBuffer=t.createIndexBuffer(this.indexArray),this.sharedVertexBuffer=t.createVertexBuffer(this.vertexArray,e))},h.prototype.buildDefaultSubGeometry=function(){var t=new i.SubGeometry;t.matID=0,t.geometry=this,t.start=0,t.count=this.indexCount,this.subGeometrys.push(t)},h.prototype.dispose=function(){this.decRef(),this.canDispose&&(this.sharedIndexBuffer&&(this.sharedIndexBuffer.dispose(),this.sharedIndexBuffer=null),this.sharedVertexBuffer&&(this.sharedVertexBuffer.dispose(),this.sharedVertexBuffer=null),this.vertexArray=null,this.indexArray=null,this.subGeometrys=[])},h.positionSize=3,h.normalSize=3,h.tangentSize=3,h.colorSize=4,h.uvSize=2,h.uv2Size=2,h.skinSize=8,h}(i.Reference);i.Geometry=t}(dou3d||(dou3d={})),function(o){var t=function(){function t(){this._useVertexAttributeList={},this.start=0,this.count=0,this.matID=0,this.preAttList=[]}return t.prototype.activeState=function(t,e){t.attributeDiry&&this.upload(t,e),e.disableAllVertexAttribArray();for(var i=0;i<t.attributeList.length;i++){var r=t.attributeList[i];0<=r.uniformIndex&&e.vertexAttribPointer(r.uniformIndex,r.size,r.dataType,r.normalized,r.stride,r.offsetBytes)}},t.prototype.upload=function(t,e){t.attributeDiry=!1;var i=0;t.attributeList=[],1&this.geometry.vertexFormat&&(t.attribute_position&&(t.attribute_position.uniformIndex||(t.attribute_position.uniformIndex=e.getShaderAttribLocation(t.program3D,t.attribute_position.varName)),t.attribute_position.size=o.Geometry.positionSize,t.attribute_position.dataType=o.ContextConfig.FLOAT,t.attribute_position.normalized=!1,t.attribute_position.stride=this.geometry.vertexSizeInBytes,t.attribute_position.offsetBytes=i,t.attributeList.push(t.attribute_position),this._useVertexAttributeList[t.attribute_position.uniformIndex]=t.attribute_position.uniformIndex),i+=o.Geometry.positionSize*Float32Array.BYTES_PER_ELEMENT),2&this.geometry.vertexFormat&&(t.attribute_normal&&(t.attribute_normal.uniformIndex||(t.attribute_normal.uniformIndex=e.getShaderAttribLocation(t.program3D,t.attribute_normal.varName)),t.attribute_normal.size=o.Geometry.normalSize,t.attribute_normal.dataType=o.ContextConfig.FLOAT,t.attribute_normal.normalized=!1,t.attribute_normal.stride=this.geometry.vertexSizeInBytes,t.attribute_normal.offsetBytes=i,t.attributeList.push(t.attribute_normal),this._useVertexAttributeList[t.attribute_normal.uniformIndex]=t.attribute_normal.uniformIndex),i+=o.Geometry.normalSize*Float32Array.BYTES_PER_ELEMENT),4&this.geometry.vertexFormat&&(t.attribute_tangent&&(t.attribute_tangent.uniformIndex||(t.attribute_tangent.uniformIndex=e.getShaderAttribLocation(t.program3D,t.attribute_tangent.varName)),t.attribute_tangent.size=o.Geometry.tangentSize,t.attribute_tangent.dataType=o.ContextConfig.FLOAT,t.attribute_tangent.normalized=!1,t.attribute_tangent.stride=this.geometry.vertexSizeInBytes,t.attribute_tangent.offsetBytes=i,t.attributeList.push(t.attribute_tangent),this._useVertexAttributeList[t.attribute_tangent.uniformIndex]=t.attribute_tangent.uniformIndex),i+=o.Geometry.tangentSize*Float32Array.BYTES_PER_ELEMENT),8&this.geometry.vertexFormat&&(t.attribute_color&&(t.attribute_color.uniformIndex||(t.attribute_color.uniformIndex=e.getShaderAttribLocation(t.program3D,t.attribute_color.varName)),t.attribute_color.size=o.Geometry.colorSize,t.attribute_color.dataType=o.ContextConfig.FLOAT,t.attribute_color.normalized=!1,t.attribute_color.stride=this.geometry.vertexSizeInBytes,t.attribute_color.offsetBytes=i,t.attributeList.push(t.attribute_color),this._useVertexAttributeList[t.attribute_color.uniformIndex]=t.attribute_color.uniformIndex),i+=o.Geometry.colorSize*Float32Array.BYTES_PER_ELEMENT),16&this.geometry.vertexFormat&&(t.attribute_uv0&&(t.attribute_uv0.uniformIndex||(t.attribute_uv0.uniformIndex=e.getShaderAttribLocation(t.program3D,t.attribute_uv0.varName)),t.attribute_uv0.size=o.Geometry.uvSize,t.attribute_uv0.dataType=o.ContextConfig.FLOAT,t.attribute_uv0.normalized=!1,t.attribute_uv0.stride=this.geometry.vertexSizeInBytes,t.attribute_uv0.offsetBytes=i,t.attributeList.push(t.attribute_uv0),this._useVertexAttributeList[t.attribute_uv0.uniformIndex]=t.attribute_uv0.uniformIndex),i+=o.Geometry.uvSize*Float32Array.BYTES_PER_ELEMENT),32&this.geometry.vertexFormat&&(t.attribute_uv1&&(t.attribute_uv1.uniformIndex||(t.attribute_uv1.uniformIndex=e.getShaderAttribLocation(t.program3D,t.attribute_uv1.varName)),t.attribute_uv1.size=o.Geometry.uv2Size,t.attribute_uv1.dataType=o.ContextConfig.FLOAT,t.attribute_uv1.normalized=!1,t.attribute_uv1.stride=this.geometry.vertexSizeInBytes,t.attribute_uv1.offsetBytes=i,t.attributeList.push(t.attribute_uv1),this._useVertexAttributeList[t.attribute_uv1.uniformIndex]=t.attribute_uv1.uniformIndex),i+=o.Geometry.uv2Size*Float32Array.BYTES_PER_ELEMENT),64&this.geometry.vertexFormat&&(t.attribute_boneIndex&&(t.attribute_boneIndex.uniformIndex||(t.attribute_boneIndex.uniformIndex=e.getShaderAttribLocation(t.program3D,t.attribute_boneIndex.varName)),t.attribute_boneIndex.size=o.Geometry.skinSize/2,t.attribute_boneIndex.dataType=o.ContextConfig.FLOAT,t.attribute_boneIndex.normalized=!1,t.attribute_boneIndex.stride=this.geometry.vertexSizeInBytes,t.attribute_boneIndex.offsetBytes=i,t.attributeList.push(t.attribute_boneIndex),this._useVertexAttributeList[t.attribute_boneIndex.uniformIndex]=t.attribute_boneIndex.uniformIndex),i+=o.Geometry.skinSize/2*Float32Array.BYTES_PER_ELEMENT,t.attribute_boneWeight&&(t.attribute_boneWeight.uniformIndex||(t.attribute_boneWeight.uniformIndex=e.getShaderAttribLocation(t.program3D,t.attribute_boneWeight.varName)),t.attribute_boneWeight.size=o.Geometry.skinSize/2,t.attribute_boneWeight.dataType=o.ContextConfig.FLOAT,t.attribute_boneWeight.normalized=!1,t.attribute_boneWeight.stride=this.geometry.vertexSizeInBytes,t.attribute_boneWeight.offsetBytes=i,t.attributeList.push(t.attribute_boneWeight),this._useVertexAttributeList[t.attribute_boneWeight.uniformIndex]=t.attribute_boneWeight.uniformIndex),i+=o.Geometry.skinSize/2*Float32Array.BYTES_PER_ELEMENT);for(var r=0;r<this.preAttList.length;++r){var a=this.preAttList[r],n=t[a.name];n&&(n.uniformIndex||(n.uniformIndex=e.getShaderAttribLocation(t.program3D,n.varName),n.size=a.size,n.dataType=o.ContextConfig.FLOAT,n.normalized=!1,n.stride=this.geometry.vertexSizeInBytes,n.offsetBytes=i,t.attributeList.push(n),this._useVertexAttributeList[n.uniformIndex]=n.uniformIndex)),i+=a.size*Float32Array.BYTES_PER_ELEMENT}},t}();o.SubGeometry=t}(dou3d||(dou3d={})),function(t){var e=function(a){function t(t,e,i){void 0===t&&(t=80),void 0===e&&(e=80),void 0===i&&(i=80);var r=a.call(this)||this;return r._width=t,r._height=e,r._depth=i,r.buildGeomtry(!0),r}return __extends(t,a),Object.defineProperty(t.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"depth",{get:function(){return this._depth},enumerable:!0,configurable:!0}),t.prototype.buildGeomtry=function(t){this.vertexFormat=63,this.vertexCount=36,this.indexCount=36,this.vertexArray.set([.5*-this._width,.5*-this._height,.5*-this._depth,0,0,-10,1,0,0,1,1,1,1,1,0,0,0,.5*-this._width,.5*this._height,.5*-this._depth,0,0,-10,1,0,0,1,1,1,1,1,1,0,0,.5*this._width,.5*this._height,.5*-this._depth,0,0,-10,1,0,0,1,1,1,1,0,1,0,0,.5*this._width,.5*this._height,.5*-this._depth,0,0,-10,1,0,0,1,1,1,1,0,1,0,0,.5*this._width,.5*-this._height,.5*-this._depth,0,0,-10,1,0,0,1,1,1,1,0,0,0,0,.5*-this._width,.5*-this._height,.5*-this._depth,0,0,-10,1,0,0,1,1,1,1,1,0,0,0,.5*-this._width,.5*-this._height,.5*this._depth,0,0,10,1,0,0,1,1,1,1,0,0,0,0,.5*this._width,.5*-this._height,.5*this._depth,0,0,10,1,0,0,1,1,1,1,1,0,0,0,.5*this._width,.5*this._height,.5*this._depth,0,0,10,1,0,0,1,1,1,1,1,1,0,0,.5*this._width,.5*this._height,.5*this._depth,0,0,10,1,0,0,1,1,1,1,1,1,0,0,.5*-this._width,.5*this._height,.5*this._depth,0,0,10,1,0,0,1,1,1,1,0,1,0,0,.5*-this._width,.5*-this._height,.5*this._depth,0,0,10,1,0,0,1,1,1,1,0,0,0,0,.5*-this._width,.5*-this._height,.5*-this._depth,0,-10,0,1,0,0,1,1,1,1,0,0,0,0,.5*this._width,.5*-this._height,.5*-this._depth,0,-10,0,1,0,0,1,1,1,1,1,0,0,0,.5*this._width,.5*-this._height,.5*this._depth,0,-10,0,1,0,0,1,1,1,1,1,1,0,0,.5*this._width,.5*-this._height,.5*this._depth,0,-10,0,1,0,0,1,1,1,1,1,1,0,0,.5*-this._width,.5*-this._height,.5*this._depth,0,-10,0,1,0,0,1,1,1,1,0,1,0,0,.5*-this._width,.5*-this._height,.5*-this._depth,0,-10,0,1,0,0,1,1,1,1,0,0,0,0,.5*this._width,.5*-this._height,.5*-this._depth,10,0,0,1,0,0,1,1,1,1,0,0,0,0,.5*this._width,.5*this._height,.5*-this._depth,10,0,0,1,0,0,1,1,1,1,1,0,0,0,.5*this._width,.5*this._height,.5*this._depth,10,0,0,1,0,0,1,1,1,1,1,1,0,0,.5*this._width,.5*this._height,.5*this._depth,10,0,0,1,0,0,1,1,1,1,1,1,0,0,.5*this._width,.5*-this._height,.5*this._depth,10,0,0,1,0,0,1,1,1,1,0,1,0,0,.5*this._width,.5*-this._height,.5*-this._depth,10,0,0,1,0,0,1,1,1,1,0,0,0,0,.5*this._width,.5*this._height,.5*-this._depth,0,10,0,1,0,0,1,1,1,1,0,0,0,0,.5*-this._width,.5*this._height,.5*-this._depth,0,10,0,1,0,0,1,1,1,1,1,0,0,0,.5*-this._width,.5*this._height,.5*this._depth,0,10,0,1,0,0,1,1,1,1,1,1,0,0,.5*-this._width,.5*this._height,.5*this._depth,0,10,0,1,0,0,1,1,1,1,1,1,0,0,.5*this._width,.5*this._height,.5*this._depth,0,10,0,1,0,0,1,1,1,1,0,1,0,0,.5*this._width,.5*this._height,.5*-this._depth,0,10,0,1,0,0,1,1,1,1,0,0,0,0,.5*-this._width,.5*this._height,.5*-this._depth,-10,0,0,1,0,0,1,1,1,1,0,0,0,0,.5*-this._width,.5*-this._height,.5*-this._depth,-10,0,0,1,0,0,1,1,1,1,1,0,0,0,.5*-this._width,.5*-this._height,.5*this._depth,-10,0,0,1,0,0,1,1,1,1,1,1,0,0,.5*-this._width,.5*-this._height,.5*this._depth,-10,0,0,1,0,0,1,1,1,1,1,1,0,0,.5*-this._width,.5*this._height,.5*this._depth,-10,0,0,1,0,0,1,1,1,1,0,1,0,0,.5*-this._width,.5*this._height,.5*-this._depth,-10,0,0,1,0,0,1,1,1,1,0,0,0,0]),t?this.indexArray.set([0,2,1,3,5,4,6,8,7,9,11,10,12,14,13,15,17,16,18,20,19,21,23,22,24,26,25,27,29,28,30,32,31,33,35,34]):this.indexArray.set([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35]),this.buildDefaultSubGeometry()},t}(t.Geometry);t.CubeGeometry=e}(dou3d||(dou3d={})),function(c){var t=function(r){function t(t,e){void 0===t&&(t=100),void 0===e&&(e=200);var i=r.call(this)||this;return i._height=t,i._radius=e,i.buildGeomtry(),i}return __extends(t,r),Object.defineProperty(t.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"radius",{get:function(){return this._radius},enumerable:!0,configurable:!0}),t.prototype.buildGeomtry=function(){this.vertexFormat=63;var t=[],e=[],i=20,r=2*Math.PI/20;for(i=0;i<20;i++){var a=this._radius*Math.sin(i*r),n=this._radius*Math.cos(i*r);t.push(a,0+this._height/2,n,a,0,n,1,0,0,1,1,1,1,1,0,0,0,a,0-this._height/2,n,a,0,n,1,0,0,1,1,1,1,1,0,0,0)}var o=t.length/this.vertexAttLength,s=o;t.push(0,0-this._height/2,0,0,-1,0,1,0,0,1,1,1,1,1,0,0,0);var h=1+o;t.push(0,0+this._height/2,0,0,1,0,1,0,0,1,1,1,1,1,0,0,0);for(var u=0;u<o;u++)0!=(1&u)?e.push(u,o<=u+1?u+1-o:u+1,o<=u+2?u+2-o:u+2,s,u,o<=u+2?u+2-o:u+2):e.push(o<=u+1?u+1-o:u+1,u,o<=u+2?u+2-o:u+2,u,h,o<=u+2?u+2-o:u+2);this.setVerticesForIndex(0,this.vertexFormat,t,t.length/this.vertexAttLength),this.setVertexIndices(0,e);var l=new c.SubGeometry;l.geometry=this,l.start=0,l.count=this.indexCount,this.subGeometrys.push(l)},t}(c.Geometry);c.CylinderGeometry=t}(dou3d||(dou3d={})),function(c){var t=function(u){function t(t,e,i,r,a,n,o,s){void 0===t&&(t=500),void 0===e&&(e=500),void 0===i&&(i=1),void 0===r&&(r=1),void 0===a&&(a=1),void 0===n&&(n=1),void 0===o&&(o=!0),void 0===s&&(s=!0);var h=u.call(this)||this;return h._width=t,h._height=e,h._segmentsW=i,h._segmentsH=r,h._scaleU=a,h._scaleV=n,h._wCenter=o,h._hCenter=s,h.buildGeometry(),h}return __extends(t,u),Object.defineProperty(t.prototype,"segmentsW",{get:function(){return this._segmentsW},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"segmentsH",{get:function(){return this._segmentsH},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"scaleU",{get:function(){return this._scaleU},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"scaleV",{get:function(){return this._scaleV},enumerable:!0,configurable:!0}),t.prototype.buildGeometry=function(){var t,e,i,r;this.vertexFormat=31;var a=this._segmentsW+1,n=(this._segmentsH+1)*a,o=this.vertexAttLength-15;i=this._segmentsH*this._segmentsW*6,this.vertexCount=n,this.indexCount=i;for(var s=i=0,h=0;h<=this._segmentsH;++h)for(var u=0;u<=this._segmentsW;++u)if(t=(u/this._segmentsW-.5)*this._width,e=(h/this._segmentsH-.5)*this._height,0==this._wCenter&&(t+=this._width/2),0==this._hCenter&&(e+=this._height/2),this.vertexArray[s++]=t,this.vertexArray[s++]=0,this.vertexArray[s++]=e,this.vertexArray[s++]=0,this.vertexArray[s++]=1,this.vertexArray[s++]=0,this.vertexArray[s++]=1,this.vertexArray[s++]=0,this.vertexArray[s++]=0,this.vertexArray[s++]=1,this.vertexArray[s++]=1,this.vertexArray[s++]=1,this.vertexArray[s++]=1,this.vertexArray[s++]=u/this._segmentsW*this._scaleU,this.vertexArray[s++]=(1-h/this._segmentsH)*this._scaleV,s+=o,u!=this._segmentsW&&h!=this._segmentsH){r=u+h*a;this.indexArray[i++]=1*r,this.indexArray[i++]=1*(r+a+1),this.indexArray[i++]=1*(r+a),this.indexArray[i++]=1*r,this.indexArray[i++]=1*(r+1),this.indexArray[i++]=1*(r+a+1)}var l=new c.SubGeometry;l.geometry=this,l.start=0,l.count=this.indexCount,this.subGeometrys.push(l)},t}(c.Geometry);c.PlaneGeometry=t}(dou3d||(dou3d={})),function(A){var t=function(a){function t(t,e,i){void 0===t&&(t=100),void 0===e&&(e=15),void 0===i&&(i=15);var r=a.call(this)||this;return r._radius=t,r._segmentsW=e,r._segmentsH=i,r.buildSphere(!0),r}return __extends(t,a),Object.defineProperty(t.prototype,"segmentsW",{get:function(){return this._segmentsW},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"segmentsH",{get:function(){return this._segmentsH},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"radius",{get:function(){return this._radius},enumerable:!0,configurable:!0}),t.prototype.buildSphere=function(t){void 0===t&&(t=!0),this.vertexFormat=63;var e=0,i=0,r=0,a=(this._segmentsH+1)*(this._segmentsW+1),n=this.vertexAttLength,o=n-9;this.vertexCount=a,this.indexCount=(this._segmentsH-1)*this._segmentsW*6;var s=0,h=0,u=0,l=0,c=0,d=0;for(i=0;i<=this._segmentsH;++i){s=h;var p=Math.PI*i/this._segmentsH,f=-this._radius*Math.cos(p),_=this._radius*Math.sin(p);for(e=0;e<=this._segmentsW;++e){var m=2*Math.PI*e/this._segmentsW,y=_*Math.cos(m),g=_*Math.sin(m),x=1/Math.sqrt(y*y+g*g+f*f),v=Math.sqrt(g*g+y*y);if(c=0,d=.007<v?y/v:0,u=-f,l=g,e==this._segmentsW?(this.vertexArray[h++]=this.vertexArray[s],this.vertexArray[h++]=this.vertexArray[s+1],this.vertexArray[h++]=this.vertexArray[s+2],this.vertexArray[h++]=y*x,this.vertexArray[h++]=u*x,this.vertexArray[h++]=l*x,this.vertexArray[h++]=.007<v?-g/v:1,this.vertexArray[h++]=c,this.vertexArray[h++]=d,this.vertexArray[h+0]=1):(this.vertexArray[h++]=y,this.vertexArray[h++]=u,this.vertexArray[h++]=l,this.vertexArray[h++]=y*x,this.vertexArray[h++]=u*x,this.vertexArray[h++]=l*x,this.vertexArray[h++]=.007<v?-g/v:1,this.vertexArray[h++]=c,this.vertexArray[h++]=d,this.vertexArray[h]=1),this.vertexArray[h+1]=1,this.vertexArray[h+2]=1,this.vertexArray[h+3]=1,0<e&&0<i){var b=(this._segmentsW+1)*i+e,D=(this._segmentsW+1)*i+e-1,P=(this._segmentsW+1)*(i-1)+e-1,w=(this._segmentsW+1)*(i-1)+e;i==this._segmentsH?(this.vertexArray[h-9]=this.vertexArray[s],this.vertexArray[h-8]=this.vertexArray[s+1],this.vertexArray[h-7]=this.vertexArray[s+2],t?(this.indexArray[r++]=b,this.indexArray[r++]=w,this.indexArray[r++]=P):(this.indexArray[r++]=b,this.indexArray[r++]=P,this.indexArray[r++]=w)):1==i?t?(this.indexArray[r++]=b,this.indexArray[r++]=P,this.indexArray[r++]=D):(this.indexArray[r++]=b,this.indexArray[r++]=D,this.indexArray[r++]=P):t?(this.indexArray[r++]=b,this.indexArray[r++]=w,this.indexArray[r++]=P,this.indexArray[r++]=b,this.indexArray[r++]=P,this.indexArray[r++]=D):(this.indexArray[r++]=b,this.indexArray[r++]=P,this.indexArray[r++]=w,this.indexArray[r++]=b,this.indexArray[r++]=D,this.indexArray[r++]=P)}h+=o}}n=17;this._segmentsH,this._segmentsW;for(o=n-2,h=13,i=0;i<=this._segmentsH;++i)for(e=0;e<=this._segmentsW;++e)this.vertexArray[h++]=e/this._segmentsW,this.vertexArray[h++]=i/this._segmentsH,h+=o;var T=new A.SubGeometry;T.geometry=this,T.start=0,T.count=this.indexCount,this.subGeometrys.push(T)},t}(A.Geometry);A.SphereGeometry=t}(dou3d||(dou3d={})),function(f){var t=function(){function t(){this.vertexAttLength=17,this.vertLen=0,this.faces=0,this.source_indexData=[],this.source_vertexData=[],this.source_vertexColorData=[],this.source_normalData=[],this.source_tangtData=[],this.source_uvData=[],this.source_uv2Data=[],this.source_skinData=[],this.vertexIndex=0,this.indices=[],this.vertices=[],this.normals=[],this.tangts=[],this.verticesColor=[],this.uvs=[],this.uv2s=[],this.skinMesh=[],this.faceNormals=[],this.faceWeights=[],this.vertexIndices=[],this.uvIndices=[],this.uv2Indices=[],this.normalIndices=[],this.colorIndices=[],this.indexIds=[],this.matCount=0,this.material={}}return t.buildGeomtry=function(t,e){var i=new f.Geometry;i.vertexFormat=e,i.vertexCount=3*t.faces,i.indexCount=3*t.faces,i.faceCount=t.faces,i.skeleton=t.skeleton;for(var r=new f.Vector3,a=new f.Vector3(1,1,1),n=new f.Vector4(1,1,1,1),o={u:1,v:0},s={u:1,v:0},h=0,u=0,l=0,c=0;c<t.faces;c++){i.indexArray[3*c+0]=3*c+0,i.indexArray[3*c+1]=3*c+2,i.indexArray[3*c+2]=3*c+1;for(var d=0;d<3;d++)u=3*c+d,u*=i.vertexAttLength,l=0,h=t.vertexIndices[3*c+d]*f.Geometry.positionSize,1&e&&(r.x=t.source_vertexData[h+0],r.y=t.source_vertexData[h+1],r.z=t.source_vertexData[h+2],i.vertexArray[u+l+0]=r.x,i.vertexArray[u+l+1]=r.y,i.vertexArray[u+l+2]=r.z,l+=f.Geometry.positionSize),2&e&&(t.normalIndices&&t.source_normalData&&0<t.source_normalData.length&&(h=t.normalIndices[3*c+d]*f.Geometry.normalSize,a.x=t.source_normalData[h+0],a.y=t.source_normalData[h+1],a.z=t.source_normalData[h+2]),i.vertexArray[u+l+0]=a.x,i.vertexArray[u+l+1]=a.y,i.vertexArray[u+l+2]=a.z,l+=f.Geometry.normalSize),4&e&&(i.vertexArray[u+l+0]=0,i.vertexArray[u+l+1]=0,i.vertexArray[u+l+2]=0,l+=f.Geometry.tangentSize),8&e&&(t.colorIndices&&t.source_vertexColorData&&0<t.source_vertexColorData.length&&(h=t.colorIndices[3*c+d]*f.Geometry.colorSize,n.x=t.source_vertexColorData[h+0],n.y=t.source_vertexColorData[h+1],n.z=t.source_vertexColorData[h+2],n.w=t.source_vertexColorData[h+3]),i.vertexArray[u+l+0]=n.x,i.vertexArray[u+l+1]=n.y,i.vertexArray[u+l+2]=n.z,i.vertexArray[u+l+3]=n.w,l+=f.Geometry.colorSize),16&e&&(t.uvIndices&&t.source_uvData&&0<t.source_uvData.length&&(h=t.uvIndices[3*c+d]*f.Geometry.uvSize,o.u=t.source_uvData[h+0],o.v=t.source_uvData[h+1]),i.vertexArray[u+l+0]=o.u,i.vertexArray[u+l+1]=o.v,l+=f.Geometry.uvSize),32&e&&(t.uv2Indices&&t.source_uv2Data&&0<t.source_uv2Data.length&&(h=t.uv2Indices[3*c+d]*f.Geometry.uv2Size,s.u=t.source_uv2Data[h+0],s.v=t.source_uv2Data[h+1]),i.vertexArray[u+l+0]=s.u,i.vertexArray[u+l+1]=s.v,l+=f.Geometry.uv2Size),64&e&&(t.source_skinData&&0<t.source_skinData.length?(h=t.vertexIndices[3*c+d]*f.Geometry.skinSize,i.vertexArray[u+l+0]=t.source_skinData[h+0],i.vertexArray[u+l+1]=t.source_skinData[h+2],i.vertexArray[u+l+2]=t.source_skinData[h+4],i.vertexArray[u+l+3]=t.source_skinData[h+6],i.vertexArray[u+l+4]=t.source_skinData[h+1],i.vertexArray[u+l+5]=t.source_skinData[h+3],i.vertexArray[u+l+6]=t.source_skinData[h+5],i.vertexArray[u+l+7]=t.source_skinData[h+7]):(i.vertexArray[u+l+0]=0,i.vertexArray[u+l+1]=0,i.vertexArray[u+l+2]=0,i.vertexArray[u+l+3]=0,i.vertexArray[u+l+4]=0,i.vertexArray[u+l+5]=0,i.vertexArray[u+l+6]=0,i.vertexArray[u+l+7]=0))}for(d=0;d<t.matCount;++d){var p=new f.SubGeometry;p.matID=d,p.geometry=i,p.start=3*t.material[d].start*Uint16Array.BYTES_PER_ELEMENT,p.count=3*t.material[d].count,p.textureDiffuse=t.material[d].textureDiffuse,p.textureNormal=t.material[d].textureNormal,p.textureSpecular=t.material[d].textureSpecular,i.subGeometrys.push(p)}return i},t}();f.GeometryCreator=t}(dou3d||(dou3d={})),function(i){var t=function(e){function t(){var t=e.call(this)||this;return t._ambientColor=0,t._diffuseColor=16777215,t._specularColor=16777215,t._intensity=1,t._halfIntensity=0,t._change=!0,t._ambient=new i.Vector4(0,0,0),t._diffuse=new i.Vector4(1,1,1),t._specular=new i.Vector4(1,1,1),t}return __extends(t,e),Object.defineProperty(t.prototype,"lightType",{get:function(){return this._lightType},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"intensity",{get:function(){return this._intensity},set:function(t){this._intensity!=t&&(this._intensity=t,this._change=!1)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"halfIntensity",{get:function(){return this._halfIntensity},set:function(t){this._halfIntensity!=t&&(this._halfIntensity=t,this._change=!1)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"ambient",{get:function(){return this._ambientColor},set:function(t){this._ambientColor=t,this._ambient.w=(t>>24&255)/255,this._ambient.x=(t>>16&255)/255,this._ambient.y=(t>>8&255)/255,this._ambient.z=(255&t)/255,this._change=!1},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"diffuse",{get:function(){return this._diffuseColor},set:function(t){this._diffuseColor=t,this._diffuse.w=(t>>24&255)/255,this._diffuse.x=(t>>16&255)/255,this._diffuse.y=(t>>8&255)/255,this._diffuse.z=(255&t)/255,this._change=!1},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"specular",{get:function(){return this._specularColor},set:function(t){this._specularColor=t,this._specular.w=(t>>24&255)/255,this._specular.x=(t>>16&255)/255,this._specular.y=(t>>8&255)/255,this._specular.z=(255&t)/255,this._change=!1},enumerable:!0,configurable:!0}),t}(i.ObjectContainer3D);i.LightBase=t}(dou3d||(dou3d={})),function(a){var t=function(i){function r(t){var e=i.call(this)||this;return e._lightType=1,e._direction=new a.Vector3(0,0,1),e.direction=t,e}return __extends(r,i),Object.defineProperty(r.prototype,"direction",{get:function(){return this.validateTransformNow(),this._direction},set:function(t){this._direction.copy(t),this._direction.normalize();var e=dou.recyclable(a.Quaternion);e.fromVectors(a.Vector3.ZERO,this._direction),(this.orientation=e).recycle()},enumerable:!0,configurable:!0}),r.prototype.onTransformUpdate=function(){i.prototype.onTransformUpdate.call(this),this.orientation.transformVector(a.Vector3.UP,this._direction),this._direction.normalize(),this.parent&&(this.parent.globalOrientation.transformVector(this._direction,this._direction),this._direction.normalize())},r.prototype.updateLightData=function(t,e,i){i[e*r.stride+0]=this._direction.x,i[e*r.stride+1]=this._direction.y,i[e*r.stride+2]=this._direction.z,i[e*r.stride+3]=this._diffuse.x*this._intensity,i[e*r.stride+4]=this._diffuse.y*this._intensity,i[e*r.stride+5]=this._diffuse.z*this._intensity,i[e*r.stride+6]=this._ambient.x,i[e*r.stride+7]=this._ambient.y,i[e*r.stride+8]=this._ambient.z},r.stride=9,r}(a.LightBase);a.DirectLight=t}(dou3d||(dou3d={})),function(t){var e=function(i){function r(t){var e=i.call(this)||this;return e._radius=100,e._cutoff=.01,e._lightType=0,e.diffuse=t,e}return __extends(r,i),Object.defineProperty(r.prototype,"radius",{get:function(){return this._radius},set:function(t){this._radius=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"cutoff",{get:function(){return this._cutoff},set:function(t){this._cutoff=t},enumerable:!0,configurable:!0}),r.prototype.updateLightData=function(t,e,i){i[e*r.stride]=this.globalPosition.x,i[e*r.stride+1]=this.globalPosition.y,i[e*r.stride+2]=this.globalPosition.z,i[e*r.stride+3]=this._diffuse.x*this._intensity,i[e*r.stride+4]=this._diffuse.y*this._intensity,i[e*r.stride+5]=this._diffuse.z*this._intensity,i[e*r.stride+6]=this._ambient.x,i[e*r.stride+7]=this._ambient.y,i[e*r.stride+8]=this._ambient.z,i[e*r.stride+9]=this._intensity,i[e*r.stride+10]=this._radius,i[e*r.stride+11]=this._cutoff},r.stride=12,r}(t.LightBase);t.PointLight=e}(dou3d||(dou3d={})),function(a){var t=function(i){function r(t){var e=i.call(this)||this;return e._spotExponent=1.1,e._spotCosCutoff=.1,e._constantAttenuation=.1,e._linearAttenuation=.1,e._quadraticAttenuation=.1,e._lightType=2,e.diffuse=t,e}return __extends(r,i),Object.defineProperty(r.prototype,"spotCosCutoff",{get:function(){return this._spotCosCutoff},set:function(t){this._spotCosCutoff=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"spotExponent",{get:function(){return this._spotExponent},set:function(t){this._spotExponent=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"constantAttenuation",{get:function(){return this._constantAttenuation},set:function(t){this._constantAttenuation=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"linearAttenuation",{get:function(){return this._linearAttenuation},set:function(t){this._linearAttenuation=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"quadraticAttenuation",{get:function(){return this._quadraticAttenuation},set:function(t){this._quadraticAttenuation=t},enumerable:!0,configurable:!0}),r.prototype.updateLightData=function(t,e,i){i[e*r.stride]=this.globalPosition.x,i[e*r.stride+1]=this.globalPosition.y,i[e*r.stride+2]=this.globalPosition.z,i[e*r.stride+3]=this.globalRotation.x*a.MathUtil.DEG_RAD,i[e*r.stride+4]=this.globalRotation.y*a.MathUtil.DEG_RAD,i[e*r.stride+5]=this.globalRotation.z*a.MathUtil.DEG_RAD,i[e*r.stride+6]=this._diffuse.x,i[e*r.stride+7]=this._diffuse.y,i[e*r.stride+8]=this._diffuse.z,i[e*r.stride+9]=this._spotExponent,i[e*r.stride+10]=this._spotCosCutoff,i[e*r.stride+11]=this._constantAttenuation,i[e*r.stride+12]=this._linearAttenuation,i[e*r.stride+13]=this._quadraticAttenuation},r.stride=14,r}(a.LightBase);a.SpotLight=t}(dou3d||(dou3d={})),function(t){var e=function(){function t(){this._lightNum=0,this._directList=[],this._spotList=[],this._pointList=[]}return Object.defineProperty(t.prototype,"lightNum",{get:function(){return this._lightNum},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"directList",{get:function(){return this._directList},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"spotList",{get:function(){return this._spotList},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"pointList",{get:function(){return this._pointList},enumerable:!0,configurable:!0}),t.prototype.addLight=function(t){switch(t.lightType){case 1:this._directList.push(t),this._lightNum++;break;case 0:this._pointList.push(t),this._lightNum++;break;case 2:this._spotList.push(t),this._lightNum++}},t.prototype.removeLight=function(t){switch(t.lightType){case 1:0<=(e=this._directList.indexOf(t))&&e<this._directList.length&&(this._directList.splice(e,1),this._lightNum--);break;case 0:0<=(e=this._pointList.indexOf(t))&&e<this._pointList.length&&(this._pointList.splice(e,1),this._lightNum--);break;case 2:var e;0<=(e=this._spotList.indexOf(t))&&e<this._spotList.length&&(this._spotList.splice(e,1),this._lightNum--)}},t}();t.LightGroup=e}(dou3d||(dou3d={})),function(e){var t=function(){function t(){}return t.prototype.load=function(t,e,i){var r=this,a=new dou.ImageLoader;a.crossOrigin=!0,a.on(dou.Event.COMPLETE,function(){e.call(i,t,r.createTexture(a.data))}),a.on(dou.IOErrorEvent.IO_ERROR,function(){e.call(i,t)}),a.load(t)},t.prototype.createTexture=function(t){return new e.ImageTexture(t)},t.prototype.release=function(t){return!!t&&(t.dispose(),!0)},t}();e.TextureAnalyzer=t}(dou3d||(dou3d={})),function(m){var t=function(){function t(){}return t.prototype.load=function(e,i,r){var a=this,n=new dou.HttpRequest;n.responseType=dou.HttpResponseType.arraybuffer,n.on(dou.Event.COMPLETE,function(t){i.call(r,e,a.createGeometry(n.response))},this),n.on(dou.IOErrorEvent.IO_ERROR,function(t){i.call(r,e)},this),n.open(e,dou.HttpMethod.GET),n.send()},t.prototype.createGeometry=function(t){var e=new dou.ByteArray(t);e.position=3;var i=e.readUnsignedInt(),r=new m.GeometryCreator;switch(i){case 1:this.parseVersion_1(e,r);break;case 2:this.parseVersion_2(e,r);break;case 3:this.parseVersion_3(e,r);break;default:return console.error("ESM version error : "+i),null}var a=0;return a=0<r.source_skinData.length?95:63,m.GeometryCreator.buildGeomtry(r,a)},t.prototype.parseVersion_1=function(t,e){var i=t.readInt();e.matCount=t.readInt();for(var r=0;r<e.matCount;++r)e.material[r]={},e.material[r].matID=t.readInt(),e.material[r].start=t.readInt(),e.material[r].count=t.readInt(),e.material[r].textureDiffuse=t.readUTF(),e.material[r].textureNormal=t.readUTF(),e.material[r].textureSpecular=t.readUTF();if(1&i){var a=t.readInt();for(r=0;r<a;r++)e.source_vertexData.push(t.readFloat()),e.source_vertexData.push(t.readFloat()),e.source_vertexData.push(t.readFloat())}if(2&i){var n=t.readInt();for(r=0;r<n;r++)e.source_normalData.push(t.readFloat()),e.source_normalData.push(t.readFloat()),e.source_normalData.push(t.readFloat())}if(8&i){var o=t.readInt();for(r=0;r<o;r++)e.source_vertexColorData.push(t.readFloat()),e.source_vertexColorData.push(t.readFloat()),e.source_vertexColorData.push(t.readFloat()),e.source_vertexColorData.push(t.readFloat())}if(16&i){var s=t.readInt();for(r=0;r<s;r++)e.source_uvData.push(t.readFloat()),e.source_uvData.push(t.readFloat())}if(32&i)for(s=t.readInt(),r=0;r<s;r++)e.source_uv2Data.push(t.readFloat()),e.source_uv2Data.push(t.readFloat());e.faces=t.readInt();for(r=0;r<e.faces;r++)e.vertexIndices.push(t.readUnsignedInt()),e.vertexIndices.push(t.readUnsignedInt()),e.vertexIndices.push(t.readUnsignedInt()),2&i&&(e.normalIndices.push(t.readUnsignedInt()),e.normalIndices.push(t.readUnsignedInt()),e.normalIndices.push(t.readUnsignedInt())),8&i&&(e.colorIndices.push(t.readUnsignedInt()),e.colorIndices.push(t.readUnsignedInt()),e.colorIndices.push(t.readUnsignedInt())),16&i&&(e.uvIndices.push(t.readUnsignedInt()),e.uvIndices.push(t.readUnsignedInt()),e.uvIndices.push(t.readUnsignedInt())),32&i&&(e.uv2Indices.push(t.readUnsignedInt()),e.uv2Indices.push(t.readUnsignedInt()),e.uv2Indices.push(t.readUnsignedInt()));var h=t.readUnsignedByte();0<h&&(e.skeleton=new m.Skeleton);var u=new m.Vector3,l=new m.Vector3,c=new m.Vector3;for(r=0;r<h;++r){var d=new m.Joint(null);t.readInt(),d.parentIndex=t.readInt(),d.name=t.readUTF(),u.x=t.readFloat()*m.MathUtil.RAD_DEG,u.y=t.readFloat()*m.MathUtil.RAD_DEG,u.z=t.readFloat()*m.MathUtil.RAD_DEG,l.x=t.readFloat(),l.y=t.readFloat(),l.z=t.readFloat(),c.x=t.readFloat(),c.y=t.readFloat(),c.z=t.readFloat(),d.buildInverseMatrix(l,u,c),e.skeleton.joints.push(d)}var p=t.readInt();for(r=0;r<p;r++){for(var f=t.readUnsignedByte(),_=0;_<f;_++)e.source_skinData.push(t.readUnsignedByte()),e.source_skinData.push(t.readFloat());for(_=f;_<4;_++)e.source_skinData.push(0),e.source_skinData.push(0)}},t.prototype.parseVersion_2=function(t,e){var i=t.readInt();e.matCount=t.readInt();for(var r=0;r<e.matCount;++r)e.material[r]={},e.material[r].matID=t.readInt(),e.material[r].start=t.readInt(),e.material[r].count=t.readInt(),e.material[r].textureDiffuse=t.readUTF(),e.material[r].textureNormal=t.readUTF(),e.material[r].textureSpecular=t.readUTF();if(1&i){var a=t.readInt();for(r=0;r<a;r++)e.source_vertexData.push(t.readFloat()),e.source_vertexData.push(t.readFloat()),e.source_vertexData.push(t.readFloat())}if(2&i){var n=t.readInt();for(r=0;r<n;r++)e.source_normalData.push(t.readFloat()),e.source_normalData.push(t.readFloat()),e.source_normalData.push(t.readFloat())}if(8&i){var o=t.readInt();for(r=0;r<o;r++)e.source_vertexColorData.push(t.readUnsignedByte()/255),e.source_vertexColorData.push(t.readUnsignedByte()/255),e.source_vertexColorData.push(t.readUnsignedByte()/255),e.source_vertexColorData.push(t.readUnsignedByte()/255)}if(16&i){var s=t.readInt();for(r=0;r<s;r++)e.source_uvData.push(t.readFloat()),e.source_uvData.push(t.readFloat())}if(32&i)for(s=t.readInt(),r=0;r<s;r++)e.source_uv2Data.push(t.readFloat()),e.source_uv2Data.push(t.readFloat());e.faces=t.readInt();for(r=0;r<e.faces;r++)e.vertexIndices.push(t.readUnsignedShort()),e.vertexIndices.push(t.readUnsignedShort()),e.vertexIndices.push(t.readUnsignedShort()),2&i&&(e.normalIndices.push(t.readUnsignedShort()),e.normalIndices.push(t.readUnsignedShort()),e.normalIndices.push(t.readUnsignedShort())),8&i&&(e.colorIndices.push(t.readUnsignedShort()),e.colorIndices.push(t.readUnsignedShort()),e.colorIndices.push(t.readUnsignedShort())),16&i&&(e.uvIndices.push(t.readUnsignedShort()),e.uvIndices.push(t.readUnsignedShort()),e.uvIndices.push(t.readUnsignedShort())),32&i&&(e.uv2Indices.push(t.readUnsignedShort()),e.uv2Indices.push(t.readUnsignedShort()),e.uv2Indices.push(t.readUnsignedShort()));var h=t.readUnsignedByte();0<h&&(e.skeleton=new m.Skeleton);var u=new m.Vector3,l=new m.Vector3,c=new m.Vector3;for(r=0;r<h;++r){var d=new m.Joint(null);t.readInt(),d.parentIndex=t.readInt(),d.name=t.readUTF(),u.x=t.readFloat()*m.MathUtil.RAD_DEG,u.y=t.readFloat()*m.MathUtil.RAD_DEG,u.z=t.readFloat()*m.MathUtil.RAD_DEG,l.x=t.readFloat(),l.y=t.readFloat(),l.z=t.readFloat(),c.x=t.readFloat(),c.y=t.readFloat(),c.z=t.readFloat(),d.buildInverseMatrix(l,u,c),e.skeleton.joints.push(d)}var p=t.readInt();for(r=0;r<p;r++){for(var f=t.readUnsignedByte(),_=0;_<f;_++)e.source_skinData.push(t.readUnsignedByte()),e.source_skinData.push(t.readFloat());for(_=f;_<4;_++)e.source_skinData.push(0),e.source_skinData.push(0)}},t.prototype.parseVersion_3=function(t,e){var i=t.readInt();e.matCount=t.readInt();for(var r=0;r<e.matCount;++r)e.material[r]={},e.material[r].matID=t.readInt(),e.material[r].start=t.readInt(),e.material[r].count=t.readInt(),e.material[r].textureDiffuse=t.readUTF(),e.material[r].textureNormal=t.readUTF(),e.material[r].textureSpecular=t.readUTF();if(1&i){var a=t.readInt();for(r=0;r<a;r++)e.source_vertexData.push(t.readFloat()),e.source_vertexData.push(t.readFloat()),e.source_vertexData.push(t.readFloat())}if(2&i){var n=t.readInt();for(r=0;r<n;r++)e.source_normalData.push(t.readFloat()),e.source_normalData.push(t.readFloat()),e.source_normalData.push(t.readFloat())}if(8&i){var o=t.readInt();for(r=0;r<o;r++)e.source_vertexColorData.push(t.readUnsignedByte()/255),e.source_vertexColorData.push(t.readUnsignedByte()/255),e.source_vertexColorData.push(t.readUnsignedByte()/255),e.source_vertexColorData.push(t.readUnsignedByte()/255)}if(16&i){var s=t.readInt();for(r=0;r<s;r++)e.source_uvData.push(t.readFloat()),e.source_uvData.push(t.readFloat())}if(32&i)for(s=t.readInt(),r=0;r<s;r++)e.source_uv2Data.push(t.readFloat()),e.source_uv2Data.push(t.readFloat());e.faces=t.readInt();for(r=0;r<e.faces;r++)e.vertexIndices.push(t.readUnsignedShort()),e.vertexIndices.push(t.readUnsignedShort()),e.vertexIndices.push(t.readUnsignedShort()),2&i&&(e.normalIndices.push(t.readUnsignedShort()),e.normalIndices.push(t.readUnsignedShort()),e.normalIndices.push(t.readUnsignedShort())),8&i&&(e.colorIndices.push(t.readUnsignedShort()),e.colorIndices.push(t.readUnsignedShort()),e.colorIndices.push(t.readUnsignedShort())),16&i&&(e.uvIndices.push(t.readUnsignedShort()),e.uvIndices.push(t.readUnsignedShort()),e.uvIndices.push(t.readUnsignedShort())),32&i&&(e.uv2Indices.push(t.readUnsignedShort()),e.uv2Indices.push(t.readUnsignedShort()),e.uv2Indices.push(t.readUnsignedShort()));var h=t.readUnsignedByte();0<h&&(e.skeleton=new m.Skeleton);var u=new m.Quaternion,l=new m.Vector3,c=new m.Vector3;for(r=0;r<h;++r){var d=new m.Joint(null);t.readInt(),d.parentIndex=t.readInt(),d.name=t.readUTF(),u.x=t.readFloat(),u.y=t.readFloat(),u.z=t.readFloat(),u.w=t.readFloat(),l.x=t.readFloat(),l.y=t.readFloat(),l.z=t.readFloat(),c.x=t.readFloat(),c.y=t.readFloat(),c.z=t.readFloat(),d.buildInverseMatrix(l,u,c),e.skeleton.joints.push(d)}var p=t.readInt();for(r=0;r<p;r++){for(var f=t.readUnsignedByte(),_=0;_<f;_++)e.source_skinData.push(t.readUnsignedByte()),e.source_skinData.push(t.readFloat());for(_=f;_<4;_++)e.source_skinData.push(0),e.source_skinData.push(0)}},t.prototype.release=function(t){return!0},t}();m.ESMAnalyzer=t}(dou3d||(dou3d={})),function(p){var t=function(){function t(){}return t.prototype.load=function(e,i,r){var a=this,n=new dou.HttpRequest;n.responseType=dou.HttpResponseType.arraybuffer,n.on(dou.Event.COMPLETE,function(t){i.call(r,e,a.createClip(n.response))},this),n.on(dou.IOErrorEvent.IO_ERROR,function(t){i.call(r,e)},this),n.open(e,dou.HttpMethod.GET),n.send()},t.prototype.createClip=function(t){var e=new dou.ByteArray(t);e.position=3;var i,r=e.readUnsignedInt();switch(r){case 1:i=this.parseVersion_1(e);break;case 2:i=this.parseVersion_2(e);break;default:return console.error("EAM version error : "+r),null}return i},t.prototype.parseVersion_1=function(t){var e=t.readUnsignedByte();t.readUnsignedByte();if(e<=0)return null;for(var i=new p.SkeletonAnimationClip,r=[],a=[],n=0;n<e;n++)r.push(t.readUTF()),a.push(t.readUTF());t.readInt();var o=t.readInt(),s=new p.Quaternion,h=new p.Vector3,u=new p.Vector3;for(n=0;n<o;n++){var l=new p.SkeletonPose;l.frameTime=t.readInt()/60/80*1e3;for(var c=0;c<e;c++){var d=new p.Joint(r[c]);d.parent=a[c],d.parentIndex=l.findJointIndex(d.parent),s.fromEuler(t.readFloat(),t.readFloat(),t.readFloat(),6),h.x=t.readFloat(),h.y=t.readFloat(),h.z=t.readFloat(),u.x=t.readFloat(),u.y=t.readFloat(),u.z=t.readFloat(),d.buildLocalMatrix(h,s,u),l.joints.push(d)}l.calculateJointWorldMatrix(),i.addSkeletonPose(l)}return i},t.prototype.parseVersion_2=function(t){var e=t.readUnsignedByte();t.readUnsignedByte();if(e<=0)return null;for(var i=new p.SkeletonAnimationClip,r=[],a=[],n=0;n<e;n++)r.push(t.readUTF()),a.push(t.readUTF());t.readInt();var o=t.readInt(),s=new p.Quaternion,h=new p.Vector3,u=new p.Vector3;for(n=0;n<o;n++){var l=new p.SkeletonPose;l.frameTime=t.readInt()/60/80*1e3;for(var c=0;c<e;c++){var d=new p.Joint(r[c]);d.parent=a[c],d.parentIndex=l.findJointIndex(d.parent),s.x=t.readFloat(),s.y=t.readFloat(),s.z=t.readFloat(),s.w=t.readFloat(),h.x=t.readFloat(),h.y=t.readFloat(),h.z=t.readFloat(),u.x=t.readFloat(),u.y=t.readFloat(),u.z=t.readFloat(),d.buildLocalMatrix(h,s,u),l.joints.push(d)}l.calculateJointWorldMatrix(),i.addSkeletonPose(l)}return i},t.prototype.release=function(t){return!0},t}();p.EAMAnalyzer=t}(dou3d||(dou3d={})),function(t){var e=function(){function t(){this.vsShaderList=[],this.fsShaderList=[]}return t.prototype.dispose=function(){},t}();t.MethodBase=e}(dou3d||(dou3d={})),function(i){var t=function(e){function t(){var t=e.call(this)||this;return t.fsShaderList[i.ShaderPhaseType.diffuse_fragment]=t.fsShaderList[i.ShaderPhaseType.diffuse_fragment]||[],t.fsShaderList[i.ShaderPhaseType.diffuse_fragment].push("color_fs"),t}return __extends(t,e),t.prototype.upload=function(t,e,i,r,a,n,o){},t.prototype.activeState=function(t,e,i,r,a,n,o){},t}(i.MethodBase);i.ColorMethod=t}(dou3d||(dou3d={})),function(h){var t=function(i){function t(t){var e=i.call(this)||this;return e.materialData=t.materialData,e.vsShaderList[h.ShaderPhaseType.local_vertex]=e.vsShaderList[h.ShaderPhaseType.local_vertex]||[],e.vsShaderList[h.ShaderPhaseType.local_vertex].push("shadowMapping_vs"),e.fsShaderList[h.ShaderPhaseType.shadow_fragment]=e.fsShaderList[h.ShaderPhaseType.shadow_fragment]||[],e.fsShaderList[h.ShaderPhaseType.shadow_fragment].push("shadowMapping_fs"),e}return __extends(t,i),Object.defineProperty(t.prototype,"shadowMapTexture",{get:function(){return this.materialData.shadowMapTexture},set:function(t){this.materialData.shadowMapTexture!=t&&(this.materialData.shadowMapTexture=t,this.materialData.textureChange=!0)},enumerable:!0,configurable:!0}),t.prototype.upload=function(t,e,i,r,a,n,o){i.uniform_ShadowMatrix&&(i.uniform_ShadowMatrix.uniformIndex=a.getUniformLocation(i.program3D,"uniform_ShadowMatrix"))},t.prototype.activeState=function(t,e,i,r,a,n,o){var s=h.ShadowCast.instance.shadowCamera;s&&i.uniform_ShadowMatrix&&i.uniform_ShadowMatrix.uniformIndex&&a.uniformMatrix4fv(i.uniform_ShadowMatrix.uniformIndex,!1,s.viewProjectionMatrix.rawData),a.uniform4fv(i.uniform_ShadowColor.uniformIndex,this.materialData.shadowColor)},t}(h.MethodBase);h.ShadowMethod=t}(dou3d||(dou3d={})),function(m){var t=function(){function t(t){this._passChange=!0,this._vs_shader_methods={},this._fs_shader_methods={},this.methodList=[],this.methodDatas=[],this.vsShaderNames=[],this.fsShaderNames=[],this._materialData=t}return t.prototype.addMethod=function(t){-1==this.methodList.indexOf(t)&&(this.methodList.push(t),t.materialData=this._materialData,this._passChange=!0)},t.prototype.getMethod=function(t){for(var e=0;e<this.methodList.length;++e)if(this.methodList[e]instanceof t)return this.methodList[e];return null},t.prototype.removeMethod=function(t){var e=this.methodList.indexOf(t);-1!=e&&(this.methodList.slice(e),this._passChange=!0)},t.prototype.passInvalid=function(){this._passChange=!0},t.prototype.resetTexture=function(t){var e,i;for(var r in this._passUsage.sampler2DList)e=this._passUsage.sampler2DList[r],this._materialData[e.varName]&&(e.texture=this._materialData[e.varName]);for(var r in this._passUsage.sampler3DList)i=this._passUsage.sampler3DList[r],this._materialData[i.varName]&&(i.texture=this._materialData[i.varName]);this._materialData.textureChange=!1},t.prototype.addMethodShaders=function(t,e){for(var i=0;i<e.length;i++)t.addUseShaderName(e[i])},t.prototype.addShaderPhase=function(t,e,i){var r,a,n;for(a in e){r=e[a];for(var o=0;o<r.length;o++){i[a]=i[a]||[],i[a].push(r[o]),n=m.ShaderPhaseType[a];var s=this._materialData.shaderPhaseTypes[t].indexOf(m.ShaderPhaseType[n]);-1!=s&&this._materialData.shaderPhaseTypes[t].splice(s,1)}}},t.prototype.initUseMethod=function(t){this._passChange=!1,this._passUsage=new m.PassUsage,this._vs_shader_methods={},this._fs_shader_methods={},t&&t instanceof m.SkeletonAnimation&&(this._passUsage.maxBone=2*t.jointNum,this._vs_shader_methods[m.ShaderPhaseType.start_vertex]=[],this._vs_shader_methods[m.ShaderPhaseType.start_vertex].push("skeleton_vs")),this._materialData.acceptShadow&&(this._vs_shader_methods[m.ShaderPhaseType.global_vertex]=this._vs_shader_methods[m.ShaderPhaseType.global_vertex]||[],this._fs_shader_methods[m.ShaderPhaseType.shadow_fragment]=this._fs_shader_methods[m.ShaderPhaseType.shadow_fragment]||[]),-1!=this._materialData.shaderPhaseTypes[0].indexOf(m.ShaderPhaseType.diffuse_fragment)&&(this._fs_shader_methods[m.ShaderPhaseType.diffuse_fragment]=[],this._fs_shader_methods[m.ShaderPhaseType.diffuse_fragment].push("diffuse_fs")),-1!=this._materialData.shaderPhaseTypes[0].indexOf(m.ShaderPhaseType.normal_fragment)&&(this._fs_shader_methods[m.ShaderPhaseType.normal_fragment]=[],this._fs_shader_methods[m.ShaderPhaseType.normal_fragment].push("normalMap_fs")),-1!=this._materialData.shaderPhaseTypes[0].indexOf(m.ShaderPhaseType.specular_fragment)&&(this._fs_shader_methods[m.ShaderPhaseType.specular_fragment]=[],this._fs_shader_methods[m.ShaderPhaseType.specular_fragment].push("specularMap_fs")),-1!=this._materialData.shaderPhaseTypes[0].indexOf(m.ShaderPhaseType.matCap_fragment)&&(this._fs_shader_methods[m.ShaderPhaseType.matCap_fragment]=[],this._fs_shader_methods[m.ShaderPhaseType.matCap_fragment].push("matCap_TextureMult_fs")),this.lightGroup&&(this._passUsage.maxDirectLight=this.lightGroup.directList.length,this._passUsage.maxSpotLight=this.lightGroup.spotList.length,this._passUsage.maxPointLight=this.lightGroup.pointList.length,this._vs_shader_methods[m.ShaderPhaseType.local_vertex]=this._vs_shader_methods[m.ShaderPhaseType.local_vertex]||[],this._fs_shader_methods[m.ShaderPhaseType.lighting_fragment]=[],this._fs_shader_methods[m.ShaderPhaseType.lighting_fragment].push("lightingBase_fs"),this.lightGroup.directList.length&&(this._passUsage.directLightData=new Float32Array(m.DirectLight.stride*this.lightGroup.directList.length),this._vs_shader_methods[m.ShaderPhaseType.local_vertex].push("varyingViewDir_vs"),this._fs_shader_methods[m.ShaderPhaseType.lighting_fragment].push("directLight_fs")),this.lightGroup.spotList.length&&(this._passUsage.spotLightData=new Float32Array(m.SpotLight.stride*this.lightGroup.spotList.length),this._fs_shader_methods[m.ShaderPhaseType.lighting_fragment].push("spotLight_fs")),this.lightGroup.pointList.length&&(this._passUsage.pointLightData=new Float32Array(m.PointLight.stride*this.lightGroup.pointList.length),this._fs_shader_methods[m.ShaderPhaseType.lighting_fragment].push("pointLight_fs"))),this.initOtherMethods(),this.phaseEnd()},t.prototype.initOtherMethods=function(){for(var t,e,i=0;i<this.methodList.length;i++){var r=this.methodList[i];for(t in r.vsShaderList){e=r.vsShaderList[t];for(var a=0;a<e.length;a++)this._vs_shader_methods[t]=this._vs_shader_methods[t]||[],this._vs_shader_methods[t].push(e[a])}for(t in r.fsShaderList){e=r.fsShaderList[t];for(a=0;a<e.length;a++)this._fs_shader_methods[t]=this._fs_shader_methods[t]||[],this._fs_shader_methods[t].push(e[a])}}},t.prototype.phaseEnd=function(){var t;(t=this._vs_shader_methods[m.ShaderPhaseType.base_vertex])&&0<t.length?this.addMethodShaders(this._passUsage.vertexShader,t):(this.addMethodShaders(this._passUsage.vertexShader,["base_vs"]),(t=this._vs_shader_methods[m.ShaderPhaseType.start_vertex])&&0<t.length?this.addMethodShaders(this._passUsage.vertexShader,t):this.addMethodShaders(this._passUsage.vertexShader,["diffuse_vs"]),(t=this._vs_shader_methods[m.ShaderPhaseType.local_vertex])&&0<t.length&&this.addMethodShaders(this._passUsage.vertexShader,t),(t=this._vs_shader_methods[m.ShaderPhaseType.global_vertex])&&0<t.length&&this.addMethodShaders(this._passUsage.vertexShader,t),(t=this._vs_shader_methods[m.ShaderPhaseType.end_vertex])&&0<t.length?this.addMethodShaders(this._passUsage.vertexShader,t):this.addMethodShaders(this._passUsage.vertexShader,["end_vs"])),(t=this._fs_shader_methods[m.ShaderPhaseType.base_fragment])&&0<t.length?this.addMethodShaders(this._passUsage.fragmentShader,t):(this.addMethodShaders(this._passUsage.fragmentShader,["base_fs"]),(t=this._fs_shader_methods[m.ShaderPhaseType.start_fragment])&&0<t.length&&this.addMethodShaders(this._passUsage.fragmentShader,t),(t=this._fs_shader_methods[m.ShaderPhaseType.materialsource_fragment])&&0<t.length?this.addMethodShaders(this._passUsage.fragmentShader,t):this.addMethodShaders(this._passUsage.fragmentShader,["materialSource_fs"]),(t=this._fs_shader_methods[m.ShaderPhaseType.diffuse_fragment])&&0<t.length?this.addMethodShaders(this._passUsage.fragmentShader,t):this.addMethodShaders(this._passUsage.fragmentShader,["diffuse_fs"]),(t=this._fs_shader_methods[m.ShaderPhaseType.normal_fragment])&&0<t.length&&this.addMethodShaders(this._passUsage.fragmentShader,t),(t=this._fs_shader_methods[m.ShaderPhaseType.shadow_fragment])&&0<t.length&&this.addMethodShaders(this._passUsage.fragmentShader,t),(t=this._fs_shader_methods[m.ShaderPhaseType.lighting_fragment])&&0<t.length&&this.addMethodShaders(this._passUsage.fragmentShader,t),(t=this._fs_shader_methods[m.ShaderPhaseType.specular_fragment])&&0<t.length&&this.addMethodShaders(this._passUsage.fragmentShader,t),(t=this._fs_shader_methods[m.ShaderPhaseType.matCap_fragment])&&0<t.length&&this.addMethodShaders(this._passUsage.fragmentShader,t),(t=this._fs_shader_methods[m.ShaderPhaseType.multi_end_fragment])&&0<t.length&&this.addMethodShaders(this._passUsage.fragmentShader,t),(t=this._fs_shader_methods[m.ShaderPhaseType.end_fragment])&&0<t.length?this.addMethodShaders(this._passUsage.fragmentShader,t):this.addMethodShaders(this._passUsage.fragmentShader,["end_fs"]))},t.prototype.upload=function(t,e,i,r,a,n){for(var o in this._passChange=!1,this.initUseMethod(n),this._passUsage.vertexShader.shader=this._passUsage.vertexShader.getShader(this._passUsage),this._passUsage.fragmentShader.shader=this._passUsage.fragmentShader.getShader(this._passUsage),this._passUsage.program3D=m.ShaderPool.getProgram(this._passUsage.vertexShader.shader.id,this._passUsage.fragmentShader.shader.id),this._passUsage)-1!=o.indexOf("uniform")&&this._passUsage[o]&&(this._passUsage[o].uniformIndex=i.getUniformLocation(this._passUsage.program3D,o));var s,h;for(var u in this._passUsage.sampler2DList)(s=this._passUsage.sampler2DList[u]).uniformIndex=i.getUniformLocation(this._passUsage.program3D,s.varName),s.texture=this._materialData[s.varName];for(var u in this._passUsage.sampler3DList)(h=this._passUsage.sampler3DList[u]).uniformIndex=i.getUniformLocation(this._passUsage.program3D,h.varName);if(this.methodList)for(var l=0;l<this.methodList.length;l++)this.methodList[l].upload(t,e,this._passUsage,null,i,r,a)},t.prototype.draw=function(t,e,i,r,a,n,o){if(this._materialData.materialDataNeedChange){var s=this._materialData.tintColor,h=Math.floor(s/16777216),u=(16711680&s)/65536,l=(65280&s)/256,c=255&s;h/=128,u/=128,l/=128,c/=128,this._materialData.materialSourceData[0]=u*(this._materialData.diffuseColor>>16&255)/255,this._materialData.materialSourceData[1]=l*(this._materialData.diffuseColor>>8&255)/255,this._materialData.materialSourceData[2]=c*(255&this._materialData.diffuseColor)/255,this._materialData.materialSourceData[3]=(this._materialData.ambientColor>>16&255)/255,this._materialData.materialSourceData[4]=(this._materialData.ambientColor>>8&255)/255,this._materialData.materialSourceData[5]=(255&this._materialData.ambientColor)/255,this._materialData.materialSourceData[6]=(this._materialData.specularColor>>16&255)/255,this._materialData.materialSourceData[7]=(this._materialData.specularColor>>8&255)/255,this._materialData.materialSourceData[8]=(255&this._materialData.specularColor)/255,this._materialData.materialSourceData[9]=h*this._materialData.alpha,this._materialData.materialSourceData[10]=this._materialData.cutAlpha,this._materialData.materialSourceData[11]=this._materialData.gloss,this._materialData.materialSourceData[12]=this._materialData.specularLevel,this._materialData.materialSourceData[13]=this._materialData.albedo,this._materialData.materialSourceData[14]=this._materialData.uvRectangle.x,this._materialData.materialSourceData[15]=this._materialData.uvRectangle.y,this._materialData.materialSourceData[16]=this._materialData.uvRectangle.w,this._materialData.materialSourceData[17]=this._materialData.uvRectangle.h,this._materialData.materialSourceData[18]=this._materialData.specularLevel,this._materialData.materialSourceData[19]=window.devicePixelRatio}var d,p;for(var f in this._passChange&&this.upload(t,e,i,r,a,o.animation),i.setProgram(this._passUsage.program3D),n.activeState(this._passUsage,i),this._materialData.depthTest?i.enableDepth():i.disableDepth(),i.depthFunc(m.ContextConfig.LEQUAL),i.setCulling(this._materialData.cullFrontOrBack),this._materialData.bothside?i.disableCullFace():i.enableCullFace(),3==this._passID?(i.disableBlend(),i.setBlendFactors(m.ContextConfig.ONE,m.ContextConfig.ZERO)):(this._materialData.alphaBlending&&m.Context3DProxy.gl.depthMask(!1),i.enableBlend(),i.setBlendFactors(this._materialData.blend_src,this._materialData.blend_dest)),this._passUsage.uniform_materialSource&&i.uniform1fv(this._passUsage.uniform_materialSource.uniformIndex,this._materialData.materialSourceData),this._materialData.textureChange&&this.resetTexture(i),this._passUsage.sampler2DList)(d=this._passUsage.sampler2DList[f]).texture=this._materialData[d.varName],d.texture&&(d.texture.upload(i),i.setTexture2DAt(d.activeTextureIndex,d.uniformIndex,d.index,d.texture.texture2D),d.texture.useMipmap&&(d.texture.useMipmap=this._materialData.useMipmap),d.texture.repeat=this._materialData.repeat,d.texture.activeState(i),this._materialData.textureStateChage=!1);for(var f in this._passUsage.sampler3DList)(p=this._passUsage.sampler3DList[f]).texture=this._materialData[p.varName],p.texture&&(p.texture.upload(i),i.setCubeTextureAt(p.activeTextureIndex,p.uniformIndex,p.index,p.texture.texture3D));if(this.lightGroup){for(var _=0;_<this._passUsage.maxDirectLight;_++)this.lightGroup.directList[_].updateLightData(a,_,this._passUsage.directLightData);for(_=0;_<this._passUsage.maxSpotLight;_++)this.lightGroup.spotList[_].updateLightData(a,_,this._passUsage.spotLightData);for(_=0;_<this._passUsage.maxPointLight;_++)this.lightGroup.pointList[_].updateLightData(a,_,this._passUsage.pointLightData);this._passUsage.uniform_directLightSource&&i.uniform1fv(this._passUsage.uniform_directLightSource.uniformIndex,this._passUsage.directLightData),this._passUsage.uniform_sportLightSource&&i.uniform1fv(this._passUsage.uniform_sportLightSource.uniformIndex,this._passUsage.spotLightData),this._passUsage.uniform_pointLightSource&&i.uniform1fv(this._passUsage.uniform_pointLightSource.uniformIndex,this._passUsage.pointLightData)}if(this._passUsage.uniform_ModelMatrix&&i.uniformMatrix4fv(this._passUsage.uniform_ModelMatrix.uniformIndex,!1,r.rawData),this._passUsage.uniform_ViewMatrix&&i.uniformMatrix4fv(this._passUsage.uniform_ViewMatrix.uniformIndex,!1,a.viewMatrix.rawData),this._passUsage.uniform_ProjectionMatrix&&i.uniformMatrix4fv(this._passUsage.uniform_ProjectionMatrix.uniformIndex,!1,a.projectMatrix.rawData),this._passUsage.uniform_ViewProjectionMatrix&&i.uniformMatrix4fv(this._passUsage.uniform_ViewProjectionMatrix.uniformIndex,!1,a.viewProjectionMatrix.rawData),this._passUsage.uniform_orthProectMatrix&&i.uniformMatrix4fv(this._passUsage.uniform_orthProectMatrix.uniformIndex,!1,a.orthProjectionMatrix.rawData),o.animation&&o.animation.activeState(t,e,this._passUsage,n,i,r,a),this.methodList)for(_=0;_<this.methodList.length;_++)this.methodList[_].activeState(t,e,this._passUsage,null,i,r,a);this._passUsage.uniform_eyepos&&i.uniform3f(this._passUsage.uniform_eyepos.uniformIndex,a.x,a.y,a.z),this._passUsage.uniform_cameraMatrix&&i.uniformMatrix4fv(this._passUsage.uniform_cameraMatrix.uniformIndex,!1,a.globalMatrix.rawData),i.drawElement(this._materialData.drawMode,n.start,n.count),this._materialData.alphaBlending&&m.Context3DProxy.gl.depthMask(!0)},t.prototype.deactiveState=function(t,e){for(var i in t.sampler2DList)this._passUsage.sampler2DList[i].texture},t.prototype.dispose=function(){this._passUsage&&this._passUsage.dispose(),this._passUsage=null},t}();m.MaterialPass=t}(dou3d||(dou3d={})),function(e){var t=function(){function t(){this.sampler2DList=[],this.sampler3DList=[],this.vertexShader=new e.ShaderBase(0),this.fragmentShader=new e.ShaderBase(1),this.maxDirectLight=0,this.maxSpotLight=0,this.maxPointLight=0,this.maxBone=0,this.attributeDiry=!0}return t.prototype.dispose=function(){this.program3D&&this.program3D.dispose(),this.program3D=null,this.vertexShader&&this.vertexShader.shader&&this.vertexShader.shader.dispose(),this.vertexShader=null,this.fragmentShader&&this.fragmentShader.shader&&this.fragmentShader.shader.dispose(),this.fragmentShader=null},t}();e.PassUsage=t}(dou3d||(dou3d={})),function(i){var t;(t=i.PassUtil||(i.PassUtil={})).passAuto=[!0,!0,!0,!1,!1,!0,!0,!0,!0,!0],t.creatPass=function(t,e){switch(t){case 1:return e.shaderPhaseTypes[1]=[],[new i.ColorPass(e)];case 0:return e.shaderPhaseTypes[0]=[],[new i.DiffusePass(e)];case 3:return e.shaderPhaseTypes[3]=[],[new i.ShadowPass(e)];case 2:return e.shaderPhaseTypes[2]=[],[new i.NormalPass(e)]}return null}}(dou3d||(dou3d={})),function(e){var t=function(i){function t(t){var e=i.call(this,t)||this;return e._passID=1,e}return __extends(t,i),t.prototype.initUseMethod=function(){this._passChange=!1,this._passUsage=new e.PassUsage,this._passUsage.vertexShader.shaderType=0,-(this._passUsage.fragmentShader.shaderType=1)!=this._materialData.shaderPhaseTypes[0].indexOf(e.ShaderPhaseType.diffuse_fragment)&&(this._fs_shader_methods[e.ShaderPhaseType.diffuse_fragment]=[],this._fs_shader_methods[e.ShaderPhaseType.diffuse_fragment].push("diffuse_fs")),this._fs_shader_methods[e.ShaderPhaseType.end_fragment]=this._fs_shader_methods[e.ShaderPhaseType.end_fragment]||[],this._fs_shader_methods[e.ShaderPhaseType.end_fragment].push("colorPassEnd_fs"),this.phaseEnd()},t}(e.MaterialPass);e.ColorPass=t}(dou3d||(dou3d={})),function(t){var e=function(i){function t(t){var e=i.call(this,t)||this;return e._passID=0,e}return __extends(t,i),t}(t.MaterialPass);t.DiffusePass=e}(dou3d||(dou3d={})),function(e){var t=function(i){function t(t){var e=i.call(this,t)||this;return e._passID=3,e}return __extends(t,i),t.prototype.initUseMethod=function(){this._passChange=!1,this._passUsage=new e.PassUsage,this._vs_shader_methods={},this._fs_shader_methods={},this.addMethodShaders(this._passUsage.vertexShader,["shadowPass_vs"]),this.addMethodShaders(this._passUsage.fragmentShader,["shadowPass_fs"])},t}(e.MaterialPass);e.ShadowPass=t}(dou3d||(dou3d={})),function(e){var t=function(i){function t(t){var e=i.call(this,t)||this;return e._passID=2,e}return __extends(t,i),t.prototype.initUseMethod=function(){this._passChange=!1,this._passUsage=new e.PassUsage,this._passUsage.vertexShader.shaderType=0,-(this._passUsage.fragmentShader.shaderType=1)!=this._materialData.shaderPhaseTypes[0].indexOf(e.ShaderPhaseType.normal_fragment)&&(this._fs_shader_methods[e.ShaderPhaseType.normal_fragment]=[],this._fs_shader_methods[e.ShaderPhaseType.normal_fragment].push("normalMap_fs")),this._fs_shader_methods[e.ShaderPhaseType.end_fragment]=this._fs_shader_methods[e.ShaderPhaseType.end_fragment]||[],this._fs_shader_methods[e.ShaderPhaseType.end_fragment].push("normalPassEnd_fs"),this.phaseEnd()},t}(e.MaterialPass);e.NormalPass=t}(dou3d||(dou3d={})),function(e){var t=function(){function t(t){this._passes=[],this.materialData=t||new e.MaterialData}return Object.defineProperty(t.prototype,"passes",{get:function(){return this._passes},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"diffusePass",{get:function(){return this._passes[0][0]},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"materialData",{get:function(){return this._materialData},set:function(t){this._materialData=t,this.initPass(),this.blendMode=2},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"lightGroup",{get:function(){return this._lightGroup},set:function(t){if(this._lightGroup=t,this._passes[0]&&0<this._passes[0].length)for(var e=0;e<this._passes[0].length;e++)this._passes[0][e].lightGroup=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"depth",{get:function(){return this._materialData.depthTest},set:function(t){this._materialData.depthTest=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"depthMode",{get:function(){return this._materialData.depthMode},set:function(t){this._materialData.depthMode=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"diffuseTexture",{get:function(){return this._materialData.diffuseTexture},set:function(t){t&&(this._materialData.diffuseTexture=t,this._materialData.textureChange=!0,this._materialData.shaderPhaseTypes[0]&&-1==this._materialData.shaderPhaseTypes[0].indexOf(e.ShaderPhaseType.diffuse_fragment)&&this._materialData.shaderPhaseTypes[0].push(e.ShaderPhaseType.diffuse_fragment),this._materialData.shaderPhaseTypes[3]&&-1==this._materialData.shaderPhaseTypes[3].indexOf(e.ShaderPhaseType.diffuse_fragment)&&this._materialData.shaderPhaseTypes[3].push(e.ShaderPhaseType.diffuse_fragment))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"normalTexture",{get:function(){return this._materialData.normalTexture},set:function(t){t&&(this._materialData.normalTexture=t,this._materialData.textureChange=!0,this._materialData.shaderPhaseTypes[0]&&-1==this._materialData.shaderPhaseTypes[0].indexOf(e.ShaderPhaseType.normal_fragment)&&(this._materialData.shaderPhaseTypes[0].push(e.ShaderPhaseType.normal_fragment),this.passInvalid(0)))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"matcapTexture",{get:function(){return this._materialData.normalTexture},set:function(t){t&&(this._materialData.matcapTexture=t,this._materialData.textureChange=!0,this._materialData.shaderPhaseTypes[0]&&-1==this._materialData.shaderPhaseTypes[0].indexOf(e.ShaderPhaseType.matCap_fragment)&&(this._materialData.shaderPhaseTypes[0].push(e.ShaderPhaseType.matCap_fragment),this.passInvalid(0)))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"specularTexture",{get:function(){return this._materialData.specularTexture},set:function(t){t&&(this._materialData.specularTexture=t,this._materialData.textureChange=!0,this._materialData.shaderPhaseTypes[0]&&-1==this._materialData.shaderPhaseTypes[0].indexOf(e.ShaderPhaseType.specular_fragment)&&this._materialData.shaderPhaseTypes[0].push(e.ShaderPhaseType.specular_fragment))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"drawMode",{get:function(){return this._materialData.drawMode},set:function(t){this._materialData.drawMode=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"cutAlpha",{get:function(){return this._materialData.cutAlpha},set:function(t){this._materialData.cutAlpha=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"diffuseColor",{get:function(){return this._materialData.diffuseColor},set:function(t){this._materialData.materialDataNeedChange=!0,this._materialData.diffuseColor=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"ambientColor",{get:function(){return this._materialData.ambientColor},set:function(t){this._materialData.materialDataNeedChange=!0,this._materialData.ambientColor=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"specularColor",{get:function(){return this._materialData.specularColor},set:function(t){this._materialData.materialDataNeedChange=!0,this._materialData.specularColor=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"tintColor",{get:function(){return this._materialData.tintColor},set:function(t){this._materialData.materialDataNeedChange=!0,this._materialData.tintColor=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"alpha",{get:function(){return this._materialData.alpha},set:function(t){this._materialData.alpha!=t&&(this._materialData.alpha=t,this._materialData.materialDataNeedChange=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"alphaBlending",{get:function(){return this._materialData.alphaBlending},set:function(t){this._materialData.alphaBlending!=t&&(this._materialData.alphaBlending=t,this._materialData.materialDataNeedChange=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"specularLevel",{get:function(){return this._materialData.specularLevel},set:function(t){this._materialData.specularLevel!=t&&(this._materialData.specularLevel=t,this._materialData.materialDataNeedChange=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"gloss",{get:function(){return this._materialData.gloss},set:function(t){this._materialData.gloss!=t&&(this._materialData.gloss=t,this._materialData.materialDataNeedChange=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"uvRectangle",{get:function(){return this._materialData.uvRectangle},set:function(t){this._materialData.uvRectangle.x=t.x,this._materialData.uvRectangle.y=t.y,this._materialData.uvRectangle.w=t.w,this._materialData.uvRectangle.h=t.h,this._materialData.materialDataNeedChange=!0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"castShadow",{get:function(){return this._materialData.castShadow},set:function(t){(this._materialData.castShadow=t)?(e.ShadowCast.instance.enableShadow=!0,this.addPass(3)):this._passes[3]&&(this.disposePass(3),this._passes[3]=null)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"acceptShadow",{get:function(){return this._materialData.acceptShadow},set:function(t){this._materialData.acceptShadow!=t&&(this._materialData.acceptShadow=t,this._materialData.acceptShadow?(this._shadowMethod=new e.ShadowMethod(this),this._shadowMethod.shadowMapTexture=e.ShadowCast.instance.shadowRender.renderTexture,this.diffusePass.addMethod(this._shadowMethod)):this._shadowMethod&&this.diffusePass.removeMethod(this._shadowMethod))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"shadowColor",{get:function(){var t=0;return t|=255*this._materialData.shadowColor[0]<<16,t|=255*this._materialData.shadowColor[1]<<8,t|=255*this._materialData.shadowColor[2]},set:function(t){this._materialData.shadowColor[0]=t>>16&1,this._materialData.shadowColor[1]=t>>8&1,this._materialData.shadowColor[2]=1&t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"shadowOffset",{get:function(){return this._materialData.shadowColor[3]},set:function(t){this._materialData.shadowColor[3]=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"repeat",{get:function(){return this._materialData.repeat},set:function(t){this._materialData.repeat=t,this._materialData.textureStateChage=!0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"bothside",{get:function(){return this._materialData.bothside},set:function(t){this._materialData.textureStateChage=!0,this._materialData.bothside=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"cullMode",{get:function(){return this._materialData.cullFrontOrBack},set:function(t){this._materialData.textureStateChage=!0,this._materialData.cullFrontOrBack=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"blendMode",{get:function(){return this._materialData.blendMode},set:function(t){switch(this._materialData.textureStateChage=!0,this._materialData.blendMode=t){case 2:this._materialData.blend_src=e.ContextConfig.ONE,this._materialData.blend_dest=e.ContextConfig.ONE_MINUS_SRC_ALPHA,this._materialData.alphaBlending=!1;break;case 1:this._materialData.blend_src=e.ContextConfig.SRC_ALPHA,this._materialData.blend_dest=e.ContextConfig.ZERO,this._materialData.alphaBlending=!0;break;case 3:this._materialData.blend_src=e.ContextConfig.ZERO,this._materialData.blend_dest=e.ContextConfig.SRC_COLOR,this._materialData.alphaBlending=!0;break;case 4:this._materialData.blend_src=e.ContextConfig.SRC_ALPHA,this._materialData.blend_dest=e.ContextConfig.ONE,this._materialData.alphaBlending=!0;break;case 8:this._materialData.blend_src=e.ContextConfig.SRC_COLOR,this._materialData.blend_dest=e.ContextConfig.ONE,this._materialData.alphaBlending=!0;break;case 0:this._materialData.blend_src=e.ContextConfig.ONE,this._materialData.blend_dest=e.ContextConfig.ONE_MINUS_SRC_ALPHA,this._materialData.alphaBlending=!0;break;case 7:this._materialData.blend_src=e.ContextConfig.ONE,this._materialData.blend_dest=e.ContextConfig.ONE_MINUS_SRC_COLOR}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"pointSize",{get:function(){return this._materialData.specularLevel},set:function(t){t!=this._materialData.specularLevel&&(this._materialData.specularLevel=t,this._materialData.textureStateChage=!0)},enumerable:!0,configurable:!0}),t.prototype.initPass=function(){this.addPass(1)},t.prototype.passInvalid=function(t){if(this._passes[t]&&0<this._passes[t].length)for(var e=0;e<this._passes[t].length;e++)this._passes[t][e].passInvalid()},t.prototype.addPass=function(t){this._passes[t]=e.PassUtil.creatPass(t,this._materialData)},t.prototype.disposePass=function(t){for(var e=0;e<this._passes[t].length;e++)this._passes[t][e].dispose()},t.prototype.dispose=function(){for(var t in this._passes)for(var e=0;e<this._passes[t].length;++e)this._passes[t][e].dispose()},t}();e.MaterialBase=t}(dou3d||(dou3d={})),function(t){var e=function(){function i(){this.shaderPhaseTypes={},this.drawMode=t.ContextConfig.TRIANGLES,this.useMipmap=!0,this.castShadow=!1,this.acceptShadow=!1,this.shadowColor=new Float32Array([.2,.2,.2,.003]),this.depthTest=!0,this.depthMode=0,this.blendMode=2,this.alphaBlending=!1,this.ambientColor=3355443,this.diffuseColor=16777215,this.specularColor=16777215,this.tintColor=2155905152,this.specularLevel=4,this.gloss=20,this.cutAlpha=.7,this.repeat=!1,this.bothside=!1,this.alpha=1,this.albedo=.95,this.specularScale=1,this.normalScale=1,this.uvRectangle=new t.Rectangle(0,0,1,1),this.materialDataNeedChange=!0,this.textureChange=!1,this.textureStateChage=!0,this.cullFrontOrBack=t.ContextConfig.BACK,this.materialSourceData=new Float32Array(20),this.colorGradientsSource=new Float32Array(10)}return i.prototype.clone=function(){var t=new i;t.drawMode=this.drawMode,t.diffuseTexture=this.diffuseTexture,t.shadowMapTexture=this.shadowMapTexture;for(var e=0;e<4;++e)t.shadowColor[e]=this.shadowColor[e];return t.castShadow=this.castShadow,t.acceptShadow=this.acceptShadow,t.depthTest=this.depthTest,t.blendMode=this.blendMode,t.blend_src=this.blend_src,t.blend_dest=this.blend_dest,t.ambientColor=this.ambientColor,t.diffuseColor=this.diffuseColor,t.specularColor=this.specularColor,t.cutAlpha=this.cutAlpha,t.alpha=this.alpha,t.specularLevel=this.specularLevel,t.gloss=this.gloss,t.albedo=this.albedo,t.specularScale=this.specularScale,t.materialDataNeedChange=this.materialDataNeedChange,t.textureChange=!0,t.cullFrontOrBack=this.cullFrontOrBack,t.colorTransform=this.colorTransform,t},i.prototype.dispose=function(){},i}();t.MaterialData=e}(dou3d||(dou3d={})),function(t){var e=function(){};(dou3d||(dou3d={})).MethodData=e}(),function(e){var t=function(i){function t(t){void 0===t&&(t=13421772);var e=i.call(this)||this;return e.color=t,e.initMatPass(),e}return __extends(t,i),t.prototype.initMatPass=function(){this.addPass(0),this.diffusePass.addMethod(new e.ColorMethod)},Object.defineProperty(t.prototype,"color",{get:function(){return this.materialData.diffuseColor},set:function(t){this.materialData.diffuseColor=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"alpha",{get:function(){return this.materialData.alpha},set:function(t){this.materialData.alpha=t},enumerable:!0,configurable:!0}),t}(e.MaterialBase);e.ColorMaterial=t}(dou3d||(dou3d={})),function(t){var e=function(r){function t(t,e){var i=r.call(this,e)||this;return i.diffuseTexture=t,i.initMatPass(),i}return __extends(t,r),t.prototype.initMatPass=function(){this.addPass(0)},t.prototype.clone=function(){return new t(this.diffuseTexture,this.materialData.clone())},t}(t.MaterialBase);t.TextureMaterial=e}(dou3d||(dou3d={})),function(r){var t=function(){function t(){this.numEntity=0}return t.prototype.setRenderToTexture=function(t,e,i){void 0===i&&(i=2),this.renderTexture=new r.RenderTexture(t,e,i)},t}();r.RendererBase=t}(dou3d||(dou3d={})),function(p){var t=function(i){function t(t){void 0===t&&(t=0);var e=i.call(this)||this;return e._pass=t,e}return __extends(t,i),t.prototype.draw=function(t,e,i,r,a,n){var o;this.numEntity=r.renderList.length,this.renderTexture&&(this.renderTexture.upload(i),i.setRenderToTexture(this.renderTexture.texture2D));for(var s=0;s<this.numEntity;s++){var h=r.renderList[s];h.geometry.activeState(i);for(var u=0;u<h.geometry.subGeometrys.length;u++){var l=h.geometry.subGeometrys[u],c=l.matID;if(null!=(o=h.multiMaterial[c])){if(o.passes[this._pass])for(var d=o.passes[this._pass].length-1;0<=d;d--)o.passes[this._pass][d].draw(t,e,i,h.globalMatrix,a,l,h);else if(p.PassUtil.passAuto[this._pass]){o.passes[this._pass]||o.addPass(this._pass);for(d=o.passes[this._pass].length-1;0<=d;d--)o.passes[this._pass]=p.PassUtil.creatPass(this._pass,o.materialData),o.passes[this._pass][d].draw(t,e,i,h.globalMatrix,a,l,h)}o=null}}}this.drawOver&&this.drawOver(r,a,t,e,n),this.renderTexture&&(i.setRenderToBackBuffer(),n&&(i.viewPort(n.x,n.y,n.w,n.h),i.setScissorRectangle(n.x,n.y,n.w,n.h)))},t}(p.RendererBase);p.MultiRenderer=t}(dou3d||(dou3d={})),function(e){var t=function(){function t(){this._root=new e.ObjectContainer3D}return Object.defineProperty(t.prototype,"root",{get:function(){return this._root},enumerable:!0,configurable:!0}),t}();e.Scene3D=t}(dou3d||(dou3d={})),function(t){var e=function(){function e(){this.varName="",this.name="",this.key="",this.valueType="",this.value="",this.activeTextureIndex=-1,this.index=-1,this.size=0,this.dataType=0,this.normalized=!1,this.stride=0,this.offset=0,this.offsetIndex=0,this.offsetBytes=0}return e.prototype.computeVarName=function(){var t=this.name.indexOf("[");this.varName=0<=t?this.name.substr(0,t):this.name},e.prototype.clone=function(){var t=new e;return t.name=this.name,t.valueType=this.valueType,t.varName=this.varName,t.value=this.value,t.key=this.key,t},e}();t.VarRegister=e}(dou3d||(dou3d={})),function(t){var e=function(r){function t(t,e){var i=r.call(this)||this;return i.name=t,i.computeVarName(),i.key="attribute",i.valueType=e,i}return __extends(t,r),t}(t.VarRegister);t.Attribute=e}(dou3d||(dou3d={})),function(t){var e;(e=t.AttributeType||(t.AttributeType={})).int="int",e.float="float",e.vec2="vec2",e.vec3="vec3",e.vec4="vec4",e.mat2="mat2",e.mat3="mat3",e.mat4="mat4"}(dou3d||(dou3d={})),function(t){var e=function(a){function t(t,e,i){var r=a.call(this)||this;return r.name=t,r.computeVarName(),r.key="const",r.valueType=e,r.value=i,r}return __extends(t,a),t}(t.VarRegister);t.ConstVar=e}(dou3d||(dou3d={})),function(t){var e=function(r){function t(t,e){var i=r.call(this)||this;return i.name=t,i.computeVarName(),i.key="#define",i.value=e,i}return __extends(t,r),t}(t.VarRegister);t.DefineVar=e}(dou3d||(dou3d={})),function(t){var e=function(i){function t(t){var e=i.call(this)||this;return e.name=t,e.computeVarName(),e.key="#extension",e}return __extends(t,i),t}(t.VarRegister);t.Extension=e}(dou3d||(dou3d={})),function(t){var e=function(i){function t(t){var e=i.call(this)||this;return e.name=t,e.computeVarName(),e.key="sampler2D",e}return __extends(t,i),t}(t.VarRegister);t.Sampler2D=e}(dou3d||(dou3d={})),function(t){var e=function(i){function t(t){var e=i.call(this)||this;return e.name=t,e.computeVarName(),e.key="samplerCube",e}return __extends(t,i),t}(t.VarRegister);t.Sampler3D=e}(dou3d||(dou3d={})),function(t){var e=function(r){function t(t,e){var i=r.call(this)||this;return i.name=t,i.computeVarName(),i.key="",i.valueType=e,i}return __extends(t,r),t}(t.VarRegister);t.TmpVar=e}(dou3d||(dou3d={})),function(t){var e=function(r){function t(t,e){var i=r.call(this)||this;return i.name=t,i.computeVarName(),i.key="uniform",i.valueType=e,i}return __extends(t,r),t}(t.VarRegister);t.Uniform=e}(dou3d||(dou3d={})),function(t){var e;(e=t.UniformType||(t.UniformType={})).bool="bool",e.int="int",e.float="float",e.vec2="vec2",e.vec3="vec3",e.vec4="vec4",e.bvec2="bvec2",e.bvec3="bvec3",e.bvec4="bvec4",e.ivec2="ivec2",e.ivec3="ivec3",e.ivec4="ivec4",e.mat2="mat2",e.mat3="mat3",e.mat4="mat4",e.sampler2D="sampler2D",e.sampleCube="sampleCube"}(dou3d||(dou3d={})),function(t){var e=function(r){function t(t,e){var i=r.call(this)||this;return i.name=t,i.computeVarName(),i.key="varying",i.valueType=e,i}return __extends(t,r),t}(t.VarRegister);t.Varying=e}(dou3d||(dou3d={})),function(t){var e;(e=t.VaryingType||(t.VaryingType={})).bool="bool",e.int="int",e.float="float",e.vec2="vec2",e.vec3="vec3",e.vec4="vec4",e.bvec2="bvec2",e.bvec3="bvec3",e.bvec4="bvec4",e.ivec2="ivec2",e.ivec3="ivec3",e.ivec4="ivec4",e.mat2="mat2",e.mat3="mat3",e.mat4="mat4",e.sampler2D="sampler2D",e.sampleCube="sampleCube"}(dou3d||(dou3d={})),function(e){var t=function(){function t(t){this.index=0,this.shadersName=[],this.endShadername="",this.stateChange=!1,this.maxBone=0,this.shaderType=-1,this.shaderType=t}return t.prototype.addUseShaderName=function(t){this.shadersName.push(t)},t.prototype.addEndShaderName=function(t){this.endShadername=t},t.prototype.getShader=function(t){""!=this.endShadername&&(-1==this.shadersName.indexOf(this.endShadername)&&this.shadersName.push(this.endShadername));return e.ShaderUtil.fillShaderContent(this,this.shadersName,t)},t}();e.ShaderBase=t}(dou3d||(dou3d={})),function(t){var e;(e=t.VarConstName||(t.VarConstName={})).attribute_position="attribute_position",e.attribute_normal="attribute_normal",e.attribute_tangent="attribute_tangent",e.attribute_vertexColor="attribute_vertexColor",e.attribute_uv0="attribute_uv0",e.attribute_uv1="attribute_uv1",e.varying_pos="varying_pos",e.varying_normal="varying_normal",e.varying_tangent="varying_tangent",e.varying_color="varying_color",e.varying_uv0="varying_uv0",e.varying_uv1="varying_uv1",e.varying_globalPos="varying_globalPos",e.varying_lightDir="varying_lightDir",e.varying_eye="varying_eye",e.uniform_floatv_0="uniform_floatv_0",e.uniform_floatv_1="uniform_floatv_1",e.uniform_floatv_2="uniform_floatv_2",e.uniform_iv_0="uniform_iv_0",e.uniform_iv_1="uniform_iv_1",e.uniform_iv_2="uniform_iv_2",e.uniform_bv_0="uniform_bv_0",e.uniform_bv_1="uniform_bv_1",e.uniform_bv_2="uniform_bv_2",e.uniform_vec2fv_0="uniform_vec2fv_0",e.uniform_vec2fv_1="uniform_vec2fv_1",e.uniform_vec2fv_2="uniform_vec2fv_2",e.uniform_vec3fv_0="uniform_vec3fv_0",e.uniform_vec3fv_1="uniform_vec3fv_1",e.uniform_vec3fv_2="uniform_vec3fv_2",e.uniform_vec4fv_0="uniform_vec4fv_0",e.uniform_vec4fv_1="uniform_vec4fv_1",e.uniform_vec4fv_2="uniform_vec4fv_2",e.uniform_vec2iv_0="uniform_vec2iv_0",e.uniform_vec2iv_1="uniform_vec2iv_1",e.uniform_vec2iv_2="uniform_vec2iv_2",e.uniform_vec3iv_0="uniform_vec3iv_0",e.uniform_vec3iv_1="uniform_vec3iv_1",e.uniform_vec3iv_2="uniform_vec3iv_2",e.uniform_vec4iv_0="uniform_vec4iv_0",e.uniform_vec4iv_1="uniform_vec4iv_1",e.uniform_vec4iv_2="uniform_vec4iv_2",e.uniform_vec2bv_0="uniform_vec2bv_0",e.uniform_vec2bv_1="uniform_vec2bv_1",e.uniform_vec2bv_2="uniform_vec2bv_2",e.uniform_vec3bv_0="uniform_vec3bv_0",e.uniform_vec3bv_1="uniform_vec3bv_1",e.uniform_vec3bv_2="uniform_vec3bv_2",e.uniform_vec4bv_0="uniform_vec4bv_0",e.uniform_vec4bv_1="uniform_vec4bv_1",e.uniform_vec4bv_2="uniform_vec4bv_2",e.uniform_modelMatrix="uniform_modelMatrix",e.uniform_projectionMatrix="uniform_projectionMatrix",e.uniform_normalMatrix="uniform_normalMatrix",e.uniform_eye="uniform_eye",e.uniform_lightDir="uniform_lightDir",e.texture2D_0="texture2D_0",e.texture2D_1="texture2D_1",e.texture2D_2="texture2D_2",e.texture2D_3="texture2D_3",e.texture2D_4="texture2D_4"}(dou3d||(dou3d={})),function(t){var e=function(){function r(){this.name="",this.source="",this.funcNames=[],this.funcDict={},this.structNames=[],this.structDict={},this.attributeList=[],this.varyingList=[],this.uniformList=[],this.constList=[],this.tempList=[],this.sampler2DList=[],this.sampler3DList=[],this.extensionList=[],this.defineList=[]}return r.prototype.addVar=function(t){"attribute"==t.key?this.attributeList.push(t):"varying"==t.key?this.varyingList.push(t):"uniform"==t.key?this.uniformList.push(t):"const"==t.key?this.constList.push(t):"sampler2D"==t.key?this.sampler2DList.push(t):"samplerCube"==t.key?this.sampler3DList.push(t):"#extension"==t.key?this.extensionList.push(t):"#define"==t.key?this.defineList.push(t):this.tempList.push(t)},r.prototype.addFunc=function(t,e){if(this.funcDict[t]){var i=this.mergeMainFunc(this.funcDict[t],e);this.funcDict[t]=i}else this.funcDict[t]=e,this.funcNames.push(t);if(this.funcDict.main){var r=this.funcNames.indexOf("main");this.funcNames.splice(r,1),this.funcNames.push("main")}},r.prototype.addStruct=function(t,e){this.structDict[t]?DEBUG&&console.log("<"+t+">struct"):(this.structDict[t]=e,this.structNames.push(t))},r.prototype.addContent=function(t){for(var e=0;e<t.structNames.length;++e)this.addStruct(t.structNames[e],t.structDict[t.structNames[e]]);for(e=0;e<t.funcNames.length;++e)this.addFunc(t.funcNames[e],t.funcDict[t.funcNames[e]]);for(e=0;e<t.attributeList.length;++e){for(var i=!0,r=0;r<this.attributeList.length;++r)if(t.attributeList[e].name==this.attributeList[r].name){DEBUG&&(t.attributeList[e].valueType==this.attributeList[r].valueType&&t.attributeList[e].key==this.attributeList[r].key||console.log(t.attributeList[e].name+"=> type:"+t.attributeList[e].valueType+" "+this.attributeList[r].valueType+" => key:"+t.attributeList[e].key+" "+this.attributeList[r].key)),i=!1;break}i&&this.attributeList.push(t.attributeList[e].clone())}for(e=0;e<t.varyingList.length;++e){for(i=!0,r=0;r<this.varyingList.length;++r)if(t.varyingList[e].name==this.varyingList[r].name){DEBUG&&(t.varyingList[e].valueType==this.varyingList[r].valueType&&t.varyingList[e].key==this.varyingList[r].key||console.log(t.varyingList[e].name+"=> type:"+t.varyingList[e].valueType+" "+this.varyingList[r].valueType+" => key:"+t.varyingList[e].key+" "+this.varyingList[r].key)),i=!1;break}i&&this.varyingList.push(t.varyingList[e].clone())}for(e=0;e<t.uniformList.length;++e){for(i=!0,r=0;r<this.uniformList.length;++r)if(t.uniformList[e].name==this.uniformList[r].name){DEBUG&&(t.uniformList[e].valueType==this.uniformList[r].valueType&&t.uniformList[e].key==this.uniformList[r].key||console.log(t.uniformList[e].name+"=> type:"+t.uniformList[e].valueType+" "+this.uniformList[r].valueType+" => key:"+t.uniformList[e].key+" "+this.uniformList[r].key)),i=!1;break}i&&this.uniformList.push(t.uniformList[e].clone())}for(e=0;e<t.constList.length;++e){for(i=!0,r=0;r<this.constList.length;++r)if(t.constList[e].name==this.constList[r].name){DEBUG&&(t.constList[e].valueType==this.constList[r].valueType&&t.constList[e].key==this.constList[r].key||console.log(t.constList[e].name+"=> type:"+t.constList[e].valueType+" "+this.constList[r].valueType+" => key:"+t.constList[e].key+" "+this.constList[r].key)),i=!1;break}i&&this.constList.push(t.constList[e].clone())}for(e=0;e<t.tempList.length;++e){for(i=!0,r=0;r<this.tempList.length;++r)if(t.tempList[e].name==this.tempList[r].name){DEBUG&&(t.tempList[e].valueType==this.tempList[r].valueType&&t.tempList[e].key==this.tempList[r].key||console.log(t.tempList[e].name+"=> type:"+t.tempList[e].valueType+" "+this.tempList[r].valueType+" => key:"+t.tempList[e].key+" "+this.tempList[r].key)),i=!1;break}i&&this.tempList.push(t.tempList[e].clone())}for(e=0;e<t.sampler2DList.length;++e){for(i=!0,r=0;r<this.sampler2DList.length;++r)if(t.sampler2DList[e].name==this.sampler2DList[r].name){DEBUG&&(t.sampler2DList[e].valueType==this.sampler2DList[r].valueType&&t.sampler2DList[e].key==this.sampler2DList[r].key||console.log(t.sampler2DList[e].name+"=> type:"+t.sampler2DList[e].valueType+" "+this.sampler2DList[r].valueType+" => key:"+t.sampler2DList[e].key+" "+this.sampler2DList[r].key)),i=!1;break}i&&this.sampler2DList.push(t.sampler2DList[e].clone())}for(e=0;e<t.sampler3DList.length;++e){for(i=!0,r=0;r<this.sampler3DList.length;++r)if(t.sampler3DList[e].name==this.sampler3DList[r].name){DEBUG&&(t.sampler2DList[e].valueType==this.sampler3DList[r].valueType&&t.sampler3DList[e].key==this.sampler3DList[r].key||console.log(t.sampler3DList[e].name+"=> type:"+t.sampler3DList[e].valueType+" "+this.sampler3DList[r].valueType+" => key:"+t.sampler3DList[e].key+" "+this.sampler3DList[r].key)),i=!1;break}i&&this.sampler3DList.push(t.sampler3DList[e].clone())}for(e=0;e<t.extensionList.length;++e){for(i=!0,r=0;r<this.extensionList.length;++r)if(t.extensionList[e].name==this.extensionList[r].name){i=!1;break}i&&this.extensionList.push(t.extensionList[e].clone())}for(e=0;e<t.defineList.length;++e){for(i=!0,r=0;r<this.defineList.length;++r)if(t.defineList[e].name==this.defineList[r].name){i=!1;break}i&&this.defineList.push(t.defineList[e].clone())}},r.prototype.mergeMainFunc=function(t,e){var i,r=t,a=e.indexOf("{"),n=e.lastIndexOf("}");a++,i=e.slice(a,n),a=r.lastIndexOf("}");var o=r.substr(0,a),s=r.substr(a,r.length-a);r=o,r+=i;return r+="",r+=s},r.prototype.clone=function(){var t=new r;t.name=this.name,t.source=this.source;for(var e=0;e<this.funcNames.length;++e)t.funcNames.push(this.funcNames[e]);for(var i in this.funcDict)t.funcDict[i]=this.funcDict[i];for(e=0;e<this.structNames.length;++e)t.structNames.push(this.structNames[e]);for(var i in this.structDict)t.structDict[i]=this.structDict[i];for(e=0;e<this.attributeList.length;++e)t.attributeList.push(this.attributeList[e].clone());for(e=0;e<this.varyingList.length;++e)t.varyingList.push(this.varyingList[e].clone());for(e=0;e<this.uniformList.length;++e)t.uniformList.push(this.uniformList[e].clone());for(e=0;e<this.constList.length;++e)t.constList.push(this.constList[e].clone());for(e=0;e<this.tempList.length;++e)t.tempList.push(this.tempList[e].clone());for(e=0;e<this.sampler2DList.length;++e)t.sampler2DList.push(this.sampler2DList[e].clone());for(e=0;e<this.sampler3DList.length;++e)t.sampler3DList.push(this.sampler3DList[e].clone());for(e=0;e<this.attributeList.length;++e)t.attributeList.push(this.attributeList[e].clone());for(e=0;e<this.extensionList.length;++e)t.extensionList.push(this.extensionList[e].clone());for(e=0;e<this.defineList.length;++e)t.defineList.push(this.defineList[e].clone());return t},r}();t.ShaderContent=e}(dou3d||(dou3d={})),function(t){var e,o,s,h,u;e=t.ShaderPool||(t.ShaderPool={}),s={},h={},u={},e.register=function(t){o=t},e.getGPUShader=function(t,e,i){var r=h[e];return r||(r=u[e]),r||(0==t?((r=o.createVertexShader(i)).id=e,h[e]=r):1==t&&((r=o.createFragmentShader(i)).id=e,u[e]=r)),r},e.getProgram=function(t,e){var i,r=h[t],a=u[e],n=r.id+"_"+a.id;return s[n]?i=s[n]:(i=function(t,e){return o.createProgram(t,e)}(r,a),s[n]=i),s[n]}}(dou3d||(dou3d={})),function(t){var e;(e=t.ShaderLib||(t.ShaderLib={})).base_fs="#extension GL_OES_standard_derivatives:enable\nvarying vec3 varying_eyeNormal;\nvarying vec2 varying_uv0;\nvarying vec4 varying_color;\nuniform mat4 uniform_ViewMatrix;\nvec4 outColor;\nvec4 diffuseColor;\nvec4 specularColor;\nvec4 ambientColor;\nvec4 light;\nvec3 normal;\nvec2 uv_0;\nvec3 flatNormals(vec3 pos){\nvec3 fdx=dFdx(pos);vec3 fdy=dFdy(pos);return normalize(cross(fdx,fdy));\n}\nvoid main(){\ndiffuseColor=vec4(1.0,1.0,1.0,1.0);\nspecularColor=vec4(0.0,0.0,0.0,0.0);\nambientColor=vec4(0.0,0.0,0.0,0.0);\nlight=vec4(1.0,1.0,1.0,1.0);\nnormal=normalize(varying_eyeNormal);\nuv_0=varying_uv0;\n}",e.base_vs="attribute vec3 attribute_position;\nattribute vec3 attribute_normal;\nattribute vec4 attribute_color;\nattribute vec2 attribute_uv0;\nvec3 e_position=vec3(0.0,0.0,0.0);\nuniform mat4 uniform_ModelMatrix;\nuniform mat4 uniform_ViewMatrix;\nuniform mat4 uniform_ProjectionMatrix;\nvarying vec3 varying_eyeNormal;\nvarying vec2 varying_uv0;\nvarying vec4 varying_color;\nvec4 outPosition;\nmat4 transpose(mat4 inMatrix){\nvec4 i0=inMatrix[0];\nvec4 i1=inMatrix[1];\nvec4 i2=inMatrix[2];\nvec4 i3=inMatrix[3];\nmat4 outMatrix=mat4(\nvec4(i0.x,i1.x,i2.x,i3.x),\nvec4(i0.y,i1.y,i2.y,i3.y),\nvec4(i0.z,i1.z,i2.z,i3.z),\nvec4(i0.w,i1.w,i2.w,i3.w)\n);\nreturn outMatrix;\n}\nmat4 inverse(mat4 m){\nfloat\na00=m[0][0],a01=m[0][1],a02=m[0][2],a03=m[0][3],\na10=m[1][0],a11=m[1][1],a12=m[1][2],a13=m[1][3],\na20=m[2][0],a21=m[2][1],a22=m[2][2],a23=m[2][3],\na30=m[3][0],a31=m[3][1],a32=m[3][2],a33=m[3][3],\nb00=a00*a11-a01*a10,\nb01=a00*a12-a02*a10,\nb02=a00*a13-a03*a10,\nb03=a01*a12-a02*a11,\nb04=a01*a13-a03*a11,\nb05=a02*a13-a03*a12,\nb06=a20*a31-a21*a30,\nb07=a20*a32-a22*a30,\nb08=a20*a33-a23*a30,\nb09=a21*a32-a22*a31,\nb10=a21*a33-a23*a31,\nb11=a22*a33-a23*a32,\ndet=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;\nreturn mat4(\na11*b11-a12*b10+a13*b09,\na02*b10-a01*b11-a03*b09,\na31*b05-a32*b04+a33*b03,\na22*b04-a21*b05-a23*b03,\na12*b08-a10*b11-a13*b07,\na00*b11-a02*b08+a03*b07,\na32*b02-a30*b05-a33*b01,\na20*b05-a22*b02+a23*b01,\na10*b10-a11*b08+a13*b06,\na01*b08-a00*b10-a03*b06,\na30*b04-a31*b02+a33*b00,\na21*b02-a20*b04-a23*b00,\na11*b07-a10*b09-a12*b06,\na00*b09-a01*b07+a02*b06,\na31*b01-a30*b03-a32*b00,\na20*b03-a21*b01+a22*b00)/det;\n}\nvoid main(){\ne_position=attribute_position;\nvarying_color=attribute_color;\nvarying_uv0=attribute_uv0;\n}",e.colorPassEnd_fs="void main(){\ngl_FragColor=vec4(diffuseColor.xyz,1.0);\n}",e.color_fs="vec4 diffuseColor;\nvoid main(){\nif(diffuseColor.w==0.0){\ndiscard;\n}\ndiffuseColor=vec4(1.0,1.0,1.0,1.0);\nif(diffuseColor.w<materialSource.cutAlpha){\ndiscard;\n}\nelse{\ndiffuseColor.xyz*=diffuseColor.w;\n}\n}",e.diffuse_fs="uniform sampler2D diffuseTexture;\nvec4 diffuseColor;\nvoid main(){\ndiffuseColor=texture2D(diffuseTexture,uv_0);\nif(diffuseColor.w<materialSource.cutAlpha){\ndiscard;\n}\n}",e.diffuse_vs="attribute vec3 attribute_normal;\nattribute vec4 attribute_color;\nvarying vec4 varying_mvPose;\nvarying vec4 varying_color;\nvoid main(){\nmat4 mvMatrix=mat4(uniform_ViewMatrix*uniform_ModelMatrix);\nvarying_mvPose=mvMatrix*vec4(e_position,1.0);\nmat4 normalMatrix=inverse(mvMatrix);\nnormalMatrix=transpose(normalMatrix);\nvarying_eyeNormal=mat3(normalMatrix)*-attribute_normal;\noutPosition=varying_mvPose;\nvarying_color=attribute_color;\n}",e.directLight_fs="const int max_directLight=0;\nuniform float uniform_directLightSource[9*max_directLight];\nvarying vec4 varying_mvPose;\nuniform mat4 uniform_ViewMatrix;\nmat4 normalMatrix;\nstruct DirectLight{\nvec3 direction;\nvec3 diffuse;\nvec3 ambient;\n};\nmat4 transpose(mat4 inMatrix){\nvec4 i0=inMatrix[0];\nvec4 i1=inMatrix[1];\nvec4 i2=inMatrix[2];\nvec4 i3=inMatrix[3];\nmat4 outMatrix=mat4(\nvec4(i0.x,i1.x,i2.x,i3.x),\nvec4(i0.y,i1.y,i2.y,i3.y),\nvec4(i0.z,i1.z,i2.z,i3.z),\nvec4(i0.w,i1.w,i2.w,i3.w)\n);\nreturn outMatrix;\n}\nmat4 inverse(mat4 m){\nfloat\na00=m[0][0],a01=m[0][1],a02=m[0][2],a03=m[0][3],\na10=m[1][0],a11=m[1][1],a12=m[1][2],a13=m[1][3],\na20=m[2][0],a21=m[2][1],a22=m[2][2],a23=m[2][3],\na30=m[3][0],a31=m[3][1],a32=m[3][2],a33=m[3][3],\nb00=a00*a11-a01*a10,\nb01=a00*a12-a02*a10,\nb02=a00*a13-a03*a10,\nb03=a01*a12-a02*a11,\nb04=a01*a13-a03*a11,\nb05=a02*a13-a03*a12,\nb06=a20*a31-a21*a30,\nb07=a20*a32-a22*a30,\nb08=a20*a33-a23*a30,\nb09=a21*a32-a22*a31,\nb10=a21*a33-a23*a31,\nb11=a22*a33-a23*a32,\ndet=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;\nreturn mat4(\na11*b11-a12*b10+a13*b09,\na02*b10-a01*b11-a03*b09,\na31*b05-a32*b04+a33*b03,\na22*b04-a21*b05-a23*b03,\na12*b08-a10*b11-a13*b07,\na00*b11-a02*b08+a03*b07,\na32*b02-a30*b05-a33*b01,\na20*b05-a22*b02+a23*b01,\na10*b10-a11*b08+a13*b06,\na01*b08-a00*b10-a03*b06,\na30*b04-a31*b02+a33*b00,\na21*b02-a20*b04-a23*b00,\na11*b07-a10*b09-a12*b06,\na00*b09-a01*b07+a02*b06,\na31*b01-a30*b03-a32*b00,\na20*b03-a21*b01+a22*b00)/det;\n}\nvoid calculateDirectLight(MaterialSource materialSource){\nfloat lambertTerm,specular;\nvec3 dir,viewDir=normalize(varying_mvPose.xyz/varying_mvPose.w);\nfor(int i=0;i<max_directLight;i++){\nDirectLight directLight;\ndirectLight.direction=(normalMatrix*vec4(uniform_directLightSource[i*9],uniform_directLightSource[i*9+1],uniform_directLightSource[i*9+2],1.0)).xyz;\ndirectLight.diffuse=vec3(uniform_directLightSource[i*9+3],uniform_directLightSource[i*9+4],uniform_directLightSource[i*9+5]);\ndirectLight.ambient=vec3(uniform_directLightSource[i*9+6],uniform_directLightSource[i*9+7],uniform_directLightSource[i*9+8]);\ndir=normalize(directLight.direction);\nlight.xyzw+=LightingBlinnPhong(dir,directLight.diffuse,directLight.ambient,normal,viewDir,0.5);\n}\n}\nvoid main(){\nnormalMatrix=inverse(uniform_ViewMatrix);\nnormalMatrix=transpose(normalMatrix);\ncalculateDirectLight(materialSource);\n}",e.end_fs="varying vec4 varying_color;\nvec4 outColor;\nvec4 diffuseColor;\nvec4 specularColor;\nvec4 ambientColor;\nvec4 light;\nvoid main(){\noutColor.xyz=(light.xyz+materialSource.ambient)*diffuseColor.xyz*materialSource.diffuse*varying_color.xyz;\noutColor.w=materialSource.alpha*diffuseColor.w*varying_color.w;\noutColor.xyz*=outColor.w;\ngl_FragColor=outColor;\n}",e.end_vs="vec4 endPosition;\nuniform float uniform_materialSource[20];\nvoid main(){\ngl_PointSize=50.0;\ngl_PointSize=uniform_materialSource[18];\ngl_Position=uniform_ProjectionMatrix*outPosition;\n}",e.lightingBase_fs="vec4 LightingBlinnPhong(vec3 lightDir,vec3 lightColor,vec3 lightAmbient,vec3 normal,vec3 viewDir,float atten){\nfloat NdotL=clamp(dot(normal,lightDir),0.0,1.0);\nvec3 diffuse=lightColor.xyz*NdotL;\nvec3 h=normalize(lightDir+normalize(viewDir));\nfloat nh=clamp(dot(normal,h),0.0,1.0);\nfloat specPower=pow(nh,materialSource.shininess)*materialSource.specularScale;\nvec3 specular=lightColor.xyz*specPower*materialSource.specular;\nspecularColor.xyz+=specular;\nvec4 c;\nc.rgb=(diffuse+specular+lightAmbient)*(atten*2.0);\nc.a=materialSource.alpha+(specPower*atten);\nreturn c;\n}\nvoid main(){\nlight.xyzw=vec4(0.0,0.0,0.0,1.0);\n}",e.materialSource_fs="struct MaterialSource{\nvec3 diffuse;\nvec3 ambient;\nvec3 specular;\nfloat alpha;\nfloat cutAlpha;\nfloat shininess;\nfloat roughness;\nfloat albedo;\nvec4 uvRectangle;\nfloat specularScale;\nfloat normalScale;\n};\nuniform float uniform_materialSource[20];\nvarying vec2 varying_uv0;\nMaterialSource materialSource;\nvec2 uv_0;\nvoid main(){\nmaterialSource.diffuse.x=uniform_materialSource[0];\nmaterialSource.diffuse.y=uniform_materialSource[1];\nmaterialSource.diffuse.z=uniform_materialSource[2];\nmaterialSource.ambient.x=uniform_materialSource[3];\nmaterialSource.ambient.y=uniform_materialSource[4];\nmaterialSource.ambient.z=uniform_materialSource[5];\nmaterialSource.specular.x=uniform_materialSource[6];\nmaterialSource.specular.y=uniform_materialSource[7];\nmaterialSource.specular.z=uniform_materialSource[8];\nmaterialSource.alpha=uniform_materialSource[9];\nmaterialSource.cutAlpha=uniform_materialSource[10];\nmaterialSource.shininess=uniform_materialSource[11];\nmaterialSource.specularScale=uniform_materialSource[12];\nmaterialSource.albedo=uniform_materialSource[13];\nmaterialSource.uvRectangle.x=uniform_materialSource[14];\nmaterialSource.uvRectangle.y=uniform_materialSource[15];\nmaterialSource.uvRectangle.z=uniform_materialSource[16];\nmaterialSource.uvRectangle.w=uniform_materialSource[17];\nmaterialSource.specularScale=uniform_materialSource[18];\nmaterialSource.normalScale=uniform_materialSource[19];\nuv_0=varying_uv0.xy*materialSource.uvRectangle.zw+materialSource.uvRectangle.xy;\n}",e.normalMap_fs="uniform sampler2D normalTexture;\nvarying vec2 varying_uv0;\nvarying vec4 varying_mvPose;\nmat3 TBN;\nmat3 cotangentFrame(vec3 N,vec3 p,vec2 uv){\nvec3 dp1=dFdx(p);\nvec3 dp2=dFdy(p);\nvec2 duv1=dFdx(uv);\nvec2 duv2=dFdy(uv);\nvec3 dp2perp=cross(dp2,N);\nvec3 dp1perp=cross(N,dp1);\nvec3 T=dp2perp*duv1.x+dp1perp*duv2.x;\nvec3 B=dp2perp*duv1.y+dp1perp*duv2.y;\nfloat invmax=1.0/sqrt(max(dot(T,T),dot(B,B)));\nreturn mat3(T*invmax,B*invmax,N);\n}\nvec3 tbn(vec3 map,vec3 N,vec3 V,vec2 texcoord){\nmat3 TBN=cotangentFrame(N,-V,texcoord);\nreturn normalize(TBN*map);\n}\nvoid main(){\nvec3 normalTex=texture2D(normalTexture,uv_0).xyz*2.0-1.0;\nnormalTex.y*=-1.0;\nnormal.xyz=tbn(normalTex.xyz,normal.xyz,varying_mvPose.xyz,uv_0);\n}",e.normalPassEnd_fs="void main(){\ngl_FragColor=vec4(normal,1.0);\n}",e.pointLight_fs="const int max_pointLight=0;\nuniform float uniform_pointLightSource[12*max_pointLight];\nvarying vec4 varying_mvPose;\nstruct PointLight{\nvec3 position;\nvec3 diffuse;\nvec3 ambient;\nfloat intensity;\nfloat radius;\nfloat cutoff;\n};\nvoid calculatePointLight(MaterialSource materialSource){\nvec3 N=normal;\nvec3 viewDir=normalize(varying_mvPose.xyz/varying_mvPose.w);\nfor(int i=0;i<max_pointLight;i++){\nPointLight pointLight;\npointLight.position=vec3(uniform_pointLightSource[i*12],uniform_pointLightSource[i*12+1],uniform_pointLightSource[i*12+2]);\npointLight.diffuse=vec3(uniform_pointLightSource[i*12+3],uniform_pointLightSource[i*12+4],uniform_pointLightSource[i*12+5]);\npointLight.ambient=vec3(uniform_pointLightSource[i*12+6],uniform_pointLightSource[i*12+7],uniform_pointLightSource[i*12+8]);\npointLight.intensity=uniform_pointLightSource[i*12+9];\npointLight.radius=uniform_pointLightSource[i*12+10];\npointLight.cutoff=uniform_pointLightSource[i*12+11];\nvec3 lightCentre=(mat4(uniform_ViewMatrix)*vec4(pointLight.position.xyz,1.0)).xyz;\nfloat r=pointLight.radius*0.5;\nvec3 ldir=varying_mvPose.xyz-lightCentre;\nfloat distance=length(ldir);\nfloat d=max(distance-r,0.0);\nvec3 L=ldir/distance;\nfloat denom=d/r+1.0;\nfloat attenuation=1.0/(denom*denom);\nfloat cutoff=pointLight.cutoff;\nattenuation=(attenuation-cutoff)/(1.0-cutoff);\nattenuation=max(attenuation*pointLight.intensity,0.0);\nlight.xyzw+=LightingBlinnPhong(normalize(ldir),pointLight.diffuse,pointLight.ambient,N,viewDir,attenuation);\n};\n}\nvoid main(){\ncalculatePointLight(materialSource);\n}",e.shadowMapping_fs="uniform sampler2D shadowMapTexture;\nuniform vec4 uniform_ShadowColor;\nvarying vec4 varying_ShadowCoord;\nvoid main(){\nvec3 shadowColor=vec3(1.0,1.0,1.0);\nfloat offset=uniform_ShadowColor.w;\nvec2 sample=varying_ShadowCoord.xy/varying_ShadowCoord.w*0.5+0.5;\nif(sample.x>=0.0 && sample.x<=1.0 && sample.y>=0.0 && sample.y<=1.0){\nvec4 sampleDepth=texture2D(shadowMapTexture,sample).xyzw;\nfloat depth=varying_ShadowCoord.z;\nif(sampleDepth.z !=0.0){\nif(sampleDepth.z<depth-offset){\nshadowColor=uniform_ShadowColor.xyz;\n}\n}\n}\ndiffuseColor.xyz=diffuseColor.xyz*shadowColor;\n}",e.shadowMapping_vs="uniform mat4 uniform_ShadowMatrix;\nuniform mat4 uniform_ModelMatrix;\nvarying vec4 varying_ShadowCoord;\nvoid main(){\nvarying_ShadowCoord=uniform_ShadowMatrix*uniform_ModelMatrix*vec4(e_position,1.0);\n}",e.shadowPass_fs="uniform sampler2D diffuseTexture;\nvec4 diffuseColor;\nvarying vec2 varying_uv0;\nvarying vec4 varying_color;\nvarying vec4 varying_pos;\nvoid main(){\ndiffuseColor=varying_color;\nif(diffuseColor.w==0.0){\ndiscard;\n}\ndiffuseColor=texture2D(diffuseTexture,varying_uv0);\nif(diffuseColor.w<=0.3){\ndiscard;\n}\ngl_FragColor=vec4(varying_pos.zzz,1.0);\n}",e.shadowPass_vs="attribute vec3 attribute_position;\nattribute vec4 attribute_color;\nattribute vec2 attribute_uv0;\nuniform mat4 uniform_ModelMatrix;\nuniform mat4 uniform_ViewMatrix;\nuniform mat4 uniform_ProjectionMatrix;\nvarying vec2 varying_uv0;\nvarying vec4 varying_color;\nvarying vec4 varying_pos;\nvoid main(){\nmat4 mvMatrix=mat4(uniform_ViewMatrix*uniform_ModelMatrix);\nvarying_color=attribute_color;\nvarying_uv0=attribute_uv0;\nvarying_pos=uniform_ProjectionMatrix*uniform_ViewMatrix*uniform_ModelMatrix*vec4(attribute_position,1.0);\ngl_Position=varying_pos;\n}",e.skeleton_vs="attribute vec4 attribute_boneIndex;\nattribute vec4 attribute_boneWeight;\nattribute vec3 attribute_normal;\nattribute vec4 attribute_color;\nvec4 e_boneIndex=vec4(0.0,0.0,0.0,0.0);\nvec4 e_boneWeight=vec4(0.0,0.0,0.0,0.0);\nconst int bonesNumber=0;\nuniform vec4 uniform_PoseMatrix[bonesNumber];\nvarying vec4 varying_mvPose;\nmat4 buildMat4(int index){\nvec4 quat=uniform_PoseMatrix[index*2+0];\nvec4 translation=uniform_PoseMatrix[index*2+1];\nfloat xy2=2.0*quat.x*quat.y;\nfloat xz2=2.0*quat.x*quat.z;\nfloat xw2=2.0*quat.x*quat.w;\nfloat yz2=2.0*quat.y*quat.z;\nfloat yw2=2.0*quat.y*quat.w;\nfloat zw2=2.0*quat.z*quat.w;\nfloat xx=quat.x*quat.x;\nfloat yy=quat.y*quat.y;\nfloat zz=quat.z*quat.z;\nfloat ww=quat.w*quat.w;\nmat4 matrix=mat4(\nxx-yy-zz+ww,xy2+zw2,xz2-yw2,0,\nxy2-zw2,-xx+yy-zz+ww,yz2+xw2,0,\nxz2+yw2,yz2-xw2,-xx-yy+zz+ww,0,\ntranslation.x,translation.y,translation.z,1\n);\nreturn matrix;\n}\nvoid main(){\ne_boneIndex=attribute_boneIndex;\ne_boneWeight=attribute_boneWeight;\nvec4 temp_position=vec4(attribute_position,1.0);\nvec4 temp_normal=vec4(attribute_normal,0.0);\nmat4 m0=buildMat4(int(e_boneIndex.x));\nmat4 m1=buildMat4(int(e_boneIndex.y));\nmat4 m2=buildMat4(int(e_boneIndex.z));\nmat4 m3=buildMat4(int(e_boneIndex.w));\noutPosition=m0*temp_position*e_boneWeight.x;\noutPosition+=m1*temp_position*e_boneWeight.y;\noutPosition+=m2*temp_position*e_boneWeight.z;\noutPosition+=m3*temp_position*e_boneWeight.w;\ne_position=outPosition.xyz;\nvec4 temp_n;\ntemp_n=m0*temp_normal*e_boneWeight.x;\ntemp_n+=m1*temp_normal*e_boneWeight.y;\ntemp_n+=m2*temp_normal*e_boneWeight.z;\ntemp_n+=m3*temp_normal*e_boneWeight.w;\nmat4 mvMatrix=mat4(uniform_ViewMatrix*uniform_ModelMatrix);\nvarying_mvPose=mvMatrix*vec4(e_position,1.0);\nmat4 normalMatrix=inverse(mvMatrix);\nnormalMatrix=transpose(normalMatrix);\nvarying_eyeNormal=mat3(normalMatrix)*-attribute_normal;\noutPosition.xyzw=varying_mvPose.xyzw;\nvarying_color=attribute_color;\n}",e.spotLight_fs="",e.varyingViewDir_vs="varying vec3 varying_ViewDir;\nuniform vec3 uniform_eyepos;\nvoid main(){\nvarying_ViewDir=uniform_eyepos.xyz-e_position;\n}"}(dou3d||(dou3d={})),function(z){!function(t){var l=[];function i(t){for(var e=new z.ShaderContent,i=function(t){for(var e=[],i="",r=";",a=0;a<t.length;++a)if("{"==t.charAt(a)&&i.indexOf("=")<0&&(r="}"),(""!=i||" "!=t.charAt(a)&&"    "!=t.charAt(a)&&"\t"!=t.charAt(a))&&(i+=t.charAt(a),"\n"!=r&&(0<=i.indexOf("#extension")?r="\n":0<=i.indexOf("#define")&&(r="\n")),r==t.charAt(a))){if("}"==r){for(var n=0,o=0,s=0;s<i.length;++s)"{"==i.charAt(s)?n++:"}"==i.charAt(s)&&o++;if(n!=o)continue;if(0<=i.indexOf("struct")){r=";";continue}}0<i.length&&e.push(i),i="",r=";"}return e}(t);0<i.length;){var r=i[0];i.shift();var a=g(r);if(-1==a.indexOf("struct"))if(-1==a.indexOf("function"))if(-1==a.indexOf("unknown"));else{var n=b(_=v(r)),o=D(_);if("sampler2D"==o){var s=P(r);s&&e.addVar(s)}else if("samplerCube"==o){var h=w(r);h&&e.addVar(h)}else if("attribute"==n){var u=T(r);u&&e.addVar(u)}else if("varying"==n){var l=A(r);l&&e.addVar(l)}else if("uniform"==n){var c=S(r);c&&e.addVar(c)}else if("const"==n){var d=L(r);d&&e.addVar(d)}else if("#extension"==n){var p=M(r);p&&e.addVar(p)}else if("#define"==n){var f=C(r);f&&e.addVar(f)}else e.addVar(E(r))}else{var _=a.split(" "),m=r;e.addFunc(_[1],m)}else{var _=a.split(" "),y=r;e.addStruct(_[1],y),x(_[1],y,e)}}return e}function g(t){var e=t.indexOf("{");if(0<e){var i=t.substr(0,e);if(0<=i.indexOf("struct")){var r=i.lastIndexOf(" ");return r++,"struct "+i.substr(r,i.length-r)}if(i.indexOf("=")<0){var a=t.indexOf("(");r=t.lastIndexOf(" ",a);return r++,"function "+t.substr(r,a-r)}}return"unknown"}function x(t,e,i){var r=e.lastIndexOf("}");r++;for(var a=e.lastIndexOf(";"),n=v(e.substr(r,a-r)),o=0;o<n.length;++o){var s=E(t+" "+n[o]+";");s&&i.addVar(s)}}function v(t){for(var e=[],i="",r=!1,a=0;a<t.length;++a)if(r){if(";"==t.charAt(a)){r=!1,0<i.length&&(e.push(i),i="");break}i+=t.charAt(a)}else if(" "!=t.charAt(a)&&"\t"!=t.charAt(a)&&","!=t.charAt(a)&&"\r"!=t.charAt(a)&&"\n"!=t.charAt(a)&&":"!=t.charAt(a)){if(";"==t.charAt(a)){0<i.length&&(e.push(i),i="");break}if("="==t.charAt(a)){0<i.length&&(e.push(i),i=""),e.push("="),r=!0;continue}i+=t.charAt(a),a==t.length-1&&""!=t&&(e.push(i),i="")}else""!=i&&(e.push(i),i="");return e}function r(t,e){for(var i=0;i<t.length;++i)if(t[i]==e)return i;return-1}function s(t,e,i){for(var r=t,a=!1;!a;){a=!0;for(var n=0;n<e.length;++n)if(0<=r.indexOf(e[n])){a=!1;break}for(n=0;n<e.length;++n)r=r.replace(e[n],i)}return r}function b(t){var e=r(t,"=");return 0<=e?0<=(e-=3)&&e<t.length?t[e]:"":0<=(e=t.length-3)&&e<t.length?t[e]:t[0]}function D(t){var e=r(t,"=");if(0<=e){if(0<=(e-=2)&&e<t.length)return t[e]}else if(0<=(e=t.length-2)&&e<t.length)return t[e];return""}function n(t){var e=r(t,"=");if(0<=e){if(0<=(e-=1)&&e<t.length)return t[e]}else if(0<=(e=t.length-1)&&e<t.length)return t[e];return""}function o(t){var e=r(t,"=");return 0<=e&&0<=(e+=1)&&e<t.length?t[e]:""}function P(t){var e;return e=n(v(t)),new z.Sampler2D(e)}function w(t){var e;return e=n(v(t)),new z.Sampler3D(e)}function T(t){var e,i,r,a=v(t);return e=n(a),i=D(a),(r=new z.Attribute(e,i)).value=o(a),r}function A(t){var e,i,r=v(t);return e=n(r),i=D(r),new z.Varying(e,i)}function S(t){var e,i,r=v(t);return e=n(r),i=D(r),new z.Uniform(e,i)}function L(t){var e,i,r,a=v(t);return e=n(a),i=D(a),r=o(a),new z.ConstVar(e,i,r)}function M(t){var e=t.indexOf("#"),i=t.indexOf(" "),r=(t.substr(e,i),t.indexOf(":")),a=t.substr(i,r-i);a=s(a,[" "],""),r+=1;var n=t.substr(r,t.length-r);n=s(n,[" ",":","\n","\r"],"");var o=new z.Extension(a);return o.value=n,o}function C(t){var e,i="",r=v(t);return e=r[1],3<=r.length&&(i=r[2]),new z.DefineVar(e,i)}function E(t){var e,i,r,a=v(t);return e=n(a),i=D(a),(r=new z.TmpVar(e,i)).value=o(a),r}function d(t){return t.value?t.valueType+" "+t.name+" = "+t.value+"; \r\n":t.valueType+" "+t.name+"; \r\n"}function c(t){switch(t){case 0:return z.ContextSamplerType.TEXTURE_0;case 1:return z.ContextSamplerType.TEXTURE_1;case 2:return z.ContextSamplerType.TEXTURE_2;case 3:return z.ContextSamplerType.TEXTURE_3;case 4:return z.ContextSamplerType.TEXTURE_4;case 5:return z.ContextSamplerType.TEXTURE_5;case 6:return z.ContextSamplerType.TEXTURE_6;case 7:return z.ContextSamplerType.TEXTURE_7;case 8:return z.ContextSamplerType.TEXTURE_8}throw new Error("texture not big then 8")}t.load=function(){for(var t in z.ShaderLib){var e=i(z.ShaderLib[t]);(l[t]=e).name=t}},t.fillShaderContent=function(t,e,i){var r,a,n=0,o="";for(n=0;n<e.length;++n)""!=o&&(o+="/"),o+=e[n];if(o+="/d"+i.maxDirectLight,o+="/s"+i.maxSpotLight,o+="/p"+i.maxPointLight,o+="/b"+i.maxBone,l[o])r=l[o].clone();else for((r=new z.ShaderContent).name=o,n=0;n<e.length;++n){var s=l[e[n]];r.addContent(s)}for(n=0;n<r.attributeList.length;n++)i[o=r.attributeList[n].varName]=r.attributeList[n];for(n=0;n<r.varyingList.length;n++)i[o=r.varyingList[n].varName]||(i[o]=r.varyingList[n]);for(n=0;n<r.tempList.length;n++)i[o=r.tempList[n].varName]=r.tempList[n];for(n=0;n<r.uniformList.length;n++)i[o=r.uniformList[n].varName]=r.uniformList[n];for(n=0;n<r.constList.length;n++)switch(o=r.constList[n].varName,a=r.constList[n],i[o]=a,o){case"max_directLight":a.value=i.maxDirectLight;break;case"max_spotLight":a.value=i.maxSpotLight;break;case"max_pointLight":a.value=i.maxPointLight;break;case"bonesNumber":t.maxBone=i.maxBone,a.value=i.maxBone}for(n=0;n<r.sampler2DList.length;n++){var h=r.sampler2DList[n];h.index=n,i.sampler2DList.push(h),h.activeTextureIndex=c(n)}for(n=0;n<r.sampler3DList.length;n++){var u=r.sampler3DList[n];u.activeTextureIndex=c(r.sampler2DList.length+n),u.index=r.sampler2DList.length+n,i.sampler3DList.push(u)}return function(t,e){var i,r,a,n,o,s,h,u="";for(i=0;i<t.extensionList.length;i++)u+="#extension "+(r=t.extensionList[i]).name+":"+r.value+"\r\n";for(u+="precision highp float;\n",i=0;i<t.defineList.length;i++)u+=(a=t.defineList[i]).key+" "+a.name+" "+a.value+"\r\n";for(i=0;i<t.attributeList.length;i++)u+="attribute "+(n=t.attributeList[i]).valueType+" "+n.name+"; \r\n";for(i=0;i<t.structNames.length;i++)u+=t.structDict[t.structNames[i]]+" \r\n";for(i=0;i<t.varyingList.length;i++)u+="varying "+(o=t.varyingList[i]).valueType+" "+o.name+"; \r\n";for(i=0;i<t.tempList.length;i++)u+=d(t.tempList[i]);for(i=0;i<t.constList.length;i++)u+="const "+(s=t.constList[i]).valueType+" "+s.name+" = "+s.value+"; \r\n";for(i=0;i<t.uniformList.length;i++)u+="uniform "+(h=t.uniformList[i]).valueType+" "+h.name+"; \r\n";for(i=0;i<t.sampler2DList.length;i++){var l=t.sampler2DList[i];u+="uniform sampler2D "+l.name+"; \r\n"}for(i=0;i<t.sampler3DList.length;i++){var c=t.sampler3DList[i];u+="uniform samplerCube "+c.name+"; \r\n"}for(i=0;i<t.funcNames.length;i++)u+=t.funcDict[t.funcNames[i]];t.source=u}(r),z.ShaderPool.getGPUShader(t.shaderType,r.name,r.source)}}(z.ShaderUtil||(z.ShaderUtil={}))}(dou3d||(dou3d={})),function(n){var t=function(){function t(){this._enableShadow=!1,this._textureWidth=4096,this._textureHeight=4096,this._boundBox=new n.BoundBox(null,new n.Vector3,new n.Vector3),this._shadowCamera=new n.Camera3D(1),this._shadowRender=new n.MultiRenderer(3),this._shadowRender.setRenderToTexture(this._textureWidth,this._textureHeight,3),this.castShadowLight(new n.DirectLight(new n.Vector3(0,-1,1)));var t=dou.recyclable(n.Vector3);t.copy(this._directLight.direction),t.negate(),t.addScalar(1e3),this._shadowCamera.globalPosition=t}return Object.defineProperty(t,"instance",{get:function(){return t._instance||(t._instance=new t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"enableShadow",{get:function(){return this._enableShadow},set:function(t){this._enableShadow=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"textureWidth",{get:function(){return this._textureWidth},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"textureHeight",{get:function(){return this._textureHeight},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"shadowCamera",{get:function(){return this._shadowCamera},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"shadowRender",{get:function(){return this._shadowRender},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"directLight",{get:function(){return this._directLight},enumerable:!0,configurable:!0}),t.prototype.setTextureSize=function(t,e){this._textureWidth=t,this._textureHeight=e,this._shadowRender.setRenderToTexture(this._textureWidth,this._textureHeight,3)},t.prototype.castShadowLight=function(t){this._directLight=t,this._shadowCamera.updateViewport(0,0,2048,2048),this._shadowCamera.near=1,this._shadowCamera.far=3e3,t.addChild(this._shadowCamera)},t.prototype.update=function(t,e,i,r,a){this.calculateBoundBox(t),n.Engine.context3DProxy.clearColor(1,1,1,1),n.Engine.context3DProxy.clear(n.Context3DProxy.gl.COLOR_BUFFER_BIT|n.Context3DProxy.gl.DEPTH_BUFFER_BIT),this._shadowRender.draw(i,r,n.Engine.context3DProxy,t,this._shadowCamera,a)},t.prototype.calculateBoundBox=function(t){this._boundBox.min.copy(new n.Vector3(n.MathUtil.INT_MAX,n.MathUtil.INT_MAX,n.MathUtil.INT_MAX)),this._boundBox.max.copy(new n.Vector3(-n.MathUtil.INT_MAX,-n.MathUtil.INT_MAX,-n.MathUtil.INT_MAX));for(var e=0;e<t.renderList.length;e++){var i=t.renderList[e];if(i.material&&i.material.castShadow){var r=i.bound;this._boundBox.max.x<r.max.x+i.globalPosition.x&&(this._boundBox.max.x=r.max.x+i.globalPosition.x),this._boundBox.max.y<r.max.y+i.globalPosition.y&&(this._boundBox.max.y=r.max.y+i.globalPosition.y),this._boundBox.max.z<r.max.z+i.globalPosition.z&&(this._boundBox.max.z=r.max.z+i.globalPosition.z),this._boundBox.min.x>r.min.x+i.globalPosition.x&&(this._boundBox.min.x=r.min.x+i.globalPosition.x),this._boundBox.min.y>r.min.y+i.globalPosition.y&&(this._boundBox.min.y=r.min.y+i.globalPosition.y),this._boundBox.min.z>r.min.z+i.globalPosition.z&&(this._boundBox.min.z=r.min.z+i.globalPosition.z)}}this._boundBox.fillBox(this._boundBox.min,this._boundBox.max);var a=dou.recyclable(n.Vector3);a.copy(this._directLight.direction),a.negate(),a.addScalar(this._boundBox.radius),a.add(this._boundBox.center),this._shadowCamera.globalPosition=a,this._shadowCamera.updateViewport(0,0,2*this._boundBox.radius,2*this._boundBox.radius),this._shadowCamera.far=2*this._boundBox.radius},t}();n.ShadowCast=t}(dou3d||(dou3d={})),function(n){var t=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.useMipmap=!0,t.smooth=!0,t.repeat=!1,t.hasMipmap=!1,t._ready=!1,t}return __extends(t,e),t.prototype.copyFromTexture=function(t,e,i,r,a){(this.parentTexture=t).width=r,t.height=a,this.texture2D=t.texture2D,this.uvRectangle=this.uvRectangle||new n.Rectangle,this.uvRectangle.x=e,this.uvRectangle.y=i,this.uvRectangle.w=r,this.uvRectangle.h=a},t.prototype.activeState=function(t){this._ready||(this._ready=!0,this.premultiplyAlpha||n.Context3DProxy.gl.pixelStorei(n.Context3DProxy.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this.useMipmap&&!this.hasMipmap&&(n.Context3DProxy.gl.generateMipmap(n.Context3DProxy.gl.TEXTURE_2D),this.hasMipmap=!0),this.smooth?(this.hasMipmap?t.texParameteri(n.Context3DProxy.gl.TEXTURE_2D,n.Context3DProxy.gl.TEXTURE_MIN_FILTER,n.Context3DProxy.gl.LINEAR_MIPMAP_LINEAR):t.texParameteri(n.Context3DProxy.gl.TEXTURE_2D,n.Context3DProxy.gl.TEXTURE_MIN_FILTER,n.Context3DProxy.gl.LINEAR),t.texParameteri(n.Context3DProxy.gl.TEXTURE_2D,n.Context3DProxy.gl.TEXTURE_MAG_FILTER,n.Context3DProxy.gl.LINEAR)):(t.texParameteri(n.Context3DProxy.gl.TEXTURE_2D,n.Context3DProxy.gl.TEXTURE_MIN_FILTER,n.Context3DProxy.gl.NEAREST),t.texParameteri(n.Context3DProxy.gl.TEXTURE_2D,n.Context3DProxy.gl.TEXTURE_MAG_FILTER,n.Context3DProxy.gl.NEAREST)),this.repeat?(t.texParameteri(n.Context3DProxy.gl.TEXTURE_2D,n.Context3DProxy.gl.TEXTURE_WRAP_S,n.Context3DProxy.gl.REPEAT),t.texParameteri(n.Context3DProxy.gl.TEXTURE_2D,n.Context3DProxy.gl.TEXTURE_WRAP_T,n.Context3DProxy.gl.REPEAT)):(t.texParameteri(n.Context3DProxy.gl.TEXTURE_2D,n.Context3DProxy.gl.TEXTURE_WRAP_S,n.Context3DProxy.gl.CLAMP_TO_EDGE),t.texParameteri(n.Context3DProxy.gl.TEXTURE_2D,n.Context3DProxy.gl.TEXTURE_WRAP_T,n.Context3DProxy.gl.CLAMP_TO_EDGE)),this.filp_y&&n.Context3DProxy.gl.pixelStorei(n.Context3DProxy.gl.UNPACK_FLIP_Y_WEBGL,this.filp_y))},t.prototype.dispose=function(){this.texture2D&&this.texture2D.dispose(),this.texture2D=null,this.texture3D&&this.texture3D.dispose(),this.texture3D=null},t}(dou.HashObject);n.TextureBase=t}(dou3d||(dou3d={})),function(r){var t=function(i){function t(t){var e=i.call(this)||this;return e._imageData=t,e.texture2D=new r.ContextTexture2D,e.texture2D.imageData=t,e}return __extends(t,i),Object.defineProperty(t.prototype,"width",{get:function(){return this._imageData.width},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return this._imageData.height},enumerable:!0,configurable:!0}),t.prototype.upload=function(t){this.texture2D.texture||(this.texture2D.texture=t.createTexture(),this.texture2D.internalFormat=2,this.texture2D.imageData=this._imageData,this.texture2D.dataFormat=r.Context3DProxy.gl.UNSIGNED_BYTE,this.texture2D.colorFormat=r.ContextConfig.ColorFormat_RGBA8888,t.upLoadTextureData(0,this))},t.prototype.uploadForcing=function(t){t.upLoadTextureData(0,this)},t}(r.TextureBase);r.ImageTexture=t}(dou3d||(dou3d={})),function(i){var t=function(e){function t(){var t=e.call(this)||this;return t.smooth=!0,t.texture2D=new i.ContextTexture2D,t}return __extends(t,e),t.prototype.upload=function(t){if(!this.texture2D.texture){if(this.texture2D.texture=this.texture2D.texture||t.createTexture(),this.texture2D.internalFormat=this.internalFormat,this.texture2D.colorFormat=this.colorFormat,this.texture2D.mimapData=this.mimapData,this.texture2D.dataFormat=i.Context3DProxy.gl.UNSIGNED_BYTE,this.mimapData&&0<this.mimapData.length)for(var e=0;e<this.mimapData.length;e++)t.upLoadTextureData(e,this);else t.upLoadTextureData(0,this);this.parentTexture&&(this.parentTexture.texture2D||this.parentTexture.upload(t),this.texture2D=this.parentTexture.texture2D,this.texture2D.internalFormat=this.parentTexture.internalFormat,this.texture2D.colorFormat=this.parentTexture.colorFormat,this.texture2D.mimapData=this.parentTexture.mimapData)}},t.prototype.uploadForcing=function(t){t.upLoadTextureData(0,this)},t}(i.TextureBase);i.Texture=t}(dou3d||(dou3d={})),function(h){var t=function(s){function t(t,e,i,r,a,n){var o=s.call(this)||this;return o.image_front=t,o.image_back=e,o.image_left=i,o.image_right=r,o.image_up=a,o.image_down=n,o.texture3D=new h.ContextTexture3D,o}return __extends(t,s),t.prototype.upload=function(t){this.image_front&&this.image_back&&this.image_left&&this.image_right&&this.image_up&&this.image_down&&(this.texture3D.texture||(this.texture3D.texture=this.texture3D.texture||t.createTexture(),this.texture3D.border=0,this.texture3D.image_front=this.image_front,this.texture3D.image_back=this.image_back,this.texture3D.image_left=this.image_left,this.texture3D.image_right=this.image_right,this.texture3D.image_up=this.image_up,this.texture3D.image_down=this.image_down,t.uploadCubetexture(this.texture3D)))},t.prototype.uploadForcing=function(t){},t}(h.TextureBase);h.CubeTexture=t}(dou3d||(dou3d={})),function(n){var t=function(a){function t(t,e,i){void 0===t&&(t=512),void 0===e&&(e=512),void 0===i&&(i=2);var r=a.call(this)||this;return r.useMipmap=!1,r.smooth=!1,r.width=t,r.height=e,r.frameBufferFormat=i,r.uvRectangle=new n.Rectangle(0,0,1,1),r}return __extends(t,a),t.prototype.upload=function(t){this.texture2D||(this.texture2D=t.createFramebuffer(this.width,this.height,this.frameBufferFormat))},t.prototype.uploadForcing=function(t){},t}(n.TextureBase);n.RenderTexture=t}(dou3d||(dou3d={})),function(t){var e;(e=t.MathUtil||(t.MathUtil={})).PI_HALF=.5*Math.PI,e.PI_QUARTER=.25*Math.PI,e.PI_DOUBLE=2*Math.PI,e.RAD_DEG=180/Math.PI,e.DEG_RAD=Math.PI/180,e.EPSILON=2220446049250313e-31,e.SQRT_2=1.4142135623731,e.SQRT1_2=.5*e.SQRT_2,e.INT_MAX=2147483647,e.INT_MIN=-2147483647,e.clamp=function(t,e,i){return void 0===e&&(e=0),void 0===i&&(i=1),t<e?e:i<t?i:t},e.lerp=function(t,e,i){return t+(e-t)*i},e.toRadians=function(t){return t*Math.PI/180},e.toDegrees=function(t){return 180*t/Math.PI}}(dou3d||(dou3d={})),function(i){(i.GeometryUtil||(i.GeometryUtil={})).fromVertexFormatToLength=function(t){var e=0;return 1&t&&(e+=i.Geometry.positionSize),2&t&&(e+=i.Geometry.normalSize),4&t&&(e+=i.Geometry.tangentSize),8&t&&(e+=i.Geometry.colorSize),16&t&&(e+=i.Geometry.uvSize),32&t&&(e+=i.Geometry.uv2Size),64&t&&(e+=i.Geometry.skinSize),e}}(dou3d||(dou3d={})),function(u){var t=function(){function i(t){var r=this;t||((t=document.createElement("canvas")).style.position="fixed",t.style.left="0px",t.style.top="0px",t.style.width="100%",t.style.height="100%",document.body.appendChild(t)),this._canvas=u.canvas=t;var e=t.getContext("experimental-webgl")||t.getContext("webgl");e?(u.Context3DProxy.gl=e,window.addEventListener("mousedown",function(t){r.onTouchEvent("mousedown",t)}),window.addEventListener("mousemove",function(t){r.onTouchEvent("mousemove",t)}),window.addEventListener("mouseup",function(t){r.onTouchEvent("mouseup",t)}),window.addEventListener("touchstart",function(t){r.onTouchEvent("touchstart",t)}),window.addEventListener("touchmove",function(t){r.onTouchEvent("touchmove",t)}),window.addEventListener("touchend",function(t){r.onTouchEvent("touchend",t)}),window.addEventListener("touchcancel",function(t){r.onTouchEvent("touchcancel",t)}),window.addEventListener("resize",function(){setTimeout(function(){for(var t=0,e=r._view3Ds;t<e.length;t++){var i=e[t];u.Event3D.dispatch(i,u.Event3D.RESIZE)}},300)}),this._viewRect=new u.Rectangle,this._view3Ds=[],(i.context3DProxy=new u.Context3DProxy).register(),u.ticker=new u.Ticker(this),this.startTicker()):console.error("You drivers not suport WEBGL!")}return Object.defineProperty(i.prototype,"viewRect",{get:function(){var t=this._canvas.getBoundingClientRect();return this._viewRect.set(t.left,t.top,t.width,t.height),this._canvas.width=t.width,this._canvas.height=t.height,this._viewRect},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"view3Ds",{get:function(){return this._view3Ds},enumerable:!0,configurable:!0}),i.prototype.addView3D=function(t){-1==this._view3Ds.indexOf(t)&&this._view3Ds.push(t)},i.prototype.removeView3D=function(t){var e=this._view3Ds.indexOf(t);-1!=e&&this._view3Ds.splice(e,1)},i.prototype.startTicker=function(){requestAnimationFrame(function t(){u.ticker.update();requestAnimationFrame(t)})},i.prototype.onTouchEvent=function(t,e){var i,r=this._canvas.getBoundingClientRect(),a=dou.recyclable(u.Vector2);if(e instanceof MouseEvent){switch(t){case"mousedown":i=u.Event3D.TOUCH_BEGIN;break;case"mousemove":i=u.Event3D.TOUCH_MOVE;break;case"mouseup":i=u.Event3D.TOUCH_END}a.set(e.clientX-r.left,e.clientY-r.top)}else{switch(t){case"touchstart":i=u.Event3D.TOUCH_BEGIN;break;case"touchmove":i=u.Event3D.TOUCH_MOVE;break;case"touchend":case"touchcancel":i=u.Event3D.TOUCH_END}if(0<e.touches.length){var n=e.touches[0];a.set(n.clientX-r.left,n.clientY-r.top)}}for(var o=0,s=this._view3Ds;o<s.length;o++){var h=s[o];u.Event3D.dispatch(h,i,a)}a.recycle()},i}();u.Engine=t}(dou3d||(dou3d={}));